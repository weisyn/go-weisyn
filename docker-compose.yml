services:
  weisyn:
    image: weisyn-dev:latest
    container_name: weisyn
    restart: unless-stopped
    working_dir: /app
    environment:
      WES_ENV: "${WES_ENV:-testing}"
      WES_LOG_LEVEL: "${WES_LOG_LEVEL:-info}"
      GOFLAGS: "${GOFLAGS:-}"  # ç¼–è¯‘æ—¶å¯è®¾ç½® -j=1 é™åˆ¶å¹¶å‘ç¼–è¯‘æ•°ï¼Œå‡å°‘å†…å­˜å³°å€¼
      TZ: "${TZ:-Asia/Shanghai}"
    ports:
      - "${HTTP_PORT:-28680}:28680"
      - "${GRPC_PORT:-28682}:28682"
      - "${WS_PORT:-28681}:28681"
      - "${P2P_PORT:-28683}:28683"
      - "${DIAGNOSTICS_PORT:-28686}:28686"
    volumes:
      - ./:/app
      - ./data:/app/data
      - ./configs:/app/configs:ro
      # Go æ„å»ºç¼“å­˜æŒä¹…åŒ–ï¼ˆåŠ é€Ÿç¼–è¯‘ - é¿å…æ¯æ¬¡éƒ½é‡æ–°ç¼–è¯‘æ‰€æœ‰åŒ…ï¼‰
      - go-build-cache:/root/.cache/go-build
      - go-mod-cache:/go/pkg/mod
    # å†…å­˜é™åˆ¶é…ç½®ï¼ˆé˜²æ­¢ OOMï¼‰
    # æ–¹å¼1: ä½¿ç”¨ mem_limitï¼ˆé€‚ç”¨äºå•æœº Dockerï¼Œå…¼å®¹æ€§å¥½ï¼‰
    # æ³¨æ„ï¼šGo ç¼–è¯‘å¤§å‹é¡¹ç›®ï¼ˆ500+ ä¾èµ–ï¼‰æ—¶ï¼Œé“¾æ¥é˜¶æ®µå¯èƒ½å ç”¨ 4-6GB å†…å­˜
    # å¦‚æœç¼–è¯‘æ—¶å‡ºç° OOMï¼Œå¯ä»¥ä¸´æ—¶æé«˜åˆ° 8g æˆ–æ›´é«˜
    mem_limit: 8g  # æœ€å¤§å†…å­˜é™åˆ¶ï¼ˆç¼–è¯‘æ¨è 8gï¼Œè¿è¡Œæ—¶ 4g å³å¯ï¼‰
    mem_reservation: 1g  # ä¿ç•™å†…å­˜ï¼ˆç¼–è¯‘æ—¶éœ€è¦æ›´å¤šä¿è¯ï¼‰
    memswap_limit: 8g  # é™åˆ¶ swap ä½¿ç”¨ï¼ˆè®¾ç½®ä¸ºä¸ mem_limit ç›¸åŒå¯ç¦ç”¨ swapï¼‰
    # 
    # ğŸ”§ å¦‚æœ 8GB å†…å­˜ä»ç„¶ä¸è¶³ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼é™åˆ¶ç¼–è¯‘å¹¶å‘ï¼ˆå‡å°‘å†…å­˜å³°å€¼ï¼‰ï¼š
    # æ–¹å¼1ï¼ˆæ¨èï¼‰: ä½¿ç”¨ -j æ ‡å¿—é™åˆ¶å¹¶è¡Œç¼–è¯‘åŒ…æ•°
    #   docker exec weisyn go build -j=1 -o ./bin/weisyn-node ./cmd/node
    # æ–¹å¼2: ä½¿ç”¨ GOFLAGS ç¯å¢ƒå˜é‡ï¼ˆé™åˆ¶æ‰€æœ‰ go å‘½ä»¤çš„å¹¶å‘ï¼‰
    #   docker exec -e GOFLAGS=-j=1 weisyn go build -o ./bin/weisyn-node ./cmd/node
    # æ–¹å¼3: ä½¿ç”¨ GOMAXPROCS é™åˆ¶ Go è¿è¡Œæ—¶å¹¶å‘ï¼ˆå¯¹ç¼–è¯‘æœ‰é—´æ¥å½±å“ï¼‰
    #   docker exec -e GOMAXPROCS=2 weisyn go build -o ./bin/weisyn-node ./cmd/node
    # æ–¹å¼2: ä½¿ç”¨ deploy.resourcesï¼ˆé€‚ç”¨äº Docker Swarm æ¨¡å¼ï¼‰
    # deploy:
    #   resources:
    #     limits:
    #       memory: 4G
    #     reservations:
    #       memory: 512M
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "true"]

volumes:
  weisyn-data:
  go-build-cache:  # Go æ„å»ºç¼“å­˜ï¼ˆåŠ é€Ÿç¼–è¯‘ï¼‰
  go-mod-cache:    # Go æ¨¡å—ç¼“å­˜ï¼ˆé¿å…é‡å¤ä¸‹è½½ä¾èµ–ï¼‰

