# Network 组件能力视图

---

## 🎯 组件定位

Network 组件是 WES 系统的 P2P 网络通信核心，负责节点发现、消息传播、区块同步等网络功能。

**在三层模型中的位置**：协调层（Coordination Layer）

> **战略背景**：Network 组件为所有需要网络通信的组件提供统一的 P2P 网络能力，支持共识、同步、交易广播等核心功能。详见 [WES 项目总览](../overview.md)

---

## 💡 核心能力

### 1. 节点发现

**能力描述**：
- 基于 K-bucket 的节点发现机制
- 支持动态节点加入和退出
- 支持节点距离计算（XOR 距离）

**使用约束**：
- 节点必须提供有效的节点 ID
- 节点必须支持 P2P 协议
- 节点发现是自动的

**节点角色**：
- **矿工节点**：参与区块生产
- **验证节点**：验证区块和交易
- **普通节点**：同步链状态

---

### 2. 消息传播

**能力描述**：
- 支持交易广播
- 支持区块广播
- 支持流式请求-响应通信
- 支持发布-订阅消息

**使用约束**：
- 消息必须符合协议格式
- 消息大小有限制
- 消息传播是异步的

**消息类型**：
- **交易消息**：交易广播和同步
- **区块消息**：区块广播和同步
- **协议消息**：自定义协议消息

---

### 3. 区块同步

**能力描述**：
- 支持链状态同步
- 支持区块下载和验证
- 支持快速同步模式

**使用约束**：
- 同步是自动的
- 同步过程不影响节点运行
- 同步失败会重试

**同步模式**：
- **全量同步**：下载所有区块
- **快速同步**：下载状态快照
- **增量同步**：只同步新区块

---

### 4. 协议路由

**能力描述**：
- 支持自定义协议注册
- 支持协议消息路由
- 支持协议版本管理

**使用约束**：
- 协议 ID 必须符合格式
- 协议处理器必须幂等
- 协议版本必须兼容

**协议格式**：
- 格式：`/<org>/<domain>/<feature>/<vN>`
- 示例：`/weisyn/block/sync/v1`

---

## 🔧 接口能力

### Network（网络接口）

**能力**：
- `RegisterStreamHandler()` - 注册流式协议处理器
- `RegisterPubSubHandler()` - 注册发布-订阅处理器
- `Call()` - 流式请求-响应调用
- `Publish()` - 发布主题消息
- `Subscribe()` - 订阅主题消息

**约束**：
- 协议注册是持久的
- 消息传播是异步的
- 协议版本必须兼容

---

## ⚙️ 配置说明

### 网络配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `listen_address` | string | "0.0.0.0:8080" | 监听地址 |
| `max_peers` | int | 50 | 最大连接数 |
| `enable_discovery` | bool | true | 启用节点发现 |

---

## 📋 使用约束

### 节点连接约束

1. **连接限制**：
   - 最大连接数不能超过 `max_peers`
   - 连接失败会重试
   - 连接断开会自动重连

2. **节点验证**：
   - 节点必须提供有效的节点 ID
   - 节点必须支持相同的协议版本
   - 节点必须通过身份验证

### 消息传播约束

1. **消息大小**：
   - 消息大小不能超过限制
   - 大消息需要分块传输

2. **消息格式**：
   - 消息必须符合协议格式
   - 消息必须包含版本信息
   - 消息必须包含校验和

### 协议注册约束

1. **协议 ID**：
   - 协议 ID 必须符合格式
   - 协议 ID 不能重复注册
   - 协议版本必须兼容

2. **协议处理器**：
   - 处理器不能为 nil
   - 处理器必须是幂等的
   - 处理器必须处理错误

---

## 🎯 典型使用场景

### 场景 1：节点接入

```go
// 启动节点并连接到网络
network := network.NewNetwork()
err := network.Start()
if err != nil {
    return err
}
// 节点自动发现和连接其他节点
```

### 场景 2：交易广播

```go
// 广播交易到网络
network := network.NewNetwork()
err := network.BroadcastTransaction(tx)
if err != nil {
    return err
}
// 交易自动传播到所有节点
```

### 场景 3：自定义协议

```go
// 注册自定义协议
network := network.NewNetwork()
handler := func(ctx context.Context, req []byte) ([]byte, error) {
    // 处理协议消息
    return response, nil
}
err := network.RegisterStreamHandler("/myorg/mydomain/myfeature/v1", handler)
if err != nil {
    return err
}
```

---

## 📚 相关文档

- [架构鸟瞰](../architecture/overview.md) - 了解系统架构
- [共识能力视图](./consensus.md) - 了解共识能力


