# TX ç»„ä»¶èƒ½åŠ›è§†å›¾

---

## ğŸ¯ ç»„ä»¶å®šä½

TXï¼ˆTransactionï¼‰ç»„ä»¶æ˜¯ WES ç³»ç»Ÿçš„äº¤æ˜“å¤„ç†æ ¸å¿ƒï¼Œè´Ÿè´£äº¤æ˜“çš„æ„å»ºã€éªŒè¯å’Œæäº¤ã€‚

**åœ¨ä¸‰å±‚æ¨¡å‹ä¸­çš„ä½ç½®**ï¼šäº¤äº’å±‚ï¼ˆInteraction Layerï¼‰

> **æˆ˜ç•¥èƒŒæ™¯**ï¼šTX ç»„ä»¶ä½äºæ ¸å¿ƒä¸šåŠ¡å±‚å‚ç›´ä¾èµ–é“¾çš„ç¬¬â‘¤å±‚ï¼Œä¾èµ– EUTXOï¼ˆâ‘£ï¼‰å’Œ URESï¼ˆâ‘¢ï¼‰ï¼Œè¢« Blockï¼ˆâ‘¥ï¼‰ä¾èµ–ã€‚è¯¦è§ [WES é¡¹ç›®æ€»è§ˆ](../overview.md)

---

## ğŸ’¡ æ ¸å¿ƒèƒ½åŠ›

### 1. äº¤æ˜“æ„å»º

**èƒ½åŠ›æè¿°**ï¼š
- æ”¯æŒé€šè¿‡æµå¼ API æ„å»ºäº¤æ˜“
- æ”¯æŒæ·»åŠ å¤šç§ç±»å‹çš„è¾“å…¥å’Œè¾“å‡ºï¼ˆAsset/Resource/Stateï¼‰
- æ”¯æŒæ¶ˆè´¹å‹è¾“å…¥å’Œå¼•ç”¨å‹è¾“å…¥
- é€šè¿‡ Type-state æ¨¡å¼ä¿è¯æ„å»ºé¡ºåºçš„æ­£ç¡®æ€§

**ä½¿ç”¨çº¦æŸ**ï¼š
- äº¤æ˜“æ„å»ºå¿…é¡»æŒ‰ç…§ï¼šComposedTx â†’ ProvenTx â†’ SignedTx â†’ SubmittedTx çš„é¡ºåº
- æ¯ä¸ªé˜¶æ®µå®Œæˆåä¸å¯å†ä¿®æ”¹
- å¿…é¡»æä¾›æœ‰æ•ˆçš„ UTXO å¼•ç”¨å’Œè¾“å‡ºåœ°å€

**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š
- ç®€å•è½¬è´¦ï¼šæ·»åŠ èµ„äº§è¾“å…¥å’Œè¾“å‡º
- åˆçº¦è°ƒç”¨ï¼šæ·»åŠ èµ„æºå¼•ç”¨å’ŒçŠ¶æ€è¾“å‡º
- å¤æ‚äº¤æ˜“ï¼šç»„åˆå¤šç§è¾“å…¥è¾“å‡ºç±»å‹

---

### 2. äº¤æ˜“éªŒè¯

**èƒ½åŠ›æè¿°**ï¼š
- ä¸‰é˜¶æ®µéªŒè¯æœºåˆ¶ï¼šAuthZï¼ˆæƒé™ï¼‰â†’ Conservationï¼ˆå®ˆæ’ï¼‰â†’ Conditionï¼ˆæ¡ä»¶ï¼‰
- æ”¯æŒæ’ä»¶åŒ–éªŒè¯è§„åˆ™
- å¿«é€Ÿå¤±è´¥æœºåˆ¶ï¼šä»»ä¸€é˜¶æ®µå¤±è´¥ç«‹å³è¿”å›

**ä½¿ç”¨çº¦æŸ**ï¼š
- æ‰€æœ‰è¾“å…¥å¿…é¡»é€šè¿‡æƒé™éªŒè¯
- ä»·å€¼å¿…é¡»å®ˆæ’ï¼šÎ£è¾“å…¥ â‰¥ Î£è¾“å‡º + Fee
- æ—¶é—´é”ã€é«˜åº¦é”ç­‰æ¡ä»¶å¿…é¡»æ»¡è¶³
- åˆçº¦ä»£å¸é“¸é€ åœºæ™¯æœ‰ç‰¹æ®Šè§„åˆ™ï¼ˆå‚è§ç›¸å…³æ–‡æ¡£ï¼‰

**éªŒè¯è§„åˆ™**ï¼š
- **AuthZ éªŒè¯**ï¼šæ¯ä¸ªè¾“å…¥å¿…é¡»æä¾›æœ‰æ•ˆçš„è§£é”è¯æ˜
- **Conservation éªŒè¯**ï¼šä»·å€¼å®ˆæ’ï¼Œä¸å…è®¸å‡­ç©ºåˆ›é€ ä»·å€¼
- **Condition éªŒè¯**ï¼šæ—¶é—´çª—å£ã€é«˜åº¦çª—å£ã€Nonceã€ChainID ç­‰æ¡ä»¶æ£€æŸ¥

---

### 3. äº¤æ˜“æäº¤

**èƒ½åŠ›æè¿°**ï¼š
- éªŒè¯é€šè¿‡åè‡ªåŠ¨æäº¤åˆ°äº¤æ˜“æ± 
- æ”¯æŒæŸ¥è¯¢äº¤æ˜“çŠ¶æ€
- è‡ªåŠ¨å¹¿æ’­åˆ°ç½‘ç»œ

**ä½¿ç”¨çº¦æŸ**ï¼š
- å¿…é¡»å…ˆéªŒè¯ï¼ŒéªŒè¯é€šè¿‡åæ‰èƒ½æäº¤
- äº¤æ˜“æ± æœ‰å®¹é‡é™åˆ¶
- é‡å¤äº¤æ˜“ä¼šè¢«æ‹’ç»

**æäº¤æµç¨‹**ï¼š

```mermaid
stateDiagram-v2
    [*] --> ComposedTx: æ„å»ºäº¤æ˜“
    ComposedTx --> ProvenTx: æ·»åŠ è¯æ˜
    ProvenTx --> SignedTx: ç­¾åäº¤æ˜“
    SignedTx --> Validating: æ‰§è¡ŒéªŒè¯
    Validating --> Validated: éªŒè¯é€šè¿‡
    Validated --> SubmittedTx: æäº¤åˆ°äº¤æ˜“æ± 
    SubmittedTx --> Broadcasting: å¹¿æ’­åˆ°ç½‘ç»œ
    Broadcasting --> [*]: å®Œæˆ
    
    Validating --> Failed: éªŒè¯å¤±è´¥
    Failed --> [*]
    
    note right of ComposedTx
        Type-state 1
        ä¸å¯å†ä¿®æ”¹
    end note
    
    note right of Validated
        ä¸‰é˜¶æ®µéªŒè¯é€šè¿‡
        AuthZ â†’ Conservation â†’ Condition
    end note
```

---

## ğŸ”§ æ¥å£èƒ½åŠ›

### TxBuilderï¼ˆäº¤æ˜“æ„å»ºå™¨ï¼‰

**èƒ½åŠ›**ï¼š
- `AddInput()` - æ·»åŠ äº¤æ˜“è¾“å…¥
- `AddAssetOutput()` - æ·»åŠ èµ„äº§è¾“å‡º
- `AddResourceOutput()` - æ·»åŠ èµ„æºè¾“å‡º
- `AddStateOutput()` - æ·»åŠ çŠ¶æ€è¾“å‡º
- `Build()` - æ„å»ºäº¤æ˜“

**çº¦æŸ**ï¼š
- æ”¯æŒé“¾å¼è°ƒç”¨
- æ„å»ºåè¿›å…¥ ComposedTx çŠ¶æ€ï¼Œä¸å¯å†ä¿®æ”¹

### TxVerifierï¼ˆäº¤æ˜“éªŒè¯å™¨ï¼‰

**èƒ½åŠ›**ï¼š
- `Verify()` - æ‰§è¡Œä¸‰é˜¶æ®µéªŒè¯
- `RegisterAuthZPlugin()` - æ³¨å†Œæƒé™éªŒè¯æ’ä»¶
- `RegisterConservationPlugin()` - æ³¨å†Œä»·å€¼å®ˆæ’æ’ä»¶
- `RegisterConditionPlugin()` - æ³¨å†Œæ¡ä»¶æ£€æŸ¥æ’ä»¶

**çº¦æŸ**ï¼š
- éªŒè¯æ˜¯åªè¯»æ“ä½œï¼Œä¸ä¿®æ”¹äº¤æ˜“
- éªŒè¯å¤±è´¥ä¼šè¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯

### TxProcessorï¼ˆäº¤æ˜“å¤„ç†å™¨ï¼‰

**èƒ½åŠ›**ï¼š
- `SubmitTx()` - æäº¤äº¤æ˜“ï¼ˆéªŒè¯ + å…¥æ± ï¼‰
- `GetTxStatus()` - æŸ¥è¯¢äº¤æ˜“çŠ¶æ€

**çº¦æŸ**ï¼š
- æäº¤å‰å¿…é¡»å®Œæˆç­¾å
- éªŒè¯å¤±è´¥ä¸ä¼šå…¥æ± 

---

## âš™ï¸ é…ç½®è¯´æ˜

### éªŒè¯é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enable_batch_verification` | bool | true | å¯ç”¨æ‰¹é‡éªŒè¯ |
| `max_batch_size` | int | 100 | æœ€å¤§æ‰¹é‡å¤§å° |
| `enable_parallel_authz` | bool | false | å¯ç”¨ AuthZ å¹¶è¡ŒéªŒè¯ |

### æ€§èƒ½ç‰¹æ€§

**é«˜ååé‡æ”¯æŒ**ï¼š
- æ”¯æŒæ‰¹é‡äº¤æ˜“å¤„ç†
- æ”¯æŒå¹¶è¡ŒéªŒè¯
- ä¼˜åŒ–çš„éªŒè¯ç®—æ³•

---

## ğŸ“‹ ä½¿ç”¨çº¦æŸ

### äº¤æ˜“æ„å»ºçº¦æŸ

1. **è¾“å…¥çº¦æŸ**ï¼š
   - å¿…é¡»å¼•ç”¨æœ‰æ•ˆçš„ UTXO
   - æ¶ˆè´¹å‹è¾“å…¥ï¼ˆ`isReferenceOnly=false`ï¼‰ä¼šè¢«æ¶ˆè´¹
   - å¼•ç”¨å‹è¾“å…¥ï¼ˆ`isReferenceOnly=true`ï¼‰ä¸ä¼šè¢«æ¶ˆè´¹ï¼Œä»…ç”¨äºè¯»å–

2. **è¾“å‡ºçº¦æŸ**ï¼š
   - AssetOutputï¼šå¿…é¡»æŒ‡å®šæ¥æ”¶åœ°å€å’Œé‡‘é¢
   - ResourceOutputï¼šå¿…é¡»æŒ‡å®šèµ„æºå“ˆå¸Œå’Œæ‰€æœ‰è€…
   - StateOutputï¼šå¿…é¡»åŒ…å«çŠ¶æ€æ•°æ®å’Œè¯æ˜

3. **æ„å»ºé¡ºåºçº¦æŸ**ï¼š
   - å¿…é¡»æŒ‰ç…§ Type-state é¡ºåºæ„å»º
   - æ¯ä¸ªé˜¶æ®µå®Œæˆåä¸å¯å›é€€

### äº¤æ˜“éªŒè¯çº¦æŸ

1. **æƒé™éªŒè¯**ï¼š
   - æ¯ä¸ªè¾“å…¥å¿…é¡»æä¾›æœ‰æ•ˆçš„è§£é”è¯æ˜
   - è§£é”è¯æ˜å¿…é¡»åŒ¹é…é”å®šæ¡ä»¶

2. **ä»·å€¼å®ˆæ’**ï¼š
   - Î£è¾“å…¥ â‰¥ Î£è¾“å‡º + Fee
   - åˆçº¦ä»£å¸é“¸é€ åœºæ™¯æœ‰ç‰¹æ®Šè§„åˆ™

3. **æ¡ä»¶æ£€æŸ¥**ï¼š
   - æ—¶é—´é”å¿…é¡»æ»¡è¶³
   - é«˜åº¦é”å¿…é¡»æ»¡è¶³
   - Nonce å¿…é¡»æ­£ç¡®
   - ChainID å¿…é¡»åŒ¹é…

### äº¤æ˜“æäº¤çº¦æŸ

1. **æäº¤å‰è¦æ±‚**ï¼š
   - äº¤æ˜“å¿…é¡»å®Œæˆç­¾å
   - äº¤æ˜“å¿…é¡»é€šè¿‡éªŒè¯

2. **äº¤æ˜“æ± é™åˆ¶**ï¼š
   - äº¤æ˜“æ± æœ‰å®¹é‡é™åˆ¶
   - é‡å¤äº¤æ˜“ä¼šè¢«æ‹’ç»
   - è¿‡æœŸäº¤æ˜“ä¼šè¢«æ¸…ç†

---

## ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç®€å•è½¬è´¦

```go
builder := tx.NewTxBuilder()
tx := builder.
    AddInput(utxoRef, false).
    AddAssetOutput(toAddress, "100", nil, lock).
    Build()
```

### åœºæ™¯ 2ï¼šåˆçº¦è°ƒç”¨

```go
builder := tx.NewTxBuilder()
tx := builder.
    AddInput(utxoRef, false).
    AddResourceInput(contractHash, true).  // å¼•ç”¨å‹è¾“å…¥
    AddStateOutput(stateData, proof).
    Build()
```

### åœºæ™¯ 3ï¼šå¤æ‚äº¤æ˜“

```go
builder := tx.NewTxBuilder()
tx := builder.
    AddInput(utxoRef1, false).
    AddInput(utxoRef2, true).  // å¼•ç”¨å‹è¾“å…¥
    AddAssetOutput(toAddress1, "100", nil, lock1).
    AddResourceOutput(resourceHash, owner).
    AddStateOutput(stateData, proof).
    Build()
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ¶æ„é¸Ÿç°](../architecture/overview.md) - äº†è§£ç³»ç»Ÿæ¶æ„
- [EUTXO èƒ½åŠ›è§†å›¾](./eutxo.md) - äº†è§£è´¦æœ¬èƒ½åŠ›
- [API å‚è€ƒ](../reference/api/) - äº†è§£ API æ¥å£

