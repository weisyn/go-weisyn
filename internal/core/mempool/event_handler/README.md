# å†…å­˜æ± äº‹ä»¶å¤„ç†å™¨ï¼ˆinternal/core/mempool/event_handlerï¼‰

## ğŸ¯ æ¨¡å—æ¦‚è¿°

æœ¬æ¨¡å—å®ç°å†…å­˜æ± ï¼ˆmempoolï¼‰çš„äº‹ä»¶å¤„ç†å™¨ï¼Œè´Ÿè´£å¤„ç†ä¸äº¤æ˜“æ± ã€å€™é€‰åŒºå—æ± ç›¸å…³çš„å„ç±»äº‹ä»¶ã€‚é€šè¿‡æ ‡å‡†åŒ–çš„äº‹ä»¶å¤„ç†æ¶æ„ï¼Œå®ç°å†…å­˜æ± ä¸ç³»ç»Ÿå…¶ä»–ç»„ä»¶çš„äº‹ä»¶é©±åŠ¨é›†æˆã€‚

## ğŸ“‹ é‡æ„æˆæœ

### âœ… æ¶æ„æ ‡å‡†åŒ–
- **æ›¿æ¢æ—§æ¶æ„**ï¼šä»å¤æ‚çš„"ä¸‹æ²‰æ¡¥æ¥"æ¨¡å¼è¿ç§»åˆ°æ ‡å‡†çš„`subscribe_handlers.go` + `event_handler/manager.go`æ¶æ„
- **ç»Ÿä¸€äº‹ä»¶å¸¸é‡**ï¼šæ‰€æœ‰å­—ç¬¦ä¸²äº‹ä»¶ï¼ˆå¦‚`"mempool.tx.added.v1"`ï¼‰è¿ç§»åˆ°`pkg/constants/events/system_events.go`
- **æ¥å£æ ‡å‡†åŒ–**ï¼šå®ç°æ ‡å‡†çš„`MempoolEventSubscriber`ã€`TxPoolEventSubscriber`ã€`CandidatePoolEventSubscriber`æ¥å£

### âœ… äº‹ä»¶å¸¸é‡å½’å£
æ·»åŠ äº†17ä¸ªmempoolç›¸å…³çš„æ ‡å‡†åŒ–äº‹ä»¶å¸¸é‡ï¼š

#### äº¤æ˜“æ± äº‹ä»¶
- `EventTypeTxAdded` - äº¤æ˜“æ·»åŠ äº‹ä»¶
- `EventTypeTxRemoved` - äº¤æ˜“ç§»é™¤äº‹ä»¶  
- `EventTypeTxConfirmed` - äº¤æ˜“ç¡®è®¤äº‹ä»¶
- `EventTypeTxExpired` - äº¤æ˜“è¿‡æœŸäº‹ä»¶
- `EventTypeTxPoolFull` - äº¤æ˜“æ± æ»¡äº‹ä»¶
- `EventTypeTxPoolCleared` - äº¤æ˜“æ± æ¸…ç†äº‹ä»¶

#### å€™é€‰åŒºå—æ± äº‹ä»¶
- `EventTypeCandidateAdded` - å€™é€‰åŒºå—æ·»åŠ äº‹ä»¶
- `EventTypeCandidateRemoved` - å€™é€‰åŒºå—ç§»é™¤äº‹ä»¶
- `EventTypeCandidateExpired` - å€™é€‰åŒºå—è¿‡æœŸäº‹ä»¶
- `EventTypeCandidatePoolFull` - å€™é€‰åŒºå—æ± æ»¡äº‹ä»¶
- `EventTypeCandidatePoolCleared` - å€™é€‰åŒºå—æ± æ¸…ç†äº‹ä»¶
- `EventTypeCandidateCleanupCompleted` - æ¸…ç†å®Œæˆäº‹ä»¶

#### å†…å­˜æ± ç®¡ç†äº‹ä»¶
- `EventTypeMempoolStarted` - å†…å­˜æ± å¯åŠ¨äº‹ä»¶
- `EventTypeMempoolStopped` - å†…å­˜æ± åœæ­¢äº‹ä»¶
- `EventTypeMempoolSizeChanged` - å¤§å°å˜åŒ–äº‹ä»¶
- `EventTypeMempoolPressureHigh` - å‹åŠ›é«˜äº‹ä»¶

### âœ… ç”Ÿäº§çº§äº‹ä»¶å¤„ç†é€»è¾‘

#### MempoolEventHandlerï¼ˆå†…å­˜æ± é€šç”¨äº‹ä»¶å¤„ç†å™¨ï¼‰
- **ç³»ç»Ÿåœæ­¢å¤„ç†**ï¼šåŒºåˆ†ç´§æ€¥/æ­£å¸¸åœæ­¢ï¼Œå®ç°ä¼˜é›…å…³é—­
- **ç½‘ç»œè´¨é‡è‡ªé€‚åº”**ï¼šæ ¹æ®ç½‘ç»œè´¨é‡è°ƒæ•´å†…å­˜æ± ç­–ç•¥
- **åŒºå—ç¡®è®¤å¤„ç†**ï¼šæ¸…ç†å·²ç¡®è®¤äº¤æ˜“å’Œå€™é€‰åŒºå—
- **é“¾é‡ç»„å“åº”**ï¼šæ¢å¤å›æ»šäº¤æ˜“ï¼Œæ¸…ç†æ— æ•ˆå€™é€‰åŒºå—
- **å…±è¯†ç»“æœå“åº”**ï¼šæ ¹æ®å…±è¯†ç»“æœè°ƒæ•´ç­–ç•¥

#### TxPoolEventHandlerï¼ˆäº¤æ˜“æ± äº‹ä»¶å¤„ç†å™¨ï¼‰
- **èµ„æºè€—å°½å¤„ç†**ï¼šæ ¹æ®èµ„æºç±»å‹å¯åŠ¨ä¸åŒæ¸…ç†ç­–ç•¥
- **å†…å­˜å‹åŠ›ç®¡ç†**ï¼šåˆ†çº§å¤„ç†å†…å­˜å‹åŠ›ï¼Œé˜²æ­¢ç³»ç»Ÿå´©æºƒ
- **äº¤æ˜“æ¥æ”¶å¤„ç†**ï¼šéªŒè¯å¹¶å†³å®šäº¤æ˜“å…¥æ± 
- **äº¤æ˜“å¤±è´¥å¤„ç†**ï¼šåŠæ—¶ç§»é™¤å¤±è´¥äº¤æ˜“
- **åˆ†å‰æ£€æµ‹å“åº”**ï¼šæš‚åœå¤„ç†ç­‰å¾…åˆ†å‰è§£å†³

#### CandidatePoolEventHandlerï¼ˆå€™é€‰åŒºå—æ± äº‹ä»¶å¤„ç†å™¨ï¼‰
- **åŒºå—ç”Ÿäº§å¤„ç†**ï¼šå°†æ–°äº§ç”ŸåŒºå—åŠ å…¥å€™é€‰æ± 
- **å…±è¯†çŠ¶æ€å“åº”**ï¼šæ ¹æ®å…±è¯†çŠ¶æ€è°ƒæ•´å€™é€‰åŒºå—ç­–ç•¥
- **èµ„æºç®¡ç†**ï¼šåœ¨èµ„æºä¸è¶³æ—¶æ¸…ç†è¿‡æœŸå€™é€‰åŒºå—
- **å­˜å‚¨ä¼˜åŒ–**ï¼šåœ¨å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶å‡å°‘ç¼“å­˜

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### Fxæ¨¡å—é›†æˆ

å†…å­˜æ± æ¨¡å—å·²åœ¨`module.go`ä¸­å®ç°æ ‡å‡†åŒ–äº‹ä»¶é›†æˆï¼š

```go
// æ ‡å‡†åŒ–äº‹ä»¶é›†æˆï¼šç»Ÿä¸€çš„äº‹ä»¶è®¢é˜…å’Œå¤„ç†
fx.Invoke(func(
    logger log.Logger,
    eventBus event.EventBus,
    txPool mempoolIfaces.TxPool,
    candidatePool mempoolIfaces.CandidatePool,
) error {
    // åˆ›å»ºäº‹ä»¶å¤„ç†å™¨
    mempoolHandler, txPoolHandler, candidatePoolHandler := event_handler.CreateMempoolEventHandlers(
        logger, eventBus, txPool, candidatePool,
    )

    // åˆ›å»ºäº‹ä»¶è®¢é˜…æ³¨å†Œå™¨
    registry := eventintegration.NewEventSubscriptionRegistry(eventBus, logger)

    // æ³¨å†Œæ‰€æœ‰äº‹ä»¶è®¢é˜…
    return registry.RegisterEventSubscriptions(
        mempoolHandler,
        txPoolHandler,
        candidatePoolHandler,
    )
}),
```

### äº‹ä»¶å‘å¸ƒç¤ºä¾‹

```go
// å‘å¸ƒäº¤æ˜“æ·»åŠ äº‹ä»¶
eventBus.Publish(eventconstants.EventTypeTxAdded, map[string]interface{}{
    "tx_hash": txHash,
    "source":  "network",
})

// å‘å¸ƒå€™é€‰åŒºå—æ·»åŠ äº‹ä»¶  
eventBus.Publish(eventconstants.EventTypeCandidateAdded, map[string]interface{}{
    "block_height": height,
    "block_hash":   hash,
    "producer":     producer,
})
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
internal/core/mempool/
â”œâ”€â”€ event_handler/
â”‚   â”œâ”€â”€ manager.go              # äº‹ä»¶å¤„ç†å™¨å®ç°
â”‚   â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
â”œâ”€â”€ integration/event/
â”‚   â””â”€â”€ subscribe_handlers.go  # äº‹ä»¶è®¢é˜…æ¥å£å®šä¹‰
â”œâ”€â”€ candidatepool/             # å€™é€‰åŒºå—æ± 
â”œâ”€â”€ txpool/                    # äº¤æ˜“æ± 
â””â”€â”€ module.go                  # Fxæ¨¡å—å®šä¹‰ï¼ˆå·²æ›´æ–°ä¸ºæ ‡å‡†æ¶æ„ï¼‰
```

## ğŸ”„ è¿ç§»å¯¹æ¯”

### æ—§æ¶æ„ â†’ æ–°æ¶æ„

| æ—§æ¶æ„ç»„ä»¶ | æ–°æ¶æ„ç»„ä»¶ | æ”¹è¿›ç‚¹ |
|------------|------------|---------|
| `integration/event/incoming/` | `integration/event/subscribe_handlers.go` | ç®€åŒ–è®¢é˜…æ¥å£å®šä¹‰ |
| `integration/event/outgoing/` | `event_handler/manager.go` | ç»Ÿä¸€äº‹ä»¶å¤„ç†é€»è¾‘ |
| å­—ç¬¦ä¸²äº‹ä»¶å¸¸é‡ | `pkg/constants/events/system_events.go` | ç±»å‹å®‰å…¨ï¼Œå…¨å±€ç»Ÿä¸€ |
| å¤æ‚çš„ä¸‹æ²‰æ¡¥æ¥ | ç›´æ¥EventBusè®¢é˜… | é™ä½å¤æ‚åº¦ï¼Œæé«˜æ€§èƒ½ |

## ğŸ¯ è®¾è®¡åŸåˆ™

- **é«˜å†…èšä½è€¦åˆ**ï¼šäº‹ä»¶å¤„ç†é€»è¾‘é›†ä¸­ç®¡ç†ï¼Œé¿å…æ•£è½å„å¤„
- **æ¥å£å¯¼å‘**ï¼šå®ç°æ¸…æ™°çš„è®¢é˜…æ¥å£çº¦å®š
- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨å¼ºç±»å‹äº‹ä»¶å¸¸é‡ï¼Œé¿å…å­—ç¬¦ä¸²é”™è¯¯
- **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªäº‹ä»¶å¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–äº‹ä»¶
- **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•å’Œæ¡ä»¶åˆ¤æ–­

## ğŸš€ åç»­ä¼˜åŒ–

æœ¬æ¬¡é‡æ„ä¸ºå†…å­˜æ± äº‹ä»¶ç³»ç»Ÿå¥ å®šäº†åšå®åŸºç¡€ï¼Œåç»­å¯ä»¥ï¼š

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ·»åŠ äº‹ä»¶å¤„ç†æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§
2. **æ‰©å±•åŠŸèƒ½**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ·»åŠ æ–°çš„äº‹ä»¶å¤„ç†é€»è¾‘
3. **æµ‹è¯•å®Œå–„**ï¼šç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **æ–‡æ¡£è¡¥å……**ï¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µå®Œå–„æ–‡æ¡£

---

*æœ¬æ–‡æ¡£è®°å½•äº†å†…å­˜æ± äº‹ä»¶ç³»ç»Ÿä»å¤æ‚çš„ä¸‹æ²‰æ¡¥æ¥æ¶æ„å‘æ ‡å‡†åŒ–æ¶æ„çš„é‡æ„è¿‡ç¨‹ï¼Œä¸ºWESç³»ç»Ÿäº‹ä»¶æ ‡å‡†åŒ–æä¾›äº†é‡è¦å‚è€ƒã€‚*
