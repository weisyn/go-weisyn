# Security - å®‰å…¨ç»„ä»¶å­åŸŸ

---

## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼š1.0
- **çŠ¶æ€**ï¼šstable
- **æœ€åæ›´æ–°**ï¼š2025-11-30
- **æœ€åå®¡æ ¸**ï¼š2025-11-30
- **æ‰€æœ‰è€…**ï¼šWES Network å¼€å‘ç»„
- **é€‚ç”¨èŒƒå›´**ï¼šWES Network ç»„ä»¶å®‰å…¨ç»„ä»¶å­åŸŸ

---

## ğŸ¯ å­åŸŸå®šä½

**è·¯å¾„**ï¼š`internal/core/network/security/`

**æ‰€å±ç»„ä»¶**ï¼š`network`

**æ ¸å¿ƒèŒè´£**ï¼šæä¾›ç½‘ç»œå®‰å…¨ç»„ä»¶ï¼ŒåŒ…æ‹¬è¿æ¥é€Ÿç‡é™åˆ¶å’Œæ¶ˆæ¯é€Ÿç‡é™åˆ¶ï¼Œé˜²æ­¢ DoS æ”»å‡»å’Œèµ„æºæ»¥ç”¨ã€‚

**åœ¨ç»„ä»¶ä¸­çš„è§’è‰²**ï¼š
- ç½‘ç»œå®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿
- é˜²æ­¢æ¶æ„èŠ‚ç‚¹çš„èµ„æºæ»¥ç”¨
- ä¿æŠ¤ç½‘ç»œæœåŠ¡çš„ç¨³å®šæ€§
- æ”¯æŒç»†ç²’åº¦çš„é€Ÿç‡æ§åˆ¶ç­–ç•¥

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åœ¨ç»„ä»¶ä¸­çš„ä½ç½®

> **è¯´æ˜**ï¼šå±•ç¤ºæ­¤å­åŸŸåœ¨ç»„ä»¶å†…éƒ¨çš„ä½ç½®å’Œåä½œå…³ç³»

```mermaid
graph TB
    subgraph "ç»„ä»¶ internal/core/network"
        subgraph "æœ¬å­åŸŸ security/"
            THIS["Security SubDomain<br/>å®‰å…¨ç»„ä»¶"]
            
            RATE_LIMITER["rate_limiter.go<br/>è¿æ¥é€Ÿç‡é™åˆ¶å™¨"]
            MSG_RATE_LIMITER["message_rate_limiter.go<br/>æ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨"]
        end
        
        subgraph "åä½œçš„å­åŸŸ"
            FACADE["facade/<br/>ç½‘ç»œé—¨é¢<br/>ä½¿ç”¨å®‰å…¨ç»„ä»¶"]
            PUBSUB["pubsub/<br/>å‘å¸ƒè®¢é˜…æœåŠ¡<br/>è°ƒç”¨æ¶ˆæ¯é€Ÿç‡é™åˆ¶"]
        end
    end
    
    FACADE --> RATE_LIMITER
    FACADE --> MSG_RATE_LIMITER
    PUBSUB --> MSG_RATE_LIMITER
    
    style THIS fill:#FFD700
    style RATE_LIMITER fill:#FFD700
    style MSG_RATE_LIMITER fill:#FFD700
```

**ä½ç½®è¯´æ˜**ï¼š

| å…³ç³»ç±»å‹ | ç›®æ ‡ | å…³ç³»è¯´æ˜ |
|---------|------|---------|
| **è¢«ä½¿ç”¨** | facade/ | Facade ä½¿ç”¨ RateLimiter å’Œ MessageRateLimiter è¿›è¡Œé€Ÿç‡é™åˆ¶ |
| **è¢«ä½¿ç”¨** | pubsub/ | PubSub æœåŠ¡è°ƒç”¨ MessageRateLimiter é™åˆ¶æ¶ˆæ¯é€Ÿç‡ |

---

### å†…éƒ¨ç»„ç»‡

> **è¯´æ˜**ï¼šå±•ç¤ºæ­¤å­åŸŸå†…éƒ¨çš„æ–‡ä»¶ç»„ç»‡å’Œç±»å‹å…³ç³»

```mermaid
graph TB
    subgraph "security/ ç›®å½•ç»“æ„"
        RATE["rate_limiter.go<br/>è¿æ¥é€Ÿç‡é™åˆ¶å™¨<br/>RateLimiter"]
        MSG["message_rate_limiter.go<br/>æ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨<br/>MessageRateLimiter"]
        TEST1["rate_limiter_test.go<br/>è¿æ¥é€Ÿç‡é™åˆ¶å™¨æµ‹è¯•"]
        TEST2["message_rate_limiter_test.go<br/>æ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨æµ‹è¯•"]
    end
    
    TEST1 --> RATE
    TEST2 --> MSG
    
    style RATE fill:#FFD700
    style MSG fill:#FFD700
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
internal/core/network/security/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ rate_limiter.go             # è¿æ¥é€Ÿç‡é™åˆ¶å™¨
â”œâ”€â”€ message_rate_limiter.go     # æ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨
â”œâ”€â”€ rate_limiter_test.go        # è¿æ¥é€Ÿç‡é™åˆ¶å™¨æµ‹è¯•
â””â”€â”€ message_rate_limiter_test.go # æ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨æµ‹è¯•
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### å®ç°æ–‡ä»¶ 1ï¼š`rate_limiter.go`

**æ ¸å¿ƒç±»å‹**ï¼š`RateLimiter`

**èŒè´£**ï¼šé™åˆ¶æ¯ä¸ªèŠ‚ç‚¹å’Œ IP çš„è¿æ¥é€Ÿç‡ï¼Œé˜²æ­¢è¿æ¥æ´ªæ°´æ”»å‡»

**å…³é”®å­—æ®µ**ï¼š

```go
type RateLimiter struct {
    maxConnectionsPerPeer int           // æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è¿æ¥æ•°
    maxConnectionsPerIP   int           // æ¯ä¸ª IP çš„æœ€å¤§è¿æ¥æ•°
    connections           map[string]int // è¿æ¥è®¡æ•°ï¼ˆpeerID -> countï¼‰
    ipConnections         map[string]int // IP è¿æ¥è®¡æ•°ï¼ˆIP -> countï¼‰
    mu                    sync.RWMutex   // å¹¶å‘ä¿æŠ¤
}
```

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³•å | èŒè´£ | å¯è§æ€§ | å¤‡æ³¨ |
|-------|------|-------|-----|
| `NewRateLimiter()` | æ„é€ å‡½æ•° | Public | åˆ›å»ºé€Ÿç‡é™åˆ¶å™¨å®ä¾‹ |
| `CheckConnection()` | æ£€æŸ¥è¿æ¥æ˜¯å¦å…è®¸ | Public | æ£€æŸ¥èŠ‚ç‚¹å’Œ IP è¿æ¥æ•° |
| `RemoveConnection()` | ç§»é™¤è¿æ¥è®¡æ•° | Public | è¿æ¥å…³é—­æ—¶è°ƒç”¨ |
| `Stop()` | åœæ­¢é€Ÿç‡é™åˆ¶å™¨ | Public | æ¸…ç†èµ„æº |

---

### å®ç°æ–‡ä»¶ 2ï¼š`message_rate_limiter.go`

**æ ¸å¿ƒç±»å‹**ï¼š`MessageRateLimiter`

**èŒè´£**ï¼šé™åˆ¶æ¯ä¸ªèŠ‚ç‚¹å‘é€æ¶ˆæ¯çš„é€Ÿç‡ï¼Œé˜²æ­¢æ¶ˆæ¯æ´ªæ°´æ”»å‡»

**å…³é”®å­—æ®µ**ï¼š

```go
type MessageRateLimiter struct {
    maxMessagesPerSecond int                    // æ¯ç§’æœ€å¤§æ¶ˆæ¯æ•°
    windowSize          time.Duration          // æ—¶é—´çª—å£å¤§å°
    messageCount        map[string][]time.Time // æ¶ˆæ¯æ—¶é—´æˆ³è®°å½•ï¼ˆpeerID -> timestampsï¼‰
    mu                  sync.RWMutex           // å¹¶å‘ä¿æŠ¤
}
```

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³•å | èŒè´£ | å¯è§æ€§ | å¤‡æ³¨ |
|-------|------|-------|-----|
| `NewMessageRateLimiter()` | æ„é€ å‡½æ•° | Public | åˆ›å»ºæ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨å®ä¾‹ |
| `CheckMessage()` | æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å…è®¸ | Public | æ£€æŸ¥æ¶ˆæ¯é€Ÿç‡é™åˆ¶ |
| `Stop()` | åœæ­¢æ¶ˆæ¯é€Ÿç‡é™åˆ¶å™¨ | Public | æ¸…ç†èµ„æº |

---

## ğŸ”— åä½œå…³ç³»

### ä¾èµ–çš„æ¥å£

| æ¥å£ | æ¥æº | ç”¨é€” |
|-----|------|-----|
| æ—  | - | ç‹¬ç«‹ç»„ä»¶ï¼Œä¸ä¾èµ–å¤–éƒ¨æ¥å£ |

### è¢«ä¾èµ–å…³ç³»

**è¢«ä»¥ä¸‹å­åŸŸä½¿ç”¨**ï¼š
- `facade/` - ä½¿ç”¨ `RateLimiter` å’Œ `MessageRateLimiter` è¿›è¡Œé€Ÿç‡é™åˆ¶
- `pubsub/` - ä½¿ç”¨ `MessageRateLimiter` é™åˆ¶æ¶ˆæ¯é€Ÿç‡

**ç¤ºä¾‹**ï¼š

```go
// åœ¨ facade/service.go ä¸­ä½¿ç”¨
import "github.com/weisyn/v1/internal/core/network/security"

func NewFacade(...) *Facade {
    rateLimiter := netsec.NewRateLimiter(maxConnPerPeer, maxConnPerIP)
    msgRateLimiter := netsec.NewMessageRateLimiter(maxMsgPerSec, windowSize)
    
    return &Facade{
        rateLimiter:    rateLimiter,
        msgRateLimiter: msgRateLimiter,
        // ...
    }
}

// åœ¨å‘å¸ƒæ¶ˆæ¯æ—¶æ£€æŸ¥é€Ÿç‡é™åˆ¶
func (f *Facade) Publish(ctx context.Context, topic string, data []byte, opts *iface.PublishOptions) error {
    peerID := msg.ReceivedFrom.String()
    if err := f.msgRateLimiter.CheckMessage(peerID); err != nil {
        return err // é€Ÿç‡é™åˆ¶
    }
    // ... ç»§ç»­å‘å¸ƒ
}
```

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•è¦†ç›–

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶ | è¦†ç›–ç‡ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|---------|------|-----------|---------|
| å•å…ƒæµ‹è¯• | `rate_limiter_test.go` | â‰¥ 80% | âœ… å·²å®ç° |
| å•å…ƒæµ‹è¯• | `message_rate_limiter_test.go` | â‰¥ 80% | âœ… å·²å®ç° |

---

## ğŸ“Š å…³é”®è®¾è®¡å†³ç­–

### å†³ç­– 1ï¼šåˆ†ç¦»è¿æ¥é™åˆ¶å’Œæ¶ˆæ¯é™åˆ¶

**é—®é¢˜**ï¼šè¿æ¥é™åˆ¶å’Œæ¶ˆæ¯é™åˆ¶æ˜¯å¦åº”è¯¥åˆå¹¶ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šåˆ†ç¦»ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„ç»„ä»¶ `RateLimiter` å’Œ `MessageRateLimiter`

**ç†ç”±**ï¼š
- èŒè´£å•ä¸€ï¼šè¿æ¥é™åˆ¶å’Œæ¶ˆæ¯é™åˆ¶æ˜¯ä¸åŒçš„å®‰å…¨ç­–ç•¥
- çµæ´»é…ç½®ï¼šå¯ä»¥ç‹¬ç«‹é…ç½®å’Œè°ƒæ•´å„è‡ªçš„é™åˆ¶å‚æ•°
- æ˜“äºæµ‹è¯•ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•å’ŒéªŒè¯

**æƒè¡¡**ï¼š
- âœ… ä¼˜ç‚¹ï¼šèŒè´£æ¸…æ™°ã€é…ç½®çµæ´»ã€æ˜“äºç»´æŠ¤
- âš ï¸ ç¼ºç‚¹ï¼šéœ€è¦ç»´æŠ¤ä¸¤ä¸ªç»„ä»¶ï¼ˆä½†ä»£ç é‡ä¸å¤§ï¼Œå¯æ¥å—ï¼‰

---

### å†³ç­– 2ï¼šæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•

**é—®é¢˜**ï¼šå¦‚ä½•å®ç°æ¶ˆæ¯é€Ÿç‡é™åˆ¶ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œè®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„æ¶ˆæ¯æ—¶é—´æˆ³

**ç†ç”±**ï¼š
- ç²¾ç¡®æ§åˆ¶ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ç§’çš„æ¶ˆæ¯æ•°é‡
- å†…å­˜å¯æ§ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„æ—¶é—´æˆ³ï¼Œé¿å…å†…å­˜æ³„æ¼
- æ€§èƒ½è‰¯å¥½ï¼šæ—¶é—´å¤æ‚åº¦ O(n)ï¼Œn ä¸ºæ—¶é—´çª—å£å†…çš„æ¶ˆæ¯æ•°

**æƒè¡¡**ï¼š
- âœ… ä¼˜ç‚¹ï¼šç²¾ç¡®ã€å¯æ§ã€æ€§èƒ½è‰¯å¥½
- âš ï¸ ç¼ºç‚¹ï¼šéœ€è¦å®šæœŸæ¸…ç†ï¼ˆå·²åœ¨ `CheckMessage` ä¸­å®ç°ï¼‰

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### è¿æ¥é€Ÿç‡é™åˆ¶

- **é˜²è¿æ¥æ´ªæ°´**ï¼šé™åˆ¶æ¯ä¸ªèŠ‚ç‚¹å’Œ IP çš„æœ€å¤§è¿æ¥æ•°
- **èµ„æºä¿æŠ¤**ï¼šé˜²æ­¢æ¶æ„èŠ‚ç‚¹å ç”¨è¿‡å¤šè¿æ¥èµ„æº
- **è‡ªåŠ¨æ¸…ç†**ï¼šè¿æ¥å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†è®¡æ•°

### æ¶ˆæ¯é€Ÿç‡é™åˆ¶

- **é˜²æ¶ˆæ¯æ´ªæ°´**ï¼šé™åˆ¶æ¯ä¸ªèŠ‚ç‚¹æ¯ç§’çš„æœ€å¤§æ¶ˆæ¯æ•°
- **DoS é˜²æŠ¤**ï¼šé˜²æ­¢æ¶æ„èŠ‚ç‚¹å‘é€å¤§é‡æ¶ˆæ¯å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- **æ»‘åŠ¨çª—å£**ï¼šä½¿ç”¨æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ç²¾ç¡®æ§åˆ¶é€Ÿç‡

---

## âš™ï¸ é…ç½®å‚æ•°

### RateLimiter é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| `maxConnectionsPerPeer` | int | 10 | æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è¿æ¥æ•° |
| `maxConnectionsPerIP` | int | 50 | æ¯ä¸ª IP çš„æœ€å¤§è¿æ¥æ•° |

### MessageRateLimiter é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| `maxMessagesPerSecond` | int | 100 | æ¯ç§’æœ€å¤§æ¶ˆæ¯æ•° |
| `windowSize` | time.Duration | 1s | æ—¶é—´çª—å£å¤§å° |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç»„ä»¶æ€»è§ˆ](../README.md)
- [ç½‘ç»œé—¨é¢](../facade/README.md)
- [å‘å¸ƒè®¢é˜…æœåŠ¡](../pubsub/README.md)
- [ä»£ç ç»„ç»‡è§„èŒƒ](../../../../docs/system/standards/principles/code-organization.md)

---

## ğŸ“ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| 1.0 | 2025-11-30 | åˆå§‹ç‰ˆæœ¬ | WES Network å¼€å‘ç»„ |

---

## ğŸš§ å¾…åŠäº‹é¡¹

- [ ] æ·»åŠ é…ç½®åŒ–çš„é€Ÿç‡é™åˆ¶å‚æ•°
- [ ] æ·»åŠ é€Ÿç‡é™åˆ¶çš„ç›‘æ§æŒ‡æ ‡
- [ ] æ”¯æŒåŠ¨æ€è°ƒæ•´é€Ÿç‡é™åˆ¶å‚æ•°
- [ ] æ·»åŠ é€Ÿç‡é™åˆ¶çš„æ—¥å¿—è®°å½•

---

