package interfaces

import (
	"context"
)

// TensorInput å¼ é‡è¾“å…¥ï¼ˆæ”¯æŒå¤šç»´å¼ é‡å’Œå¤šç§æ•°æ®ç±»å‹ï¼‰
//
// ğŸ¯ **è®¾è®¡ç›®çš„**ï¼š
// - æ”¯æŒå¤šç»´å¼ é‡è¾“å…¥ï¼ˆå¦‚ [1, 3, 224, 224]ï¼‰
// - æä¾›å½¢çŠ¶ä¿¡æ¯ï¼Œç¡®ä¿ä¸æ¨¡å‹è¦æ±‚åŒ¹é…
// - æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ˆfloat32, int64, uint8ç­‰ï¼‰
//
// ğŸ“‹ **å­—æ®µè¯´æ˜**ï¼š
//   - Name: è¾“å…¥åç§°ï¼ˆå¯é€‰ï¼ŒæŒ‰é¡ºåºåŒ¹é…æ—¶å¯ä¸ºç©ºï¼‰
//   - Data: å±•å¹³çš„æ•°æ®ï¼ˆfloat64æ•°ç»„ï¼Œç”¨äºfloat32/float64ç±»å‹ï¼‰
//   - Int64Data: int64ç±»å‹æ•°æ®ï¼ˆç”¨äºint64ç±»å‹ï¼Œå¦‚BERTç­‰æ–‡æœ¬æ¨¡å‹ï¼‰
//   - Int32Data: int32ç±»å‹æ•°æ®ï¼ˆç”¨äºint32ç±»å‹ï¼‰
//   - Int16Data: int16ç±»å‹æ•°æ®ï¼ˆç”¨äºint16ç±»å‹ï¼‰
//   - Uint8Data: uint8ç±»å‹æ•°æ®ï¼ˆç”¨äºuint8ç±»å‹ï¼Œå¦‚å›¾åƒåŸå§‹æ•°æ®ï¼‰
//   - Shape: å½¢çŠ¶ä¿¡æ¯ï¼ˆå¦‚ [1, 3, 224, 224]ï¼‰
//   - DataType: æ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸ºç©ºåˆ™ä»æ¨¡å‹å…ƒæ•°æ®è·å–ï¼‰
//
// ğŸ“‹ **ä½¿ç”¨è¯´æ˜**ï¼š
//   - æ ¹æ®æ¨¡å‹è¦æ±‚çš„æ•°æ®ç±»å‹ï¼Œä½¿ç”¨å¯¹åº”çš„Dataå­—æ®µ
//   - å¦‚æœDataTypeä¸ºç©ºï¼Œå°†ä»æ¨¡å‹å…ƒæ•°æ®ä¸­è‡ªåŠ¨è·å–
//
// ğŸ“š **å®˜æ–¹ç±»å‹æ”¯æŒå‚è€ƒ** (github.com/yalue/onnxruntime_go@v1.22.0):
//   - tensor_type_constraints.go: IntData æ¥å£å®šä¹‰
//     type IntData interface {
//         ~int8 | ~uint8 | ~int16 | ~uint16 | ~int32 | ~uint32 | ~int64 | ~uint64
//     }
//   - tensor_type_constraints.go: FloatData æ¥å£å®šä¹‰
//     type FloatData interface {
//         ~float32 | ~float64
//     }
//   - onnxruntime_go å®Œå…¨æ”¯æŒ: int8, uint8, int16, uint16, int32, uint32, int64, uint64, float32, float64
//   - float16/bfloat16: éœ€è¦ä½¿ç”¨ NewCustomDataTensor å’Œå­—èŠ‚æ ¼å¼æ•°æ®ï¼ˆGo æ²¡æœ‰åŸç”Ÿ float16/bfloat16 ç±»å‹ï¼‰
type TensorInput struct {
	Name      string    // è¾“å…¥åç§°ï¼ˆå¯é€‰ï¼‰
	Data      []float64 // float32/float64ç±»å‹æ•°æ®ï¼ˆé€šè¿‡float64ä¼ é€’ï¼‰
	Int64Data []int64   // int64ç±»å‹æ•°æ®ï¼ˆç”¨äºæ–‡æœ¬æ¨¡å‹ï¼‰
	Int32Data []int32   // int32ç±»å‹æ•°æ®ï¼ˆonnxruntime_go å®Œå…¨æ”¯æŒï¼‰
	Int16Data []int16   // int16ç±»å‹æ•°æ®ï¼ˆonnxruntime_go å®Œå…¨æ”¯æŒï¼‰
	Uint8Data []uint8   // uint8ç±»å‹æ•°æ®ï¼ˆç”¨äºå›¾åƒåŸå§‹æ•°æ®ï¼‰
	Shape     []int64   // å½¢çŠ¶ä¿¡æ¯
	DataType  string    // æ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼š"float32", "float64", "int64", "int32", "int16", "uint8"ï¼‰
}

// TensorOutput å¼ é‡è¾“å‡ºï¼ˆå¯Œå¼ é‡ç»“æ„ï¼ŒåŒ…å«dtype/shape/åŸå§‹æ•°æ®ï¼‰
//
// ğŸ¯ **è®¾è®¡ç›®çš„**ï¼š
// - ä¸ºä¸Šå±‚ï¼ˆEngineManager / Coordinator / JSON-RPCï¼‰æä¾›ç»Ÿä¸€çš„ã€å¯Œè¯­ä¹‰çš„å¼ é‡ç»“æœè§†å›¾
// - åŒæ—¶ä¿ç•™æ•°å€¼è§†å›¾ï¼ˆValuesï¼‰å’ŒåŸå§‹å­—èŠ‚è§†å›¾ï¼ˆRawDataï¼‰ï¼Œä¾¿äºå¯è§†åŒ–ä¸bitçº§éªŒè¯
//
// ğŸ“‹ **å­—æ®µè¯´æ˜**ï¼š
//   - Name: è¾“å‡ºåç§°ï¼ˆæ¥è‡ªæ¨¡å‹å…ƒæ•°æ®ï¼‰ï¼›
//   - DType: æ•°æ®ç±»å‹å­—ç¬¦ä¸²ï¼ˆå¦‚ "float32"ã€"float64"ã€"int64"ã€"float16" ç­‰ï¼Œæ˜ å°„è‡ª ONNX/DataTypeï¼‰ï¼›
//   - Shape: å¼ é‡å½¢çŠ¶ï¼ˆä¼˜å…ˆä½¿ç”¨æ¨¡å‹å…ƒæ•°æ®ä¸­çš„ Dimensionsï¼‰ï¼›
//   - Layout: å¯é€‰çš„å¸ƒå±€è¯´æ˜ï¼ˆå¦‚ "NCHW"ã€"NHWC"ï¼Œå½“å‰é˜¶æ®µå¯ç•™ç©ºï¼‰ï¼›
//   - Values: å±•å¹³åçš„ float64 æ•°å€¼æ•°ç»„ï¼ˆç”¨äºé€šç”¨å¯è§†åŒ–ä¸ç®€å•æ¶ˆè´¹åœºæ™¯ï¼‰ï¼›
//   - RawData: åŸå§‹å­—èŠ‚åºåˆ—ï¼ˆæ ¹æ®åº•å±‚å…ƒç´ ç±»å‹ç¼–ç ï¼Œå½“å‰é˜¶æ®µä¸»è¦ç”¨äº float32/float64ï¼‰ã€‚
type TensorOutput struct {
	Name     string  // è¾“å‡ºåç§°
	DType    string  // æ•°æ®ç±»å‹å­—ç¬¦ä¸²ï¼ˆå¦‚ "float32", "float64", "int64", "float16"ï¼‰
	Shape    []int64 // å¼ é‡å½¢çŠ¶ï¼ˆæ¥è‡ªæ¨¡å‹å…ƒæ•°æ®æˆ–æ¨æ–­ï¼‰
	Layout   string  // å¸ƒå±€è¯´æ˜ï¼ˆå¯é€‰ï¼‰
	Values   []float64
	RawData  []byte
}

// InternalONNXEngine ONNXå¼•æ“å†…éƒ¨æ¥å£
//
// ğŸ¯ **ISPCå†…éƒ¨æ¥å£**ï¼š
// - ä»…ä¾›ISPCæ¨¡å—å†…éƒ¨ä½¿ç”¨
// - engines/onnx/Engineå®ç°æ­¤æ¥å£
// - coordinator.Manageré€šè¿‡æ­¤æ¥å£è°ƒç”¨ONNXå¼•æ“
//
// ğŸ“‹ **è®¾è®¡åŸåˆ™**ï¼š
// - åªæš´éœ²æ‰§è¡Œå¿…éœ€çš„å…¬å…±æ–¹æ³•
// - å†…éƒ¨å®ç°ç»†èŠ‚é€šè¿‡å°å†™æ–¹æ³•æˆ–ç§æœ‰æ¥å£å¤„ç†
type InternalONNXEngine interface {
	// CallModel æ‰§è¡ŒONNXæ¨¡å‹æ¨ç†
	//
	// å‚æ•°ï¼š
	//   - ctx: æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆåŒ…å«ExecutionContextï¼‰
	//   - modelHash: æ¨¡å‹å†…å®¹å“ˆå¸Œï¼ˆ32å­—èŠ‚ï¼‰
	//   - tensorInputs: å¼ é‡è¾“å…¥åˆ—è¡¨ï¼ˆåŒ…å«æ•°æ®å’Œå½¢çŠ¶ä¿¡æ¯ï¼‰
	//
	// è¿”å›å€¼ï¼š
	//   - []TensorOutput: æ¨ç†ç»“æœï¼ˆå¯Œå¼ é‡ç»“æ„ï¼‰
	//   - error: æ¨ç†é”™è¯¯
	CallModel(
		ctx context.Context,
		modelHash []byte,
		tensorInputs []TensorInput,
	) ([]TensorOutput, error)

	// Shutdown å…³é—­å¼•æ“ï¼Œé‡Šæ”¾èµ„æº
	//
	// ğŸ¯ **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š
	// - æ¸…ç†æ¨¡å‹ç¼“å­˜
	// - å…³é—­ä¼šè¯æ± 
	// - æ¸…ç†ONNX Runtimeç¯å¢ƒ
	// - é‡Šæ”¾æ‰€æœ‰å ç”¨çš„èµ„æº
	//
	// ğŸ”§ **è¿”å›å€¼**ï¼š
	//   - error: å…³é—­è¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰
	//
	// âš ï¸ **æ³¨æ„**ï¼šå…³é—­åå¼•æ“ä¸èƒ½å†ä½¿ç”¨
	Shutdown() error
}

