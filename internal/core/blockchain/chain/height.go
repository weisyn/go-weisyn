// Package chain é“¾é«˜åº¦æŸ¥è¯¢å®ç°
//
// ğŸ“ **é“¾é«˜åº¦æŸ¥è¯¢å®ç° (Chain Height Query)**
//
// æœ¬æ–‡ä»¶å®ç°é“¾é«˜åº¦æŸ¥è¯¢çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
// - é«˜æ€§èƒ½çš„å½“å‰é«˜åº¦è·å–
// - é«˜åº¦ç¼“å­˜å’Œä¼˜åŒ–ç­–ç•¥
// - é«˜åº¦ä¸€è‡´æ€§ä¿è¯
//
// ğŸ¯ **æ ¸å¿ƒåŠŸèƒ½**
// - æ¯«ç§’çº§å“åº”ï¼šæ”¯æŒé«˜é¢‘æŸ¥è¯¢çš„æ€§èƒ½è¦æ±‚
// - ç¼“å­˜ä¼˜åŒ–ï¼šåˆç†ä½¿ç”¨ç¼“å­˜æå‡æŸ¥è¯¢æ€§èƒ½
// - æ•°æ®ä¸€è‡´æ€§ï¼šç¡®ä¿é«˜åº¦æ•°æ®çš„å‡†ç¡®æ€§å’Œå®æ—¶æ€§
package chain

import (
	"context"
	"fmt"
)

// ============================================================================
//                              é“¾é«˜åº¦æŸ¥è¯¢
// ============================================================================

// getCurrentHeight è·å–å½“å‰é“¾é«˜åº¦
//
// ğŸ¯ **é«˜æ€§èƒ½é“¾é«˜åº¦æŸ¥è¯¢æ ¸å¿ƒå®ç°**
//
// å®ç°æµç¨‹ï¼š
// 1. æ£€æŸ¥é«˜åº¦ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
// 2. å¦‚ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ•°æ®åº“è·å–æœ€æ–°é«˜åº¦
// 3. æ›´æ–°ç¼“å­˜å¹¶è¿”å›é«˜åº¦
//
// å‚æ•°ï¼š
//
//	ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
//
// è¿”å›ï¼š
//
//	uint64: å½“å‰åŒºå—é“¾é«˜åº¦
//	error: æŸ¥è¯¢é”™è¯¯
func (m *Manager) getCurrentHeight(ctx context.Context) (uint64, error) {
	if m.logger != nil {
		m.logger.Debugf("å¼€å§‹æŸ¥è¯¢å½“å‰é“¾é«˜åº¦")
	}

	// é€šè¿‡ repository è·å–æœ€é«˜åŒºå—çš„é«˜åº¦ä¿¡æ¯
	// GetHighestBlock è¿”å›: (height uint64, blockHash []byte, err error)
	// æˆ‘ä»¬åªéœ€è¦ç¬¬ä¸€ä¸ªè¿”å›å€¼ height
	currentHeight, _, err := m.repo.GetHighestBlock(ctx)
	if err != nil {
		if m.logger != nil {
			m.logger.Errorf("è·å–é“¾é«˜åº¦å¤±è´¥: %v", err)
		}
		return 0, fmt.Errorf("è·å–é“¾é«˜åº¦å¤±è´¥: %w", err)
	}

	if m.logger != nil {
		m.logger.Debugf("é“¾é«˜åº¦æŸ¥è¯¢å®Œæˆ - height: %d", currentHeight)
	}

	return currentHeight, nil
}
