// Package chain é“¾ä¿¡æ¯æŸ¥è¯¢å®ç°
//
// ğŸ“Š **é“¾ä¿¡æ¯æŸ¥è¯¢å®ç° (Chain Information Query)**
//
// æœ¬æ–‡ä»¶å®ç°é“¾åŸºç¡€ä¿¡æ¯çš„ç»¼åˆæŸ¥è¯¢åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
// - é“¾é«˜åº¦ã€å“ˆå¸Œç­‰åŸºç¡€çŠ¶æ€èšåˆ
// - åŒæ­¥çŠ¶æ€å’Œå¥åº·åº¦è®¡ç®—
// - å®Œæ•´é“¾ä¿¡æ¯çš„æ„å»ºå’Œè¿”å›
//
// ğŸ¯ **æ ¸å¿ƒåŠŸèƒ½**
// - çŠ¶æ€èšåˆï¼šå°†åˆ†æ•£çš„é“¾çŠ¶æ€æ•°æ®èšåˆä¸ºç»Ÿä¸€è§†å›¾
// - å¥åº·è®¡ç®—ï¼šè¯„ä¼°é“¾çš„æ•´ä½“å¥åº·çŠ¶å†µ
// - ä¿¡æ¯å®Œæ•´æ€§ï¼šæä¾›å®Œæ•´å‡†ç¡®çš„é“¾çŠ¶æ€ä¿¡æ¯
package chain

import (
	"context"
	"fmt"

	"github.com/weisyn/v1/pkg/types"
)

// ============================================================================
//                              é“¾ä¿¡æ¯æŸ¥è¯¢
// ============================================================================

// getChainInfo è·å–é“¾åŸºç¡€ä¿¡æ¯
//
// ğŸ¯ **ç»¼åˆé“¾çŠ¶æ€ä¿¡æ¯æŸ¥è¯¢æ ¸å¿ƒå®ç°**
//
// å®ç°æµç¨‹ï¼š
// 1. æŸ¥è¯¢å½“å‰é“¾é«˜åº¦
// 2. è·å–æœ€ä½³åŒºå—å“ˆå¸Œ
// 3. æ£€æŸ¥åŒæ­¥çŠ¶æ€
// 4. è®¡ç®—å¥åº·åº¦æŒ‡æ ‡
// 5. æ„å»ºå®Œæ•´çš„é“¾ä¿¡æ¯å¯¹è±¡
//
// å‚æ•°ï¼š
//
//	ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
//
// è¿”å›ï¼š
//
//	*types.ChainInfo: é“¾åŸºç¡€ä¿¡æ¯
//	error: æŸ¥è¯¢é”™è¯¯
func (m *Manager) getChainInfo(ctx context.Context) (*types.ChainInfo, error) {
	if m.logger != nil {
		m.logger.Debugf("å¼€å§‹æŸ¥è¯¢é“¾åŸºç¡€ä¿¡æ¯")
	}

	// 1. é€šè¿‡ GetHighestBlock è·å–åŸºç¡€é“¾çŠ¶æ€ä¿¡æ¯
	height, bestBlockHash, err := m.repo.GetHighestBlock(ctx)
	if err != nil {
		if m.logger != nil {
			m.logger.Errorf("è·å–æœ€é«˜åŒºå—ä¿¡æ¯å¤±è´¥: %v", err)
		}
		return nil, fmt.Errorf("è·å–æœ€é«˜åŒºå—ä¿¡æ¯å¤±è´¥: %w", err)
	}

	// 2. æ„å»ºé“¾ä¿¡æ¯å¯¹è±¡ï¼Œå…ˆå¡«å……èƒ½ç¡®å®šçš„å­—æ®µ
	chainInfo := &types.ChainInfo{
		// åŸºç¡€çŠ¶æ€ - ä» GetHighestBlock è·å–
		Height:        height,        // å½“å‰åŒºå—é«˜åº¦
		BestBlockHash: bestBlockHash, // æœ€ä½³åŒºå—å“ˆå¸Œ

		// ç³»ç»ŸçŠ¶æ€ - è°ƒç”¨å…¶ä»–æ–¹æ³•è·å–
		IsReady: true,     // TODO: è°ƒç”¨ m.isReady(ctx) è·å–çœŸå®çŠ¶æ€
		Status:  "normal", // TODO: è·å–çœŸå®é“¾çŠ¶æ€

		// ç½‘ç»œä¿¡æ¯ - TODO: ä»ç½‘ç»œæ¨¡å—è·å–
		NetworkHeight: height, // æš‚æ—¶ä¸æœ¬åœ°é«˜åº¦ç›¸åŒï¼ŒTODO: ä»ç½‘ç»œè·å–çœŸå®ç½‘ç»œé«˜åº¦
		PeerCount:     0,      // TODO: ä»P2Pæ¨¡å—è·å–è¿æ¥èŠ‚ç‚¹æ•°

		// æ—¶é—´ä¿¡æ¯ - TODO: éœ€è¦ä»åŒºå—æ•°æ®è·å–
		LastBlockTime: 0, // TODO: ä»æœ€æ–°åŒºå—è·å–æ—¶é—´æˆ³
		Uptime:        0, // TODO: è®¡ç®—ç³»ç»Ÿè¿è¡Œæ—¶é—´

		// èŠ‚ç‚¹æ¨¡å¼ - TODO: ä»é…ç½®è·å–
		NodeMode: types.NodeModeFull, // TODO: è°ƒç”¨ m.getNodeMode(ctx) è·å–çœŸå®æ¨¡å¼
	}

	// 3. TODO: åç»­ç‰ˆæœ¬å¯ä»¥ç»§ç»­å®Œå–„å…¶ä»–å­—æ®µ
	// - é€šè¿‡ç½‘ç»œæ¨¡å—è·å– PeerCount å’Œ NetworkHeight
	// - é€šè¿‡åŒºå—æ•°æ®è·å– LastBlockTime
	// - é€šè¿‡ç³»ç»Ÿå¯åŠ¨æ—¶é—´è®¡ç®— Uptime
	// - é€šè¿‡é…ç½®è·å–çœŸå®çš„ NodeMode

	if m.logger != nil {
		m.logger.Debugf("é“¾åŸºç¡€ä¿¡æ¯æŸ¥è¯¢å®Œæˆ - height: %d, hash: %x", height, bestBlockHash)
	}

	return chainInfo, nil
}

// ============================================================================
//                              è¾…åŠ©å·¥å…·æ–¹æ³•
// ============================================================================

// calculateSyncStatus è®¡ç®—åŒæ­¥çŠ¶æ€
//
// ğŸ”„ **åŒæ­¥çŠ¶æ€è®¡ç®—å™¨**
//
// è®¡ç®—å½“å‰èŠ‚ç‚¹çš„åŒæ­¥çŠ¶æ€ï¼ŒåŒ…æ‹¬åŒæ­¥è¿›åº¦å’ŒçŠ¶æ€åˆ¤æ–­ã€‚
//
// å‚æ•°ï¼š
//
//	currentHeight: å½“å‰é«˜åº¦
//	networkHeight: ç½‘ç»œé«˜åº¦
//
// è¿”å›ï¼š
//
//	isSynced: æ˜¯å¦å·²åŒæ­¥
//	syncProgress: åŒæ­¥è¿›åº¦ç™¾åˆ†æ¯”
//	error: è®¡ç®—é”™è¯¯
func (m *Manager) calculateSyncStatus(currentHeight, networkHeight uint64) (bool, float64, error) {
	if m.logger != nil {
		m.logger.Debugf("è®¡ç®—åŒæ­¥çŠ¶æ€ - current: %d, network: %d", currentHeight, networkHeight)
	}

	// TODO: å®ç°åŒæ­¥çŠ¶æ€è®¡ç®—é€»è¾‘
	// 1. è®¡ç®—é«˜åº¦å·®
	// 2. è¯„ä¼°åŒæ­¥é˜ˆå€¼
	// 3. è®¡ç®—åŒæ­¥è¿›åº¦
	// 4. åˆ¤æ–­æ˜¯å¦å·²åŒæ­¥

	// ä¸´æ—¶å®ç°
	isSynced := true
	syncProgress := 100.0

	return isSynced, syncProgress, nil
}

// evaluateChainHealth è¯„ä¼°é“¾å¥åº·åº¦
//
// ğŸ¥ **é“¾å¥åº·åº¦è¯„ä¼°å™¨**
//
// è¯„ä¼°åŒºå—é“¾çš„æ•´ä½“å¥åº·çŠ¶å†µï¼ŒåŒ…æ‹¬å¤šä¸ªç»´åº¦çš„å¥åº·æŒ‡æ ‡ã€‚
//
// è¿”å›ï¼š
//
//	healthScore: å¥åº·åº¦è¯„åˆ†ï¼ˆ0-100ï¼‰
//	healthStatus: å¥åº·çŠ¶æ€æè¿°
//	error: è¯„ä¼°é”™è¯¯
func (m *Manager) evaluateChainHealth() (uint8, string, error) {
	if m.logger != nil {
		m.logger.Debugf("è¯„ä¼°é“¾å¥åº·åº¦")
	}

	// TODO: å®ç°é“¾å¥åº·åº¦è¯„ä¼°é€»è¾‘
	// 1. æ£€æŸ¥åŒºå—ç”Ÿäº§ç¨³å®šæ€§
	// 2. è¯„ä¼°ç½‘ç»œè¿é€šæ€§
	// 3. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
	// 4. ç»¼åˆè®¡ç®—å¥åº·åº¦è¯„åˆ†

	// ä¸´æ—¶å®ç°
	healthScore := uint8(95)
	healthStatus := "healthy"

	return healthScore, healthStatus, nil
}
