// Package chain æä¾›åŒºå—é“¾çŠ¶æ€ç®¡ç†çš„å®ç°
//
// ğŸ”— **é“¾çŠ¶æ€ç®¡ç†å™¨ (Chain State Manager)**
//
// æœ¬æ–‡ä»¶å®ç°äº†é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡ï¼Œä¸“æ³¨äºï¼š
// - åŸºç¡€é“¾çŠ¶æ€æŸ¥è¯¢ï¼šé«˜åº¦ã€æœ€ä½³åŒºå—å“ˆå¸Œã€é“¾ä¿¡æ¯
// - ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼šå°±ç»ªçŠ¶æ€ã€æ•°æ®æ–°é²œåº¦éªŒè¯
// - é…ç½®ä¿¡æ¯æŸ¥è¯¢ï¼šèŠ‚ç‚¹æ¨¡å¼ã€ç½‘ç»œå‚æ•°ç­‰
//
// ğŸ—ï¸ **è®¾è®¡åŸåˆ™**
// - å®ç°å†…éƒ¨æ¥å£ï¼šç»§æ‰¿å…¬å…± ChainService æ¥å£
// - ä¾èµ–æ³¨å…¥ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥æ‰€éœ€ä¾èµ–
// - é«˜æ€§èƒ½è®¾è®¡ï¼šé’ˆå¯¹é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–ï¼Œæ”¯æŒæ¯«ç§’çº§å“åº”
// - èŒè´£å•ä¸€ï¼šä¸“æ³¨é“¾çŠ¶æ€æŸ¥è¯¢ï¼Œä¸æ¶‰åŠçŠ¶æ€ä¿®æ”¹
package chain

import (
	"context"
	"fmt"

	// å…¬å…±æ¥å£
	"github.com/weisyn/v1/pkg/interfaces/blockchain"
	"github.com/weisyn/v1/pkg/interfaces/infrastructure/log"
	"github.com/weisyn/v1/pkg/interfaces/repository"
	"github.com/weisyn/v1/pkg/types"

	// å†…éƒ¨æ¥å£
	"github.com/weisyn/v1/internal/core/blockchain/interfaces"
)

// ============================================================================
//                              æœåŠ¡ç»“æ„å®šä¹‰
// ============================================================================

// Manager é“¾çŠ¶æ€ç®¡ç†å™¨
//
// ğŸ¯ **ç»Ÿä¸€é“¾çŠ¶æ€æœåŠ¡å…¥å£**
//
// è´Ÿè´£å®ç° ChainService çš„æ‰€æœ‰å…¬å…±æ¥å£æ–¹æ³•ï¼Œå¹¶å°†å…·ä½“å®ç°
// å§”æ‰˜ç»™ä¸“é—¨çš„å­æ–‡ä»¶å¤„ç†ã€‚
//
// æ¶æ„ç‰¹ç‚¹ï¼š
// - ç»Ÿä¸€å…¥å£ï¼šæ‰€æœ‰é“¾çŠ¶æ€æŸ¥è¯¢çš„ç»Ÿä¸€è®¿é—®ç‚¹
// - ä¾èµ–æ³¨å…¥ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥å¿…éœ€çš„æœåŠ¡ä¾èµ–
// - å§”æ‰˜å®ç°ï¼šå°†å…·ä½“ä¸šåŠ¡é€»è¾‘å§”æ‰˜ç»™ä¸“é—¨çš„å­æ–‡ä»¶
type Manager struct {
	// æ ¸å¿ƒä¾èµ–
	logger log.Logger                   // æ—¥å¿—æœåŠ¡
	repo   repository.RepositoryManager // æ•°æ®ä»“åº“ç®¡ç†å™¨

	// å†…éƒ¨æœåŠ¡ä¾èµ– - ç”¨äºåˆ›ä¸–åŒºå—å¤„ç†
	blockService       interfaces.InternalBlockService       // å†…éƒ¨åŒºå—æœåŠ¡
	transactionService interfaces.InternalTransactionService // å†…éƒ¨äº¤æ˜“æœåŠ¡
}

// ============================================================================
//                              æ„é€ å‡½æ•°
// ============================================================================

// NewManager åˆ›å»ºé“¾çŠ¶æ€ç®¡ç†å™¨å®ä¾‹
//
// ğŸ—ï¸ **æ„é€ å™¨æ¨¡å¼**
//
// å‚æ•°ï¼š
//
//	logger: æ—¥å¿—æœåŠ¡
//	repo: æ•°æ®ä»“åº“ç®¡ç†å™¨
//
// è¿”å›ï¼š
//
//	interfaces.InternalChainService: å†…éƒ¨é“¾æœåŠ¡æ¥å£å®ä¾‹
//	error: åˆ›å»ºé”™è¯¯
//
// âœ… ç›´æ¥ä¾èµ–æ³¨å…¥ï¼šæ— å¾ªç¯ä¾èµ–é—®é¢˜
func NewManager(
	logger log.Logger,
	repo repository.RepositoryManager,
	blockService interfaces.InternalBlockService,
	transactionService interfaces.InternalTransactionService,
) (interfaces.InternalChainService, error) {
	if logger == nil {
		return nil, fmt.Errorf("logger ä¸èƒ½ä¸ºç©º")
	}
	if repo == nil {
		return nil, fmt.Errorf("repository manager ä¸èƒ½ä¸ºç©º")
	}
	if blockService == nil {
		return nil, fmt.Errorf("block service ä¸èƒ½ä¸ºç©º")
	}
	if transactionService == nil {
		return nil, fmt.Errorf("transaction service ä¸èƒ½ä¸ºç©º")
	}

	manager := &Manager{
		logger:             logger,
		repo:               repo,
		blockService:       blockService,       // âœ… ç›´æ¥æ³¨å…¥
		transactionService: transactionService, // âœ… ç›´æ¥æ³¨å…¥
	}

	logger.Infof("âœ… é“¾çŠ¶æ€ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")

	return manager, nil
}

// âœ… SetServicesæ–¹æ³•å·²ç§»é™¤ï¼šç°åœ¨ä½¿ç”¨æ„é€ å‡½æ•°ç›´æ¥æ³¨å…¥ï¼Œæ— å¾ªç¯ä¾èµ–

// ============================================================================
//                              åŸºç¡€é“¾çŠ¶æ€æŸ¥è¯¢
// ============================================================================

// GetChainInfo è·å–é“¾åŸºç¡€ä¿¡æ¯
//
// ğŸ“ **å®ç°æ–‡ä»¶**: info.go
//
// ğŸ¯ **ç»¼åˆé“¾çŠ¶æ€ä¿¡æ¯æŸ¥è¯¢**
//
// è·å–é“¾çš„æ ¸å¿ƒçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰é«˜åº¦ã€æœ€ä½³åŒºå—å“ˆå¸Œã€
// åŒæ­¥çŠ¶æ€ç­‰ç»¼åˆä¿¡æ¯ã€‚
//
// å®ç°è¦ç‚¹ï¼š
// - èšåˆå¤šç§é“¾çŠ¶æ€æ•°æ®
// - è®¡ç®—åŒæ­¥çŠ¶æ€å’Œå¥åº·åº¦
// - æä¾›å®Œæ•´çš„é“¾çŠ¶æ€è§†å›¾
func (m *Manager) GetChainInfo(ctx context.Context) (*types.ChainInfo, error) {
	if m.logger != nil {
		m.logger.Debugf("æŸ¥è¯¢é“¾åŸºç¡€ä¿¡æ¯")
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (info.go)
	return m.getChainInfo(ctx)
}

// GetCurrentHeight è·å–å½“å‰é“¾é«˜åº¦
//
// ğŸ“ **å®ç°æ–‡ä»¶**: height.go
//
// ğŸ¯ **é«˜æ€§èƒ½é“¾é«˜åº¦æŸ¥è¯¢**
//
// è·å–åŒºå—é“¾å½“å‰çš„æœ€æ–°é«˜åº¦ï¼Œè¿™æ˜¯é“¾çŠ¶æ€çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚
// é«˜é¢‘è°ƒç”¨æ–¹æ³•ï¼Œè¦æ±‚é«˜æ€§èƒ½å®ç°ã€‚
//
// å®ç°è¦ç‚¹ï¼š
// - æ¯«ç§’çº§å“åº”æ—¶é—´
// - æ”¯æŒç¼“å­˜ä¼˜åŒ–
// - æ•°æ®ä¸€è‡´æ€§ä¿è¯
func (m *Manager) GetCurrentHeight(ctx context.Context) (uint64, error) {
	if m.logger != nil {
		m.logger.Debugf("æŸ¥è¯¢å½“å‰é“¾é«˜åº¦")
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (height.go)
	return m.getCurrentHeight(ctx)
}

// GetBestBlockHash è·å–æœ€ä½³åŒºå—å“ˆå¸Œ
//
// ğŸ“ **å®ç°æ–‡ä»¶**: hash.go
//
// ğŸ¯ **æœ€ä½³åŒºå—å“ˆå¸ŒæŸ¥è¯¢**
//
// è·å–å½“å‰æœ€é•¿é“¾çš„é¡¶ç«¯åŒºå—å“ˆå¸Œï¼Œç”¨äºç¡®å®šé“¾çš„å½“å‰çŠ¶æ€ã€‚
// ä¸GetCurrentHeight()è¿”å›çš„é«˜åº¦å¯¹åº”ã€‚
//
// å®ç°è¦ç‚¹ï¼š
// - ç¡®ä¿ä¸å½“å‰é«˜åº¦ä¸€è‡´æ€§
// - æ”¯æŒåˆ†å‰æ£€æµ‹
// - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
func (m *Manager) GetBestBlockHash(ctx context.Context) ([]byte, error) {
	if m.logger != nil {
		m.logger.Debugf("æŸ¥è¯¢æœ€ä½³åŒºå—å“ˆå¸Œ")
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (hash.go)
	return m.getBestBlockHash(ctx)
}

// ============================================================================
//                              ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
// ============================================================================

// IsReady æ£€æŸ¥ç³»ç»Ÿå°±ç»ªçŠ¶æ€
//
// ğŸ“ **å®ç°æ–‡ä»¶**: status.go
//
// ğŸ¯ **ç³»ç»Ÿå°±ç»ªçŠ¶æ€æ£€æŸ¥**
//
// æ£€æŸ¥åŒºå—é“¾ç³»ç»Ÿæ˜¯å¦å®Œå…¨å°±ç»ªï¼Œåˆ¤æ–­æ ‡å‡†åŒ…æ‹¬ï¼š
// - æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å·²å¯åŠ¨å¹¶æ­£å¸¸è¿è¡Œ
// - æ•°æ®åº“è¿æ¥æ­£å¸¸ä¸”æ•°æ®å®Œæ•´
// - åŒæ­¥çŠ¶æ€æ­£å¸¸ï¼Œæ•°æ®æ˜¯æœ€æ–°çš„
//
// å®ç°è¦ç‚¹ï¼š
// - å¤šç»„ä»¶çŠ¶æ€èšåˆæ£€æŸ¥
// - æä¾›æ˜ç¡®çš„å°±ç»ªåˆ¤æ–­
// - æ”¯æŒå¥åº·æ£€æŸ¥é›†æˆ
func (m *Manager) IsReady(ctx context.Context) (bool, error) {
	if m.logger != nil {
		m.logger.Debugf("æ£€æŸ¥ç³»ç»Ÿå°±ç»ªçŠ¶æ€")
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (status.go)
	return m.isReady(ctx)
}

// IsDataFresh æ£€æŸ¥æ•°æ®æ–°é²œåº¦
//
// ğŸ“ **å®ç°æ–‡ä»¶**: status.go
//
// ğŸ¯ **æ•°æ®æ–°é²œåº¦éªŒè¯**
//
// å¿«é€Ÿæ£€æŸ¥æœ¬åœ°æ•°æ®æ˜¯å¦ä¸ç½‘ç»œä¿æŒåŒæ­¥ï¼Œé€‚ç”¨äºï¼š
// - APIæŸ¥è¯¢å‰éªŒè¯æ•°æ®çš„æ—¶æ•ˆæ€§
// - äº¤æ˜“æäº¤å‰ç¡®è®¤é“¾çŠ¶æ€æœ€æ–°
// - ç”¨æˆ·æ“ä½œå‰çš„æ•°æ®æ–°é²œåº¦æ£€æŸ¥
//
// å®ç°è¦ç‚¹ï¼š
// - å¿«é€ŸåŒæ­¥çŠ¶æ€åˆ¤æ–­
// - ç½‘ç»œå¯¹æ¯”éªŒè¯
// - æ—¶æ•ˆæ€§é˜ˆå€¼æ§åˆ¶
func (m *Manager) IsDataFresh(ctx context.Context) (bool, error) {
	if m.logger != nil {
		m.logger.Debugf("æ£€æŸ¥æ•°æ®æ–°é²œåº¦")
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (status.go)
	return m.isDataFresh(ctx)
}

// ============================================================================
//                              é…ç½®æŸ¥è¯¢
// ============================================================================

// GetNodeMode è·å–å½“å‰èŠ‚ç‚¹æ¨¡å¼
//
// ğŸ“ **å®ç°æ–‡ä»¶**: config.go
//
// ğŸ¯ **èŠ‚ç‚¹è¿è¡Œæ¨¡å¼æŸ¥è¯¢**
//
// è·å–èŠ‚ç‚¹çš„è¿è¡Œæ¨¡å¼ï¼ŒèŠ‚ç‚¹æ¨¡å¼åœ¨å¯åŠ¨æ—¶ç¡®å®šä¸”è¿è¡ŒæœŸé—´ä¸å˜ï¼š
// - Light: è½»èŠ‚ç‚¹æ¨¡å¼ï¼Œä»…åŒæ­¥åŒºå—å¤´
// - Full: å…¨èŠ‚ç‚¹æ¨¡å¼ï¼ŒåŒæ­¥å®Œæ•´åŒºå—æ•°æ®
//
// å®ç°è¦ç‚¹ï¼š
// - è¯»å–èŠ‚ç‚¹é…ç½®ä¿¡æ¯
// - ç¼“å­˜æ¨¡å¼ä¿¡æ¯é¿å…é‡å¤æŸ¥è¯¢
// - æä¾›æ¨¡å¼ç›¸å…³çš„ç‰¹æ€§ä¿¡æ¯
func (m *Manager) GetNodeMode(ctx context.Context) (types.NodeMode, error) {
	if m.logger != nil {
		m.logger.Debugf("æŸ¥è¯¢èŠ‚ç‚¹æ¨¡å¼")
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (config.go)
	return m.getNodeMode(ctx)
}

// ============================================================================
//                              å†…éƒ¨çŠ¶æ€ç®¡ç†æ–¹æ³•
// ============================================================================

// SetChainStatus è®¾ç½®é“¾çŠ¶æ€
//
// ğŸ¯ **å†…éƒ¨çŠ¶æ€æ§åˆ¶æ–¹æ³•**
//
// ç”¨äºç³»ç»Ÿå†…éƒ¨ç»„ä»¶ï¼ˆå¦‚forkã€syncï¼‰ä¿®æ”¹é“¾çš„è¿è¡ŒçŠ¶æ€ã€‚
// è¿™æ˜¯InternalChainServiceæ¥å£çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”¨äºåè°ƒç³»ç»ŸçŠ¶æ€ã€‚
//
// å‚æ•°ï¼š
//   - ctx: æ“ä½œä¸Šä¸‹æ–‡
//   - status: æ–°çš„çŠ¶æ€å€¼ï¼ˆ"normal", "fork_processing", "syncing", "error", "maintenance"ï¼‰
//   - isReady: ç³»ç»Ÿæ˜¯å¦å°±ç»ªå¯ç”¨
//
// è¿”å›ï¼š
//   - error: çŠ¶æ€è®¾ç½®å¤±è´¥çš„é”™è¯¯
func (m *Manager) SetChainStatus(ctx context.Context, status string, isReady bool) error {
	if m.logger != nil {
		m.logger.Infof("[ChainManager] è®¾ç½®é“¾çŠ¶æ€: status=%s, isReady=%v", status, isReady)
	}

	// è°ƒç”¨å…·ä½“å®ç°æ–¹æ³• (status.go)
	return m.setChainStatus(ctx, status, isReady)
}

// ============================================================================
//                              ç¼–è¯‘æ—¶æ¥å£æ£€æŸ¥
// ============================================================================

// ç¡®ä¿ Manager å®ç°äº† ChainService æ¥å£
var _ blockchain.ChainService = (*Manager)(nil)

// ç¡®ä¿ Manager å®ç°äº†å†…éƒ¨é“¾æœåŠ¡æ¥å£
var _ interfaces.InternalChainService = (*Manager)(nil)
