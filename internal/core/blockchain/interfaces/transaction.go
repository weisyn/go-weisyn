// Package interfaces å®šä¹‰åŒºå—é“¾å†…éƒ¨æ¥å£
package interfaces

import (
	"context"

	networkintegration "github.com/weisyn/v1/internal/core/blockchain/integration/network"
	transaction "github.com/weisyn/v1/pb/blockchain/block/transaction"
	blockchain "github.com/weisyn/v1/pkg/interfaces/blockchain"
)

// ============================================================================
//                           ç½‘ç»œåè®®å¤„ç†æ¥å£
// ============================================================================

// NetworkProtocolHandler äº¤æ˜“ç½‘ç»œåè®®å¤„ç†å™¨
//
// ğŸ¯ **èŒè´£**ï¼šå¤„ç†äº¤æ˜“ç›¸å…³çš„ç½‘ç»œåè®®æ¶ˆæ¯
//
// æ ¸å¿ƒåŠŸèƒ½ï¼š
// - ç»§æ‰¿TxProtocolRouteræ¥å£ï¼ˆæµå¼åè®®å¤„ç†ï¼‰
// - ç»§æ‰¿TxAnnounceRouteræ¥å£ï¼ˆè®¢é˜…åè®®å¤„ç†ï¼‰
// - æä¾›transactionç‰¹æœ‰çš„ç½‘ç»œæ–¹æ³•
//
// ä»…åœ¨ transaction å†…éƒ¨å­ç»„ä»¶é—´ä½¿ç”¨
type NetworkProtocolHandler interface {
	// ç»§æ‰¿åŸºç¡€ç½‘ç»œæ¥å£ï¼Œé¿å…é‡å¤å®šä¹‰æ–¹æ³•
	networkintegration.TxProtocolRouter // æµå¼åè®®å¤„ç†
	networkintegration.TxAnnounceRouter // è®¢é˜…åè®®å¤„ç†
}

// ============================================================================
//                           å†…éƒ¨äº¤æ˜“æœåŠ¡æ¥å£
// ============================================================================

// InternalTransactionService å†…éƒ¨äº¤æ˜“æœåŠ¡æ¥å£
//
// ğŸ¯ è®¾è®¡ç†å¿µ: ç»§æ‰¿å…¬å…±TransactionServiceæ¥å£ï¼Œå¹¶æä¾›æŒ–çŸ¿æ¨¡æ¿æœåŠ¡
// ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½: æä¾›å®Œæ•´çš„æŒ–çŸ¿äº¤æ˜“æ¨¡æ¿ï¼Œç®€åŒ–blockchainå±‚è°ƒç”¨
// ğŸ”® æ‰©å±•èƒ½åŠ›: æ”¯æŒä¸€ç«™å¼æŒ–çŸ¿æ¨¡æ¿ç”Ÿæˆï¼Œå†…éƒ¨å¤„ç†æ‰€æœ‰äº¤æ˜“ç›¸å…³é€»è¾‘
type InternalTransactionService interface {
	blockchain.TransactionService // ç»§æ‰¿æ‰€æœ‰å…¬å…±äº¤æ˜“æœåŠ¡æ–¹æ³•
	blockchain.ContractService    // ç»§æ‰¿æ™ºèƒ½åˆçº¦æœåŠ¡æ–¹æ³•
	blockchain.AIModelService     // ç»§æ‰¿AIæ¨¡å‹æœåŠ¡æ–¹æ³•
	blockchain.TransactionManager // ç»§æ‰¿äº¤æ˜“ç®¡ç†æ–¹æ³•
	NetworkProtocolHandler        // ç½‘ç»œåè®®å¤„ç†èƒ½åŠ›

	// ==================== æŒ–çŸ¿æ¨¡æ¿æœåŠ¡ ====================

	// ValidateTransactionsInBlock æ‰¹é‡éªŒè¯åŒºå—ä¸­çš„äº¤æ˜“
	//
	// ğŸ¯ **åŒºå—äº¤æ˜“éªŒè¯æœåŠ¡**
	//
	// å¯¹åŒºå—ä¸­çš„æ‰€æœ‰äº¤æ˜“è¿›è¡Œæ‰¹é‡éªŒè¯ï¼Œç¡®ä¿ï¼š
	// 1. æ¯ä¸ªäº¤æ˜“çš„æ•°æ®ç»“æ„å®Œæ•´æ€§
	// 2. äº¤æ˜“ç­¾åçš„æœ‰æ•ˆæ€§
	// 3. UTXOå¼•ç”¨çš„æ­£ç¡®æ€§
	// 4. äº¤æ˜“è´¹ç”¨è®¡ç®—çš„å‡†ç¡®æ€§
	//
	// å‚æ•°:
	//   ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   transactions: éœ€è¦éªŒè¯çš„äº¤æ˜“åˆ—è¡¨
	//
	// è¿”å›å€¼:
	//   bool: æ˜¯å¦æ‰€æœ‰äº¤æ˜“éƒ½æœ‰æ•ˆ
	//   error: éªŒè¯è¿‡ç¨‹ä¸­çš„é”™è¯¯
	ValidateTransactionsInBlock(ctx context.Context, transactions []*transaction.Transaction) (bool, error)

	// GetMiningTemplate è·å–å®Œæ•´çš„æŒ–çŸ¿æ¨¡æ¿
	//
	// ğŸ¯ **ä¸€ç«™å¼æŒ–çŸ¿æ¨¡æ¿æœåŠ¡**
	//
	// å†…éƒ¨å®Œæˆä»¥ä¸‹å®Œæ•´å¤„ç†æµç¨‹ï¼š
	// 1. ä»å†…å­˜æ± è·å–ä¼˜è´¨äº¤æ˜“ï¼ˆåŸºäºé…ç½®çš„æ•°é‡å’Œå¤§å°é™åˆ¶ï¼‰
	// 2. è·å–çŸ¿å·¥åœ°å€ï¼ˆé€šè¿‡å…±è¯†æœåŠ¡ï¼‰
	// 3. è·å–å½“å‰åŒºå—é«˜åº¦ï¼ˆé€šè¿‡åŒºå—é“¾çŠ¶æ€ï¼‰
	// 4. è®¡ç®—æ‰€æœ‰äº¤æ˜“çš„æ‰‹ç»­è´¹èšåˆï¼ˆæŒ‰ä»£å¸ç±»å‹åˆ†ç»„ï¼‰
	// 5. è®¡ç®—åŒºå—å¥–åŠ±ï¼ˆåŸºäºåŒºå—é«˜åº¦å’Œå¥–åŠ±ç­–ç•¥ï¼‰
	// 6. ç”ŸæˆåŒ…å«æ‰€æœ‰å¥–åŠ±çš„Coinbaseäº¤æ˜“
	// 7. ç»„åˆå®Œæ•´çš„äº¤æ˜“åˆ—è¡¨ï¼ˆCoinbaseåœ¨é¦–ä½ï¼‰
	//
	// ğŸ¯ **èŒè´£é›†ä¸­è®¾è®¡**ï¼š
	// - transactionæœåŠ¡ï¼šè´Ÿè´£æ‰€æœ‰äº¤æ˜“ç›¸å…³é€»è¾‘ï¼ˆè·å–ã€è®¡ç®—ã€ç»„åˆï¼‰
	// - blockchainæœåŠ¡ï¼šä¸“æ³¨äºåŒºå—æ„é€ ï¼ˆMerkleæ ¹ã€åŒºå—å¤´ã€å“ˆå¸Œè®¡ç®—ï¼‰
	//
	// ğŸ¯ **ä¼˜åŠ¿**ï¼š
	// - ç®€åŒ–è°ƒç”¨ï¼šblockchainå±‚åªéœ€ä¸€æ¬¡è°ƒç”¨
	// - èŒè´£æ¸…æ™°ï¼šäº¤æ˜“ç›¸å…³é€»è¾‘å®Œå…¨å†…èš
	// - æ˜“äºæµ‹è¯•ï¼šå¯ç‹¬ç«‹æµ‹è¯•äº¤æ˜“æ¨¡æ¿ç”Ÿæˆé€»è¾‘
	// - å¯ç»´æŠ¤æ€§ï¼šäº¤æ˜“é€»è¾‘å˜æ›´ä¸å½±å“blockchainå±‚
	//
	// å‚æ•°:
	//   ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//
	// è¿”å›å€¼:
	//   []*transaction.Transaction: å®Œæ•´çš„äº¤æ˜“åˆ—è¡¨ï¼ˆé¦–ä¸ªä¸ºCoinbaseäº¤æ˜“ï¼‰
	//   error: ç”Ÿæˆè¿‡ç¨‹ä¸­çš„é”™è¯¯
	//
	// ä½¿ç”¨ç¤ºä¾‹:
	//   allTransactions, err := transactionService.GetMiningTemplate(ctx)
	//   if err != nil { return nil, fmt.Errorf("è·å–æŒ–çŸ¿æ¨¡æ¿å¤±è´¥: %w", err) }
	//   // ç›´æ¥ä½¿ç”¨ allTransactions æ„å»ºåŒºå—
	GetMiningTemplate(ctx context.Context) ([]*transaction.Transaction, error)

	// ==================== åˆ›ä¸–åŒºå—äº¤æ˜“æœåŠ¡ ====================

	// CreateGenesisTransactions åˆ›å»ºåˆ›ä¸–åŒºå—äº¤æ˜“
	//
	// ğŸ¯ **åˆ›ä¸–äº¤æ˜“ç”ŸæˆæœåŠ¡**
	//
	// åŸºäºåˆ›ä¸–é…ç½®ç”Ÿæˆæ‰€æœ‰åˆ›ä¸–äº¤æ˜“ï¼ŒåŒ…æ‹¬ï¼š
	// 1. åˆå§‹è´¦æˆ·åˆ†é…äº¤æ˜“ï¼šä¸ºé¢„è®¾è´¦æˆ·åˆ†é…åˆå§‹ä»£å¸
	// 2. ç³»ç»Ÿåˆçº¦éƒ¨ç½²äº¤æ˜“ï¼šéƒ¨ç½²æ ¸å¿ƒç³»ç»Ÿåˆçº¦ï¼ˆå¯é€‰ï¼‰
	// 3. ç½‘ç»œå‚æ•°è®¾ç½®äº¤æ˜“ï¼šè®¾ç½®ç½‘ç»œåˆå§‹å‚æ•°ï¼ˆå¯é€‰ï¼‰
	//
	// è®¾è®¡ç‰¹ç‚¹ï¼š
	// - é…ç½®é©±åŠ¨ï¼šå®Œå…¨åŸºäºGenesisConfigç”Ÿæˆ
	// - ç¡®å®šæ€§ï¼šç›¸åŒé…ç½®äº§ç”Ÿç›¸åŒçš„äº¤æ˜“åˆ—è¡¨
	// - éªŒè¯æ€§ï¼šç”Ÿæˆçš„äº¤æ˜“å¿…é¡»èƒ½é€šè¿‡æ ‡å‡†éªŒè¯
	// - åŸå­æ€§ï¼šè¦ä¹ˆå…¨éƒ¨ç”ŸæˆæˆåŠŸè¦ä¹ˆå…¨éƒ¨å¤±è´¥
	//
	// å‚æ•°:
	//   ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   genesisConfig: åˆ›ä¸–åŒºå—é…ç½®ï¼ˆæ¥è‡ªé…ç½®æ–‡ä»¶ï¼‰
	//
	// è¿”å›å€¼:
	//   []*transaction.Transaction: åˆ›ä¸–äº¤æ˜“åˆ—è¡¨
	//   error: åˆ›å»ºè¿‡ç¨‹ä¸­çš„é”™è¯¯
	//
	// ä½¿ç”¨ç¤ºä¾‹:
	//   genesisTransactions, err := transactionService.CreateGenesisTransactions(ctx, genesisConfig)
	//   if err != nil { return fmt.Errorf("åˆ›å»ºåˆ›ä¸–äº¤æ˜“å¤±è´¥: %w", err) }
	//   // ä½¿ç”¨åˆ›ä¸–äº¤æ˜“æ„å»ºåˆ›ä¸–åŒºå—
	CreateGenesisTransactions(ctx context.Context, genesisConfig interface{}) ([]*transaction.Transaction, error)

	// ValidateGenesisTransactions éªŒè¯åˆ›ä¸–äº¤æ˜“æœ‰æ•ˆæ€§
	//
	// ğŸ¯ **åˆ›ä¸–äº¤æ˜“éªŒè¯æœåŠ¡**
	//
	// å¯¹åˆ›ä¸–äº¤æ˜“è¿›è¡Œä¸“é—¨éªŒè¯ï¼ŒåŒ…æ‹¬ï¼š
	// 1. äº¤æ˜“æ ¼å¼çš„æ­£ç¡®æ€§ï¼šç»“æ„å®Œæ•´æ€§ã€å­—æ®µæœ‰æ•ˆæ€§
	// 2. åˆå§‹ä½™é¢åˆ†é…çš„åˆç†æ€§ï¼šæ€»é‡å¹³è¡¡ã€è´¦æˆ·æœ‰æ•ˆæ€§
	// 3. ç³»ç»Ÿåˆçº¦çš„å®Œæ•´æ€§ï¼šåˆçº¦ä»£ç ã€åˆå§‹åŒ–å‚æ•°
	// 4. åˆ›ä¸–äº¤æ˜“çš„ç‰¹æ®Šè§„åˆ™ï¼šæ— è¾“å…¥ã€ç‰¹æ®Šç­¾åç­‰
	//
	// éªŒè¯ç‰¹ç‚¹ï¼š
	// - åˆ›ä¸–äº¤æ˜“éªŒè¯è§„åˆ™ä¸æ™®é€šäº¤æ˜“ç•¥æœ‰ä¸åŒ
	// - å…è®¸æ— è¾“å…¥äº¤æ˜“ï¼ˆåˆå§‹åˆ†é…ï¼‰
	// - å…è®¸ç‰¹æ®Šçš„ç³»ç»Ÿçº§æ“ä½œ
	//
	// å‚æ•°:
	//   ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   transactions: åˆ›ä¸–äº¤æ˜“åˆ—è¡¨
	//
	// è¿”å›å€¼:
	//   bool: éªŒè¯ç»“æœï¼Œtrueè¡¨ç¤ºæ‰€æœ‰äº¤æ˜“æœ‰æ•ˆ
	//   error: éªŒè¯è¿‡ç¨‹ä¸­çš„é”™è¯¯
	//
	// ä½¿ç”¨ç¤ºä¾‹:
	//   valid, err := transactionService.ValidateGenesisTransactions(ctx, genesisTransactions)
	//   if err != nil { return fmt.Errorf("åˆ›ä¸–äº¤æ˜“éªŒè¯å¤±è´¥: %w", err) }
	//   if !valid { return fmt.Errorf("åˆ›ä¸–äº¤æ˜“éªŒè¯ä¸é€šè¿‡") }
	ValidateGenesisTransactions(ctx context.Context, transactions []*transaction.Transaction) (bool, error)
}
