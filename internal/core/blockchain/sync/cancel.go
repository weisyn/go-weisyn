// Package sync å®ç°åŒæ­¥å–æ¶ˆåŠŸèƒ½
//
// ğŸ¯ **åŒæ­¥å–æ¶ˆå®ç°**
//
// æœ¬æ–‡ä»¶å®ç° CancelSync æ–¹æ³•çš„å…·ä½“é€»è¾‘ï¼Œæä¾›åŒæ­¥æ“ä½œå–æ¶ˆåŠŸèƒ½ï¼š
// - æ£€æŸ¥å½“å‰åŒæ­¥çŠ¶æ€
// - å‘é€å–æ¶ˆä¿¡å·ç»™æ´»è·ƒçš„åŒæ­¥ä»»åŠ¡
// - æ¸…ç†åŒæ­¥ç›¸å…³çš„ä¸´æ—¶èµ„æº
// - é‡ç½®åŒæ­¥çŠ¶æ€ä¸ºç©ºé—²
package sync

import (
	"context"
	"fmt"
	"time"

	"github.com/weisyn/v1/pkg/interfaces/infrastructure/log"
)

// ============================================================================
//                           åŒæ­¥å–æ¶ˆå®ç°
// ============================================================================

// cancelSyncImpl å–æ¶ˆå½“å‰åŒæ­¥æ“ä½œçš„å…·ä½“å®ç°
//
// ğŸ¯ **åŒæ­¥å–æ¶ˆç­–ç•¥**ï¼š
// 1. æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æ´»è·ƒçš„åŒæ­¥ä»»åŠ¡
// 2. å‘é€å–æ¶ˆä¿¡å·ç»™æ­£åœ¨è¿è¡Œçš„åŒæ­¥æ“ä½œ
// 3. æ¸…ç†åŒæ­¥è¿‡ç¨‹ä¸­çš„ä¸´æ—¶èµ„æºå’ŒçŠ¶æ€
// 4. å°†åŒæ­¥çŠ¶æ€é‡ç½®ä¸ºç©ºé—²çŠ¶æ€
//
// å‚æ•°ï¼š
//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆå¯èƒ½å·²ç»è¢«å–æ¶ˆï¼‰
//   - logger: æ—¥å¿—è®°å½•å™¨
//
// è¿”å›ï¼š
//   - error: å–æ¶ˆæ“ä½œé”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
//
// æ³¨æ„ï¼š
//   - å½“å‰å®ç°ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºåŒæ­¥æ“ä½œè¿˜æ²¡æœ‰é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
//   - æœªæ¥å¦‚æœæœ‰åå°åŒæ­¥ä»»åŠ¡ï¼Œéœ€è¦æ‰©å±•å–æ¶ˆæœºåˆ¶
func cancelSyncImpl(
	ctx context.Context,
	logger log.Logger,
) error {
	if logger != nil {
		logger.Info("ğŸ›‘ å¼€å§‹æ‰§è¡ŒåŒæ­¥å–æ¶ˆæ“ä½œ")
	}

	// é˜¶æ®µ1: æ£€æŸ¥å½“å‰åŒæ­¥çŠ¶æ€
	activeSyncExists := checkActiveSyncTasks(logger)
	if !activeSyncExists {
		if logger != nil {
			logger.Info("ğŸ“‹ å½“å‰æ²¡æœ‰æ´»è·ƒçš„åŒæ­¥ä»»åŠ¡ï¼Œæ— éœ€å–æ¶ˆ")
		}
		return nil
	}

	// é˜¶æ®µ2: å‘é€å–æ¶ˆä¿¡å·
	if err := sendCancelSignal(ctx, logger); err != nil {
		return fmt.Errorf("å‘é€å–æ¶ˆä¿¡å·å¤±è´¥: %w", err)
	}

	// é˜¶æ®µ3: æ¸…ç†ä¸´æ—¶èµ„æº
	if err := cleanupSyncResources(logger); err != nil {
		if logger != nil {
			logger.Warnf("æ¸…ç†åŒæ­¥èµ„æºæ—¶å‡ºç°è­¦å‘Š: %v", err)
		}
		// æ¸…ç†å¤±è´¥ä¸é˜»æ­¢å–æ¶ˆæ“ä½œå®Œæˆ
	}

	// é˜¶æ®µ4: é‡ç½®åŒæ­¥çŠ¶æ€
	resetSyncState(logger)

	if logger != nil {
		logger.Info("âœ… åŒæ­¥å–æ¶ˆæ“ä½œå®Œæˆ")
	}
	return nil
}

// ============================================================================
//                           å–æ¶ˆæœºåˆ¶å®ç°
// ============================================================================

// checkActiveSyncTasks æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ´»è·ƒçš„åŒæ­¥ä»»åŠ¡
//
// ğŸ¯ **çŠ¶æ€æ£€æŸ¥é€»è¾‘**ï¼š
// - æ£€æŸ¥å…¨å±€ activeSyncTask æ˜¯å¦å­˜åœ¨
// - ç¡®ä¿å–æ¶ˆæ“ä½œèƒ½å¤Ÿæ­£ç¡®è¯†åˆ«è¿›è¡Œä¸­çš„åŒæ­¥ä»»åŠ¡
func checkActiveSyncTasks(logger log.Logger) bool {
	activeSyncMutex.RLock()
	defer activeSyncMutex.RUnlock()

	hasActiveTask := (activeSyncTask != nil)

	if logger != nil {
		if hasActiveTask {
			logger.Infof("å‘ç°æ´»è·ƒåŒæ­¥ä»»åŠ¡: RequestID=%s, è¿è¡Œæ—¶é•¿=%s, ç›®æ ‡é«˜åº¦=%d",
				activeSyncTask.RequestID,
				time.Since(activeSyncTask.StartTime),
				activeSyncTask.TargetHeight)
		} else {
			logger.Debug("å½“å‰æ²¡æœ‰æ´»è·ƒçš„åŒæ­¥ä»»åŠ¡")
		}
	}

	return hasActiveTask
}

// sendCancelSignal å‘æ´»è·ƒçš„åŒæ­¥ä»»åŠ¡å‘é€å–æ¶ˆä¿¡å·
//
// ğŸ¯ **å–æ¶ˆä¿¡å·ç­–ç•¥**ï¼š
// - è°ƒç”¨ activeSyncTask.CancelFunc å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„åŒæ­¥
// - é€šçŸ¥æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ç½‘ç»œè¯·æ±‚å’ŒåŒºå—å¤„ç†æ“ä½œ
// - ç¡®ä¿å–æ¶ˆä¿¡å·èƒ½å¤Ÿåœ¨1ç§’å†…ç”Ÿæ•ˆ
func sendCancelSignal(ctx context.Context, logger log.Logger) error {
	activeSyncMutex.RLock()
	currentTask := activeSyncTask
	activeSyncMutex.RUnlock()

	if currentTask == nil {
		if logger != nil {
			logger.Debug("æ²¡æœ‰æ´»è·ƒä»»åŠ¡éœ€è¦å–æ¶ˆ")
		}
		return nil
	}

	if currentTask.CancelFunc == nil {
		if logger != nil {
			logger.Warn("æ´»è·ƒä»»åŠ¡ç¼ºå°‘å–æ¶ˆå‡½æ•°ï¼Œæ— æ³•å‘é€å–æ¶ˆä¿¡å·")
		}
		return fmt.Errorf("æ´»è·ƒä»»åŠ¡ç¼ºå°‘å–æ¶ˆå‡½æ•°")
	}

	if logger != nil {
		logger.Infof("ğŸ›‘ å‘é€å–æ¶ˆä¿¡å·åˆ°åŒæ­¥ä»»åŠ¡: RequestID=%s", currentTask.RequestID)
	}

	// è°ƒç”¨å–æ¶ˆå‡½æ•°ï¼Œè¿™ä¼šå–æ¶ˆ syncCtx å¹¶ä¼ æ’­åˆ°æ‰€æœ‰å­æ“ä½œ
	currentTask.CancelFunc()

	if logger != nil {
		logger.Info("âœ… å–æ¶ˆä¿¡å·å·²å‘é€ï¼Œç­‰å¾…ä»»åŠ¡å“åº”...")
	}

	return nil
}

// cleanupSyncResources æ¸…ç†åŒæ­¥è¿‡ç¨‹ä¸­çš„ä¸´æ—¶èµ„æº
//
// ğŸ¯ **èµ„æºæ¸…ç†ç­–ç•¥**ï¼š
// - é‡Šæ”¾åŒæ­¥è¿‡ç¨‹ä¸­åˆ†é…çš„å†…å­˜èµ„æº
// - å…³é—­æœªå®Œæˆçš„ç½‘ç»œè¿æ¥
// - æ¸…ç†ä¸´æ—¶ç¼“å­˜å’Œä¸­é—´çŠ¶æ€
func cleanupSyncResources(logger log.Logger) error {
	if logger != nil {
		logger.Debug("æ¸…ç†åŒæ­¥ä¸´æ—¶èµ„æº")
	}

	// å½“å‰ç®€åŒ–å®ç°ï¼šæ²¡æœ‰éœ€è¦ç‰¹åˆ«æ¸…ç†çš„èµ„æº
	// æœªæ¥å¯èƒ½éœ€è¦æ¸…ç†ï¼š
	// - ç½‘ç»œè¿æ¥æ± ä¸­çš„æœªå®Œæˆè¿æ¥
	// - åŒºå—æ•°æ®çš„ä¸´æ—¶ç¼“å­˜
	// - Kæ¡¶æŸ¥è¯¢çš„ä¸­é—´ç»“æœ

	if logger != nil {
		logger.Debug("èµ„æºæ¸…ç†å®Œæˆï¼šå½“å‰å®ç°ä¸­æ²¡æœ‰éœ€è¦æ¸…ç†çš„èµ„æº")
	}

	return nil
}

// resetSyncState é‡ç½®åŒæ­¥çŠ¶æ€ä¸ºç©ºé—²
//
// ğŸ¯ **çŠ¶æ€é‡ç½®ç­–ç•¥**ï¼š
// - å°†åŒæ­¥çŠ¶æ€æ ‡è®°ä¸ºidle
// - æ¸…é™¤åŒæ­¥è¿›åº¦ä¿¡æ¯
// - é‡ç½®é”™è¯¯çŠ¶æ€
func resetSyncState(logger log.Logger) {
	if logger != nil {
		logger.Debug("é‡ç½®åŒæ­¥çŠ¶æ€ä¸ºç©ºé—²")
	}

	// å½“å‰ç®€åŒ–å®ç°ï¼šçŠ¶æ€ç®¡ç†ç›¸å¯¹ç®€å•
	// æœªæ¥å¯èƒ½éœ€è¦ï¼š
	// - æ›´æ–°å…¨å±€åŒæ­¥çŠ¶æ€å˜é‡
	// - æ¸…é™¤åŒæ­¥è¿›åº¦æŒ‡æ ‡
	// - é€šçŸ¥å…¶ä»–ç»„ä»¶åŒæ­¥å·²åœæ­¢

	if logger != nil {
		logger.Debug("åŒæ­¥çŠ¶æ€å·²é‡ç½®ä¸ºç©ºé—²")
	}
}

// ============================================================================
//                           æ‰©å±•æ¥å£é¢„ç•™
// ============================================================================

// æ³¨æ„ï¼šä»¥ä¸‹æ¥å£ä¸ºæœªæ¥æ‰©å±•é¢„ç•™ï¼Œå½“å‰æœªå®ç°
//
// - CancelSyncWithTimeout: å¸¦è¶…æ—¶çš„åŒæ­¥å–æ¶ˆ
// - ForceStopSync: å¼ºåˆ¶åœæ­¢åŒæ­¥ï¼ˆä¸ç­‰å¾…æ¸…ç†å®Œæˆï¼‰
// - GetCancelProgress: è·å–å–æ¶ˆæ“ä½œçš„è¿›åº¦
// - RegisterCancelCallback: æ³¨å†Œå–æ¶ˆå®Œæˆçš„å›è°ƒå‡½æ•°
//
// è¿™äº›æ‰©å±•åŠŸèƒ½å°†åœ¨éœ€è¦æ”¯æŒé•¿æ—¶é—´è¿è¡Œçš„åå°åŒæ­¥ä»»åŠ¡æ—¶å®ç°
