# Repositories Core Moduleï¼ˆinternal/core/repositoriesï¼‰

## ğŸ¯ æ¨¡å—æ¦‚è¿°

**Repositories Core Module** æ˜¯ WES åŒºå—é“¾æ•°æ®ä»“å‚¨å±‚çš„æ ¸å¿ƒå®ç°æ¨¡å—ï¼Œæä¾›å®Œæ•´çš„åŒºå—é“¾æ•°æ®å­˜å‚¨ã€æŸ¥è¯¢å’Œç®¡ç†æœåŠ¡ã€‚æœ¬æ¨¡å—éµå¾ªå•ä¸€æ•°æ®æºåŸåˆ™ï¼Œå°†åŒºå—ä½œä¸ºå”¯ä¸€æ•°æ®å†™å…¥ç‚¹ï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿæä¾›å¯é çš„æ•°æ®åŸºç¡€è®¾æ–½ã€‚

ã€å®ç°æ¶æ„ã€‘

ã€€ã€€é‡‡ç”¨**åˆ†å±‚æ•°æ®ç®¡ç†**çš„ä¸‰å±‚å®ç°æ¶æ„ï¼Œç¡®ä¿æ•°æ®è®¿é—®çš„é«˜æ•ˆæ€§å’Œå¯é æ€§ã€‚

```mermaid
graph TB
    subgraph "æ•°æ®ä»“å‚¨æ ¸å¿ƒæ¶æ„"
        subgraph "å…¬å…±æ¥å£å±‚"
            REPO_SERVICE["RepositoryManager<br/>ğŸ“Š æ•°æ®ä»“å‚¨ç®¡ç†æ¥å£"]
            UTXO_SERVICE["UTXOManager<br/>ğŸ’ UTXOç®¡ç†æ¥å£"]
        end
        
        subgraph "å†…éƒ¨åè°ƒå±‚"
            INTERNAL_REPO["å†…éƒ¨ä»“å‚¨æ¥å£<br/>ğŸ“‹ InternalRepositoryManager"]
            INTERNAL_UTXO["å†…éƒ¨UTXOæ¥å£<br/>ğŸ“‹ InternalUTXOManager"]
        end
        
        subgraph "ä¸šåŠ¡å®ç°å±‚"
            REPO_IMPL["æ•°æ®ä»“å‚¨å®ç°<br/>ğŸ—„ï¸ repository/"]
            UTXO_IMPL["UTXOå®ç°<br/>ğŸ’ utxo/"]
            RESOURCE_IMPL["èµ„æºå®ç°<br/>âš™ï¸ resource/"]
        end
        
        subgraph "å­˜å‚¨åŸºç¡€å±‚"
            BADGER_STORE["BadgerDBå­˜å‚¨<br/>ğŸ—„ï¸ BadgerStore"]
            MEMORY_STORE["å†…å­˜å­˜å‚¨<br/>ğŸ§  MemoryStore"]
            INDEX_SERVICE["ç´¢å¼•æœåŠ¡<br/>ğŸ“‡ IndexService"]
        end
    end
    
    %% æ¥å£å±‚åˆ°åè°ƒå±‚
    REPO_SERVICE --> INTERNAL_REPO
    UTXO_SERVICE --> INTERNAL_UTXO
    
    %% åè°ƒå±‚åˆ°å®ç°å±‚
    INTERNAL_REPO --> REPO_IMPL
    INTERNAL_UTXO --> UTXO_IMPL
    INTERNAL_REPO --> RESOURCE_IMPL
    
    %% å®ç°å±‚åˆ°å­˜å‚¨å±‚
    REPO_IMPL --> BADGER_STORE
    UTXO_IMPL --> MEMORY_STORE
    RESOURCE_IMPL --> INDEX_SERVICE
    
    %% æ ·å¼è®¾ç½®
    style REPO_SERVICE fill:#E8F5E8
    style UTXO_SERVICE fill:#FFF3E0
    style INTERNAL_REPO fill:#E3F2FD
    style REPO_IMPL fill:#F3E5F5
    style UTXO_IMPL fill:#FFF8E1
```

**æ¶æ„å±‚æ¬¡è¯´æ˜ï¼š**

1. **å…¬å…±æ¥å£å±‚**ï¼šå¯¹å¤–æä¾›æ ‡å‡†åŒ–çš„æ•°æ®è®¿é—®æ¥å£
   - åŒºå—é“¾æ•°æ®å­˜å‚¨æŸ¥è¯¢
   - UTXOçŠ¶æ€ç®¡ç†
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

2. **å†…éƒ¨åè°ƒå±‚**ï¼šå†…éƒ¨æ¥å£åè°ƒå’Œä¸šåŠ¡é€»è¾‘ç»„ç»‡
   - è·¨æ¨¡å—åä½œæ¥å£
   - å¤æ‚ä¸šåŠ¡æµç¨‹åè°ƒ
   - å†…éƒ¨çŠ¶æ€ç®¡ç†

3. **ä¸šåŠ¡å®ç°å±‚**ï¼šå…·ä½“çš„æ•°æ®æ“ä½œå’Œä¸šåŠ¡é€»è¾‘å®ç°
   - åŒºå—ã€äº¤æ˜“ã€èµ„æºæ•°æ®æ“ä½œ
   - UTXOæŸ¥è¯¢å’Œå¼•ç”¨ç®¡ç†
   - èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## ğŸ“ **æ¨¡å—ç»„ç»‡ç»“æ„**

ã€æ•°æ®ä»“å‚¨å±‚æ¨¡å—æ¶æ„ã€‘

```
internal/core/repositories/
â”œâ”€â”€ ğŸ“‹ module.go                         # fxä¾èµ–æ³¨å…¥æ¨¡å—é…ç½®
â”œâ”€â”€ ğŸ—ï¸ interfaces/                       # å†…éƒ¨æ¥å£å®šä¹‰å±‚
â”‚   â”œâ”€â”€ repository.go                     # å†…éƒ¨ä»“å‚¨æ¥å£æ‰©å±•
â”‚   â”œâ”€â”€ resource.go                       # å†…éƒ¨èµ„æºæ¥å£æ‰©å±•
â”‚   â”œâ”€â”€ utxo.go                          # å†…éƒ¨UTXOæ¥å£æ‰©å±•
â”‚   â””â”€â”€ README.md                        # æ¥å£å±‚æ–‡æ¡£
â”œâ”€â”€ ğŸ—„ï¸ repository/                       # ä¸»æ•°æ®ä»“å‚¨å®ç°
â”‚   â”œâ”€â”€ manager.go                       # ä»“å‚¨ç®¡ç†å™¨ä¸»å…¥å£
â”‚   â”œâ”€â”€ batch_hash.go                    # æ‰¹é‡å“ˆå¸Œè®¡ç®—æœåŠ¡
â”‚   â”œâ”€â”€ block.go                         # åŒºå—å­˜å‚¨æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ chain.go                         # åŒºå—é“¾çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ outbox.go                        # äº‹ä»¶è¾“å‡ºç›’ç®¡ç†
â”‚   â”œâ”€â”€ validation.go                    # æ•°æ®éªŒè¯æœåŠ¡
â”‚   â”œâ”€â”€ ğŸ” index/                        # ç»Ÿä¸€ç´¢å¼•ç®¡ç†å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ manager.go                   # ç´¢å¼•ç®¡ç†å™¨åè°ƒä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ hash.go                      # å“ˆå¸Œç´¢å¼•å®ç°
â”‚   â”‚   â”œâ”€â”€ height.go                    # é«˜åº¦ç´¢å¼•å®ç°
â”‚   â”‚   â””â”€â”€ README.md                    # ç´¢å¼•ç®¡ç†æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ transaction/                  # äº¤æ˜“ä½ç½®ç´¢å¼•å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ service.go                   # äº¤æ˜“æŸ¥è¯¢æœåŠ¡é—¨é¢
â”‚   â”‚   â”œâ”€â”€ index.go                     # äº¤æ˜“ç´¢å¼•æ ¸å¿ƒå®ç°
â”‚   â”‚   â”œâ”€â”€ query.go                     # äº¤æ˜“æŸ¥è¯¢æ“ä½œå®ç°
â”‚   â”‚   â””â”€â”€ README.md                    # äº¤æ˜“ç´¢å¼•æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“¦ resource/                     # èµ„æºå…ƒæ•°æ®ç´¢å¼•å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ service.go                   # èµ„æºæŸ¥è¯¢æœåŠ¡é—¨é¢
â”‚   â”‚   â”œâ”€â”€ index.go                     # èµ„æºç´¢å¼•æ ¸å¿ƒå®ç°
â”‚   â”‚   â”œâ”€â”€ query.go                     # èµ„æºæŸ¥è¯¢æ“ä½œå®ç°
â”‚   â”‚   â””â”€â”€ README.md                    # èµ„æºç´¢å¼•æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ”— utxo/                         # UTXOç³»ç»Ÿæ¥å£å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ service.go                   # UTXOæ¥å£å®¢æˆ·ç«¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ README.md                    # UTXOå®¢æˆ·ç«¯æ–‡æ¡£
â”‚   â””â”€â”€ README.md                        # ä¸»ä»“å‚¨å®ç°æ–‡æ¡£
â”œâ”€â”€ ğŸ“ resource/                         # èµ„æºæ–‡ä»¶å­˜å‚¨ç®¡ç†
â”‚   â”œâ”€â”€ manager.go                       # èµ„æºç®¡ç†å™¨ä¸»å…¥å£
â”‚   â”œâ”€â”€ store.go                         # æ··åˆå­˜å‚¨æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ index.go                         # èµ„æºç´¢å¼•ç®¡ç†
â”‚   â”œâ”€â”€ query.go                         # èµ„æºæŸ¥è¯¢æ“ä½œ
â”‚   â”œâ”€â”€ lifecycle.go                     # èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”œâ”€â”€ consistency.go                   # ä¸€è‡´æ€§æ£€æŸ¥å’Œä¿®å¤
â”‚   â””â”€â”€ README.md                        # èµ„æºç®¡ç†æ–‡æ¡£
â”œâ”€â”€ ğŸ’ utxo/                             # UTXOçŠ¶æ€ç®¡ç†å®ç°
â”‚   â”œâ”€â”€ manager.go                       # UTXOç®¡ç†å™¨ä¸»å…¥å£
â”‚   â”œâ”€â”€ query.go                         # UTXOæŸ¥è¯¢æ“ä½œå®ç°
â”‚   â”œâ”€â”€ reference.go                     # UTXOå¼•ç”¨ç®¡ç†å®ç°
â”‚   â”œâ”€â”€ state_root.go                    # UTXOçŠ¶æ€æ ¹ç®¡ç†
â”‚   â”œâ”€â”€ storage.go                       # UTXOå­˜å‚¨ç­–ç•¥
â”‚   â””â”€â”€ README.md                        # UTXOç®¡ç†æ–‡æ¡£
â”œâ”€â”€ ğŸ“ README.md                         # æœ¬æ–‡æ¡£
â””â”€â”€ ğŸ“Š tests/                            # æµ‹è¯•æ–‡ä»¶ç›®å½•
    â”œâ”€â”€ repository_manager_test.go        # ä»“å‚¨ç®¡ç†å™¨æµ‹è¯•
    â”œâ”€â”€ utxo_manager_test.go             # UTXOç®¡ç†å™¨æµ‹è¯•
    â”œâ”€â”€ resource_manager_test.go         # èµ„æºç®¡ç†å™¨æµ‹è¯•
    â”œâ”€â”€ integration_test.go              # æ¨¡å—é›†æˆæµ‹è¯•
    â””â”€â”€ benchmark_test.go                # æ€§èƒ½åŸºå‡†æµ‹è¯•
```

### **ğŸ¯ å­æ¨¡å—èŒè´£åˆ†å·¥**

| **å­æ¨¡å—** | **æ ¸å¿ƒèŒè´£** | **å¯¹å¤–æ¥å£** | **å†…éƒ¨ç»„ä»¶** | **å¤æ‚åº¦** |
|-----------|-------------|-------------|-------------|-----------|
| `module.go` | fxä¾èµ–æ³¨å…¥æ¨¡å—é…ç½® | RepositoriesModule | ä¾èµ–ç®¡ç†ã€ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ã€æ¥å£å¯¼å‡º | ä½ |
| `interfaces/` | å†…éƒ¨æ¥å£å®šä¹‰å’Œæ‰©å±• | æ‰©å±•æ¥å£é›†åˆ | ä»“å‚¨æ¥å£ã€èµ„æºæ¥å£ã€UTXOæ¥å£ | ä½ |
| `repository/` | ä¸»æ•°æ®ä»“å‚¨æœåŠ¡å®ç° | RepositoryManager | åŒºå—å­˜å‚¨ã€äº¤æ˜“ç´¢å¼•ã€èµ„æºç´¢å¼•ã€UTXOå®¢æˆ·ç«¯ | é«˜ |
| `repository/index/` | ç»Ÿä¸€ç´¢å¼•ç®¡ç†åè°ƒ | IndexManager | é«˜åº¦ç´¢å¼•ã€å“ˆå¸Œç´¢å¼•ã€ç´¢å¼•å¥åº·æ£€æŸ¥ | é«˜ |
| `repository/transaction/` | äº¤æ˜“ä½ç½®ç´¢å¼•ä¸æŸ¥è¯¢ | TransactionService | äº¤æ˜“ç´¢å¼•ã€æŸ¥è¯¢æœåŠ¡ã€nonceè®¡ç®— | ä¸­ |
| `repository/resource/` | èµ„æºå…ƒæ•°æ®ç´¢å¼•ä¸æŸ¥è¯¢ | ResourceService | èµ„æºç´¢å¼•ã€æŸ¥è¯¢æœåŠ¡ã€å†…å®¹å¯»å€ | ä¸­ |
| `repository/utxo/` | UTXOç³»ç»Ÿæ¥å£å®¢æˆ·ç«¯ | UTXOClient | æ¥å£è°ƒç”¨ã€å¼‚æ­¥é€šçŸ¥ã€é‡è¯•æœºåˆ¶ | ä¸­ |
| `resource/` | èµ„æºæ–‡ä»¶å­˜å‚¨ç®¡ç† | ResourceManager | æ··åˆå­˜å‚¨ã€ç´¢å¼•ç®¡ç†ã€ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ | é«˜ |
| `utxo/` | UTXOçŠ¶æ€ç®¡ç†å®ç° | UTXOManager | UTXOæŸ¥è¯¢ã€å¼•ç”¨ç®¡ç†ã€çŠ¶æ€æ ¹ç®¡ç† | é«˜ |
| `tests/` | æ•°æ®ä»“å‚¨å±‚åŠŸèƒ½æµ‹è¯• | æµ‹è¯•å·¥å…·å’Œæ¡†æ¶ | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯• | ä¸­ |

---

## ğŸ”„ **ç»Ÿä¸€æ•°æ®ä»“å‚¨å®ç°**

ã€å®ç°ç­–ç•¥ã€‘

ã€€ã€€æ‰€æœ‰æ•°æ®ä»“å‚¨å­æ¨¡å—å‡ä¸¥æ ¼éµå¾ª**å•ä¸€æ•°æ®æºåŸåˆ™**å’Œ**åˆ†å±‚å­˜å‚¨æ¶æ„**ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€é«˜æ•ˆæ€§å’Œå¯é æ€§ã€‚

```mermaid
flowchart TD
    subgraph "ç»Ÿä¸€æ•°æ®ä»“å‚¨å®ç°æ¶æ„"
        subgraph "æ•°æ®å†™å…¥é˜¶æ®µ"
            A[åŒºå—æ•°æ®å†™å…¥è¯·æ±‚] --> B{æ•°æ®ç±»å‹}
            B -->|åŒºå—æ•°æ®| C[ä¸»ä»“å‚¨å¤„ç†]
            B -->|èµ„æºæ–‡ä»¶| D[èµ„æºå­˜å‚¨å¤„ç†]
            B -->|UTXOå˜æ›´| E[UTXOå¤„ç†]
        end
        
        subgraph "å­˜å‚¨åè°ƒé˜¶æ®µ"
            C --> F[åŒºå—å­˜å‚¨äº‹åŠ¡å¼€å§‹]
            F --> G[åŒºå—æ•°æ®å†™å…¥]
            G --> H[ç´¢å¼•æ›´æ–°åè°ƒ]
            D --> I[èµ„æºæ–‡ä»¶å­˜å‚¨]
            E --> J[UTXOçŠ¶æ€æ›´æ–°]
        end
        
        subgraph "ç´¢å¼•æ›´æ–°é˜¶æ®µ"
            H --> K{ç´¢å¼•ç±»å‹}
            K -->|äº¤æ˜“ç´¢å¼•| L[äº¤æ˜“ä½ç½®ç´¢å¼•æ„å»º]
            K -->|èµ„æºç´¢å¼•| M[èµ„æºå…ƒæ•°æ®ç´¢å¼•æ„å»º]
            K -->|ç»Ÿä¸€ç´¢å¼•| N[é«˜åº¦å’Œå“ˆå¸Œç´¢å¼•æ„å»º]
            I --> O[èµ„æºç´¢å¼•åŒæ­¥]
        end
        
        subgraph "ä¸€è‡´æ€§ä¿éšœé˜¶æ®µ"
            L --> P[äº‹åŠ¡ä¸€è‡´æ€§æ£€æŸ¥]
            M --> P
            N --> P
            O --> Q[å­˜å‚¨ä¸€è‡´æ€§éªŒè¯]
            J --> R[UTXOçŠ¶æ€ä¸€è‡´æ€§]
        end
        
        subgraph "å¼‚æ­¥é€šçŸ¥é˜¶æ®µ"
            P --> S{é€šçŸ¥ç±»å‹}
            S -->|UTXOé€šçŸ¥| T[UTXOç³»ç»Ÿå¼‚æ­¥é€šçŸ¥]
            S -->|äº‹ä»¶é€šçŸ¥| U[äº‹ä»¶æ€»çº¿é€šçŸ¥]
            Q --> V[èµ„æºçŠ¶æ€é€šçŸ¥]
            R --> W[çŠ¶æ€å˜æ›´ç¡®è®¤]
        end
        
        subgraph "å®Œæˆç¡®è®¤é˜¶æ®µ"
            T --> X[äº‹åŠ¡æäº¤ç¡®è®¤]
            U --> Y[é€šçŸ¥å‘é€ç¡®è®¤]
            V --> Z[å­˜å‚¨å®Œæˆç¡®è®¤]
            W --> AA[çŠ¶æ€åŒæ­¥å®Œæˆ]
            X --> BB[æ“ä½œå®Œæˆ]
        end
    end
```

**å…³é”®å®ç°è¦ç‚¹ï¼š**

1. **å•ä¸€æ•°æ®æºä¿è¯**ï¼š
   - åŒºå—ä½œä¸ºå”¯ä¸€æ•°æ®å†™å…¥ç‚¹ï¼Œæ‰€æœ‰å…¶ä»–æ•°æ®ä»åŒºå—å®æ—¶æå–
   - è½»é‡çº§ç´¢å¼•è®¾è®¡ï¼Œåªå­˜å‚¨ä½ç½®ä¿¡æ¯ä¸é‡å¤å­˜å‚¨ä¸šåŠ¡æ•°æ®
   - å¼ºä¸€è‡´æ€§äº‹åŠ¡ä¿è¯ï¼Œç¡®ä¿æ•°æ®å†™å…¥çš„åŸå­æ€§

2. **åˆ†å±‚å­˜å‚¨ä¼˜åŒ–**ï¼š
   - ä¸»ä»“å‚¨è´Ÿè´£åŒºå—å’Œç´¢å¼•çš„æ ¸å¿ƒå­˜å‚¨åŠŸèƒ½
   - èµ„æºå­˜å‚¨è´Ÿè´£æ–‡ä»¶å†…å®¹çš„æ··åˆå­˜å‚¨ç­–ç•¥
   - UTXOå­˜å‚¨è´Ÿè´£çŠ¶æ€æ•°æ®çš„é«˜æ•ˆæŸ¥è¯¢ä¼˜åŒ–

3. **å¼‚æ­¥åè°ƒæœºåˆ¶**ï¼š
   - è·¨æ¨¡å—å¼‚æ­¥é€šçŸ¥ï¼Œé¿å…é˜»å¡ä¸»å­˜å‚¨æµç¨‹
   - é‡è¯•å’Œæ¢å¤æœºåˆ¶ï¼Œç¡®ä¿åˆ†å¸ƒå¼æ“ä½œçš„å¯é æ€§
   - äº‹ä»¶é©±åŠ¨é›†æˆï¼Œæ”¯æŒç³»ç»Ÿé—´çš„æ¾è€¦åˆåä½œ

### ğŸ¯ æ ¸å¿ƒæœåŠ¡

#### ğŸ—„ï¸ Repository Manager

**æ•°æ®ä»“å‚¨ç®¡ç†æœåŠ¡** - å®ç° `repository.RepositoryManager` æ¥å£

- **åŒºå—æ•°æ®æ“ä½œ**ï¼šåŒºå—å­˜å‚¨ã€æŸ¥è¯¢ã€ç´¢å¼•ç®¡ç†
- **äº¤æ˜“æƒåˆ©ç®¡ç†**ï¼šäº¤æ˜“æŸ¥è¯¢ã€nonceé˜²é‡æ”¾æ”»å‡»
- **èµ„æºèƒ½åŠ›ç®¡ç†**ï¼šåŸºäºå†…å®¹å“ˆå¸Œçš„èµ„æºæŸ¥è¯¢

#### ğŸ’ UTXO Manager

**UTXOæ•°æ®ç®¡ç†æœåŠ¡** - å®ç° `repository.UTXOManager` æ¥å£

- **UTXOæŸ¥è¯¢æ“ä½œ**ï¼šç²¾ç¡®æŸ¥è¯¢å’Œåœ°å€èšåˆæŸ¥è¯¢
- **å¼•ç”¨ç®¡ç†æ“ä½œ**ï¼šResourceUTXOçš„å¹¶å‘å¼•ç”¨æ§åˆ¶

### ğŸš€ æŠ€æœ¯ç‰¹æ€§

- **å•ä¸€æ•°æ®æº**ï¼šä¸¥æ ¼éµå¾ªåŒºå—ä½œä¸ºå”¯ä¸€å†™å…¥ç‚¹çš„æ¶æ„åŸåˆ™
- **é«˜æ•ˆæŸ¥è¯¢**ï¼šåŸºäºå¤šé‡ç´¢å¼•çš„O(1)æ—¶é—´å¤æ‚åº¦æŸ¥è¯¢
- **å¹¶å‘å®‰å…¨**ï¼šResourceUTXOå¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œé˜²æ­¢å¹¶å‘å†²çª
- **å­˜å‚¨åˆ†å±‚**ï¼šçƒ­æ•°æ®ç¼“å­˜ä¸å†·æ•°æ®ç´¢å¼•çš„çµæ´»å­˜å‚¨ç­–ç•¥
- **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡fxæ¡†æ¶ç»Ÿä¸€ç®¡ç†æœåŠ¡ä¾èµ–å’Œç”Ÿå‘½å‘¨æœŸ

---

## ğŸ—ï¸ **ä¾èµ–æ³¨å…¥æ¶æ„**

ã€fxæ¡†æ¶é›†æˆã€‘

ã€€ã€€å…¨é¢é‡‡ç”¨fxä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œå®ç°ç»„ä»¶é—´çš„æ¾è€¦åˆå’Œç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†ã€‚

```go
// ç¤ºä¾‹ï¼šæ•°æ®ä»“å‚¨æ¨¡å—ä¾èµ–æ³¨å…¥é…ç½®
package repositories

import (
    "go.uber.org/fx"
    "github.com/weisyn/v1/pkg/interfaces/repository"
)

// Module æ•°æ®ä»“å‚¨æ¨¡å—
var Module = fx.Module("repositories",
    // å¯¼å…¥æ ¸å¿ƒç»„ä»¶
    fx.Provide(
        // æ•°æ®ä»“å‚¨ç®¡ç†ç»„ä»¶
        repository.NewRepositoryManager,
        repository.NewBlockManager,
        repository.NewTransactionManager,
        repository.NewResourceManager,
        
        // UTXOç®¡ç†ç»„ä»¶
        utxo.NewUTXOManager,
        utxo.NewQueryService,
        utxo.NewReferenceManager,
        utxo.NewStateRootManager,
        
        // èµ„æºç®¡ç†ç»„ä»¶
        resource.NewResourceManager,
        resource.NewIndexService,
        resource.NewQueryService,
        resource.NewLifecycleManager,
        
        // å­˜å‚¨åŸºç¡€ç»„ä»¶
        NewStorageProvider,
        NewIndexManager,
        NewCacheManager,
    ),
    
    // å¯¼å‡ºå…¬å…±æ¥å£
    fx.Provide(
        fx.Annotate(
            func(mgr *repository.RepositoryManager) repository.RepositoryManager {
                return mgr
            },
            fx.As(new(repository.RepositoryManager)),
        ),
        fx.Annotate(
            func(mgr *utxo.UTXOManager) repository.UTXOManager {
                return mgr
            },
            fx.As(new(repository.UTXOManager)),
        ),
        // ... å…¶ä»–æ¥å£å¯¼å‡º
    ),
    
    // ç”Ÿå‘½å‘¨æœŸç®¡ç†
    fx.Invoke(InitializeRepositoryServices),
    fx.Invoke(CreateIndexes),
)

// æ•°æ®ä»“å‚¨æœåŠ¡åˆå§‹åŒ–
func InitializeRepositoryServices(
    repoManager *repository.RepositoryManager,
    utxoManager *utxo.UTXOManager,
    config *RepositoriesConfig,
) error {
    // åˆå§‹åŒ–å­˜å‚¨åç«¯
    if err := repoManager.Initialize(config.Storage); err != nil {
        return err
    }
    
    // åˆå§‹åŒ–UTXOç®¡ç†å™¨
    if err := utxoManager.Initialize(config.UTXO); err != nil {
        return err
    }
    
    return nil
}

// ç´¢å¼•åˆ›å»º
func CreateIndexes(
    indexManager *IndexManager,
    config *RepositoriesConfig,
) error {
    // åˆ›å»ºåŒºå—ç´¢å¼•
    if err := indexManager.CreateBlockIndexes(); err != nil {
        return err
    }
    
    // åˆ›å»ºäº¤æ˜“ç´¢å¼•
    if err := indexManager.CreateTransactionIndexes(); err != nil {
        return err
    }
    
    // åˆ›å»ºèµ„æºç´¢å¼•
    if err := indexManager.CreateResourceIndexes(); err != nil {
        return err
    }
    
    return nil
}
```

**ä¾èµ–ç®¡ç†ç‰¹ç‚¹ï¼š**
- **è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ**ï¼šç»„ä»¶å¯åŠ¨å’Œåœæ­¢ç”±fxè‡ªåŠ¨ç®¡ç†
- **æ¥å£å¯¼å‘**ï¼šé€šè¿‡æ¥å£è€Œéå…·ä½“ç±»å‹è¿›è¡Œä¾èµ–
- **å±‚æ¬¡æ¸…æ™°**ï¼šæ˜ç¡®çš„ä¾èµ–æ–¹å‘ï¼Œé¿å…å¾ªç¯ä¾èµ–
- **æµ‹è¯•å‹å¥½**ï¼šæ”¯æŒä¾èµ–æ³¨å…¥çš„å•å…ƒæµ‹è¯•

---

## ğŸ“Š **æ€§èƒ½ä¸ç›‘æ§**

ã€æ€§èƒ½æŒ‡æ ‡ã€‘

| **æ“ä½œç±»å‹** | **ç›®æ ‡å»¶è¿Ÿ** | **ååé‡ç›®æ ‡** | **å‘½ä¸­ç‡** | **ç›‘æ§æ–¹å¼** |
|-------------|-------------|---------------|-----------|------------|
| åŒºå—æŸ¥è¯¢ | < 5ms | > 2000 QPS | > 95% | å®æ—¶ç›‘æ§ |
| äº¤æ˜“æŸ¥è¯¢ | < 2ms | > 5000 QPS | > 98% | æ‰¹é‡ç»Ÿè®¡ |
| UTXOæŸ¥è¯¢ | < 1ms | > 10000 QPS | > 99% | å…³é”®è·¯å¾„ç›‘æ§ |
| åŒºå—å†™å…¥ | < 50ms | > 100 BPS | N/A | å¼‚æ­¥ç›‘æ§ |
| ç´¢å¼•æ›´æ–° | < 10ms | > 1000 UPS | > 90% | å®æ—¶ç›‘æ§ |

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š**
- **ç¼“å­˜ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜ã€æ™ºèƒ½é¢„å–ã€LRUç­–ç•¥
- **ç´¢å¼•ä¼˜åŒ–**ï¼šå¤åˆç´¢å¼•ã€åˆ†åŒºç´¢å¼•ã€å¢é‡æ›´æ–°
- **å­˜å‚¨ä¼˜åŒ–**ï¼šæ‰¹é‡å†™å…¥ã€å‹ç¼©å­˜å‚¨ã€å¼‚æ­¥æŒä¹…åŒ–
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šæŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–ã€å¹¶è¡ŒæŸ¥è¯¢ã€ç»“æœç¼“å­˜

---

## ğŸ”— **ä¸å…¬å…±æ¥å£çš„æ˜ å°„å…³ç³»**

ã€æ¥å£å®ç°æ˜ å°„ã€‘

```mermaid
classDiagram
    class RepositoryManager {
        <<interface>>
        +WriteBlock(block)
        +GetBlock(hash)
        +GetBlockByHeight(height)
        +QueryTransactions(criteria)
    }
    
    class RepositoryManagerImpl {
        -blockManager BlockManager
        -transactionManager TransactionManager
        -resourceManager ResourceManager
        -storageProvider StorageProvider
        +WriteBlock(block) error
        +GetBlock(hash) Block
        +GetBlockByHeight(height) Block
        +QueryTransactions(criteria) []Transaction
    }
    
    class UTXOManager {
        <<interface>>
        +GetUTXOsByAddress(address)
        +GetUTXO(outpoint)
        +AddUTXO(utxo)
        +SpendUTXO(outpoint)
    }
    
    class UTXOManagerImpl {
        -queryService UTXOQueryService
        -referenceManager ReferenceManager
        -stateRootManager StateRootManager
        -memoryStore MemoryStore
        +GetUTXOsByAddress(address) []UTXO
        +GetUTXO(outpoint) UTXO
        +AddUTXO(utxo) error
        +SpendUTXO(outpoint) error
    }
    
    class ResourceManager {
        <<interface>>
        +DeployResource(resource)
        +GetResource(address)
        +QueryResourcesByType(type)
        +UpdateResourceState(address, state)
    }
    
    class ResourceManagerImpl {
        -indexService ResourceIndexService
        -queryService ResourceQueryService
        -lifecycleManager LifecycleManager
        -storageProvider StorageProvider
        +DeployResource(resource) error
        +GetResource(address) Resource
        +QueryResourcesByType(type) []Resource
        +UpdateResourceState(address, state) error
    }
    
    RepositoryManager <|-- RepositoryManagerImpl : implements
    UTXOManager <|-- UTXOManagerImpl : implements
    ResourceManager <|-- ResourceManagerImpl : implements
```

**å®ç°è¦ç‚¹ï¼š**
- **æ¥å£å¥‘çº¦**ï¼šä¸¥æ ¼éµå¾ªå…¬å…±æ¥å£çš„æ–¹æ³•ç­¾åå’Œè¯­ä¹‰
- **é”™è¯¯å¤„ç†**ï¼šæ ‡å‡†åŒ–çš„é”™è¯¯è¿”å›å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•**ï¼šå®Œå–„çš„æ“ä½œæ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡è®°å½•
- **æµ‹è¯•è¦†ç›–**ï¼šæ¯ä¸ªæ¥å£æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### ğŸ“‹ æ¥å£æ˜ å°„

æœ¬æ¨¡å—å®Œæ•´å®ç°å…¬å…±æ•°æ®ä»“å‚¨æ¥å£ï¼Œä¸ºä¸Šå±‚ä¸šåŠ¡æ¨¡å—æä¾›æ•°æ®æœåŠ¡ï¼š

| å…¬å…±æ¥å£ | å®ç°æ¨¡å— | æ ¸å¿ƒåŠŸèƒ½ |
|----------|----------|----------|
| `repository.RepositoryManager` | `repository/` | åŒºå—é“¾æ•°æ®å­˜å‚¨æŸ¥è¯¢ |
| `repository.UTXOManager` | `utxo/` | UTXOçŠ¶æ€ç®¡ç† |

### ğŸ”— ä¾èµ–å…³ç³»

#### è¾“å…¥ä¾èµ–

- **åŸºç¡€è®¾æ–½**ï¼šLogger, ConfigProvider, EventBus
- **å­˜å‚¨ç»„ä»¶**ï¼šBadgerStore, MemoryStore, StorageProvider  
- **å¯†ç å­¦ç»„ä»¶**ï¼šHashManager, SignatureManager, KeyManager, AddressManager

#### è¾“å‡ºæœåŠ¡

- **æ•°æ®ä»“å‚¨æœåŠ¡**ï¼šä¸ºblockchainã€apiç­‰æ¨¡å—æä¾›æ•°æ®è®¿é—®èƒ½åŠ›
- **UTXOç®¡ç†æœåŠ¡**ï¼šä¸ºè´¦æˆ·æœåŠ¡ã€äº¤æ˜“éªŒè¯æä¾›UTXOæ“ä½œèƒ½åŠ›

### ğŸ¯ è®¾è®¡åŸåˆ™

1. **èŒè´£åˆ†ç¦»**ï¼šå°†ä¸åŒä¸šåŠ¡åŸŸçš„æ“ä½œåˆ†æ•£åˆ°ä¸“é—¨æ¨¡å—
2. **æ¥å£ç»Ÿä¸€**ï¼šé€šè¿‡å†…éƒ¨æ¥å£ä¿æŒä¸å…¬å…±æ¥å£çš„ä¸€è‡´æ€§
3. **ä¾èµ–æ˜ç¡®**ï¼šé€šè¿‡fxæ¡†æ¶æ˜ç¡®å£°æ˜æœåŠ¡ä¾èµ–
4. **ä¸šåŠ¡å¯¼å‘**ï¼šåŸºäºå®é™…ä¸šåŠ¡éœ€æ±‚è®¾è®¡ï¼Œé¿å…è¿‡åº¦è®¾è®¡

### ğŸ“Š ä¸šåŠ¡ä»·å€¼

- **æ•°æ®åŸºç¡€è®¾æ–½**ï¼šä¸ºæ•´ä¸ªWESåŒºå—é“¾ç³»ç»Ÿæä¾›å¯é çš„æ•°æ®åŸºç¡€
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡é«˜æ•ˆç´¢å¼•å’Œç¼“å­˜ç­–ç•¥æå‡æŸ¥è¯¢æ€§èƒ½
- **å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ç®€åŒ–ä¸Šå±‚ä¸šåŠ¡å¼€å‘
- **ç³»ç»Ÿå¯é æ€§**ï¼šä¸¥æ ¼çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯ç¡®ä¿ç³»ç»Ÿç¨³å®š

---

---

## ğŸš€ **åç»­æ‰©å±•è§„åˆ’**

ã€æ¨¡å—æ¼”è¿›æ–¹å‘ã€‘

1. **å­˜å‚¨èƒ½åŠ›å¢å¼º**
   - æ”¯æŒæ›´å¤šå­˜å‚¨åç«¯ï¼ˆRedisã€MongoDBç­‰ï¼‰
   - å®ç°åˆ†å¸ƒå¼å­˜å‚¨å’Œæ•°æ®åˆ†ç‰‡
   - æ·»åŠ æ•°æ®å‹ç¼©å’ŒåŠ å¯†å­˜å‚¨

2. **æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–**
   - å®ç°æ›´æ™ºèƒ½çš„æŸ¥è¯¢ä¼˜åŒ–å™¨
   - æ·»åŠ å¹¶è¡ŒæŸ¥è¯¢å’Œæ‰¹é‡æŸ¥è¯¢æ”¯æŒ
   - ä¼˜åŒ–ç´¢å¼•ç­–ç•¥å’Œç¼“å­˜æœºåˆ¶

3. **æ•°æ®ä¸€è‡´æ€§å¢å¼º**
   - å®ç°æ›´å¼ºçš„äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯
   - æ·»åŠ æ•°æ®å®Œæ•´æ€§æ ¡éªŒæœºåˆ¶
   - å¢å¼ºæ•…éšœæ¢å¤å’Œæ•°æ®ä¿®å¤èƒ½åŠ›

4. **ç›‘æ§è¿ç»´å¢å¼º**
   - æä¾›æ›´è¯¦ç»†çš„å­˜å‚¨ç›‘æ§æŒ‡æ ‡
   - å®ç°è‡ªåŠ¨åŒ–çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤
   - æ·»åŠ æ•°æ®åº“æ€§èƒ½åˆ†æå·¥å…·

---

## ğŸ“‹ **å¼€å‘æŒ‡å—**

ã€å­æ¨¡å—å¼€å‘è§„èŒƒã€‘

1. **æ–°å»ºå­æ¨¡å—æ­¥éª¤**ï¼š
   - åœ¨interfaces/ä¸­å®šä¹‰å†…éƒ¨æ¥å£
   - åˆ›å»ºå­æ¨¡å—ç›®å½•å’ŒåŸºç¡€æ–‡ä»¶
   - å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
   - æ·»åŠ å®Œæ•´çš„å•å…ƒæµ‹è¯•
   - æ›´æ–°fxä¾èµ–æ³¨å…¥é…ç½®

2. **ä»£ç è´¨é‡è¦æ±‚**ï¼š
   - éµå¾ªGoè¯­è¨€æœ€ä½³å®è·µ
   - 100%çš„æ¥å£æ–¹æ³•æµ‹è¯•è¦†ç›–
   - å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
   - æ¸…æ™°çš„ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£

3. **æ€§èƒ½è¦æ±‚**ï¼š
   - å…³é”®è·¯å¾„å»¶è¿ŸæŒ‡æ ‡è¾¾æ ‡
   - å†…å­˜ä½¿ç”¨åˆç†ï¼Œé¿å…æ³„æ¼
   - å¹¶å‘å®‰å…¨çš„æ•°æ®è®¿é—®
   - åˆç†çš„èµ„æºæ¸…ç†æœºåˆ¶

ã€å‚è€ƒæ–‡æ¡£ã€‘
- [æ•°æ®ä»“å‚¨å®ç°](repository/README.md)
- [UTXOç®¡ç†å®ç°](utxo/README.md)
- [èµ„æºç®¡ç†å®ç°](resource/README.md)
- [WESæ¶æ„è®¾è®¡æ–‡æ¡£](../../../docs/architecture/)

---

> ğŸ“ **æ¨¡æ¿è¯´æ˜**ï¼šæœ¬READMEæ¨¡æ¿åŸºäºWES v0.0.1ç»Ÿä¸€æ–‡æ¡£è§„èŒƒè®¾è®¡ï¼Œä½¿ç”¨æ—¶è¯·æ ¹æ®å…·ä½“æ¨¡å—éœ€æ±‚æ›¿æ¢ç›¸åº”çš„å ä½ç¬¦å†…å®¹ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰ç« èŠ‚éƒ½æœ‰å®è´¨æ€§çš„æŠ€æœ¯å†…å®¹ã€‚

> ğŸ”„ **ç»´æŠ¤æŒ‡å—**ï¼šæœ¬æ–‡æ¡£åº”éšç€æ¨¡å—åŠŸèƒ½çš„æ¼”è¿›åŠæ—¶æ›´æ–°ï¼Œç¡®ä¿æ–‡æ¡£ä¸ä»£ç å®ç°çš„ä¸€è‡´æ€§ã€‚å»ºè®®åœ¨æ¯æ¬¡é‡å¤§åŠŸèƒ½å˜æ›´åæ›´æ–°ç›¸åº”ç« èŠ‚ã€‚

**Repositories Core Module ä½œä¸ºWESåŒºå—é“¾ç³»ç»Ÿçš„æ•°æ®åŸºç¡€è®¾æ–½ï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿå…·å¤‡é«˜æ•ˆã€å¯é ã€ä¸€è‡´çš„æ•°æ®ç®¡ç†èƒ½åŠ›ã€‚**
