package interfaces

import (
	"context"

	"github.com/weisyn/v1/pkg/interfaces/repository"
)

// InternalResourceManager å†…éƒ¨èµ„æºç®¡ç†å™¨æ¥å£
//
// ğŸ¯ è®¾è®¡åŸåˆ™ï¼šç»§æ‰¿å…¬å…±æ¥å£ + å†…éƒ¨æ‰©å±•
//
// ç»§æ‰¿æ‰€æœ‰å…¬å…±èµ„æºç®¡ç†æ–¹æ³•ï¼Œå¹¶æ‰©å±•å†…éƒ¨å®ç°æ‰€éœ€çš„ä¸“é—¨åŠŸèƒ½ã€‚
// æœ¬æ¥å£ä¸“æ³¨äºèµ„æºå­˜å‚¨ã€ç´¢å¼•å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä¸ºå†…éƒ¨å®ç°å±‚æä¾›å®Œæ•´çš„èµ„æºæ“ä½œè§„èŒƒã€‚
//
// ğŸ“‹ ç»§æ‰¿åŠŸèƒ½ï¼ˆæ¥è‡ªpkg/interfaces/repository/resource.goï¼‰ï¼š
// - æ–‡ä»¶å­˜å‚¨ï¼šStoreResourceFile - ç»Ÿä¸€çš„æ–‡ä»¶å­˜å‚¨æ¥å£
// - å“ˆå¸ŒæŸ¥è¯¢ï¼šGetResourceByHash - åŸºäºå†…å®¹å“ˆå¸Œçš„ç²¾ç¡®æŸ¥è¯¢
// - ç±»å‹æŸ¥è¯¢ï¼šListResourcesByType - æŒ‰ä¸šåŠ¡ç±»å‹åˆ†é¡µæŸ¥è¯¢
//
// ğŸ”§ å†…éƒ¨æ‰©å±•åŠŸèƒ½ï¼š
// - å­˜å‚¨ä¸€è‡´æ€§ï¼šæ–‡ä»¶ä¸ç´¢å¼•çš„ä¸€è‡´æ€§æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
// - æ€§èƒ½ä¼˜åŒ–ï¼šå†…å®¹å¯»å€ã€å»é‡å­˜å‚¨ã€å¼•ç”¨è®¡æ•°ç®¡ç†
// - å¥åº·æ£€æŸ¥ï¼šå­˜å‚¨å®Œæ•´æ€§éªŒè¯å’Œæ•…éšœè‡ªæ¢å¤
//
// ğŸ’¡ æ¶æ„ç‰¹ç‚¹ï¼š
// - æ··åˆå­˜å‚¨ï¼šFileStore(æ–‡ä»¶) + BadgerStore(ç´¢å¼•) + MemoryStore(ç¼“å­˜)
// - äº‹åŠ¡ä¸€è‡´æ€§ï¼šç¡®ä¿æ–‡ä»¶å­˜å‚¨ä¸å…ƒæ•°æ®ç´¢å¼•çš„åŸå­æ€§
// - å†…å®¹å¯»å€ï¼šåŸºäºSHA-256å“ˆå¸Œçš„å»é‡å­˜å‚¨
// - å¼•ç”¨ç®¡ç†ï¼šæ”¯æŒResourceUTXOçš„å¹¶å‘å¼•ç”¨è®¡æ•°

type InternalResourceManager interface {
	repository.ResourceManager // ç»§æ‰¿æ‰€æœ‰å…¬å…±èµ„æºç®¡ç†æ–¹æ³•

	// ============== ğŸ” å†…éƒ¨æ‰©å±•ï¼šä¸€è‡´æ€§ç®¡ç† ==============

	// VerifyResourceIntegrity éªŒè¯å•ä¸ªèµ„æºçš„å­˜å‚¨å®Œæ•´æ€§
	//
	// æ£€æŸ¥æŒ‡å®šèµ„æºçš„æ–‡ä»¶å­˜å‚¨ä¸ç´¢å¼•å…ƒæ•°æ®æ˜¯å¦ä¸€è‡´ï¼š
	// - æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
	// - è®¡ç®—å“ˆå¸Œæ˜¯å¦ä¸å…ƒæ•°æ®ä¸­è®°å½•ä¸€è‡´
	// - æ–‡ä»¶å¤§å°æ˜¯å¦åŒ¹é…
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - contentHash: èµ„æºå†…å®¹å“ˆå¸Œ
	//
	// è¿”å›ï¼š
	//   - error: å®Œæ•´æ€§éªŒè¯å¤±è´¥æ—¶çš„é”™è¯¯
	VerifyResourceIntegrity(ctx context.Context, contentHash []byte) error

	// RepairStorageInconsistency ä¿®å¤å­˜å‚¨ä¸ä¸€è‡´çŠ¶æ€
	//
	// è‡ªåŠ¨æ£€æŸ¥å¹¶ä¿®å¤ä»¥ä¸‹ä¸ä¸€è‡´æƒ…å†µï¼š
	// - å­¤å„¿æ–‡ä»¶ï¼šæ–‡ä»¶å­˜åœ¨ä½†ç´¢å¼•ç¼ºå¤± -> é‡å»ºç´¢å¼•æˆ–åˆ é™¤æ–‡ä»¶
	// - å­¤å„¿ç´¢å¼•ï¼šç´¢å¼•å­˜åœ¨ä½†æ–‡ä»¶ç¼ºå¤± -> æ¸…ç†ç´¢å¼•è®°å½•
	// - å“ˆå¸Œä¸åŒ¹é…ï¼šé‡æ–°è®¡ç®—å¹¶æ›´æ–°ç´¢å¼•
	//
	// è¿™æ˜¯åŒºå—é“¾è‡ªè¿è¡Œç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç¡®ä¿å­˜å‚¨å±‚çš„è‡ªæ„ˆèƒ½åŠ›ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//
	// è¿”å›ï¼š
	//   - int: ä¿®å¤çš„ä¸ä¸€è‡´è®°å½•æ•°é‡
	//   - error: ä¿®å¤è¿‡ç¨‹ä¸­çš„é”™è¯¯
	RepairStorageInconsistency(ctx context.Context) (int, error)

	// ============== ğŸ“Š å†…éƒ¨æ‰©å±•ï¼šå¼•ç”¨ç®¡ç† ==============

	// GetResourceReferenceCount è·å–èµ„æºå¼•ç”¨è®¡æ•°
	//
	// ç”¨äºResourceUTXOçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ”¯æŒï¼š
	// - å¼•ç”¨è®¡æ•°æŸ¥è¯¢
	// - åƒåœ¾å›æ”¶åˆ¤æ–­ï¼ˆè®¡æ•°ä¸º0çš„èµ„æºå¯è¢«æ¸…ç†ï¼‰
	// - å¹¶å‘å®‰å…¨çš„å¼•ç”¨ç®¡ç†
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - contentHash: èµ„æºå†…å®¹å“ˆå¸Œ
	//
	// è¿”å›ï¼š
	//   - int32: å½“å‰å¼•ç”¨è®¡æ•°
	//   - error: æŸ¥è¯¢é”™è¯¯
	GetResourceReferenceCount(ctx context.Context, contentHash []byte) (int32, error)

	// IncrementResourceReference å¢åŠ èµ„æºå¼•ç”¨è®¡æ•°
	//
	// å½“ResourceUTXOè¢«å¼•ç”¨æ—¶è°ƒç”¨ï¼ˆå¦‚äº¤æ˜“è¾“å…¥å¼•ç”¨ï¼‰
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - contentHash: èµ„æºå†…å®¹å“ˆå¸Œ
	//
	// è¿”å›ï¼š
	//   - error: æ“ä½œé”™è¯¯
	IncrementResourceReference(ctx context.Context, contentHash []byte) error

	// DecrementResourceReference å‡å°‘èµ„æºå¼•ç”¨è®¡æ•°
	//
	// å½“ResourceUTXOå¼•ç”¨è¢«é‡Šæ”¾æ—¶è°ƒç”¨ï¼ˆå¦‚äº¤æ˜“ç¡®è®¤åï¼‰
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - contentHash: èµ„æºå†…å®¹å“ˆå¸Œ
	//
	// è¿”å›ï¼š
	//   - error: æ“ä½œé”™è¯¯
	DecrementResourceReference(ctx context.Context, contentHash []byte) error

	// ============== ğŸ—‘ï¸ å†…éƒ¨æ‰©å±•ï¼šç”Ÿå‘½å‘¨æœŸç®¡ç† ==============

	// MarkResourceForCleanup æ ‡è®°èµ„æºå¾…æ¸…ç†
	//
	// å½“èµ„æºå¼•ç”¨è®¡æ•°å½’é›¶ä¸”æ»¡è¶³æ¸…ç†æ¡ä»¶æ—¶ï¼Œæ ‡è®°ä¸ºå¾…æ¸…ç†çŠ¶æ€ã€‚
	// è¿™ä¸ºåŒºå—é“¾ç³»ç»Ÿæä¾›äº†è‡ªåŠ¨çš„èµ„æºåƒåœ¾å›æ”¶èƒ½åŠ›ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - contentHash: èµ„æºå†…å®¹å“ˆå¸Œ
	//
	// è¿”å›ï¼š
	//   - error: æ ‡è®°é”™è¯¯
	MarkResourceForCleanup(ctx context.Context, contentHash []byte) error

	// CleanupUnreferencedResources æ¸…ç†æ— å¼•ç”¨çš„èµ„æº
	//
	// æ¸…ç†æ‰€æœ‰å¼•ç”¨è®¡æ•°ä¸º0ä¸”æ ‡è®°ä¸ºå¾…æ¸…ç†çš„èµ„æºï¼š
	// - åˆ é™¤ç‰©ç†æ–‡ä»¶
	// - æ¸…é™¤ç´¢å¼•è®°å½•
	// - é‡Šæ”¾å­˜å‚¨ç©ºé—´
	//
	// åŒºå—é“¾ç³»ç»Ÿçš„è‡ªåŠ¨åƒåœ¾å›æ”¶æœºåˆ¶ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - maxCleanupCount: å•æ¬¡æ¸…ç†çš„æœ€å¤§èµ„æºæ•°é‡ï¼ˆé¿å…é•¿æ—¶é—´é˜»å¡ï¼‰
	//
	// è¿”å›ï¼š
	//   - int: å®é™…æ¸…ç†çš„èµ„æºæ•°é‡
	//   - error: æ¸…ç†è¿‡ç¨‹ä¸­çš„é”™è¯¯
	CleanupUnreferencedResources(ctx context.Context, maxCleanupCount int) (int, error)
}
