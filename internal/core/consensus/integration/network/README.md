# WES å…±è¯†ç½‘ç»œé›†æˆï¼ˆConsensus Network Integrationï¼‰

ã€æ¨¡å—å®šä½ã€‘
ã€€ã€€æœ¬æ¨¡å—æ˜¯WESå…±è¯†ç³»ç»Ÿçš„ç½‘ç»œé›†æˆç»„ä»¶ï¼Œä¸ºå…±è¯†ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„ç½‘ç»œåè®®é›†æˆèƒ½åŠ›ã€‚ä½œä¸ºç³»ç»Ÿçº§ç½‘ç»œé›†æˆå±‚ï¼Œä¸»è¦æœåŠ¡äºAggregatoræ¨¡å—çš„ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼Œé€šè¿‡æ ‡å‡†åŒ–çš„åè®®æ³¨å†Œã€æ¶ˆæ¯è·¯ç”±å’Œæ¥å£æŠ½è±¡ï¼Œå®ç°ç½‘ç»œå±‚ä¸ä¸šåŠ¡å±‚çš„æ¾è€¦åˆæ¶æ„ã€‚ä¸“æ³¨äºåè®®é€‚é…åŠŸèƒ½ï¼Œå…·ä½“çš„è·¯ç”±å†³ç­–ã€ä¸­ç»§æ§åˆ¶ç­‰ä¸šåŠ¡é€»è¾‘ç”±Aggregatoræ¨¡å—è´Ÿè´£ã€‚

ã€è®¾è®¡åŸåˆ™ã€‘
- **ç³»ç»Ÿçº§ç½‘ç»œé›†æˆ**ï¼šä¸ºæ•´ä¸ªå…±è¯†ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„ç½‘ç»œåè®®é›†æˆæœåŠ¡
- **æ ‡å‡†åŒ–åè®®é€‚é…**ï¼šç»Ÿä¸€ç®¡ç†åè®®æ³¨å†Œã€ç‰ˆæœ¬æ§åˆ¶å’Œæ¶ˆæ¯æ ¼å¼è½¬æ¢
- **UnifiedAggregatorRouteræ¥å£**ï¼šé€šè¿‡æ ‡å‡†åŒ–è·¯ç”±æ¥å£å®ç°ä¸ä¸šåŠ¡å±‚çš„è§£è€¦
- **ä¸šåŠ¡æ— å…³çš„é€‚é…å±‚**ï¼šä¸“æ³¨äºç½‘ç»œé€‚é…ï¼Œä¸åŒ…å«ABSå…±è¯†ä¸šåŠ¡é€»è¾‘
- **è½»é‡çº§é›†æˆè®¾è®¡**ï¼šä¿æŒé€‚é…å±‚çš„ç®€æ´æ€§ï¼Œä¸šåŠ¡å†³ç­–ç”±Aggregatorè´Ÿè´£

ã€æ ¸å¿ƒèŒè´£ã€‘
1. **ç³»ç»Ÿçº§åè®®æ³¨å†Œ**ï¼šå‘ç½‘ç»œå±‚æ³¨å†Œå…±è¯†ç³»ç»Ÿç›¸å…³çš„æµå¼åè®®å’Œè®¢é˜…åè®®
2. **åè®®å¸¸é‡ç»Ÿä¸€ç®¡ç†**ï¼šç»´æŠ¤å…±è¯†ç³»ç»Ÿæ‰€æœ‰åè®®çš„å¸¸é‡å®šä¹‰å’Œç‰ˆæœ¬ä¿¡æ¯
3. **æ¶ˆæ¯åºåˆ—åŒ–é€‚é…**ï¼šç½‘ç»œå­—èŠ‚æµä¸protobufæ¶ˆæ¯ä¹‹é—´çš„æ ‡å‡†åŒ–è½¬æ¢
4. **UnifiedAggregatorRouterè·¯ç”±**ï¼šé€šè¿‡ç»Ÿä¸€è·¯ç”±æ¥å£å°†æ¶ˆæ¯è½¬å‘ç»™ä¸šåŠ¡å±‚å¤„ç†

## ğŸ“Œ **å…±è¯†ç³»ç»Ÿç½‘ç»œé›†æˆæ¶æ„è¯´æ˜**

åœ¨WESå…±è¯†ç³»ç»Ÿæ¶æ„ä¸­ï¼š
- **ç³»ç»Ÿçº§é›†æˆèƒ½åŠ›**ï¼šä¸ºæ•´ä¸ªå…±è¯†ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„ç½‘ç»œåè®®é›†æˆæœåŠ¡
- **ä¸»è¦æœåŠ¡å¯¹è±¡**ï¼šAggregatoræ¨¡å—çš„ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼ˆåŒºå—æäº¤ã€å…±è¯†å¿ƒè·³ç­‰ï¼‰
- **æ¶æ„è¾¹ç•Œæ¸…æ™°**ï¼šIntegrationå±‚ä»…è´Ÿè´£åè®®é€‚é…ï¼Œå…·ä½“çš„è·¯ç”±å†³ç­–ã€å†…å®¹å¯»å€ã€é«˜åº¦æ ¡éªŒç­‰ABSä¸šåŠ¡é€»è¾‘ç”±Aggregatoræ¨¡å—è´Ÿè´£

## ğŸ“ **æ¨¡å—ç»„ç»‡æ¶æ„**

```text
network/
â”œâ”€â”€ ğŸ“– README.md              # æœ¬æ–‡æ¡£ï¼šç½‘ç»œé›†æˆè¯¦ç»†è®¾è®¡
â”œâ”€â”€ ğŸŒ stream_handlers.go     # æµå¼åè®®æ³¨å†Œï¼šåŒºå—æäº¤åè®®æ³¨å†Œå’Œè·¯ç”±
â”œâ”€â”€ ğŸ“¡ subscribe_handlers.go  # è®¢é˜…åè®®æ³¨å†Œï¼šåŒºå—å¹¿æ’­åè®®æ³¨å†Œå’Œè·¯ç”±  
â”œâ”€â”€ ğŸ“‹ protocol_constants.go  # åè®®å¸¸é‡ï¼šç»Ÿä¸€çš„åè®®IDã€ç‰ˆæœ¬ç®¡ç†
â””â”€â”€ ğŸ”— router_interfaces.go   # è·¯ç”±æ¥å£ï¼šUnifiedAggregatorRouteræ¥å£å®šä¹‰

ğŸ—‘ï¸  **å·²åˆ é™¤æˆ–è¿ç§»çš„æ–‡ä»¶ï¼ˆä¸šåŠ¡é€»è¾‘å·²è¿ç§»è‡³aggregatoræ¨¡å—ï¼‰**ï¼š
â”œâ”€â”€ ~~ğŸ”„ default_handler.go~~     # âŒ å·²åˆ é™¤ï¼šæ™ºèƒ½ä¸­ç»§å’Œç¯è·¯é¿å… â†’ aggregator
â”œâ”€â”€ ~~ğŸš€ relay_manager.go~~       # âŒ å·²åˆ é™¤ï¼šRelayHopLimitæ§åˆ¶å’ŒTTLç®¡ç† â†’ aggregator  
â”œâ”€â”€ ~~ğŸ“¤ fanout_controller.go~~   # âŒ å·²åˆ é™¤ï¼šå—æ§æ‰‡å‡ºå’Œå¹¶å‘ä¼˜åŒ– â†’ aggregator
â”œâ”€â”€ ~~â° ttl_cache.go~~           # âŒ å·²åˆ é™¤ï¼šåŸºäºblockHashçš„ç¯è·¯é¿å… â†’ aggregator
â””â”€â”€ ~~ğŸ” retry_handler.go~~       # âŒ å·²åˆ é™¤ï¼šé”™è¯¯é€€é¿å’Œæ™ºèƒ½é‡è¯• â†’ aggregator
```

ã€æ¶æ„ç»„ä»¶è®¾è®¡ã€‘

```mermaid
graph TB
    subgraph "å…±è¯†ç½‘ç»œé›†æˆå±‚æ¶æ„ (Consensus Network Integration)"
        subgraph "åè®®æ³¨å†Œä¸ç®¡ç†"
            PROTOCOLS["protocols.go<br/>å…±è¯†åè®®å¸¸é‡<br/>ç‰ˆæœ¬ç®¡ç†"]
            STREAM_H["stream_handlers.go<br/>æµå¼åè®®æ³¨å†Œ<br/>åŒºå—æäº¤åè®®"]
            SUB_H["subscribe_handlers.go<br/>è®¢é˜…åè®®æ³¨å†Œ<br/>å…±è¯†ç»“æœå¹¿æ’­"]
        end
        
        subgraph "ç»„ä»¶ç½‘ç»œå¤„ç†å™¨ (Target Handlers)"
            MINER_NH["miner/network/handler.go<br/>çŸ¿å·¥ç½‘ç»œå¤„ç†å™¨"]
            AGG_NH["aggregator/network/handler.go<br/>èšåˆå™¨ç½‘ç»œå¤„ç†å™¨"]
        end
        
        subgraph "ç»Ÿä¸€è·¯ç”±æ¥å£"
            UNIFIED_ROUTER["UnifiedAggregatorRouter<br/>HandleMinerBlockSubmission<br/>HandleConsensusHeartbeat"]
        end
        
        subgraph "å¤–éƒ¨ç³»ç»Ÿ"
            P2P_NET["P2P Network<br/>ç½‘ç»œåŸºç¡€è®¾æ–½"]
            NET_FACADE["Network Facade<br/>é€šç”¨ç½‘ç»œæ¥å£"]
        end
    end
    
    %% åè®®æ³¨å†Œæµç¨‹
    PROTOCOLS -.-> STREAM_H
    PROTOCOLS -.-> SUB_H
    STREAM_H --> NET_FACADE
    SUB_H --> NET_FACADE
    NET_FACADE --> P2P_NET
    
    %% æ¶ˆæ¯è·¯ç”±æµç¨‹  
    P2P_NET --> STREAM_H
    P2P_NET --> SUB_H
    STREAM_H --> UNIFIED_ROUTER
    SUB_H --> UNIFIED_ROUTER
    UNIFIED_ROUTER --> AGG_NH
    
    %% æ³¨æ„ï¼šMinerä¸ç›´æ¥æ¥æ”¶ç½‘ç»œæ¶ˆæ¯ï¼Œè€Œæ˜¯é€šè¿‡å†…éƒ¨æ¥å£æäº¤ç»™æœ¬åœ°Aggregator
    MINER_NH -.-> AGG_NH
    
    %% æ ·å¼
    style PROTOCOLS fill:#FFF3E0
    style STREAM_H fill:#E3F2FD
    style SUB_H fill:#E8F5E8
    style UNIFIED_ROUTER fill:#FFE0B2
    style MINER_NH fill:#F3E5F5
    style AGG_NH fill:#E0F2F1
```

### æ¶æ„å…³é”®ç‰¹ç‚¹

**ç³»ç»Ÿçº§ç½‘ç»œé›†æˆæ¨¡å¼**ï¼š
- é€šè¿‡ç»Ÿä¸€çš„UnifiedAggregatorRouteræ¥å£è¿›è¡Œåè®®è·¯ç”±
- ä¸»è¦æœåŠ¡aggregatoræ¨¡å—çš„ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼ˆåŒºå—æäº¤ã€å…±è¯†å¿ƒè·³ç­‰ï¼‰
- åŸºäºæ ‡å‡†åŒ–Routeræ¥å£å®ç°ç±»å‹å®‰å…¨çš„æ¶ˆæ¯åˆ†å‘

**è§’è‰²æ˜ç¡®çš„æ¶æ„è¾¹ç•Œ**ï¼š
- **Mineræ¨¡å—**ï¼šä¸ç›´æ¥å¤„ç†ç½‘ç»œæ¶ˆæ¯ï¼Œé€šè¿‡å†…éƒ¨æ¥å£æäº¤ç»™æœ¬åœ°AggregatoræœåŠ¡
- **Aggregatoræ¨¡å—**ï¼šå¤„ç†æ‰€æœ‰ç½‘ç»œæ¶ˆæ¯ï¼ˆåŒºå—æäº¤ã€å…±è¯†å¿ƒè·³ã€å†…å®¹å¯»å€è½¬å‘ç­‰ï¼‰
- **Integrationå±‚**ï¼šä»…è´Ÿè´£åè®®é€‚é…ï¼Œä¸åŒ…å«ABSä¸šåŠ¡é€»è¾‘

**âš ï¸ ~~æ™ºèƒ½ä¼ è¾“ä¼˜åŒ–~~ - å·²è¿ç§»è‡³aggregatoræ¨¡å—**ï¼š
- ~~å—æ§æ‰‡å‡º~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç½‘ç»œç­–ç•¥
- ~~TTLç¯è·¯é¿å…~~ï¼šâ†’ aggregatoræ¨¡å—çš„å†…å®¹å¯»å€é€»è¾‘  
- ~~é”™è¯¯é€€é¿~~ï¼šâ†’ aggregatoræ¨¡å—çš„é‡è¯•æœºåˆ¶

ã€ç³»ç»Ÿæ ¸å¿ƒç‰¹æ€§ã€‘

## ğŸš€ **~~æ™ºèƒ½ä¼ è¾“ç‰¹æ€§~~** âš ï¸ **å·²è¿ç§»è‡³aggregatoræ¨¡å—**

> **æ¶æ„å˜æ›´è¯´æ˜**ï¼šä»¥ä¸‹ä¼ è¾“ä¼˜åŒ–å’Œä¸­ç»§æ§åˆ¶åŠŸèƒ½å·²ä»Integrationå±‚è¿ç§»è‡³Aggregatorä¸šåŠ¡æ¨¡å—å®ç°ã€‚Integrationå±‚ç°åœ¨ä¸“æ³¨äºåè®®é€‚é…åŠŸèƒ½ã€‚

- ~~**å—æ§æ‰‡å‡ºæœºåˆ¶**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç½‘ç»œä¼ æ’­ç­–ç•¥
- ~~**é”™è¯¯é€€é¿ç­–ç•¥**~~ï¼šâ†’ aggregatoræ¨¡å—çš„é‡è¯•å’Œæ¢å¤æœºåˆ¶
- ~~**å¹¶å‘ä¼˜åŒ–**~~ï¼šâ†’ aggregatoræ¨¡å—çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥  
- ~~**æ€§èƒ½ç›‘æ§**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç›‘æ§å’Œç»Ÿè®¡

## ğŸ”„ **~~ä¸­ç»§æ§åˆ¶ç‰¹æ€§~~** âš ï¸ **å·²è¿ç§»è‡³aggregatoræ¨¡å—**

- ~~**è·³æ•°é™åˆ¶**~~ï¼šâ†’ aggregatoræ¨¡å—çš„è½¬å‘æ§åˆ¶é€»è¾‘
- ~~**æ™ºèƒ½è·¯ç”±**~~ï¼šâ†’ aggregatoræ¨¡å—çš„å†…å®¹å¯»å€å’ŒKademliaClosestPeerç®—æ³•
- ~~**è´Ÿè½½å‡è¡¡**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç½‘ç»œè´Ÿè½½ç®¡ç†
- ~~**æ–­å±‚é¿å…**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç½‘ç»œåˆ†åŒºå¤„ç†ç­–ç•¥

## ğŸ” **~~ç¯è·¯é¿å…ç‰¹æ€§~~** âš ï¸ **å·²è¿ç§»è‡³aggregatoræ¨¡å—**

- ~~**TTLè®°å½•**~~ï¼šâ†’ aggregatoræ¨¡å—çš„å†…å®¹å¯»å€å»é‡é€»è¾‘
- ~~**å“ˆå¸Œå»é‡**~~ï¼šâ†’ aggregatoræ¨¡å—çš„åŒºå—å“ˆå¸Œå»é‡æœºåˆ¶
- ~~**å†…å­˜ä¼˜åŒ–**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†
- ~~**å¹¶å‘å®‰å…¨**~~ï¼šâ†’ aggregatoræ¨¡å—çš„å¹¶å‘æ§åˆ¶æœºåˆ¶

## ğŸ“¡ **åè®®é€šä¿¡ç‰¹æ€§**
- **åŒé‡é€šä¿¡æ¨¡å¼**ï¼šè¯·æ±‚-å“åº”å’Œå‘å¸ƒ-è®¢é˜…çš„æ··åˆé€šä¿¡æœºåˆ¶
- **åè®®ç‰ˆæœ¬åŒ–**ï¼šç‰ˆæœ¬åŒ–åè®®IDå’Œä¸»é¢˜ï¼Œæ”¯æŒåè®®æ¼”è¿›
- **å‘åå…¼å®¹**ï¼šå¤šç‰ˆæœ¬åè®®çš„å¹³æ»‘åˆ‡æ¢å’Œå…¼å®¹æ€§å¤„ç†
- **èŠ‚ç‚¹ç±»å‹é€‚é…**ï¼šé’ˆå¯¹ä¸åŒèŠ‚ç‚¹ç±»å‹çš„å·®å¼‚åŒ–åè®®æ”¯æŒ

## ğŸ—ï¸ **æ¶æ„é›†æˆç‰¹æ€§**
- **æ¥å£æŠ½è±¡**ï¼šå®Œå…¨åŸºäºæ¥å£çš„è§£è€¦è®¾è®¡ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥
- **é…ç½®é©±åŠ¨**ï¼šå…¨é¢çš„é…ç½®å‚æ•°æ”¯æŒå’ŒåŠ¨æ€è°ƒæ•´èƒ½åŠ›
- **ç›‘æ§é›†æˆ**ï¼šå†…ç½®æŒ‡æ ‡æ”¶é›†ã€æ€§èƒ½ç›‘æ§ã€å¥åº·æ£€æŸ¥
- **æµ‹è¯•æ”¯æŒ**ï¼šMockæ¥å£æ”¯æŒã€å•å…ƒæµ‹è¯•å‹å¥½ã€åŸºå‡†æµ‹è¯•

## ğŸš€ **å—æ§æ‰‡å‡ºå®ç°æœºåˆ¶**

ã€æ™ºèƒ½æ‰‡å‡ºç­–ç•¥ã€‘

ã€€ã€€å—æ§æ‰‡å‡ºæ˜¯WESç½‘ç»œåè®®çš„æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥ï¼Œé€šè¿‡æ™ºèƒ½çš„ç›®æ ‡é€‰æ‹©ã€å¹¶å‘æ§åˆ¶å’Œèµ„æºç®¡ç†ï¼Œå®ç°é«˜æ•ˆã€å¯é çš„åŒºå—ä¼ è¾“ã€‚

### **æ‰‡å‡ºæ§åˆ¶ç®—æ³•**

```mermaid
graph TB
    subgraph "å—æ§æ‰‡å‡ºå®Œæ•´æµç¨‹"
        subgraph "ç›®æ ‡é€‰æ‹©é˜¶æ®µ"
            A[æ¥æ”¶åŒºå—ä¼ è¾“è¯·æ±‚] --> B[è®¡ç®—åŒºå—å“ˆå¸Œä½œä¸ºè·¯ç”±é”®]
            B --> C[Kæ¡¶æŸ¥è¯¢æœ€è¿‘èŠ‚ç‚¹åˆ—è¡¨]
            C --> D[è·å–å‰8ä¸ªæœ€è¿‘èŠ‚ç‚¹]
            D --> E[è¿‡æ»¤ä¸å¯è¾¾èŠ‚ç‚¹]
        end
        
        subgraph "æ‰‡å‡ºæ§åˆ¶é˜¶æ®µ"
            E --> F[åº”ç”¨å—æ§æ‰‡å‡ºç­–ç•¥]
            F --> G[é€‰æ‹©å‰Nä¸ªç›®æ ‡ï¼ˆé»˜è®¤2ä¸ªï¼‰]
            G --> H[æ£€æŸ¥èŠ‚ç‚¹åè®®å…¼å®¹æ€§]
            H --> I[æ„å»ºå¹¶å‘ä¼ è¾“ä»»åŠ¡]
        end
        
        subgraph "å¹¶å‘ä¼ è¾“é˜¶æ®µ"
            I --> J[å¯åŠ¨å¹¶å‘ä¼ è¾“åç¨‹]
            J --> K[å¹¶å‘è°ƒç”¨åŒºå—æäº¤åè®®]
            K --> L[ç›‘æ§ä¼ è¾“ç»“æœ]
            L --> M{ä»»ä¸€æˆåŠŸï¼Ÿ}
        end
        
        subgraph "ç»“æœå¤„ç†é˜¶æ®µ"
            M -->|æ˜¯| N[å–æ¶ˆå…¶ä»–ä¼ è¾“]
            M -->|å¦| O[é”™è¯¯é€€é¿å¤„ç†]
            N --> P[è¿”å›æˆåŠŸç»“æœ]
            O --> Q[é€‰æ‹©ä¸‹ä¸€æ‰¹ç›®æ ‡]
            Q --> G
        end
    end
    
    style B fill:#4CAF50
    style G fill:#FF9800
    style K fill:#2196F3
    style N fill:#9C27B0
```

#### **æ‰‡å‡ºç®—æ³•å®ç°**

```text
ç®—æ³•ï¼šæ™ºèƒ½å—æ§æ‰‡å‡ºä¼ è¾“
è¾“å…¥ï¼šåŒºå—æ•°æ® (blockData)ã€é…ç½®å‚æ•° (config)
è¾“å‡ºï¼šä¼ è¾“ç»“æœ (success/failure) å’Œ ç»Ÿè®¡ä¿¡æ¯ (stats)

1. ç›®æ ‡èŠ‚ç‚¹é€‰æ‹©ï¼š
   routing_key = SHA256(blockData.ParentHash)
   if routing_key == nil:
       routing_key = DefaultRoutingKey // [0x00...]
   
   candidates = KademliaMgr.FindClosestPeers(routing_key, 8)
   available_targets = FilterReachablePeers(candidates)
   
2. æ‰‡å‡ºæ§åˆ¶å‚æ•°ï¼š
   fanout_size = min(config.MaxFanout, len(available_targets))
   fanout_size = max(config.MinFanout, fanout_size)
   primary_targets = available_targets[0:fanout_size]
   
3. å¹¶å‘ä¼ è¾“æ‰§è¡Œï¼š
   results_chan = make(chan TransmissionResult, fanout_size)
   ctx, cancel = context.WithTimeout(parent_ctx, config.TransmissionTimeout)
   defer cancel()
   
   for _, target := range primary_targets:
       go func(target_peer Peer):
           result = CallBlockSubmissionProtocol(ctx, target_peer, blockData)
           results_chan <- TransmissionResult{
               Peer:      target_peer,
               Success:   result.Error == nil,
               Latency:   result.Duration,
               Error:     result.Error,
           }
       end()
   end
   
4. ç»“æœå¤„ç†é€»è¾‘ï¼š
   success_count = 0
   for i in range(fanout_size):
       result = <-results_chan
       if result.Success:
           success_count++
           cancel() // å–æ¶ˆå…¶ä»–ä¼ è¾“
           return Success(result)
       end
   end
   
   // å¦‚æœæ‰€æœ‰ä¼ è¾“éƒ½å¤±è´¥
   if success_count == 0:
       return ApplyErrorBackoff(available_targets[fanout_size:])
   end
```

### **å¹¶å‘ä¼˜åŒ–ç­–ç•¥**

```text
é«˜æ€§èƒ½å¹¶å‘ä¼ è¾“ï¼šç¡®ä¿ç½‘ç»œèµ„æºçš„é«˜æ•ˆåˆ©ç”¨

1. åç¨‹æ± ç®¡ç†ï¼š
   - é¢„åˆ†é…åç¨‹æ± ï¼šé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯åç¨‹çš„å¼€é”€
   - åç¨‹æ•°é‡é™åˆ¶ï¼šæœ€å¤§å¹¶å‘æ•°ä¸è¶…è¿‡CPUæ ¸å¿ƒæ•°*4
   - ä¼˜é›…å…³é—­ï¼šä¼ è¾“å®Œæˆåæ­£ç¡®æ¸…ç†åç¨‹èµ„æº

2. è¿æ¥å¤ç”¨ç­–ç•¥ï¼š
   - é•¿è¿æ¥ç»´æŠ¤ï¼šå¤ç”¨å·²å»ºç«‹çš„ç½‘ç»œè¿æ¥
   - è¿æ¥æ± ç®¡ç†ï¼šç»´æŠ¤åˆ°å¸¸ç”¨èŠ‚ç‚¹çš„è¿æ¥æ± 
   - ç©ºé—²æ£€æµ‹ï¼šå®šæœŸæ£€æµ‹å’Œæ¸…ç†ç©ºé—²è¿æ¥

3. å†…å­˜ç®¡ç†ä¼˜åŒ–ï¼š
   - é›¶æ‹·è´ä¼ è¾“ï¼šå°½å¯èƒ½é¿å…ä¸å¿…è¦çš„æ•°æ®æ‹·è´
   - ç¼“å†²åŒºå¤ç”¨ï¼šå¤ç”¨åºåˆ—åŒ–å’Œç½‘ç»œç¼“å†²åŒº
   - å†…å­˜æ³„æ¼é˜²æŠ¤ï¼šç¡®ä¿æ‰€æœ‰åç¨‹æ­£ç¡®é‡Šæ”¾èµ„æº

4. èƒŒå‹æ§åˆ¶æœºåˆ¶ï¼š
   - é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼šä¼ è¾“é˜Ÿåˆ—æœ€å¤§1000ä¸ªä»»åŠ¡
   - æµé‡æ§åˆ¶ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ä¼ è¾“é€Ÿåº¦
   - è¿‡è½½ä¿æŠ¤ï¼šç³»ç»Ÿè¿‡è½½æ—¶ä¸»åŠ¨æ‹’ç»æ–°çš„ä¼ è¾“è¯·æ±‚
```

## â° **é”™è¯¯é€€é¿ç­–ç•¥å®ç°**

ã€æ™ºèƒ½é‡è¯•æœºåˆ¶ã€‘

### **é”™è¯¯åˆ†ç±»å¤„ç†**

```mermaid
graph TB
    subgraph "é”™è¯¯åˆ†ç±»å’Œé€€é¿ç­–ç•¥"
        subgraph "é”™è¯¯æ£€æµ‹é˜¶æ®µ"
            A[ä¼ è¾“å¤±è´¥] --> B{é”™è¯¯ç±»å‹åˆ†æ}
            B -->|ç½‘ç»œé”™è¯¯| C[ç½‘ç»œè¿æ¥å¤±è´¥]
            B -->|åè®®é”™è¯¯| D[åè®®ä¸æ”¯æŒ]
            B -->|ä¸šåŠ¡é”™è¯¯| E[ä¸šåŠ¡å¤„ç†å¤±è´¥]
            B -->|è¶…æ—¶é”™è¯¯| F[è¯·æ±‚å“åº”è¶…æ—¶]
        end
        
        subgraph "é€€é¿ç­–ç•¥é€‰æ‹©"
            C --> G[çº¿æ€§é€€é¿ç­–ç•¥]
            D --> H[èŠ‚ç‚¹åˆ‡æ¢ç­–ç•¥]
            E --> I[ä¸šåŠ¡é‡è¯•ç­–ç•¥]
            F --> J[æŒ‡æ•°é€€é¿ç­–ç•¥]
        end
        
        subgraph "é‡è¯•æ‰§è¡Œé˜¶æ®µ"
            G --> K[ç­‰å¾…1såé‡è¯•]
            H --> L[åˆ‡æ¢åˆ°ä¸‹ä¸ªèŠ‚ç‚¹]
            I --> M[å»¶è¿Ÿ2såé‡è¯•]
            J --> N[æŒ‡æ•°å»¶è¿Ÿé‡è¯•]
        end
        
        subgraph "ç»“æœè¯„ä¼°é˜¶æ®µ"
            K --> O{é‡è¯•æˆåŠŸï¼Ÿ}
            L --> O
            M --> O
            N --> O
            O -->|æ˜¯| P[è¿”å›æˆåŠŸç»“æœ]
            O -->|å¦| Q{è¾¾åˆ°æœ€å¤§é‡è¯•ï¼Ÿ}
            Q -->|å¦| R[ç»§ç»­ä¸‹ä¸€è½®é‡è¯•]
            Q -->|æ˜¯| S[è¿”å›æœ€ç»ˆå¤±è´¥]
            R --> G
        end
    end
    
    style B fill:#4CAF50
    style J fill:#FF9800
    style O fill:#2196F3
    style S fill:#F44336
```

#### **é€€é¿ç®—æ³•å®ç°**

```text
ç®—æ³•ï¼šæ™ºèƒ½é”™è¯¯é€€é¿å’Œé‡è¯•
è¾“å…¥ï¼šé”™è¯¯ä¿¡æ¯ (error)ã€é‡è¯•é…ç½® (retryConfig)
è¾“å‡ºï¼šé‡è¯•å†³ç­– (retryDecision) å’Œ å»¶è¿Ÿæ—¶é—´ (backoffDelay)

1. é”™è¯¯åˆ†ç±»è¯†åˆ«ï¼š
   error_type = ClassifyError(error)
   switch error_type:
       case NetworkError:      // ç½‘ç»œè¿æ¥é”™è¯¯
           strategy = LinearBackoff
           base_delay = 1 * time.Second
       case ProtocolError:     // åè®®ä¸æ”¯æŒé”™è¯¯
           strategy = NodeSwitch  
           base_delay = 0 * time.Second
       case BusinessError:     // ä¸šåŠ¡é€»è¾‘é”™è¯¯
           strategy = BusinessRetry
           base_delay = 2 * time.Second
       case TimeoutError:      // è¯·æ±‚è¶…æ—¶é”™è¯¯
           strategy = ExponentialBackoff
           base_delay = 1 * time.Second
       default:
           strategy = ExponentialBackoff
           base_delay = 2 * time.Second

2. é€€é¿å»¶è¿Ÿè®¡ç®—ï¼š
   switch strategy:
       case LinearBackoff:
           delay = base_delay * attempt_count
           delay = min(delay, max_linear_delay) // æœ€å¤§10ç§’
       
       case ExponentialBackoff:
           delay = base_delay * pow(2, attempt_count-1)
           delay = min(delay, max_exponential_delay) // æœ€å¤§60ç§’
           delay += random_jitter(0, delay*0.1) // 10%æŠ–åŠ¨
       
       case BusinessRetry:
           delay = base_delay + random_jitter(0, 1*time.Second)
       
       case NodeSwitch:
           delay = 0 // ç«‹å³åˆ‡æ¢èŠ‚ç‚¹

3. é‡è¯•æ¡ä»¶æ£€æŸ¥ï¼š
   if attempt_count >= retryConfig.MaxRetryAttempts:
       return NoRetry, 0
   
   if strategy == NodeSwitch:
       if len(remaining_targets) == 0:
           return NoRetry, 0
       next_target = remaining_targets[0]
       remaining_targets = remaining_targets[1:]
       return SwitchNode(next_target), 0
   
   return RetryWithDelay, delay

4. é‡è¯•çŠ¶æ€ç®¡ç†ï¼š
   retry_state = RetryState{
       AttemptCount:     attempt_count + 1,
       LastError:       error,
       LastAttemptTime: time.Now(),
       Strategy:        strategy,
       RemainingTargets: remaining_targets,
   }
   
   return retry_state
```

### **é‡è¯•ç­–ç•¥ä¼˜åŒ–**

```text
å¤šç»´åº¦é‡è¯•ä¼˜åŒ–ï¼šæé«˜ä¼ è¾“æˆåŠŸç‡å’Œç³»ç»Ÿç¨³å®šæ€§

1. è‡ªé€‚åº”é€€é¿ï¼š
   - ç½‘ç»œçŠ¶å†µæ„ŸçŸ¥ï¼šæ ¹æ®ç½‘ç»œè´¨é‡åŠ¨æ€è°ƒæ•´é€€é¿ç­–ç•¥
   - æˆåŠŸç‡ç»Ÿè®¡ï¼šåŸºäºå†å²æˆåŠŸç‡ä¼˜åŒ–é‡è¯•å‚æ•°
   - è´Ÿè½½å‡è¡¡ï¼šåœ¨å¤šä¸ªç›®æ ‡èŠ‚ç‚¹é—´å‡è¡¡åˆ†å¸ƒé‡è¯•è¯·æ±‚

2. æ™ºèƒ½èŠ‚ç‚¹é€‰æ‹©ï¼š
   - èŠ‚ç‚¹è´¨é‡è¯„åˆ†ï¼šç»´æŠ¤èŠ‚ç‚¹çš„å¯è¾¾æ€§å’Œå“åº”é€Ÿåº¦è¯„åˆ†
   - é»‘åå•æœºåˆ¶ï¼šæš‚æ—¶æ’é™¤è¿ç»­å¤±è´¥çš„èŠ‚ç‚¹
   - åŠ¨æ€æ›´æ–°ï¼šå®šæœŸæ›´æ–°èŠ‚ç‚¹è´¨é‡è¯„åˆ†å’Œå¯è¾¾æ€§çŠ¶æ€

3. èµ„æºä¿æŠ¤æœºåˆ¶ï¼š
   - é‡è¯•é™æµï¼šé™åˆ¶åŒæ—¶è¿›è¡Œçš„é‡è¯•è¯·æ±‚æ•°é‡
   - ç†”æ–­ä¿æŠ¤ï¼šè¿ç»­å¤±è´¥æ—¶è§¦å‘ç†”æ–­ï¼Œæš‚åœé‡è¯•
   - ä¼˜é›…é™çº§ï¼šç³»ç»Ÿè¿‡è½½æ—¶é™ä½é‡è¯•é¢‘ç‡å’Œæ¬¡æ•°

4. ç»Ÿè®¡ç›‘æ§ï¼š
   - é‡è¯•æˆåŠŸç‡ï¼šæŒ‰é”™è¯¯ç±»å‹ç»Ÿè®¡é‡è¯•æˆåŠŸç‡
   - å»¶è¿Ÿåˆ†å¸ƒï¼šè®°å½•ä¸åŒé€€é¿ç­–ç•¥çš„å»¶è¿Ÿåˆ†å¸ƒ
   - èµ„æºä½¿ç”¨ï¼šç›‘æ§é‡è¯•è¿‡ç¨‹çš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ
```

## ğŸ” **åŸºäºblockHashçš„TTLè®°å½•æœºåˆ¶**

ã€è½»é‡çº§ç¯è·¯é¿å…ã€‘

### **TTLç¼“å­˜è®¾è®¡**

```mermaid
graph TB
    subgraph "TTLç¼“å­˜å®Œæ•´æ¶æ„"
        subgraph "TTL Keyç”Ÿæˆå±‚"
            A[æ¥æ”¶åŒºå—æ•°æ®] --> B[è®¡ç®—åŒºå—å“ˆå¸Œ]
            B --> C["ç”ŸæˆTTL Key: relay:blockHash"]
            C --> D[å“ˆå¸Œæˆªæ–­ä¼˜åŒ–]
        end
        
        subgraph "ç¼“å­˜æŸ¥è¯¢å±‚"
            D --> E[æŸ¥è¯¢TTLç¼“å­˜]
            E --> F{ç¼“å­˜å‘½ä¸­ï¼Ÿ}
            F -->|å‘½ä¸­| G[è¿”å›é‡å¤æ ‡è¯†]
            F -->|æœªå‘½ä¸­| H[ç»§ç»­å¤„ç†æµç¨‹]
        end
        
        subgraph "ç¼“å­˜å­˜å‚¨å±‚"
            H --> I[è®°å½•TTLæ¡ç›®]
            I --> J[è®¾ç½®è¿‡æœŸæ—¶é—´]
            J --> K[æ›´æ–°ç»Ÿè®¡ä¿¡æ¯]
            K --> L[è§¦å‘æ¸…ç†æ£€æŸ¥]
        end
        
        subgraph "ç¼“å­˜æ¸…ç†å±‚"
            L --> M{éœ€è¦æ¸…ç†ï¼Ÿ}
            M -->|æ˜¯| N[æ‰§è¡Œè¿‡æœŸæ¸…ç†]
            M -->|å¦| O[ç»§ç»­æ­£å¸¸è¿è¡Œ]
            N --> P[LRUæ·˜æ±°æ£€æŸ¥]
            P --> Q[æ›´æ–°ç¼“å­˜ç»Ÿè®¡]
        end
    end
    
    style C fill:#4CAF50
    style F fill:#FF9800
    style I fill:#2196F3
    style N fill:#9C27B0
```

#### **TTLç®¡ç†ç®—æ³•**

```text
ç®—æ³•ï¼šåŸºäºblockHashçš„TTLè®°å½•ç®¡ç†
è¾“å…¥ï¼šåŒºå—æ•°æ® (blockData)ã€TTLé…ç½® (ttlConfig)
è¾“å‡ºï¼šé‡å¤æ£€æµ‹ç»“æœ (isDuplicate) å’Œ ç¼“å­˜æ›´æ–° (cacheUpdate)

1. TTL Keyç”Ÿæˆï¼š
   block_hash = SHA256(blockData.Serialize())
   // ä½¿ç”¨å‰16å­—èŠ‚ä½œä¸ºkeyï¼Œå‡å°‘å†…å­˜å ç”¨
   ttl_key = "relay:" + hex.EncodeToString(block_hash[:16])
   
   // å¯é€‰ï¼šæ·»åŠ æ—¶é—´çª—å£åˆ°keyä¸­ï¼Œå¢å¼ºå»é‡ç²¾åº¦
   time_window = time.Now().Unix() / ttlConfig.WindowSize
   ttl_key = ttl_key + ":" + strconv.FormatInt(time_window, 10)

2. é‡å¤æ£€æµ‹æŸ¥è¯¢ï¼š
   cache_entry, exists = TTLCache.Get(ttl_key)
   if exists:
       if cache_entry.ExpiryTime > time.Now().Unix():
           // ç¼“å­˜æœªè¿‡æœŸï¼Œç¡®è®¤ä¸ºé‡å¤
           cache_entry.HitCount++
           TTLCache.UpdateStats(ttl_key, cache_entry)
           return Duplicate, nil
       else:
           // ç¼“å­˜å·²è¿‡æœŸï¼Œåˆ é™¤è¿‡æœŸæ¡ç›®
           TTLCache.Delete(ttl_key)
       end
   end
   
3. ç¼“å­˜æ¡ç›®åˆ›å»ºï¼š
   new_entry = TTLCacheEntry{
       Key:        ttl_key,
       BlockHash:  block_hash,
       CreatedAt:  time.Now().Unix(),
       ExpiryTime: time.Now().Unix() + ttlConfig.ExpiryDuration,
       HitCount:   1,
       NodeID:     local_node_id,
   }
   
4. ç¼“å­˜å­˜å‚¨ç®¡ç†ï¼š
   // æ£€æŸ¥ç¼“å­˜å®¹é‡
   if TTLCache.Size() >= ttlConfig.MaxCacheSize:
       evicted_count = TTLCache.EvictLRU(ttlConfig.EvictBatchSize)
       UpdateEvictionStats(evicted_count)
   end
   
   // å­˜å‚¨æ–°çš„TTLæ¡ç›®
   TTLCache.Set(ttl_key, new_entry)
   UpdateInsertionStats()
   
   return NotDuplicate, new_entry

5. åå°æ¸…ç†ä»»åŠ¡ï¼š
   // å®šæœŸæ‰§è¡Œçš„æ¸…ç†ä»»åŠ¡
   cleanup_task():
       expired_keys = []
       TTLCache.Range(func(key, entry) bool:
           if entry.ExpiryTime <= time.Now().Unix():
               expired_keys = append(expired_keys, key)
           end
           return true // ç»§ç»­éå†
       end)
       
       for _, key := range expired_keys:
           TTLCache.Delete(key)
       end
       
       UpdateCleanupStats(len(expired_keys))
```

### **ç¼“å­˜ä¼˜åŒ–ç­–ç•¥**

```text
é«˜æ•ˆTTLç¼“å­˜å®ç°ï¼šå¹³è¡¡æ€§èƒ½ã€å†…å­˜ä½¿ç”¨å’Œå‡†ç¡®æ€§

1. å†…å­˜ä¼˜åŒ–è®¾è®¡ï¼š
   - å“ˆå¸Œæˆªæ–­ï¼šä½¿ç”¨åŒºå—å“ˆå¸Œå‰16å­—èŠ‚ä½œä¸ºkeyï¼Œå‡å°‘50%å†…å­˜
   - ç´§å‡‘å­˜å‚¨ï¼šä½¿ç”¨ä½å‹ç¼©å­˜å‚¨æ—¶é—´æˆ³å’Œè®¡æ•°å™¨
   - é¢„åˆ†é…ï¼šé¢„å…ˆåˆ†é…ç¼“å­˜ç©ºé—´ï¼Œé¿å…é¢‘ç¹å†…å­˜åˆ†é…
   - å†…å­˜æ± ï¼šå¤ç”¨TTLCacheEntryå¯¹è±¡ï¼Œå‡å°‘GCå‹åŠ›

2. å¹¶å‘å®‰å…¨æœºåˆ¶ï¼š
   - è¯»å†™åˆ†ç¦»é”ï¼šä½¿ç”¨sync.RWMutexå®ç°è¯»å¤šå†™å°‘ä¼˜åŒ–
   - æ— é”è¯»å–ï¼šå¯¹äºåªè¯»æ“ä½œä½¿ç”¨atomicæ“ä½œé¿å…é”ç«äº‰
   - åˆ†æ®µé”ï¼šå¤§å®¹é‡ç¼“å­˜ä½¿ç”¨åˆ†æ®µé”å‡å°‘é”ç«äº‰
   - åŸå­è®¡æ•°ï¼šä½¿ç”¨atomicåŒ…å®ç°çº¿ç¨‹å®‰å…¨çš„ç»Ÿè®¡è®¡æ•°

3. ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼š
   - LRUç®—æ³•ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ¡ç›®ä¼˜å…ˆæ·˜æ±°
   - æ‰¹é‡æ·˜æ±°ï¼šæ¯æ¬¡æ·˜æ±°å¤šä¸ªæ¡ç›®ï¼Œå‡å°‘æ·˜æ±°é¢‘ç‡
   - æ—¶é—´çª—å£ï¼šç»“åˆæ—¶é—´çª—å£å’ŒLRUçš„æ··åˆæ·˜æ±°ç­–ç•¥
   - å®¹é‡é˜ˆå€¼ï¼šè¾¾åˆ°80%å®¹é‡æ—¶è§¦å‘ä¸»åŠ¨æ·˜æ±°

4. æ€§èƒ½ç›‘æ§æŒ‡æ ‡ï¼š
   - ç¼“å­˜å‘½ä¸­ç‡ï¼šç›‘æ§TTLç¼“å­˜çš„å‘½ä¸­ç‡å’Œæœ‰æ•ˆæ€§
   - å†…å­˜ä½¿ç”¨ç‡ï¼šå®æ—¶ç›‘æ§ç¼“å­˜å†…å­˜å ç”¨å’Œå¢é•¿è¶‹åŠ¿
   - æ¸…ç†æ•ˆç‡ï¼šç»Ÿè®¡è¿‡æœŸæ¸…ç†å’ŒLRUæ·˜æ±°çš„æ‰§è¡Œæ•ˆç‡
   - å¹¶å‘æ€§èƒ½ï¼šç›‘æ§ç¼“å­˜æ“ä½œçš„å»¶è¿Ÿå’Œååé‡
```

ã€å·¥ä½œæµç¨‹ã€‘

## åè®®æ³¨å†Œæµç¨‹

```mermaid
graph TB
    A[å¯åŠ¨æ³¨å†Œ] --> B{ç½‘ç»œæœåŠ¡å¯ç”¨?}
    B -->|å¦| C[è·³è¿‡æ³¨å†Œ]
    B -->|æ˜¯| D[æ³¨å†Œæµå¼åè®®]
    D --> E[æ³¨å†Œè®¢é˜…åè®®]
    E --> F[ç­‰å¾…ç½‘ç»œåŒæ­¥]
    F --> G[æ³¨å†Œå®Œæˆ]
    
    style A fill:#E3F2FD
    style G fill:#4CAF50
    style C fill:#FFCDD2
```

## æ¶ˆæ¯å¤„ç†æµç¨‹

1. **æ¶ˆæ¯æ¥æ”¶**ï¼šç½‘ç»œæœåŠ¡æ¥æ”¶åˆ°åè®®æ¶ˆæ¯
2. **åè®®è¯†åˆ«**ï¼šæ ¹æ®åè®®IDæˆ–ä¸»é¢˜è¯†åˆ«æ¶ˆæ¯ç±»å‹
3. **è·¯ç”±æŸ¥æ‰¾**ï¼šæŸ¥æ‰¾å¯¹åº”çš„ä¸šåŠ¡è·¯ç”±å™¨æ¥å£
4. **æ¶ˆæ¯é€‚é…**ï¼šå°†ç½‘ç»œæ¶ˆæ¯æ ¼å¼é€‚é…ä¸ºæ¥å£å‚æ•°
5. **ä¸šåŠ¡è°ƒç”¨**ï¼šè°ƒç”¨ä¸šåŠ¡è·¯ç”±å™¨å¤„ç†å…·ä½“é€»è¾‘
6. **ç»“æœè¿”å›**ï¼šå°†å¤„ç†ç»“æœè¿”å›ç»™ç½‘ç»œå±‚

ã€å¤–éƒ¨æ¥å£ã€‘

## ç»Ÿä¸€è·¯ç”±å™¨æ¥å£

### UnifiedAggregatorRouter

å…±è¯†ç³»ç»Ÿç»Ÿä¸€çš„ä¸šåŠ¡è·¯ç”±å™¨æ¥å£ï¼Œä¸»è¦æœåŠ¡aggregatoræ¨¡å—ï¼š

```go
type UnifiedAggregatorRouter interface {
    // å¤„ç†çŸ¿å·¥åŒºå—æäº¤ï¼ˆåŒ…æ‹¬æœ¬åœ°æäº¤å’Œè¿œç¨‹è½¬å‘ï¼‰
    HandleMinerBlockSubmission(ctx context.Context, from peer.ID, reqBytes []byte) ([]byte, error)
    
    // å¤„ç†å…±è¯†å¿ƒè·³æ¶ˆæ¯
    HandleConsensusHeartbeat(ctx context.Context, from peer.ID, reqBytes []byte) ([]byte, error)
}
```

**æ–¹æ³•è¯´æ˜**ï¼š

**HandleMinerBlockSubmission**ï¼š
- `ctx`: è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œç”¨äºè¶…æ—¶å’Œå–æ¶ˆæ§åˆ¶
- `from`: å‘é€æ–¹çš„å¯¹ç­‰èŠ‚ç‚¹ID  
- `reqBytes`: åºåˆ—åŒ–çš„åŒºå—æäº¤è¯·æ±‚æ•°æ®
- è¿”å›å€¼: å¤„ç†ç»“æœçš„åºåˆ—åŒ–æ•°æ®å’Œé”™è¯¯ä¿¡æ¯

**HandleConsensusHeartbeat**ï¼š
- `ctx`: æ¶ˆæ¯å¤„ç†ä¸Šä¸‹æ–‡
- `from`: å‘é€æ–¹çš„å¯¹ç­‰èŠ‚ç‚¹ID
- `reqBytes`: åºåˆ—åŒ–çš„å¿ƒè·³æ•°æ®
- è¿”å›å€¼: å¤„ç†ç»“æœçš„åºåˆ—åŒ–æ•°æ®å’Œé”™è¯¯ä¿¡æ¯

**å®ç°è€…**: èšåˆå™¨æ¨¡å— (`aggregator` åŒ…)

## æ³¨å†Œå‡½æ•°

### RegisterStreamHandlers

æ³¨å†Œæ‰€æœ‰æµå¼åè®®å¤„ç†å™¨ï¼š

```go
func RegisterStreamHandlers(
    network netiface.Network,
    router UnifiedAggregatorRouter,
    logger log.Logger,
) error
```

### RegisterSubscribeHandlers

æ³¨å†Œæ‰€æœ‰è®¢é˜…åè®®å¤„ç†å™¨ï¼š

```go
func RegisterSubscribeHandlers(
    network netiface.Network,
    router UnifiedAggregatorRouter,
    logger log.Logger,
) error
```

## ğŸ”§ **å…³é”®é…ç½®å‚æ•°**

ã€ç½‘ç»œé›†æˆæ ¸å¿ƒé…ç½®ã€‘

ã€€ã€€ç½‘ç»œé›†æˆæ¨¡å—ä¸“æ³¨äºåè®®é€‚é…å±‚é…ç½®ï¼Œæä¾›åè®®æ³¨å†Œã€ç‰ˆæœ¬ç®¡ç†å’Œè·¯ç”±é…ç½®æ”¯æŒã€‚ä¸šåŠ¡ç­–ç•¥ç›¸å…³é…ç½®å·²è¿ç§»è‡³aggregatoræ¨¡å—ã€‚

**åè®®é€‚é…é…ç½®è¦ç‚¹ï¼š**
- **åè®®æ ‡è¯†é…ç½®**ï¼šæ ‡å‡†åŒ–çš„åè®®IDå’Œç‰ˆæœ¬å·ç®¡ç†
- **è·¯ç”±æ¥å£é…ç½®**ï¼šUnifiedAggregatorRouteræ¥å£æ³¨å†Œå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **åºåˆ—åŒ–é…ç½®**ï¼šprotobufæ¶ˆæ¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‚æ•°

**âš ï¸ ~~å—æ§æ‰‡å‡ºé…ç½®~~ - å·²è¿ç§»è‡³aggregatoræ¨¡å—**ï¼š
- ~~æ‰‡å‡ºæ•°é‡é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç½‘ç»œä¼ æ’­ç­–ç•¥
- ~~ä¼ è¾“æ§åˆ¶é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„æ€§èƒ½æ§åˆ¶å‚æ•°
- ~~ä¼˜åŒ–ç­–ç•¥é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„è´Ÿè½½å‡è¡¡å’Œè·¯ç”±ç­–ç•¥

**âš ï¸ ~~é”™è¯¯é€€é¿é…ç½®~~ - å·²è¿ç§»è‡³aggregatoræ¨¡å—**ï¼š
- ~~é‡è¯•ç­–ç•¥é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„é‡è¯•å’Œæ¢å¤æœºåˆ¶
- ~~å»¶è¿Ÿæ§åˆ¶é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„å»¶è¿Ÿæ§åˆ¶ç­–ç•¥
- ~~æ™ºèƒ½é€‚åº”é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„åŠ¨æ€é”™è¯¯å¤„ç†

**âš ï¸ ~~TTLç¼“å­˜é…ç½®~~ - å·²è¿ç§»è‡³aggregatoræ¨¡å—**ï¼š
- ~~å®¹é‡ç®¡ç†é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç¼“å­˜ç®¡ç†ç­–ç•¥
- ~~ä¼˜åŒ–ç­–ç•¥é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- ~~æ—¶é—´çª—å£é…ç½®~~ï¼šâ†’ aggregatoræ¨¡å—çš„å»é‡æ—¶é—´çª—å£

**ç³»ç»Ÿé›†æˆé…ç½®è¦ç‚¹ï¼š**
- **åè®®ç‰ˆæœ¬ç®¡ç†**ï¼šåè®®ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥å’Œåˆ‡æ¢ç®¡ç†
- **è·¯ç”±æ¥å£ç®¡ç†**ï¼šUnifiedAggregatorRouteræ¥å£ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **é”™è¯¯å¤„ç†é…ç½®**ï¼šç½‘ç»œå±‚é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•é…ç½®

## ğŸ“Š **~~æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§~~** âš ï¸ **å·²ç®€åŒ–ä¸ºåè®®é€‚é…ç›‘æ§**

ã€åè®®é€‚é…ç›‘æ§æŒ‡æ ‡ã€‘
- **åè®®æ³¨å†Œæ€§èƒ½**ï¼šåè®®æ³¨å†ŒæˆåŠŸç‡ã€æ¥å£è°ƒç”¨å»¶è¿Ÿã€ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥æ•ˆæœ
- **æ¶ˆæ¯åºåˆ—åŒ–æ€§èƒ½**ï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–å»¶è¿Ÿã€æ¶ˆæ¯æ ¼å¼è½¬æ¢æˆåŠŸç‡
- **è·¯ç”±è½¬å‘æ€§èƒ½**ï¼šè·¯ç”±è½¬å‘å»¶è¿Ÿã€UnifiedAggregatorRouterè°ƒç”¨æˆåŠŸç‡

ã€âš ï¸ å·²è¿ç§»è‡³aggregatoræ¨¡å—çš„ç›‘æ§æŒ‡æ ‡ã€‘
- ~~**æ‰‡å‡ºæ•ˆç‡**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç½‘ç»œä¼ æ’­ç›‘æ§
- ~~**é‡è¯•ç»Ÿè®¡**~~ï¼šâ†’ aggregatoræ¨¡å—çš„é‡è¯•æœºåˆ¶ç›‘æ§  
- ~~**TTLç¼“å­˜**~~ï¼šâ†’ aggregatoræ¨¡å—çš„ç¼“å­˜æ€§èƒ½ç›‘æ§
- ~~**ä¸­ç»§æ€§èƒ½**~~ï¼šâ†’ aggregatoræ¨¡å—çš„è½¬å‘æ§åˆ¶ç›‘æ§

ã€å¯è§‚æµ‹æ€§æ”¯æŒã€‘
- **ç»“æ„åŒ–æ—¥å¿—**ï¼šè¯¦ç»†çš„åè®®äº¤äº’æ—¥å¿—ã€ä¼ è¾“è¿‡ç¨‹è¿½è¸ªã€é”™è¯¯åˆ†ç±»è®°å½•
- **æ€§èƒ½æŒ‡æ ‡**ï¼šå®æ—¶æ€§èƒ½æ•°æ®æ”¶é›†ã€ç›‘æ§å¤§ç›˜å±•ç¤ºã€è¶‹åŠ¿åˆ†æ
- **å¥åº·æ£€æŸ¥**ï¼šåè®®çŠ¶æ€æ£€æŸ¥ã€ç¼“å­˜å¥åº·ç›‘æ§ã€ç½‘ç»œè¿æ¥çŠ¶æ€æ£€æµ‹
- **è°ƒè¯•æ¥å£**ï¼šè¿è¡Œæ—¶çŠ¶æ€æŸ¥è¯¢ã€é…ç½®å‚æ•°è°ƒæ•´ã€ç»Ÿè®¡æ•°æ®å¯¼å‡º

ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‘
- **ä¼ è¾“ä¼˜åŒ–**ï¼šé›¶æ‹·è´æ•°æ®ä¼ è¾“ã€è¿æ¥å¤ç”¨ã€æ‰¹é‡å¤„ç†ã€å¼‚æ­¥å¹¶å‘
- **å†…å­˜ä¼˜åŒ–**ï¼šå¯¹è±¡æ± å¤ç”¨ã€ç¼“å†²åŒºç®¡ç†ã€å†…å­˜é¢„åˆ†é…ã€GCä¼˜åŒ–
- **ç½‘ç»œä¼˜åŒ–**ï¼šè¿æ¥æ± ç®¡ç†ã€åè®®å¤ç”¨ã€å‹ç¼©ä¼ è¾“ã€èƒŒå‹æ§åˆ¶
- **ç®—æ³•ä¼˜åŒ–**ï¼šé«˜æ•ˆå“ˆå¸Œè®¡ç®—ã€LRUç¼“å­˜å®ç°ã€æ— é”å¹¶å‘ã€æ‰¹é‡æ“ä½œ

## ğŸ—ï¸ **ä¾èµ–æ³¨å…¥æ¶æ„**

ã€fxæ¡†æ¶é›†æˆã€‘

ã€€ã€€å…¨é¢é‡‡ç”¨fxä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œå®ç°ç½‘ç»œåè®®é€‚é…ç³»ç»Ÿç»„ä»¶é—´çš„æ¾è€¦åˆå’Œç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†ã€‚é€šè¿‡æ¨¡å—åŒ–çš„ç»„ä»¶æ³¨å†Œå’Œåè®®å¤„ç†å™¨è‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œç¡®ä¿ç½‘ç»œé€‚é…å±‚çš„é«˜æ•ˆè¿è¡Œã€‚

**ä¾èµ–ç®¡ç†ç‰¹ç‚¹ï¼š**
- **ç»„ä»¶åŒ–è®¾è®¡**ï¼šå°†ç½‘ç»œåŠŸèƒ½åˆ†è§£ä¸ºæµå¼å¤„ç†å™¨ã€è®¢é˜…å¤„ç†å™¨ã€æ‰‡å‡ºæ§åˆ¶å™¨ç­‰ä¸“é—¨ç»„ä»¶
- **è‡ªåŠ¨åè®®æ³¨å†Œ**ï¼šé€šè¿‡fx.Invokeè‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ç½‘ç»œåè®®å¤„ç†å™¨
- **èŠ‚ç‚¹ç±»å‹é€‚é…**ï¼šåŸºäºèŠ‚ç‚¹ç±»å‹çš„å·®å¼‚åŒ–åè®®å¤„ç†å’ŒæœåŠ¡
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä¸å…±è¯†æ ¸å¿ƒæ¨¡å—ç”Ÿå‘½å‘¨æœŸå®Œå…¨åŒæ­¥

ã€èŠ‚ç‚¹ç±»å‹é€‚é…ç­–ç•¥ã€‘

ã€€ã€€ç½‘ç»œé€‚é…å±‚æ”¯æŒå¤šç§èŠ‚ç‚¹ç±»å‹çš„å·®å¼‚åŒ–åè®®é…ç½®ï¼Œé€šè¿‡è‡ªåŠ¨æ£€æµ‹å’Œé€‚é…æœºåˆ¶ï¼Œä¸ºä¸åŒç±»å‹èŠ‚ç‚¹æä¾›æœ€ä¼˜çš„ç½‘ç»œåè®®æ”¯æŒã€‚

**èŠ‚ç‚¹é€‚é…ç­–ç•¥ï¼š**
- **çŸ¿å·¥èŠ‚ç‚¹é€‚é…**ï¼šå¯ç”¨åŒºå—æäº¤å®¢æˆ·ç«¯ã€è®¢é˜…æœ€æ–°åŒºå—ã€ç¦ç”¨ä¸­ç»§åŠŸèƒ½
- **èšåˆå™¨èŠ‚ç‚¹é€‚é…**ï¼šå¯ç”¨åŒºå—æäº¤æœåŠ¡ç«¯ã€å‘å¸ƒæœ€æ–°åŒºå—å¹¿æ’­ã€è®¢é˜…åŒºå—åŒæ­¥
- **ä¸­ç»§èŠ‚ç‚¹é€‚é…**ï¼šå¯ç”¨é»˜è®¤å¤„ç†å™¨ã€å¯ç”¨æ™ºèƒ½ä¸­ç»§åŠŸèƒ½ã€è®¢é˜…åŒºå—å¹¿æ’­
- **è½»èŠ‚ç‚¹é€‚é…**ï¼šå¯ç”¨åŸºç¡€åè®®æ”¯æŒã€å‡å°‘èµ„æºå ç”¨ã€ä¼˜åŒ–ä¼ è¾“æ•ˆç‡

---

## ğŸ”— **ä¸å…¬å…±æ¥å£çš„æ˜ å°„å…³ç³»**

ã€æ¥å£å®ç°æ˜ å°„ã€‘

ã€€ã€€ç½‘ç»œåè®®é€‚é…ç³»ç»Ÿå®ç°äº†æ ‡å‡†çš„ç½‘ç»œåè®®å¤„ç†æ¥å£ï¼Œé€šè¿‡æµå¼å¤„ç†å™¨ã€è®¢é˜…å¤„ç†å™¨ã€æ™ºèƒ½ä¸­ç»§å™¨ç­‰ç»„ä»¶ååŒå·¥ä½œï¼Œç¡®ä¿å…±è¯†ç½‘ç»œé€šä¿¡çš„é«˜æ•ˆæ€§å’Œå¯é æ€§ã€‚

**æ ¸å¿ƒæ¥å£æ–¹æ³•ï¼š**
- **æµå¼åè®®æ¥å£**ï¼šåŒºå—æäº¤åè®®çš„è¯·æ±‚-å“åº”å¤„ç†
- **è®¢é˜…åè®®æ¥å£**ï¼šæœ€æ–°åŒºå—å¹¿æ’­çš„å‘å¸ƒ-è®¢é˜…å¤„ç†
- **æ™ºèƒ½è·¯ç”±æ¥å£**ï¼šåŸºäºä¸šåŠ¡é€»è¾‘çš„æ¶ˆæ¯è·¯ç”±å’Œåˆ†å‘
- **ä¸­ç»§æ§åˆ¶æ¥å£**ï¼šå—æ§æ‰‡å‡ºå’Œæ™ºèƒ½ä¸­ç»§ç®¡ç†

**å®ç°è¦ç‚¹ï¼š**
- **çº¯è·¯ç”±è½¬å‘è®¾è®¡**ï¼šåªè´Ÿè´£åè®®æ³¨å†Œå’Œæ¶ˆæ¯è·¯ç”±ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- **æ¥å£æŠ½è±¡è§£è€¦**ï¼šé€šè¿‡è·¯ç”±å™¨æ¥å£å®ç°ä¸å…·ä½“ä¸šåŠ¡å±‚çš„å®Œå…¨è§£è€¦
- **ç±»å‹å®‰å…¨è·¯ç”±**ï¼šåŸºäºæ¥å£çš„ç±»å‹å®‰å…¨æ¶ˆæ¯è·¯ç”±ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯
- **åè®®ç‰ˆæœ¬æ§åˆ¶**ï¼šç»´æŠ¤åè®®ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ”¯æŒåè®®æ¼”è¿›å’Œå…¼å®¹æ€§

---

## ğŸš€ **åç»­æ‰©å±•è§„åˆ’**

ã€æ¨¡å—æ¼”è¿›æ–¹å‘ã€‘

1. **æ™ºèƒ½ç½‘ç»œä¼˜åŒ–**
   - å®ç°åŸºäºæœºå™¨å­¦ä¹ çš„ç½‘ç»œè·¯ç”±ä¼˜åŒ–
   - æ·»åŠ ç½‘ç»œæ‹“æ‰‘æ„ŸçŸ¥çš„åŠ¨æ€åè®®é€‰æ‹©
   - æ”¯æŒè‡ªé€‚åº”çš„æ‰‡å‡ºæ§åˆ¶å’Œè´Ÿè½½å‡è¡¡

2. **é«˜çº§ä¸­ç»§å¢å¼º**
   - å®ç°å¤šè·³æ™ºèƒ½ä¸­ç»§å’Œè·¯å¾„ä¼˜åŒ–
   - æ·»åŠ ä¸­ç»§è´¨é‡è¯„ä¼°å’Œè·¯å¾„é¢„æµ‹
   - å¢å¼ºç½‘ç»œåˆ†åŒºæ—¶çš„ä¸­ç»§ä¿éšœæœºåˆ¶

3. **åè®®æ‰©å±•å‡çº§**
   - å¢åŠ æ›´å¤šç½‘ç»œåè®®çš„æ”¯æŒé€‰é¡¹
   - å®ç°åè®®è‡ªåŠ¨åå•†å’ŒåŠ¨æ€åˆ‡æ¢
   - æ·»åŠ åè®®å®‰å…¨è®¤è¯å’ŒåŠ å¯†ä¼ è¾“

4. **ç›‘æ§åˆ†æå‡çº§**
   - å®ç°ç½‘ç»œåè®®æµçš„å®æ—¶å¯è§†åŒ–
   - æ·»åŠ ç½‘ç»œä¼ è¾“è´¨é‡è¯„ä¼°å’Œå¼‚å¸¸æ£€æµ‹
   - å¢å¼ºç½‘ç»œç³»ç»Ÿçš„é¢„æµ‹æ€§ç»´æŠ¤èƒ½åŠ›

---

## ğŸ“‹ **å¼€å‘æŒ‡å—**

ã€å­æ¨¡å—å¼€å‘è§„èŒƒã€‘

1. **æ–°å»ºåè®®æ­¥éª¤**ï¼š
   - åœ¨protocol_constants.goä¸­å®šä¹‰æ–°çš„åè®®IDå’Œç‰ˆæœ¬
   - å®ç°å¯¹åº”çš„åè®®å¤„ç†å™¨å’Œè·¯ç”±é€»è¾‘
   - æ·»åŠ å®Œæ•´çš„åè®®å¤„ç†æµ‹è¯•å’Œç½‘ç»œæµ‹è¯•
   - æ›´æ–°åè®®æ³¨å†Œå‡½æ•°å’Œä¾èµ–æ³¨å…¥é…ç½®

2. **ä»£ç è´¨é‡è¦æ±‚**ï¼š
   - éµå¾ªGoè¯­è¨€æœ€ä½³å®è·µå’Œç¼–ç è§„èŒƒ
   - 100%çš„æ ¸å¿ƒç½‘ç»œé€»è¾‘æµ‹è¯•è¦†ç›–ç‡
   - å®Œå–„çš„å¹¶å‘å®‰å…¨å’Œç½‘ç»œå¼‚å¸¸å¤„ç†
   - æ¸…æ™°çš„åè®®æ–‡æ¡£å’Œæ¥å£è¯´æ˜

3. **æ€§èƒ½è¦æ±‚**ï¼š
   - åè®®å¤„ç†å»¶è¿ŸæŒ‡æ ‡è¾¾æ ‡
   - ç½‘ç»œèµ„æºä½¿ç”¨åˆç†ï¼Œé¿å…è¿æ¥æ³„æ¼
   - å¹¶å‘å®‰å…¨çš„åè®®å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
   - åˆç†çš„ç¼“å­˜ç­–ç•¥å’Œå†…å­˜ä¼˜åŒ–

ã€å‚è€ƒæ–‡æ¡£ã€‘
- [å…±è¯†é›†æˆå±‚æ•´ä½“æ¶æ„](../README.md)
- [ç½‘ç»œæœåŠ¡æ¥å£è§„èŒƒ](../../../../pkg/interfaces/network/)
- [å…±è¯†æ ¸å¿ƒæ¨¡å—æ–‡æ¡£](../../README.md)
- [WESæ¶æ„è®¾è®¡æ–‡æ¡£](../../../../docs/architecture/)

---

> ğŸ“ **æ¨¡æ¿è¯´æ˜**ï¼šæœ¬READMEæ¨¡æ¿åŸºäºWES v0.0.1ç»Ÿä¸€æ–‡æ¡£è§„èŒƒè®¾è®¡ï¼Œä½¿ç”¨æ—¶è¯·æ ¹æ®å…·ä½“æ¨¡å—éœ€æ±‚æ›¿æ¢ç›¸åº”çš„å ä½ç¬¦å†…å®¹ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰ç« èŠ‚éƒ½æœ‰å®è´¨æ€§çš„æŠ€æœ¯å†…å®¹ã€‚

> ğŸ”„ **ç»´æŠ¤æŒ‡å—**ï¼šæœ¬æ–‡æ¡£åº”éšç€ç½‘ç»œåè®®é€‚é…ç³»ç»ŸåŠŸèƒ½çš„æ¼”è¿›åŠæ—¶æ›´æ–°ï¼Œç¡®ä¿æ–‡æ¡£ä¸ä»£ç å®ç°çš„ä¸€è‡´æ€§ã€‚å»ºè®®åœ¨æ¯æ¬¡é‡å¤§åŠŸèƒ½å˜æ›´åæ›´æ–°ç›¸åº”ç« èŠ‚ã€‚ç½‘ç»œåè®®é€‚é…ä½œä¸ºå…±è¯†æ ¸å¿ƒä¸ç½‘ç»œåŸºç¡€è®¾æ–½ä¹‹é—´çš„å…³é”®æ¡¥æ¢ï¼Œé‡‡ç”¨ç«¯å£é€‚é…å™¨æ¶æ„æ¨¡å¼ï¼Œæä¾›é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œä¼ è¾“ä¼˜åŒ–ç­–ç•¥ã€‚
