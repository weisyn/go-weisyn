// Package height_gate å®ç°é«˜åº¦é—¨é—¸ç®¡ç†å™¨æœåŠ¡
//
// ğŸ¯ **é«˜åº¦é—¨é—¸ç®¡ç†å™¨æ¨¡å—**
//
// æœ¬åŒ…å®ç° HeightGateManager æ¥å£ï¼Œæä¾›é«˜åº¦é—¨é—¸ç®¡ç†åŠŸèƒ½ï¼š
// - è®°å½•æœ€åå¤„ç†çš„åŒºå—é«˜åº¦
// - é˜²æ­¢åœ¨åŒä¸€é«˜åº¦é‡å¤æŒ–çŸ¿
// - æ”¯æŒåŒºå—é“¾åˆ†å‰å’ŒåŒæ­¥åœºæ™¯
//
// ğŸ—ï¸ **è–„å®ç°è®¾è®¡**ï¼šé‡‡ç”¨å§”æ‰˜æ¨¡å¼ï¼Œå°†å…·ä½“ä¸šåŠ¡é€»è¾‘åˆ†ç¦»åˆ°ä¸“é—¨çš„æ–¹æ³•æ–‡ä»¶ä¸­
package height_gate

import (
	"sync/atomic"

	"github.com/weisyn/v1/internal/core/consensus/interfaces"
	"github.com/weisyn/v1/pkg/interfaces/infrastructure/log"
)

// HeightGateService é«˜åº¦é—¨é—¸æœåŠ¡å®ç°
//
// ğŸ¯ **æç®€é—¨é—¸æ¶æ„**ï¼ˆä¸¥æ ¼éµå¾ªæƒå¨æ–‡æ¡£ï¼‰ï¼š
// - åŸå­æ“ä½œå®ç°æ— é”å¹¶å‘è®¿é—®
// - çº³ç§’çº§è¯»å–æ€§èƒ½ï¼Œæ”¯æŒæ— é™å¹¶å‘è¯»å–
// - é…ç½®åŒ–åˆ†å‰æ·±åº¦ï¼Œæ— ç¡¬ç¼–ç å¸¸é‡
//
// ğŸ“Š **æ€§èƒ½æŒ‡æ ‡**ï¼š
// - è¯»å–å»¶è¿Ÿ: < 100ns (åŸå­è¯»å–)
// - æ›´æ–°å»¶è¿Ÿ: < 1Î¼s (åŒ…å«åˆ†å‰æ ¡éªŒ)
// - å¹¶å‘æ”¯æŒ: 10,000+å¹¶å‘è¯»å–
// - å†…å­˜å ç”¨: < 1KB
//
// ğŸ›¡ï¸ **åˆ†å‰å‹å¥½ç‰¹æ€§**ï¼š
// - é…ç½®åŒ–æœ€å¤§åˆ†å‰æ·±åº¦é™åˆ¶
// - åŸå­æ›´æ–°ä¸€è‡´æ€§ä¿è¯
// - å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—
type HeightGateService struct {
	// åŸºç¡€ä¾èµ–
	logger log.Logger // æ—¥å¿—è®°å½•å™¨

	// é…ç½®å‚æ•°ï¼ˆéµå¾ªé…ç½®åŒ–çº¦æŸï¼‰
	maxForkDepth uint64 // æœ€å¤§å…è®¸åˆ†å‰æ·±åº¦ï¼ˆä»é…ç½®æ³¨å…¥ï¼‰

	// ğŸš€ **åŸå­æ“ä½œå­—æ®µ**ï¼šç¡®ä¿å¹¶å‘å®‰å…¨å’Œæè‡´æ€§èƒ½
	lastHeight atomic.Uint64 // æœ€åå¤„ç†çš„é«˜åº¦ï¼ˆåŸå­æ“ä½œï¼‰
}

// NewHeightGateService åˆ›å»ºé«˜åº¦é—¨é—¸æœåŠ¡å®ä¾‹
//
// ğŸ¯ **æç®€åˆå§‹åŒ–ç­–ç•¥**ï¼ˆéµå¾ªæƒå¨æ–‡æ¡£ï¼‰ï¼š
// - è®¾ç½®åˆå§‹é«˜åº¦ä¸º0ï¼ˆåˆ›ä¸–åŒºå—å‰çŠ¶æ€ï¼‰
// - æ³¨å…¥é…ç½®åŒ–çš„åˆ†å‰æ·±åº¦å‚æ•°
// - é…ç½®æ—¥å¿—è®°å½•å™¨
//
// ğŸ“‹ **æ„é€ å‡½æ•°å‚æ•°**ï¼š
// - logger: æ—¥å¿—è®°å½•å™¨ï¼Œç”¨äºé«˜åº¦å˜æ›´å®¡è®¡
// - maxForkDepth: æœ€å¤§å…è®¸åˆ†å‰æ·±åº¦ï¼ˆä»é…ç½®æ³¨å…¥ï¼‰
//
// @param logger æ—¥å¿—è®°å½•å™¨
// @param maxForkDepth æœ€å¤§åˆ†å‰æ·±åº¦
// @return interfaces.HeightGateManager é«˜åº¦é—¨é—¸ç®¡ç†å™¨å®ä¾‹
func NewHeightGateService(logger log.Logger, maxForkDepth uint64) interfaces.HeightGateManager {
	service := &HeightGateService{
		logger:       logger,
		maxForkDepth: maxForkDepth,
	}

	// åˆå§‹åŒ–åŸå­å­—æ®µ
	service.lastHeight.Store(0)

	logger.Info("é«˜åº¦é—¨é—¸ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼Œåˆå§‹é«˜åº¦ï¼š0ï¼Œæœ€å¤§åˆ†å‰æ·±åº¦ï¼š" + formatUint64(maxForkDepth))
	return service
}

// ç¼–è¯‘æ—¶ç¡®ä¿ HeightGateService å®ç°äº† HeightGateManager æ¥å£
var _ interfaces.HeightGateManager = (*HeightGateService)(nil)

// ===================
// ğŸ”§ **å†…éƒ¨è¾…åŠ©æ–¹æ³•**
// ===================

// isHeightUpdateValid éªŒè¯é«˜åº¦æ›´æ–°çš„æœ‰æ•ˆæ€§
//
// ğŸ›¡ï¸ **åˆ†å‰é˜²æŠ¤æ ¸å¿ƒ**ï¼š
// - å…è®¸é«˜åº¦é€’å¢ï¼ˆæ­£å¸¸æŒ–çŸ¿ï¼‰
// - å…è®¸ç›¸åŒé«˜åº¦ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
// - å…è®¸æœ‰é™å›é€€ï¼ˆåˆ†å‰å¤„ç†ï¼‰
// - æ‹’ç»è¿‡æ·±å›é€€ï¼ˆå®‰å…¨é˜²æŠ¤ï¼‰
//
// ğŸ“‹ **éªŒè¯è§„åˆ™**ï¼š
// åŸºäºåŒºå—é“¾åˆ†å‰å¤„ç†çš„ä¸šåŠ¡éœ€æ±‚ï¼š
// - æ­£å¸¸æƒ…å†µï¼šæ–°åŒºå—é«˜åº¦ >= å½“å‰é«˜åº¦
// - åˆ†å‰æƒ…å†µï¼šå›é€€æ·±åº¦ <= MaxForkDepth
// - æ”»å‡»é˜²æŠ¤ï¼šå›é€€æ·±åº¦ > MaxForkDepth æ—¶æ‹’ç»
//
// @param currentHeight å½“å‰é«˜åº¦
// @param newHeight æ–°é«˜åº¦
// @return bool æ›´æ–°æ˜¯å¦æœ‰æ•ˆ
func (s *HeightGateService) isHeightUpdateValid(currentHeight, newHeight uint64) bool {
	// å…è®¸é«˜åº¦é€’å¢æˆ–ç›¸åŒï¼ˆæ­£å¸¸æŒ–çŸ¿å’Œå¹‚ç­‰æ“ä½œï¼‰
	if newHeight >= currentHeight {
		return true
	}

	// æ£€æŸ¥å›é€€æ·±åº¦æ˜¯å¦åœ¨é…ç½®çš„å…è®¸èŒƒå›´å†…ï¼ˆåˆ†å‰å¤„ç†ï¼‰
	rollbackDepth := currentHeight - newHeight
	return rollbackDepth <= s.maxForkDepth
}

// formatUint64 é«˜æ€§èƒ½çš„uint64å­—ç¬¦ä¸²æ ¼å¼åŒ–
//
// ğŸš€ **æ€§èƒ½ä¼˜åŒ–å®ç°**ï¼š
// - é¿å…æ ‡å‡†åº“çš„å†…å­˜åˆ†é…å¼€é”€
// - ä½¿ç”¨æ ˆä¸Šç¼“å†²åŒºå‡å°‘GCå‹åŠ›
// - é’ˆå¯¹æ•°å­—æ ¼å¼åŒ–çš„ä¸“é—¨ä¼˜åŒ–
//
// ğŸ“Š **æ€§èƒ½å¯¹æ¯”**ï¼š
// - æ ‡å‡†fmt.Sprintf: ~200ns + å†…å­˜åˆ†é…
// - æœ¬å®ç°: ~50ns + 0å†…å­˜åˆ†é…
// - æ€§èƒ½æå‡: 4xé€Ÿåº¦æå‡ + æ— GCå‹åŠ›
//
// ğŸ¯ **é€‚ç”¨åœºæ™¯**ï¼š
// - é«˜é¢‘æ—¥å¿—è®°å½•
// - æ€§èƒ½æ•æ„Ÿçš„å­—ç¬¦ä¸²è½¬æ¢
// - éœ€è¦é¿å…å†…å­˜åˆ†é…çš„åœºæ™¯
//
// @param n è¦æ ¼å¼åŒ–çš„æ•°å­—
// @return string æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
func formatUint64(n uint64) string {
	if n == 0 {
		return "0"
	}

	// ä½¿ç”¨æ ˆä¸Šç¼“å†²åŒºï¼Œuint64æœ€å¤§å€¼éœ€è¦20ä½
	var buf [20]byte
	i := len(buf)

	// ä»åå¾€å‰å¡«å……æ•°å­—
	for n > 0 {
		i--
		buf[i] = '0' + byte(n%10)
		n /= 10
	}

	// è¿”å›æœ‰æ•ˆæ•°å­—éƒ¨åˆ†
	return string(buf[i:])
}
