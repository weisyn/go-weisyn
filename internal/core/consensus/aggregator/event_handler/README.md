# Aggregator Event Handler

## 📖 概述

聚合器事件处理模块，负责处理影响聚合器运行的系统事件。确保聚合器能够及时响应区块链重组、网络质量变化等重要事件，保持与系统状态的一致性。

## 🎯 核心功能

### 事件处理能力

- **🔄 链重组事件处理**：响应区块链重组，调整聚合器状态和数据
- **🌐 网络质量变化处理**：根据网络状况动态优化聚合策略
- **⚡ 实时响应机制**：确保事件处理的及时性和准确性

### 架构特性

- **🏗️ 委托模式**：Manager作为薄委托层，具体处理器负责业务逻辑
- **🔌 接口实现**：完整实现AggregatorEventHandler接口
- **🤝 状态协调**：与聚合器状态管理器协调工作

## 📁 文件结构

```
event_handler/
├── manager.go                      # 事件处理服务管理器（主入口）
├── chain_reorganized_handler.go    # 链重组事件专门处理器
├── network_quality_handler.go      # 网络质量变化处理器
└── README.md                       # 本文档
```

## 🔧 核心组件

### AggregatorEventHandlerService

**职责**：聚合器事件处理服务的主要实现

- 实现`interfaces.AggregatorEventHandler`接口
- 委托具体处理器处理不同类型事件
- 协调各组件的事件响应

**关键方法**：
- `HandleChainReorganized()` - 处理链重组事件
- `HandleNetworkQualityChanged()` - 处理网络质量变化事件

### chainReorganizedHandler

**职责**：专门处理区块链重组事件

**处理流程**：
1. **事件数据解析** - 提取重组前后的链状态信息
2. **影响评估** - 检查当前聚合是否受重组影响
3. **状态清理** - 清理可能无效的候选区块数据
4. **状态重置** - 调整聚合器到安全状态

### networkQualityHandler

**职责**：专门处理网络质量变化事件

**处理流程**：
1. **事件数据解析** - 提取网络质量变化信息
2. **质量评估** - 评估网络质量对聚合的影响
3. **策略调整** - 动态调整收集超时和评分权重
4. **状态适配** - 根据网络状况调整聚合节奏

## 🌐 事件处理逻辑

### 链重组响应策略

```
检测重组 → 评估影响 → 清理数据 → 重置状态
    ↓         ↓         ↓         ↓
  解析事件   判断范围   清理候选   调整高度
```

**关键决策点**：
- 当前聚合高度是否在重组影响范围内
- 是否需要清理已收集的候选区块
- 重置到哪个安全高度继续聚合

### 网络质量适配策略

```
质量评估 → 等级划分 → 策略调整 → 状态适配
    ↓         ↓         ↓         ↓
  分析指标   分级处理   调整参数   状态建议
```

**质量等级**：
- **Excellent** (>0.8) - 标准策略
- **Good** (0.6-0.8) - 标准策略
- **Fair** (0.4-0.6) - 适度延长收集时间
- **Poor** (0.2-0.4) - 显著调整参数
- **Critical** (<0.2) - 建议暂缓聚合

## 🔄 状态交互

### 与聚合器状态管理器协作

- **状态查询**：获取当前聚合状态和高度
- **状态转换**：在必要时触发状态转换
- **高度调整**：根据重组结果调整聚合高度

### 状态转换场景

- **重组影响**：转换到 `AggregationStateIdle` 等待状态
- **网络严重**：记录建议但不强制转换状态
- **恢复正常**：配合主流程恢复正常聚合

## 📊 设计原则

### 响应及时性

- 事件到达后立即开始处理
- 最小化处理延迟，确保状态一致性
- 异步处理机制，不阻塞其他流程

### 策略动态性

- 根据网络条件动态调整参数
- 支持不同质量等级的差异化策略
- 平滑的策略切换，避免频繁抖动

### 状态协调性

- 与聚合器主流程协调工作
- 通过状态管理器统一状态变更
- 避免直接修改其他组件状态

## ⚠️ 注意事项

### 处理边界

- **不越权操作**：仅处理事件响应，不直接控制聚合流程
- **状态建议**：提供状态调整建议，由主流程决策
- **数据清理**：通过状态重置触发，避免直接清理其他组件数据

### 错误处理

- 事件解析失败时返回具体错误信息
- 状态转换失败时记录错误并继续
- 网络质量评估异常时使用默认策略

### 性能考虑

- 事件处理保持轻量化，避免阻塞
- 状态评估逻辑简单高效
- 减少不必要的状态查询和转换

## 🔮 未来扩展

### 事件类型扩展

- 支持更多系统事件类型的处理
- 增加事件优先级和批量处理机制
- 支持事件过滤和条件响应

### 策略优化

- 基于历史数据的智能策略调整
- 支持自定义策略配置
- 增加策略效果评估和反馈机制

### 监控增强

- 增加事件处理统计和监控
- 支持事件处理性能分析
- 提供事件响应效果评估报告
