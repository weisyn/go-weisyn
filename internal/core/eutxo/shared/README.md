# shared - å…±äº«å·¥å…·å­åŸŸ

---

## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼š1.0
- **çŠ¶æ€**ï¼šstable
- **æœ€åæ›´æ–°**ï¼š2025-11-XX
- **æœ€åå®¡æ ¸**ï¼š2025-11-XX
- **æ‰€æœ‰è€…**ï¼šEUTXO å¼€å‘ç»„
- **é€‚ç”¨èŒƒå›´**ï¼šEUTXOæ¨¡å—å…±äº«å·¥å…·å®ç°

---

## ğŸ¯ å­åŸŸå®šä½

**è·¯å¾„**ï¼š`internal/core/eutxo/shared/`

**æ‰€å±ç»„ä»¶**ï¼š`eutxo`

**æ ¸å¿ƒèŒè´£**ï¼šæä¾›EUTXOæ¨¡å—å†…éƒ¨å…±äº«çš„å·¥å…·å’Œè¾…åŠ©åŠŸèƒ½

**åœ¨ç»„ä»¶ä¸­çš„è§’è‰²**ï¼š
- å…±äº«å·¥å…·çš„å®ç°
- ç¼“å­˜ç®¡ç†
- ç´¢å¼•ç®¡ç†
- æ¨¡å—å†…éƒ¨å¤ç”¨

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åœ¨ç»„ä»¶ä¸­çš„ä½ç½®

> **è¯´æ˜**ï¼šå±•ç¤ºæ­¤å­åŸŸåœ¨ EUTXO ç»„ä»¶å†…éƒ¨çš„ä½ç½®å’Œåä½œå…³ç³»

```mermaid
graph TB
    subgraph "ç»„ä»¶ internal/core/eutxo"
        subgraph "æœ¬å­åŸŸ shared"
            THIS["shared/<br/>å…±äº«å·¥å…·"]
            
            CACHE["cache.go<br/>ç¼“å­˜ç®¡ç†"]
            INDEX["index.go<br/>ç´¢å¼•ç®¡ç†"]
            
            THIS --> CACHE
            THIS --> INDEX
        end
        
        subgraph "åä½œçš„å­åŸŸ"
            WRITER["writer/<br/>UTXOå†™å…¥"]
            SNAPSHOT["snapshot/<br/>å¿«ç…§ç®¡ç†"]
        end
    
    WRITER --> THIS
    SNAPSHOT --> THIS
    
    style THIS fill:#FFD700
```

**ä½ç½®è¯´æ˜**ï¼š

| å…³ç³»ç±»å‹ | ç›®æ ‡ | å…³ç³»è¯´æ˜ |
|---------|------|---------|
| **è¢«ä¾èµ–** | writer/ | ä½¿ç”¨ç¼“å­˜å’Œç´¢å¼•å·¥å…· |
| **è¢«ä¾èµ–** | snapshot/ | ä½¿ç”¨ç¼“å­˜å·¥å…· |

---

### å†…éƒ¨ç»„ç»‡

> **è¯´æ˜**ï¼šå±•ç¤ºæ­¤å­åŸŸå†…éƒ¨çš„æ–‡ä»¶ç»„ç»‡å’Œç±»å‹å…³ç³»

```mermaid
graph TB
    subgraph "shared/ ç›®å½•ç»“æ„"
        CACHE["cache.go<br/>UTXOCache - ç¼“å­˜å®ç°"]
        INDEX["index.go<br/>ç´¢å¼•å·¥å…·"]
    end
    
    style CACHE fill:#FFD700
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
internal/core/eutxo/shared/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ cache.go                     # UTXOCache - ç¼“å­˜å®ç°
â””â”€â”€ index.go                     # ç´¢å¼•å·¥å…·å‡½æ•°
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### å®ç°æ–‡ä»¶ï¼š`cache.go`

**æ ¸å¿ƒç±»å‹**ï¼š`UTXOCache`

**èŒè´£**ï¼šæä¾›UTXOçš„LRUç¼“å­˜å®ç°

**å…³é”®å­—æ®µ**ï¼š

```go
type UTXOCache struct {
    cache    *lru.Cache           // LRUç¼“å­˜
    mu       sync.RWMutex         // è¯»å†™é”
    maxSize  int                  // æœ€å¤§ç¼“å­˜å¤§å°
}
```

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³•å | èŒè´£ | å¯è§æ€§ | å¤‡æ³¨ |
|-------|------|-------|-----|
| `NewUTXOCache()` | åˆ›å»ºç¼“å­˜ | Public | æ„é€ å‡½æ•° |
| `Get()` | è·å–UTXO | Public | ä»ç¼“å­˜è¯»å– |
| `Put()` | å­˜å‚¨UTXO | Public | å†™å…¥ç¼“å­˜ |
| `Delete()` | åˆ é™¤UTXO | Public | ä»ç¼“å­˜åˆ é™¤ |
| `Clear()` | æ¸…ç©ºç¼“å­˜ | Public | æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ |

---

### è¾…åŠ©æ–‡ä»¶

**index.go** - ç´¢å¼•å·¥å…·ï¼š
- `BuildUTXOKey()` - æ„å»ºUTXOå­˜å‚¨é”®
- `ParseUTXOKey()` - è§£æUTXOå­˜å‚¨é”®
- ç´¢å¼•ç›¸å…³çš„å·¥å…·å‡½æ•°

---

## ğŸ”— åä½œå…³ç³»

### è¢«ä¾èµ–å…³ç³»

**è¢«ä»¥ä¸‹å­åŸŸä½¿ç”¨**ï¼š
- `writer/` - ä½¿ç”¨ UTXOCache ç¼“å­˜UTXOï¼Œæå‡æ€§èƒ½
- `snapshot/` - ä½¿ç”¨ç¼“å­˜å·¥å…·ä¼˜åŒ–å¿«ç…§æ“ä½œ

**ç¤ºä¾‹**ï¼š

```go
// åœ¨ writer/service.go ä¸­ä½¿ç”¨
import "github.com/weisyn/v1/internal/core/eutxo/shared"

type Service struct {
    cache *shared.UTXOCache
    // ...
}

func (s *Service) CreateUTXO(ctx context.Context, utxo *utxo.UTXO) error {
    // å†™å…¥å­˜å‚¨
    err := s.storage.Set(key, data)
    if err != nil {
        return err
    }
    
    // æ›´æ–°ç¼“å­˜
    s.cache.Put(key, utxo)
    
    return nil
}
```

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•è¦†ç›–

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶ | è¦†ç›–ç‡ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|---------|------|-----------|---------|
| å•å…ƒæµ‹è¯• | `shared_test.go` | â‰¥ 80% | â³ å¾…å®æ–½ |
| é›†æˆæµ‹è¯• | `../integration/` | æ ¸å¿ƒåœºæ™¯ | â³ å¾…å®æ–½ |

---

### æµ‹è¯•ç¤ºä¾‹

```go
func TestUTXOCache_GetPut(t *testing.T) {
    // Arrange
    cache := shared.NewUTXOCache(100)
    utxo := createTestUTXO()
    key := []byte("test-key")
    
    // Act
    cache.Put(key, utxo)
    retrieved, ok := cache.Get(key)
    
    // Assert
    assert.True(t, ok)
    assert.Equal(t, utxo, retrieved)
}
```

---

## ğŸ“Š å…³é”®è®¾è®¡å†³ç­–

### å†³ç­– 1ï¼šLRUç¼“å­˜ç­–ç•¥

**é—®é¢˜**ï¼šå¦‚ä½•ç®¡ç†UTXOç¼“å­˜ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šä½¿ç”¨LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç¼“å­˜ç­–ç•¥

**ç†ç”±**ï¼š
- è‡ªåŠ¨æ·˜æ±°ä¸å¸¸ç”¨çš„UTXO
- ä¿è¯ç¼“å­˜æ•ˆç‡
- æ”¯æŒå¹¶å‘è®¿é—®

**æƒè¡¡**ï¼š
- âœ… ä¼˜ç‚¹ï¼šè‡ªåŠ¨ç®¡ç†ï¼Œæ•ˆç‡é«˜
- âš ï¸ ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„å†…å­˜å¼€é”€

---

### å†³ç­– 2ï¼šå…±äº«åŒ…è®¾è®¡

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆå°†å·¥å…·æ”¾åœ¨sharedåŒ…ä¸­ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šåˆ›å»ºsharedåŒ…ï¼Œæ”¾ç½®æ¨¡å—å†…å…±äº«çš„å·¥å…·

**ç†ç”±**ï¼š
- é¿å…ä»£ç é‡å¤
- ç»Ÿä¸€ç®¡ç†å…±äº«å·¥å…·
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•

**æƒè¡¡**ï¼š
- âœ… ä¼˜ç‚¹ï¼šä»£ç å¤ç”¨ï¼Œæ˜“äºç»´æŠ¤
- âš ï¸ ç¼ºç‚¹ï¼šéœ€è¦ç¡®ä¿å·¥å…·ç¡®å®è¢«å…±äº«ä½¿ç”¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç»„ä»¶æ€»è§ˆ](../README.md)
- [UTXOå†™å…¥](../writer/README.md)
- [UTXOå¿«ç…§](../snapshot/README.md)
- [æ¥å£ä¸å®ç°çš„ç»„ç»‡æ¶æ„](../../../../docs/system/standards/principles/code-organization.md)

---

## ğŸ“ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| 1.0 | 2025-11-XX | åˆå§‹ç‰ˆæœ¬ | EUTXO å¼€å‘ç»„ |

---

## ğŸš§ å¾…åŠäº‹é¡¹

- [ ] å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] ä¼˜åŒ–ç¼“å­˜æ€§èƒ½
- [ ] æ”¯æŒç¼“å­˜å¤§å°åŠ¨æ€è°ƒæ•´
- [ ] æ·»åŠ ç¼“å­˜æŒ‡æ ‡æ”¶é›†

