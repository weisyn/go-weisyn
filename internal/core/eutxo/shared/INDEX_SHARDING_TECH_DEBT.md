# 索引分片策略 - 技术债记录

## 状态
⏸️ **暂缓实施** - 当前修复已足够，记录为技术债

## 背景

### 已完成的修复
- ✅ BadgerDB 事务大小智能动态批次控制（2025-12-17）
- ✅ 事务大小实时监控（80%阈值预警）
- ✅ 批次大小自适应调整（10-500）

### 潜在优化点
当前索引实现使用单个键存储所有 outpoint：
```go
// 当前实现
index:address:{address} -> [outpoint1, outpoint2, ..., outpointN]

// 追加操作（Line 348）
newData := append(existingData, outpointBytes...)
```

**潜在问题**：
- 热门地址累积大量UTXO时，索引追加需要复制整个数组
- 极端场景（交易所/矿池地址）可能导致单个索引>1MB

## 何时需要重新评估

### 触发条件（满足任一即需重新评估）

1. **日志中出现新的索引相关错误**
   ```
   grep -i "添加.*索引失败.*too big" logs/*.log
   ```

2. **热门地址场景**
   - 交易所热钱包接入（单地址可能>10,000 UTXO）
   - 矿池/质押池地址（单地址可能>50,000 UTXO）
   - 热门代币合约（单资产可能>100,000 UTXO）

3. **性能监控指标**
   - 索引追加操作延迟 >100ms
   - 单个索引大小 >500KB
   - Fork 回滚恢复失败率 >1%

4. **批量操作失败**
   - 即使在最小批次（10个UTXO）仍触发事务超限

## 实施方案（当需要时）

### 设计概要

**索引分片格式**：
```
主分片：index:address:{address}           -> 最多1MB
子分片：index:address:{address}:shard:1   -> 最多1MB
子分片：index:address:{address}:shard:2   -> 最多1MB
...
```

**核心逻辑**：
1. 优先写入主分片（向后兼容）
2. 主分片满时自动创建子分片
3. 查询时需遍历所有分片（性能权衡）

### 预计工作量
- **实现**: 4-6小时
- **测试**: 2-3小时
- **迁移**: 需要考虑现有数据兼容性

### 风险评估
- ⚠️ 查询性能下降（需遍历多个分片）
- ⚠️ 实现复杂度增加
- ⚠️ 需要充分测试确保向后兼容

## 当前建议

### 短期（当前）
✅ **不采取行动** - 当前修复已足够

### 中期（3-6个月）
📊 **监控指标**：
- 定期检查日志中的索引失败
- 监控最大索引大小
- 观察热门地址的UTXO累积情况

### 长期（如需要）
🔧 **实施分片**：
- 仅在触发条件满足时实施
- 优先考虑混合方案（按需分片）
- 确保向后兼容现有索引

## 参考资料

**相关文件**：
- `internal/core/eutxo/shared/index.go` - 当前索引实现
- `data/test/.../logs/BADGERDB_TXN_SIZE_FIX_COMPLETE.md` - 已完成修复

**相关讨论**：
- BadgerDB 事务大小超限修复（2025-12-17）
- 索引分片策略讨论（2025-12-17）

---

**记录日期**: 2025-12-17  
**决策**: 暂缓实施，作为技术债记录  
**下次评审**: 当触发条件满足或6个月后

