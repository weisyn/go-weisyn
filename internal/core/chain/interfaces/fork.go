// Package interfaces å®šä¹‰ chain æ¨¡å—çš„å†…éƒ¨æ¥å£
package interfaces

import (
	"context"

	core "github.com/weisyn/v1/pb/blockchain/block"
	"github.com/weisyn/v1/pkg/interfaces/chain"
	"github.com/weisyn/v1/pkg/types"
)

// ============================================================================
//                          åˆ†å‰å¤„ç†å†…éƒ¨æ¥å£
// ============================================================================

// InternalForkHandler å†…éƒ¨åˆ†å‰å¤„ç†æ¥å£
//
// ğŸ¯ **è®¾è®¡ç›®æ ‡**ï¼š
// - ç»§æ‰¿å…¬å…± ForkHandler æ¥å£ï¼Œæä¾›æ ‡å‡†çš„åˆ†å‰å¤„ç†èƒ½åŠ›
// - æ‰©å±•æ£€æµ‹æ–¹æ³•ï¼Œæ”¯æŒä¸»åŠ¨åˆ†å‰å‘ç°å’Œé¢„è­¦
// - æä¾›æŒ‡æ ‡æ¥å£ï¼Œæ”¯æŒåˆ†å‰åˆ†æå’Œç»Ÿè®¡
//
// ğŸ”— **ä½¿ç”¨åœºæ™¯**ï¼š
// - åŒºå—å¤„ç†ï¼šåœ¨å¤„ç†æ–°åŒºå—å‰æ£€æµ‹åˆ†å‰
// - åŒæ­¥æœåŠ¡ï¼šåœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°å’Œå¤„ç†åˆ†å‰
// - ç½‘ç»œå±‚ï¼šæ”¶åˆ°æ–°åŒºå—æ—¶æ£€æµ‹æ½œåœ¨åˆ†å‰
// - ç›‘æ§ç³»ç»Ÿï¼šæ”¶é›†åˆ†å‰ç»Ÿè®¡ä¿¡æ¯
//
// ğŸ“‹ **å®ç°è¦æ±‚**ï¼š
// - å¹¶å‘å®‰å…¨ï¼šç¡®ä¿åˆ†å‰å¤„ç†ä¸ä¼šå¹¶å‘æ‰§è¡Œ
// - äº‹åŠ¡æ€§ï¼šåˆ†å‰å¤„ç†è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
// - æ€§èƒ½ä¼˜åŒ–ï¼šåˆ†å‰æ£€æµ‹éœ€è¦å¿«é€Ÿå“åº”
type InternalForkHandler interface {
	chain.ForkHandler // åµŒå…¥å…¬å…±æ¥å£

	// ==================== å†…éƒ¨ç®¡ç†æ–¹æ³• ====================

	// DetectFork æ£€æµ‹æ˜¯å¦å­˜åœ¨åˆ†å‰
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - block: å¾…æ£€æµ‹çš„åŒºå—
	//
	// è¿”å›ï¼š
	//   - isFork: æ˜¯å¦æ˜¯åˆ†å‰ï¼ˆtrue: æ£€æµ‹åˆ°åˆ†å‰, false: æ­£å¸¸åŒºå—ï¼‰
	//   - forkHeight: åˆ†å‰ç‚¹é«˜åº¦ï¼ˆå¦‚æœæ˜¯åˆ†å‰ï¼‰
	//   - error: æ£€æµ‹é”™è¯¯
	//
	// ç”¨é€”ï¼š
	// - åŒºå—å¤„ç†ï¼šåœ¨å¤„ç†æ–°åŒºå—å‰æ£€æµ‹åˆ†å‰
	// - åŒæ­¥æœåŠ¡ï¼šåœ¨åŒæ­¥è¿‡ç¨‹ä¸­å‘ç°åˆ†å‰
	// - ç½‘ç»œå±‚ï¼šæ”¶åˆ°æ–°åŒºå—æ—¶æ£€æµ‹åˆ†å‰
	//
	// æ£€æµ‹é€»è¾‘ï¼š
	// - æ¯”è¾ƒåŒºå—çš„çˆ¶å“ˆå¸Œä¸å½“å‰é“¾å°–
	// - å¦‚æœçˆ¶å“ˆå¸Œä¸åŒ¹é…ï¼Œåˆ™å¯èƒ½å­˜åœ¨åˆ†å‰
	// - å‘å‰å›æº¯æŸ¥æ‰¾å…±åŒç¥–å…ˆï¼Œç¡®å®šåˆ†å‰ç‚¹
	DetectFork(ctx context.Context, block *core.Block) (isFork bool, forkHeight uint64, err error)

	// GetForkMetrics è·å–åˆ†å‰å¤„ç†æŒ‡æ ‡
	//
	// ç”¨é€”ï¼š
	// - ç›‘æ§ç³»ç»Ÿï¼šæ”¶é›†åˆ†å‰ç»Ÿè®¡ä¿¡æ¯
	// - åˆ†æå·¥å…·ï¼šç ”ç©¶åˆ†å‰æ¨¡å¼å’Œé¢‘ç‡
	// - å‘Šè­¦ç³»ç»Ÿï¼šæ£€æµ‹å¼‚å¸¸åˆ†å‰ï¼Œè§¦å‘å‘Šè­¦
	//
	// è¿”å›ï¼š
	//   - *ForkMetrics: åˆ†å‰å¤„ç†æŒ‡æ ‡
	//   - error: è·å–å¤±è´¥æ—¶è¿”å›é”™è¯¯
	GetForkMetrics(ctx context.Context) (*ForkMetrics, error)

	// CalculateChainWeight è®¡ç®—é“¾æƒé‡
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡
	//   - fromHeight: èµ·å§‹é«˜åº¦
	//   - toHeight: ç»“æŸé«˜åº¦
	//
	// è¿”å›ï¼š
	//   - *types.ChainWeight: é“¾æƒé‡ä¿¡æ¯
	//   - error: è®¡ç®—é”™è¯¯
	//
	// ç”¨é€”ï¼š
	// - åˆ†å‰é€‰æ‹©ï¼šé€‰æ‹©æƒé‡æœ€å¤§çš„é“¾ä½œä¸ºä¸»é“¾
	// - é“¾æ¯”è¾ƒï¼šæ¯”è¾ƒä¸¤æ¡åˆ†å‰é“¾çš„æƒé‡
	//
	// æƒé‡è®¡ç®—ï¼š
	// - ç´¯ç§¯éš¾åº¦ï¼šæ‰€æœ‰åŒºå—éš¾åº¦ä¹‹å’Œ
	// - åŒºå—æ•°é‡ï¼šé“¾çš„é•¿åº¦
	// - å…¶ä»–å› ç´ ï¼šæ—¶é—´æˆ³ã€éªŒè¯è€…ç­‰
	CalculateChainWeight(ctx context.Context, fromHeight, toHeight uint64) (*types.ChainWeight, error)

	// HandleForkWithExternalBlocks ç”¨å¤–éƒ¨ä¸‹è½½çš„åˆ†å‰æ®µæ‰§è¡Œè‡ªåŠ¨ reorg
	//
	// å…¸å‹è°ƒç”¨æ–¹ï¼šsync æ¨¡å—åœ¨ SyncHelloV2 åˆ¤å®š FORK_DETECTED åï¼Œ
	// å…ˆä»å…±åŒç¥–å…ˆä¹‹åä¸‹è½½ä¸€æ®µ blocksï¼Œå†äº¤ç»™ ForkHandler ç»Ÿä¸€æ¯”è¾ƒæƒé‡å¹¶æ‰§è¡Œé‡ç»„ã€‚
	//
	// å‚æ•°ï¼š
	//   - forkHeight: å…±åŒç¥–å…ˆé«˜åº¦ï¼ˆåˆ†å‰ç‚¹ï¼‰
	//   - forkTip:    å¤–éƒ¨é“¾çš„é“¾å°–åŒºå—ï¼ˆé«˜åº¦ >= forkHeight+1ï¼‰
	//   - forkBlocksByHeight: å¤–éƒ¨é“¾ä¸Š [forkHeight+1..forkTip.Height] çš„åŒºå—é›†åˆï¼ˆæŒ‰é«˜åº¦ç´¢å¼•ï¼‰
	HandleForkWithExternalBlocks(ctx context.Context, forkHeight uint64, forkTip *core.Block, forkBlocksByHeight map[uint64]*core.Block) error
}

// ============================================================================
//                          æŒ‡æ ‡æ•°æ®ç»“æ„
// ============================================================================

// ForkMetrics åˆ†å‰å¤„ç†æŒ‡æ ‡
//
// ğŸ¯ **ç”¨é€”**ï¼šæä¾›è¯¦ç»†çš„åˆ†å‰å¤„ç†ç»Ÿè®¡ä¿¡æ¯
//
// ğŸ“Š **æŒ‡æ ‡åˆ†ç±»**ï¼š
// - åˆ†å‰ç»Ÿè®¡ï¼šåˆ†å‰å‘ç”Ÿæ¬¡æ•°å’Œå¤„ç†çŠ¶æ€
// - é‡ç»„ç»Ÿè®¡ï¼šé“¾é‡ç»„çš„æ·±åº¦å’Œé¢‘ç‡
// - æ—¶é—´ç»Ÿè®¡ï¼šåˆ†å‰å¤„ç†è€—æ—¶
// - çŠ¶æ€ä¿¡æ¯ï¼šå½“å‰å¤„ç†çŠ¶æ€
type ForkMetrics struct {
	// ==================== åˆ†å‰ç»Ÿè®¡ ====================

	TotalForks    uint64 // æ€»åˆ†å‰æ•°ï¼ˆè‡ªç³»ç»Ÿå¯åŠ¨ä»¥æ¥ï¼‰
	ResolvedForks uint64 // å·²è§£å†³åˆ†å‰æ•°
	PendingForks  uint64 // å¾…å¤„ç†åˆ†å‰æ•°

	// ==================== é‡ç»„ç»Ÿè®¡ ====================

	TotalReorgs   uint64  // æ€»é‡ç»„æ¬¡æ•°
	MaxReorgDepth uint32  // æœ€å¤§é‡ç»„æ·±åº¦ï¼ˆåŒºå—æ•°ï¼‰
	AvgReorgDepth float64 // å¹³å‡é‡ç»„æ·±åº¦

	// ==================== æ—¶é—´ç»Ÿè®¡ ====================

	LastForkTime      int64   // æœ€ååˆ†å‰æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
	AvgResolutionTime float64 // å¹³å‡è§£å†³è€—æ—¶ï¼ˆç§’ï¼‰

	// ==================== çŠ¶æ€ä¿¡æ¯ ====================

	IsProcessing      bool   // æ˜¯å¦æ­£åœ¨å¤„ç†åˆ†å‰
	CurrentForkHeight uint64 // å½“å‰åˆ†å‰é«˜åº¦ï¼ˆå¦‚æœæ­£åœ¨å¤„ç†ï¼‰
}

// ============================================================================
//                          ç¼–è¯‘æ—¶æ£€æŸ¥
// ============================================================================

// ç¡®ä¿ InternalForkHandler åŒ…å« ForkHandler çš„æ‰€æœ‰æ–¹æ³•
var _ chain.ForkHandler = (InternalForkHandler)(nil)
