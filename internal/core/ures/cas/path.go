// Package cas è·¯å¾„æ„å»ºé€»è¾‘
package cas

import (
	"encoding/hex"
	"path/filepath"
)

// BuildFilePath æ„å»ºæ–‡ä»¶è·¯å¾„
//
// å®ç° CASStorage.BuildFilePath
//
// è·¯å¾„æ ¼å¼ï¼š{hash[0:2]}/{hash[2:4]}/{fullHash}
// ç¤ºä¾‹ï¼š5a/6b/5a6b7c8d9e...ï¼ˆå®Œæ•´64å­—ç¬¦SHA256å“ˆå¸Œï¼‰
//
// ğŸ¯ **è®¾è®¡ç†å¿µ**ï¼š
// - å†…å®¹å¯»å€ï¼šåŸºäºå†…å®¹å“ˆå¸Œæ„å»ºè·¯å¾„
// - åˆ†å±‚ç›®å½•ï¼šé¿å…å•ç›®å½•æ–‡ä»¶è¿‡å¤šï¼ˆ256Ã—256 = 65536ä¸ªäºŒçº§ç›®å½•ï¼‰
// - æ–‡ä»¶å‡åŒ€åˆ†å¸ƒï¼šåŸºäºå“ˆå¸Œçš„éšæœºæ€§
// - å¿«é€ŸæŸ¥æ‰¾ï¼šO(1)æŸ¥æ‰¾å¤æ‚åº¦
//
// å‚æ•°ï¼š
//   - contentHash: å†…å®¹å“ˆå¸Œï¼ˆå¿…é¡»æ˜¯32å­—èŠ‚SHA256å“ˆå¸Œï¼‰
//
// è¿”å›ï¼š
//   - string: æ–‡ä»¶è·¯å¾„ï¼ˆä¸åŒ…å« "files/" å‰ç¼€ï¼‰
//
// ç¤ºä¾‹ï¼š
//
//	hash := []byte{0x5a, 0x6b, 0x7c, ...} // 32å­—èŠ‚
//	path := s.BuildFilePath(hash)
//	// è¿”å›ï¼š"5a/6b/5a6b7c8d9e..."
func (s *Service) BuildFilePath(contentHash []byte) string {
	// 1. éªŒè¯å“ˆå¸Œé•¿åº¦ï¼ˆSHA256 = 32å­—èŠ‚ = 64åå…­è¿›åˆ¶å­—ç¬¦ï¼‰
	if len(contentHash) != 32 {
		if s.logger != nil {
			s.logger.Warnf("âš ï¸ æ— æ•ˆçš„å“ˆå¸Œé•¿åº¦: %dï¼ˆé¢„æœŸ32å­—èŠ‚ï¼‰", len(contentHash))
		}
		return ""
	}

	// 2. è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
	hashStr := hex.EncodeToString(contentHash) // 64ä¸ªå­—ç¬¦

	// 3. æ„å»ºåˆ†å±‚è·¯å¾„ï¼ˆé¿å…å•ç›®å½•æ–‡ä»¶è¿‡å¤šï¼‰
	// {hash[0:2]}ï¼šå‰2ä¸ªå­—ç¬¦ï¼ˆ256ç§å¯èƒ½ï¼Œä¸€çº§ç›®å½•ï¼‰
	// {hash[2:4]}ï¼šç¬¬3-4ä¸ªå­—ç¬¦ï¼ˆ256ç§å¯èƒ½ï¼ŒäºŒçº§ç›®å½•ï¼‰
	// {fullHash}ï¼šå®Œæ•´64å­—ç¬¦å“ˆå¸Œï¼ˆæ–‡ä»¶åï¼‰
	dir1 := hashStr[0:2]   // ä¸€çº§ç›®å½•
	dir2 := hashStr[2:4]   // äºŒçº§ç›®å½•
	fullHash := hashStr    // æ–‡ä»¶å

	// 4. æ‹¼æ¥è·¯å¾„ï¼ˆä½¿ç”¨ filepath.Join ç¡®ä¿è·¨å¹³å°å…¼å®¹ï¼‰
	// ç¤ºä¾‹ï¼š5a/6b/5a6b7c8d...
	return filepath.Join(dir1, dir2, fullHash)
}

