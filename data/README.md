# WES 数据目录说明

## 📁 目录结构

本目录包含WES区块链节点的运行时数据，按环境严格隔离：

```
data/
├── files/                      # 资源文件存储（内容寻址）
│   ├── 5a/                     # 哈希前缀目录 (SHA256[:2])
│   │   └── 5a6a35...bf4b9      # 完整哈希命名的文件
│   ├── ba/                     # 哈希前缀目录
│   │   └── bacb70...96d7       # 完整哈希命名的文件
│   └── [00-ff]/                # 256个可能的哈希前缀目录
├── development/                 # 开发环境数据
│   ├── single/                 # 单节点开发
│   │   ├── blockchain/         # 区块链数据（BadgerDB）
│   │   ├── logs/               # 节点日志文件
│   │   ├── p2p/                # P2P网络身份密钥
│   │   └── temp/               # 临时文件
│   └── cluster/                # 集群开发
│       ├── node1/              # 集群节点1数据
│       │   ├── blockchain/
│       │   ├── logs/
│       │   ├── p2p/
│       │   └── temp/           # 节点1临时文件
│       └── node2/              # 集群节点2数据
│           ├── blockchain/
│           ├── logs/
│           ├── p2p/
│           └── temp/           # 节点2临时文件
├── testing/                    # 测试环境数据
│   ├── blockchain/             # 测试网区块链数据
│   ├── logs/                   # 测试网日志
│   ├── p2p/                    # 测试网P2P身份
│   ├── temp/                   # 测试环境临时文件
│   └── backups/                # 测试数据备份
├── production/                 # 生产环境数据
│   ├── blockchain/             # 主网区块链数据
│   ├── logs/                   # 主网日志
│   ├── p2p/                    # 主网P2P身份
│   ├── temp/                   # 生产环境临时文件
│   ├── backups/                # 生产数据备份
│   └── archives/               # 历史数据归档
└── README.md                   # 本说明文件
```

## 🔄 自动创建机制

**重要**: 此目录结构由WES节点程序自动创建和管理，**无需手动创建**。

- 节点启动时会根据配置文件自动创建对应的数据目录
- 目录路径在配置文件中定义，代码负责确保目录存在
- 如果目录不存在，程序会自动创建完整的目录结构

## 📊 数据类型说明

### **files/** - 资源文件存储（内容寻址系统）
- **格式**: 基于SHA-256哈希的分层文件系统
- **内容**: 静态资源、智能合约、AI模型等所有资源文件
- **命名规范**: 
  - 目录名: SHA-256哈希的前2个字符 (`00` 到 `ff`, 共256种)
  - 文件名: 完整的64字符SHA-256哈希值
- **存储结构**:
  ```
  files/
  ├── 5a/5a6a352155b9196976ad9b022198d1442a59ce3d13eb41a9032059e2e08bf4b9
  ├── 5d/5d4a750385aac3fa97adb96c28b32f4eac516e1a5b6924879d99aa899125553e
  └── ba/bacb703efbf4c8b0492f81127724dbdf6c6dd9362108003d0146067f994196d7
  ```
- **设计优势**:
  - 🎯 **内容寻址**: 相同内容的文件只存储一次，自动去重
  - 🚀 **性能优化**: 分层目录避免单目录文件过多的性能问题
  - 🔒 **数据完整性**: 文件名即为内容哈希，可验证文件完整性
  - 📈 **扩展性**: 支持256个子目录，理论可存储无限文件
- **查找算法**: 
  1. 计算文件内容的SHA-256哈希
  2. 取哈希前2字符作为目录名
  3. 完整哈希作为文件名
- **备份**: 生产环境需要定期备份，包含`.sha256`校验文件

### **blockchain/** - 区块链数据
- **格式**: BadgerDB键值数据库
- **内容**: 区块、交易、UTXO、索引等核心区块链数据
- **大小**: 随区块链增长而增大
- **备份**: 生产环境需要定期备份

### **logs/** - 日志文件
- **格式**: 文本或JSON格式日志
- **内容**: 节点运行日志、错误信息、调试信息
- **轮转**: 自动按大小/时间轮转
- **保留**: 建议保留最近30天日志

### **p2p/** - P2P网络数据  
- **identity.key**: P2P网络身份私钥
- **权限**: 600 (仅所有者读写)
- **备份**: 建议备份身份密钥
- **安全**: 密钥丢失将导致P2P网络身份改变

### **temp/** - 运行时临时存储
- **用途**: 业务层临时文件存储（上传缓存、会话数据、处理文件等）
- **管理**: 自动TTL清理机制，防止磁盘空间占用
- **配置**: `internal/config/storage/temporary/` 中定义参数
- **容量**: 默认最大1GB，10000个文件限制
- **区别**: 与`./config-temp/`不同，这是运行时业务存储目录


### **backups/** - 数据备份
- **内容**: 自动创建的数据备份文件
- **格式**: 压缩归档文件
- **清理**: 需要定期清理旧备份

### **archives/** - 历史归档（仅生产环境）
- **内容**: 长期归档的历史数据
- **用途**: 历史查询、审计、合规

## 🗂️ 环境隔离特性

### **完全隔离**
- 不同环境的数据完全独立存储
- 避免开发数据污染生产环境
- 支持同时运行多个环境的节点

### **安全性**
- 生产环境数据受到严格保护
- 开发环境数据可以随时清理
- P2P身份密钥按环境独立管理

### **可维护性**
- 清晰的目录结构便于运维管理
- 支持按环境进行备份和恢复
- 便于问题诊断和数据迁移

## 🛠️ 运维操作

### **清理开发环境数据**
```bash
# 清理开发单节点数据
rm -rf data/development/single/*

# 清理开发集群数据
rm -rf data/development/cluster/*/

# 注意：清理后重启节点会重新创建目录结构
```

### **备份生产数据**
```bash
# 创建生产环境完整备份
tar -czf "production_backup_$(date +%Y%m%d_%H%M%S).tar.gz" data/production/

# 仅备份区块链数据
tar -czf "blockchain_backup_$(date +%Y%m%d_%H%M%S).tar.gz" data/production/blockchain/
```

### **监控磁盘空间**
```bash
# 检查各环境数据大小
du -sh data/*/

# 检查区块链数据增长
du -sh data/*/blockchain/

# 检查资源文件存储大小
du -sh data/files/

# 统计资源文件数量
find data/files -name "*[0-9a-f]" | grep -v ".sha256" | wc -l
```

### **资源文件管理**
```bash
# 验证文件完整性（检查哈希）
cd data/files
for dir in */; do
  for file in $dir*[0-9a-f]; do
    if [[ ! "$file" == *.sha256 ]]; then
      echo "验证: $(basename $file)"
      sha256sum "$file" | cut -d' ' -f1 | diff - <(basename "$file")
    fi
  done
done

# 查找重复内容的文件（理论上不应该存在）
find data/files -name "*[0-9a-f]" -type f | grep -v ".sha256" | xargs sha256sum | sort | uniq -d

# 清理损坏的资源文件（谨慎操作）
find data/files -name "*[0-9a-f]" | grep -v ".sha256" | while read file; do
  hash=$(basename "$file")
  if ! echo "$hash  $file" | sha256sum -c --quiet; then
    echo "发现损坏文件: $file"
    # rm "$file"  # 取消注释以删除损坏文件
  fi
done
```

## ⚠️ 注意事项

1. **数据重要性**:
   - 🔴 生产环境数据极其重要，删除前务必备份
   - 🟡 测试环境数据有一定价值，建议备份
   - 🟢 开发环境数据可以随时清理重建

2. **磁盘空间管理**:
   - 区块链数据会持续增长，注意监控磁盘空间
   - 日志文件需要定期清理，避免占用过多空间
   - 备份文件建议存储到外部存储系统

3. **权限管理**:
   - P2P身份密钥文件权限设置为600
   - 生产环境目录建议设置适当的访问权限
   - 避免以root用户运行节点程序

4. **Git版本控制**:
   - 除本README.md外，data目录下所有内容均在.gitignore中
   - 不要将运行时数据提交到Git仓库
   - P2P身份密钥等敏感信息严禁提交

5. **恢复操作**:
   - 从备份恢复时，确保节点已完全停止
   - 恢复P2P身份密钥后，节点将恢复原有网络身份
   - 区块链数据恢复后，节点会从恢复点继续同步

## 📞 技术支持

如果遇到数据相关问题：
1. 检查磁盘空间是否充足
2. 确认目录权限设置正确
3. 查看节点日志了解具体错误
4. 必要时从备份恢复数据

---
*本文档会随着WES项目发展持续更新*
