# wallet - é’±åŒ…ç®¡ç†

---

## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼š1.0
- **çŠ¶æ€**ï¼šstable
- **æœ€åæ›´æ–°**ï¼š2025-11-01
- **æ‰€æœ‰è€…**ï¼šCLI å¼€å‘ç»„
- **é€‚ç”¨èŒƒå›´**ï¼šCLI é’±åŒ…ç®¡ç†å’Œç­¾ååŠŸèƒ½

---

## ğŸ¯ å­åŸŸå®šä½

**è·¯å¾„**ï¼š`client/core/wallet/`

**æ‰€å±ç»„ä»¶**ï¼š`client/core`ï¼ˆCLI æ ¸å¿ƒä¸šåŠ¡å±‚ï¼‰

**æ ¸å¿ƒèŒè´£**ï¼šæä¾›æœ¬åœ°é’±åŒ…ç®¡ç†ã€ç§é’¥åŠ å¯†å­˜å‚¨å’Œäº¤æ˜“ç­¾ååŠŸèƒ½

**åœ¨ç»„ä»¶ä¸­çš„è§’è‰²**ï¼š
- é’±åŒ…è´¦æˆ·çš„åˆ›å»ºã€å¯¼å…¥ã€å¯¼å‡ºã€åˆ é™¤
- ç§é’¥çš„åŠ å¯†å­˜å‚¨ï¼ˆKeystore æ ¼å¼ï¼‰
- äº¤æ˜“ç­¾åå’Œå“ˆå¸Œç­¾å
- è´¦æˆ·è§£é”/é”å®šç®¡ç†

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åœ¨ç»„ä»¶ä¸­çš„ä½ç½®

```mermaid
graph TB
    subgraph "client/core CLIä¸šåŠ¡å±‚"
        subgraph "æœ¬å­åŸŸ wallet"
            THIS["wallet/<br/>é’±åŒ…ç®¡ç†"]
            
            ACCOUNT["AccountManager<br/>è´¦æˆ·ç®¡ç†"]
            KEYSTORE["Keystore<br/>åŠ å¯†å­˜å‚¨"]
            SIGNER["Signer<br/>ç­¾åæ¥å£"]
            
            THIS --> ACCOUNT
            THIS --> KEYSTORE
            THIS --> SIGNER
        end
        
        subgraph "åä½œçš„å­åŸŸ"
            TRANSFER["transfer/<br/>è½¬è´¦æœåŠ¡"]
            BUILDER["builder/<br/>äº¤æ˜“æ„å»ºå™¨"]
        end
        
        subgraph "å¤–éƒ¨ä¾èµ–"
            CRYPTO["crypto/address<br/>åœ°å€æœåŠ¡"]
        end
    end
    
    TRANSFER --> SIGNER
    BUILDER --> SIGNER
    ACCOUNT --> KEYSTORE
    ACCOUNT --> CRYPTO
    
    style THIS fill:#FFD700
```

**ä½ç½®è¯´æ˜**ï¼š

| å…³ç³»ç±»å‹ | ç›®æ ‡ | å…³ç³»è¯´æ˜ |
|---------|------|---------|
| **è¢«ä½¿ç”¨** | transfer/ | è½¬è´¦æœåŠ¡ä½¿ç”¨ Signer å¯¹äº¤æ˜“è¿›è¡Œç­¾å |
| **è¢«ä½¿ç”¨** | builder/ | äº¤æ˜“æ„å»ºå™¨ä½¿ç”¨ Signer ç­¾åäº¤æ˜“ |
| **ä¾èµ–** | crypto/address | ä½¿ç”¨ AddressService ç”Ÿæˆå’ŒéªŒè¯åœ°å€ |

---

### å†…éƒ¨ç»„ç»‡

```mermaid
graph TB
    subgraph "wallet/ ç›®å½•ç»“æ„"
        ACCOUNT["account_manager.go<br/>è´¦æˆ·ç®¡ç†å™¨"]
        KEYSTORE["keystore.go<br/>KeystoreåŠ å¯†å­˜å‚¨"]
        SIGNER["signer.go<br/>ç­¾åå™¨æ¥å£"]
    end
    
    ACCOUNT --> KEYSTORE
    ACCOUNT --> SIGNER
    KEYSTORE --> SIGNER
    
    style ACCOUNT fill:#FFD700
    style KEYSTORE fill:#E3F2FD
    style SIGNER fill:#E3F2FD
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
client/core/wallet/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ account_manager.go          # è´¦æˆ·ç®¡ç†å™¨ï¼ˆAccountManagerï¼‰
â”œâ”€â”€ keystore.go                 # Keystore åŠ å¯†å­˜å‚¨å®ç°
â””â”€â”€ signer.go                   # ç­¾åå™¨æ¥å£å®šä¹‰
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. è´¦æˆ·ç®¡ç†å™¨ï¼š`account_manager.go`

**æ ¸å¿ƒç±»å‹**ï¼š`AccountManager`

**èŒè´£**ï¼šç®¡ç†é’±åŒ…è´¦æˆ·çš„åˆ›å»ºã€å¯¼å…¥ã€å¯¼å‡ºã€åˆ é™¤å’ŒæŸ¥è¯¢

**å…³é”®å­—æ®µ**ï¼š

```go
type AccountManager struct {
    keystoreDir      string                          // Keystore ç›®å½•è·¯å¾„
    addressManager   AddressManager                  // åœ°å€ç®¡ç†å™¨ï¼ˆå¯é€‰ï¼‰
    unlockedAccounts map[string]*unlockedAccountData // å†…å­˜è§£é”ç¼“å­˜
}
```

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³•å | èŒè´£ | å¯è§æ€§ | å¤‡æ³¨ |
|-------|------|-------|-----|
| `NewAccountManager()` | åˆ›å»ºè´¦æˆ·ç®¡ç†å™¨ | Public | åˆå§‹åŒ– Keystore ç›®å½• |
| `CreateAccount()` | åˆ›å»ºæ–°è´¦æˆ· | Public | ç”Ÿæˆ32å­—èŠ‚éšæœºç§é’¥ï¼Œä½¿ç”¨ Cf å‰ç¼€åœ°å€ |
| `ImportPrivateKey()` | å¯¼å…¥ç§é’¥ | Public | æ”¯æŒ Cf å‰ç¼€åœ°å€æ ¼å¼ |
| `ExportPrivateKey()` | å¯¼å‡ºç§é’¥ | Public | éœ€è¦å¯†ç éªŒè¯ |
| `DeleteAccount()` | åˆ é™¤è´¦æˆ· | Public | éœ€è¦å¯†ç éªŒè¯ |
| `ListAccounts()` | åˆ—å‡ºæ‰€æœ‰è´¦æˆ· | Public | æ‰«æ Keystore ç›®å½• |
| `GetAccount()` | è·å–è´¦æˆ·ä¿¡æ¯ | Public | æ ¹æ®åœ°å€æŸ¥æ‰¾ |
| `UnlockAccount()` | è§£é”è´¦æˆ· | Public | å†…å­˜ç¼“å­˜è§£é”çŠ¶æ€ |
| `LockAccount()` | é”å®šè´¦æˆ· | Public | æ¸…é™¤å†…å­˜ç¼“å­˜ |

**è´¦æˆ·ä¿¡æ¯ç»“æ„**ï¼š

```go
type AccountInfo struct {
    ID            string    // è´¦æˆ·IDï¼ˆä½¿ç”¨åœ°å€ï¼‰
    Name          string    // è´¦æˆ·åç§°
    Address       string    // è´¦æˆ·åœ°å€ï¼ˆCf å‰ç¼€ï¼‰
    PrivateKeyHex string    // ç§é’¥ï¼ˆåå…­è¿›åˆ¶ï¼Œä»…è°ƒè¯•ç”¨ï¼‰
    KeystorePath  string    // Keystore æ–‡ä»¶è·¯å¾„
    Label         string    // ç”¨æˆ·æ ‡ç­¾
    CreatedAt     time.Time // åˆ›å»ºæ—¶é—´
    UpdatedAt     time.Time // æ›´æ–°æ—¶é—´
    IsDefault     bool      // æ˜¯å¦é»˜è®¤è´¦æˆ·
    IsUnlocked    bool      // æ˜¯å¦å·²è§£é”
}
```

---

### 2. Keystore åŠ å¯†å­˜å‚¨ï¼š`keystore.go`

**æ ¸å¿ƒç±»å‹**ï¼š`KeystoreV1`ã€`KeystoreSigner`

**èŒè´£**ï¼šå®ç° Keystore æ–‡ä»¶æ ¼å¼çš„åŠ å¯†å­˜å‚¨å’Œç­¾ååŠŸèƒ½

**Keystore æ–‡ä»¶æ ¼å¼ï¼ˆv1.0.0ï¼‰**ï¼š

```json
{
  "version": "1.0.0",
  "id": "uuid",
  "address": "Cf...",
  "crypto": {
    "cipher": "aes-256-gcm",
    "ciphertext": "hex...",
    "cipherparams": {
      "iv": "hex..."
    },
    "kdf": "pbkdf2",
    "kdfparams": {
      "dklen": 32,
      "salt": "hex...",
      "c": 262144,
      "prf": "hmac-sha256"
    },
    "mac": "hex..."
  },
  "created_at": "2025-11-01T10:00:00Z",
  "label": "My Wallet"
}
```

**åŠ å¯†ç®—æ³•**ï¼š
- âœ… **å¯†ç æ´¾ç”Ÿ**ï¼šPBKDF2ï¼ˆHMAC-SHA256ï¼Œ262144 æ¬¡è¿­ä»£ï¼‰
- âœ… **å¯¹ç§°åŠ å¯†**ï¼šAES-256-GCM
- âœ… **å®Œæ•´æ€§æ ¡éªŒ**ï¼šMACï¼ˆSHA256ï¼‰

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³•å | èŒè´£ | å¯è§æ€§ | å¤‡æ³¨ |
|-------|------|-------|-----|
| `NewKeystoreSigner()` | åˆ›å»º Keystore ç­¾åå™¨ | Public | éªŒè¯æ–‡ä»¶å­˜åœ¨ |
| `Unlock()` | è§£é” Keystore | Public | è§£å¯†ç§é’¥åˆ°å†…å­˜ |
| `Lock()` | é”å®š Keystore | Public | æ¸…é™¤å†…å­˜ç§é’¥ |
| `Sign()` | ç­¾åäº¤æ˜“ | Public | ä½¿ç”¨ ECDSA ç­¾å |
| `SignHash()` | ç­¾åå“ˆå¸Œå€¼ | Public | ç”¨äºæ¶ˆæ¯ç­¾å |

**å®‰å…¨ç‰¹æ€§**ï¼š
- âœ… ç§é’¥åŠ å¯†å­˜å‚¨ï¼ˆAES-256-GCMï¼‰
- âœ… å¯†ç æ´¾ç”Ÿï¼ˆPBKDF2ï¼Œ262144 æ¬¡è¿­ä»£ï¼‰
- âœ… å†…å­˜é”å®šæœºåˆ¶ï¼ˆè§£é”åç¼“å­˜ï¼Œé”å®šåæ¸…é™¤ï¼‰
- âœ… åœ°å€å¤§å°å†™æ•æ„Ÿï¼ˆBase58 åœ°å€åŒºåˆ†å¤§å°å†™ï¼‰

---

### 3. ç­¾åå™¨æ¥å£ï¼š`signer.go`

**æ ¸å¿ƒæ¥å£**ï¼š`Signer`

**èŒè´£**ï¼šå®šä¹‰ç»Ÿä¸€çš„ç­¾åæŠ½è±¡ï¼Œæ”¯æŒå¤šç§ç­¾åæ–¹å¼

**æ¥å£å®šä¹‰**ï¼š

```go
type Signer interface {
    // ç­¾åäº¤æ˜“
    Sign(tx []byte, fromAddr string) ([]byte, error)
    
    // ç­¾åå“ˆå¸Œå€¼ï¼ˆç”¨äºæ¶ˆæ¯ç­¾åï¼‰
    SignHash(hash []byte, fromAddr string) ([]byte, error)
    
    // è·å–åœ°å€
    GetAddress(derivationPath string) (string, error)
    
    // åˆ—å‡ºæ‰€æœ‰ç®¡ç†çš„åœ°å€
    ListAddresses() ([]string, error)
    
    // è§£é”ç­¾åå™¨ï¼ˆå¦‚éœ€å¯†ç ï¼‰
    Unlock(password string, duration time.Duration) error
    
    // é”å®šç­¾åå™¨
    Lock()
    
    // æ£€æŸ¥æ˜¯å¦å·²é”å®š
    IsLocked() bool
    
    // è¿”å›ç­¾åå™¨ç±»å‹
    Type() SignerType
}
```

**ç­¾åå™¨ç±»å‹**ï¼š

| ç±»å‹ | è¯´æ˜ | å®ç°çŠ¶æ€ |
|-----|------|---------|
| `keystore` | åŠ å¯† Keystore æ–‡ä»¶ | âœ… å·²å®ç° |
| `mnemonic` | BIP39 åŠ©è®°è¯ | ğŸš§ è®¡åˆ’ä¸­ |
| `hardware` | ç¡¬ä»¶é’±åŒ… | ğŸš§ è®¡åˆ’ä¸­ |
| `external` | å¤–éƒ¨ç­¾åå™¨ | ğŸš§ è®¡åˆ’ä¸­ |

---

## ğŸ”— åä½œå…³ç³»

### ä¾èµ–çš„æ¥å£

| æ¥å£ | æ¥æº | ç”¨é€” |
|-----|------|-----|
| `AddressManager` | `internal/core/infrastructure/crypto/address/` | åœ°å€ç”Ÿæˆå’ŒéªŒè¯ |

---

### è¢«ä¾èµ–å…³ç³»

**è¢«ä»¥ä¸‹æ¨¡å—ä½¿ç”¨**ï¼š
- `client/core/transfer/` - è½¬è´¦æœåŠ¡ä½¿ç”¨ Signer å¯¹äº¤æ˜“è¿›è¡Œç­¾å
- `client/core/builder/` - äº¤æ˜“æ„å»ºå™¨ä½¿ç”¨ Signer ç­¾åäº¤æ˜“
- `cmd/weisyn/` - CLI å…¥å£ä½¿ç”¨ AccountManager ç®¡ç†é’±åŒ…è´¦æˆ·

**ç¤ºä¾‹**ï¼š

```go
// åœ¨è½¬è´¦æœåŠ¡ä¸­ä½¿ç”¨
import "github.com/weisyn/v1/client/core/wallet"

func executeTransfer(signer *wallet.Signer, tx []byte) error {
    // è§£é”ç­¾åå™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if signer.IsLocked() {
        if err := signer.Unlock(password, 5*time.Minute); err != nil {
            return err
        }
    }
    
    // ç­¾åäº¤æ˜“
    signedTx, err := signer.Sign(tx, fromAddress)
    if err != nil {
        return err
    }
    
    // ä½¿ç”¨ç­¾ååçš„äº¤æ˜“...
    return nil
}
```

---

## ğŸ“Š å…³é”®è®¾è®¡å†³ç­–

### å†³ç­– 1ï¼šä½¿ç”¨ Keystore æ–‡ä»¶æ ¼å¼

**é—®é¢˜**ï¼šå¦‚ä½•å®‰å…¨åœ°å­˜å‚¨ç§é’¥ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šä½¿ç”¨ä»¥å¤ªåŠå…¼å®¹çš„ Keystore v1.0.0 æ ¼å¼

**ç†ç”±**ï¼š
- âœ… è¡Œä¸šæ ‡å‡†ï¼šä»¥å¤ªåŠç”Ÿæ€å¹¿æ³›ä½¿ç”¨ï¼Œå·¥å…·å…¼å®¹æ€§å¥½
- âœ… å®‰å…¨æ€§é«˜ï¼šAES-256-GCM åŠ å¯† + PBKDF2 å¯†ç æ´¾ç”Ÿ
- âœ… å®Œæ•´æ€§æ ¡éªŒï¼šMAC ç¡®ä¿æ–‡ä»¶æœªè¢«ç¯¡æ”¹

**æƒè¡¡**ï¼š
- âœ… ä¼˜ç‚¹ï¼šå®‰å…¨æ€§é«˜ï¼Œå·¥å…·å…¼å®¹æ€§å¥½
- âš ï¸ ç¼ºç‚¹ï¼šæ–‡ä»¶æ ¼å¼å¤æ‚ï¼Œéœ€è¦ JSON è§£æ

---

### å†³ç­– 2ï¼šå†…å­˜è§£é”ç¼“å­˜æœºåˆ¶

**é—®é¢˜**ï¼šæ¯æ¬¡ç­¾åéƒ½éœ€è¦è¾“å…¥å¯†ç ï¼Œç”¨æˆ·ä½“éªŒå·®ï¼Œå¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œä¾¿åˆ©æ€§ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šå®ç°å†…å­˜è§£é”ç¼“å­˜ï¼Œè§£é”ååœ¨ä¸€å®šæ—¶é—´å†…æ— éœ€é‡å¤è¾“å…¥å¯†ç 

**ç†ç”±**ï¼š
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼šè§£é”åçŸ­æ—¶é—´å†…æ— éœ€é‡å¤è¾“å…¥å¯†ç 
- âœ… å®‰å…¨æ€§ï¼šç§é’¥ä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œç¨‹åºé€€å‡ºåè‡ªåŠ¨æ¸…é™¤
- âœ… å¯é…ç½®ï¼šæ”¯æŒè®¾ç½®è§£é”æ—¶é•¿ï¼Œ0 è¡¨ç¤ºæ°¸ä¹…è§£é”ï¼ˆç›´åˆ°è°ƒç”¨ Lockï¼‰

**å®ç°**ï¼š
- `AccountManager` ç»´æŠ¤ `unlockedAccounts` mapï¼Œç¼“å­˜è§£é”çŠ¶æ€
- `KeystoreSigner` åœ¨å†…å­˜ä¸­ä¿å­˜è§£å¯†åçš„ç§é’¥
- è°ƒç”¨ `Lock()` æˆ–ç¨‹åºé€€å‡ºæ—¶æ¸…é™¤å†…å­˜ç¼“å­˜

---

### å†³ç­– 3ï¼šæ”¯æŒ Cf å‰ç¼€åœ°å€æ ¼å¼

**é—®é¢˜**ï¼šå¦‚ä½•å…¼å®¹æ—§ç‰ˆåœ°å€æ ¼å¼ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šåœ¨åœ°å€ç”Ÿæˆå’ŒéªŒè¯æ—¶æ”¯æŒ Cf å‰ç¼€æ ¼å¼

**ç†ç”±**ï¼š
- âœ… å‘åå…¼å®¹ï¼šæ”¯æŒæ—§ç‰ˆåœ°å€æ ¼å¼
- âœ… åœ°å€æ ‡å‡†åŒ–ï¼šç»Ÿä¸€ä½¿ç”¨ Cf å‰ç¼€æ ‡è¯†

**å®ç°**ï¼š
- `CreateAccount()` ä½¿ç”¨ `deriveAddressCf()` ç”Ÿæˆ Cf å‰ç¼€åœ°å€
- `ImportPrivateKey()` æ”¯æŒç§»é™¤ `Cf` å‰ç¼€
- åœ°å€æ¯”è¾ƒæ—¶ä½¿ç”¨ `normalizeAddress()` ç»Ÿä¸€æ ¼å¼

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•è¦†ç›–

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶ | è¦†ç›–ç‡ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|---------|------|-----------|---------|
| å•å…ƒæµ‹è¯• | `*_test.go` | â‰¥ 80% | å¾…è¡¥å…… |
| é›†æˆæµ‹è¯• | `../integration/` | æ ¸å¿ƒåœºæ™¯ | å¾…è¡¥å…… |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [CLI æ ¸å¿ƒä¸šåŠ¡å±‚æ€»è§ˆ](../README.md)
- [è½¬è´¦æœåŠ¡](../transfer/README.md)
- [äº¤æ˜“æ„å»ºå™¨](../builder/README.md)
- [CLI å®¢æˆ·ç«¯æ”¯æŒåº“](../../README.md)

---

## ğŸ“ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| 1.0 | 2025-11-01 | åˆå§‹ç‰ˆæœ¬ï¼Œæ·»åŠ  README æ–‡æ¡£ | CLI å¼€å‘ç»„ |

---

## ğŸš§ å¾…åŠäº‹é¡¹

- [ ] æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] æ”¯æŒ BIP39 åŠ©è®°è¯é’±åŒ…
- [ ] æ”¯æŒç¡¬ä»¶é’±åŒ…ï¼ˆLedger/Trezorï¼‰
- [ ] æ·»åŠ è´¦æˆ·å¤‡ä»½/æ¢å¤åŠŸèƒ½
- [ ] ä¼˜åŒ–è§£é”ç¼“å­˜æœºåˆ¶ï¼ˆè‡ªåŠ¨è¶…æ—¶é”å®šï¼‰

