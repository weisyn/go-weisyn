// Package storage æä¾›WESç³»ç»Ÿçš„SQLiteå­˜å‚¨æ¥å£å®šä¹‰
//
// ğŸ—ƒï¸ **SQLiteå­˜å‚¨æœåŠ¡ (SQLite Storage Service)**
//
// æœ¬æ–‡ä»¶å®šä¹‰äº†WESåŒºå—é“¾ç³»ç»Ÿçš„SQLiteå­˜å‚¨æ¥å£ï¼Œä¸“æ³¨äºï¼š
// - ç»“æ„åŒ–å­˜å‚¨ï¼šå…³ç³»å‹æ•°æ®çš„ç»“æ„åŒ–å­˜å‚¨å’ŒæŸ¥è¯¢
// - äº‹åŠ¡æ”¯æŒï¼šå®Œæ•´çš„ACIDäº‹åŠ¡å’Œæ•°æ®ä¸€è‡´æ€§ä¿éšœ
// - SQLæŸ¥è¯¢ï¼šçµæ´»çš„SQLæŸ¥è¯¢å’Œå¤æ‚æ•°æ®æ£€ç´¢
// - è½»é‡çº§éƒ¨ç½²ï¼šSQLiteçš„åµŒå…¥å¼ç‰¹æ€§å’Œé›¶é…ç½®ä¼˜åŠ¿
//
// ğŸ¯ **æ ¸å¿ƒåŠŸèƒ½**
// - SQLiteServiceï¼šSQLiteå­˜å‚¨æœåŠ¡æ¥å£ï¼Œæä¾›å®Œæ•´çš„å…³ç³»å‹æ•°æ®ç®¡ç†
// - è¡¨ç»“æ„ç®¡ç†ï¼šæ•°æ®è¡¨çš„åˆ›å»ºã€ä¿®æ”¹å’Œç´¢å¼•ç®¡ç†
// - äº‹åŠ¡æ“ä½œï¼šæ”¯æŒå¤æ‚çš„äº‹åŠ¡å¤„ç†å’Œå›æ»šæœºåˆ¶
// - æ•°æ®è¿ç§»ï¼šæ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å’Œç»“æ„è¿ç§»æ”¯æŒ
//
// ğŸ—ï¸ **è®¾è®¡åŸåˆ™**
// - æ•°æ®å®Œæ•´æ€§ï¼šä¸¥æ ¼çš„æ•°æ®çº¦æŸå’Œä¸€è‡´æ€§ä¿éšœ
// - æŸ¥è¯¢çµæ´»ï¼šæ”¯æŒå¤æ‚çš„SQLæŸ¥è¯¢å’Œæ•°æ®åˆ†æ
// - è½»é‡é«˜æ•ˆï¼šåˆ©ç”¨SQLiteçš„è½»é‡çº§å’Œé«˜æ€§èƒ½ç‰¹æ€§
// - æ˜“ç»´æŠ¤æ€§ï¼šæ¸…æ™°çš„è¡¨ç»“æ„è®¾è®¡å’Œæ•°æ®æ¨¡å‹
//
// ğŸ”— **ç»„ä»¶å…³ç³»**
// - SQLiteServiceï¼šè¢«ç»Ÿè®¡ã€åˆ†æã€å¤æ‚æŸ¥è¯¢ç­‰æ¨¡å—ä½¿ç”¨
// - ä¸StorageProviderï¼šä½œä¸ºç»“æ„åŒ–æ•°æ®çš„ä¸“ç”¨å­˜å‚¨å±‚
// - ä¸å…¶ä»–å­˜å‚¨ï¼šä¸BadgerDBã€Memoryé…åˆæä¾›æ··åˆå­˜å‚¨
package storage

import (
	"context"
)

//=============================================================================
// SQLiteStore æ¥å£å®šä¹‰
//=============================================================================

// SQLiteStore å®šä¹‰äº†ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ¥å£
// æä¾›å¯¹ç»“æ„åŒ–æ•°æ®çš„è®¿é—®èƒ½åŠ›ï¼Œåº•å±‚å¯åŸºäºSQLiteç­‰å…³ç³»å‹æ•°æ®åº“å®ç°
// é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–æŸ¥è¯¢ã€äº‹åŠ¡æ”¯æŒçš„åº”ç”¨åœºæ™¯
type SQLiteStore interface {
	//-------------------------------------------------------------------------
	// ç”Ÿå‘½å‘¨æœŸç®¡ç†
	//-------------------------------------------------------------------------

	// æ³¨æ„ï¼šSQLiteè¿æ¥èµ„æºç”±DIå®¹å™¨è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨Close()

	//-------------------------------------------------------------------------
	// åŸºæœ¬æŸ¥è¯¢æ“ä½œ
	//-------------------------------------------------------------------------

	// QueryRow æŸ¥è¯¢å•è¡Œæ•°æ®
	// query: SQLæŸ¥è¯¢è¯­å¥ï¼Œå¦‚"SELECT * FROM users WHERE id = ?"
	// args: æŸ¥è¯¢å‚æ•°ï¼Œç”¨äºæ›¿æ¢SQLè¯­å¥ä¸­çš„å ä½ç¬¦
	// è¿”å›é”®å€¼å¯¹å½¢å¼çš„ç»“æœï¼Œé”®ä¸ºåˆ—åï¼Œå€¼ä¸ºåˆ—å€¼
	// å¦‚æœæŸ¥è¯¢ä¸åˆ°ç»“æœï¼Œè¿”å›ç©ºmapå’Œnilé”™è¯¯
	QueryRow(ctx context.Context, query string, args ...interface{}) (map[string]interface{}, error)

	// QueryRows æŸ¥è¯¢å¤šè¡Œæ•°æ®
	// query: SQLæŸ¥è¯¢è¯­å¥ï¼Œå¦‚"SELECT * FROM users WHERE age > ?"
	// args: æŸ¥è¯¢å‚æ•°ï¼Œç”¨äºæ›¿æ¢SQLè¯­å¥ä¸­çš„å ä½ç¬¦
	// è¿”å›é”®å€¼å¯¹æ•°ç»„å½¢å¼çš„ç»“æœï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€è¡Œï¼Œé”®ä¸ºåˆ—åï¼Œå€¼ä¸ºåˆ—å€¼
	// å¦‚æœæŸ¥è¯¢ä¸åˆ°ç»“æœï¼Œè¿”å›ç©ºæ•°ç»„å’Œnilé”™è¯¯
	QueryRows(ctx context.Context, query string, args ...interface{}) ([]map[string]interface{}, error)

	// Execute æ‰§è¡Œæ›´æ–°æ“ä½œï¼ˆINSERT/UPDATE/DELETEï¼‰
	// query: SQLè¯­å¥ï¼Œå¦‚"INSERT INTO users (name, age) VALUES (?, ?)"
	// args: å‚æ•°ï¼Œç”¨äºæ›¿æ¢SQLè¯­å¥ä¸­çš„å ä½ç¬¦
	// è¿”å›å—å½±å“çš„è¡Œæ•°
	// å¯¹äºDDLè¯­å¥ï¼ˆå¦‚CREATE TABLEï¼‰ï¼Œè¿”å›0å’Œnilé”™è¯¯
	Execute(ctx context.Context, query string, args ...interface{}) (int64, error)

	//-------------------------------------------------------------------------
	// äº‹åŠ¡æ“ä½œ
	//-------------------------------------------------------------------------

	// RunInTransaction åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ
	// fn: åœ¨äº‹åŠ¡ç¯å¢ƒä¸­æ‰§è¡Œçš„å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªäº‹åŠ¡å¯¹è±¡ä½œä¸ºå‚æ•°
	// å¦‚æœfnè¿”å›é”™è¯¯ï¼Œäº‹åŠ¡å°†è¢«å›æ»š
	// å¦‚æœfnæˆåŠŸæ‰§è¡Œï¼Œäº‹åŠ¡å°†è¢«æäº¤
	// äº‹åŠ¡ç¡®ä¿æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
	RunInTransaction(ctx context.Context, fn func(tx SQLTransaction) error) error

	//-------------------------------------------------------------------------
	// è¡¨æ“ä½œ
	//-------------------------------------------------------------------------

	// TableExists æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
	// tableName: è¡¨å
	// è¿”å›trueè¡¨ç¤ºè¡¨å­˜åœ¨ï¼Œfalseè¡¨ç¤ºè¡¨ä¸å­˜åœ¨
	TableExists(ctx context.Context, tableName string) (bool, error)

	// CreateTable åˆ›å»ºè¡¨
	// tableName: è¡¨å
	// columnDefs: åˆ—å®šä¹‰ï¼Œé”®ä¸ºåˆ—åï¼Œå€¼ä¸ºåˆ—ç±»å‹å®šä¹‰ï¼ˆå¦‚"INTEGER NOT NULL"ï¼‰
	// ifNotExists: æ˜¯å¦ä½¿ç”¨"IF NOT EXISTS"è¯­å¥ï¼Œtrueè¡¨ç¤ºè¡¨å·²å­˜åœ¨æ—¶ä¸æŠ¥é”™
	// åˆ›å»ºæˆåŠŸè¿”å›nilï¼Œå¤±è´¥è¿”å›ç›¸åº”é”™è¯¯
	CreateTable(ctx context.Context, tableName string, columnDefs map[string]string, ifNotExists bool) error

	// DropTable åˆ é™¤è¡¨
	// tableName: è¡¨å
	// ifExists: æ˜¯å¦ä½¿ç”¨"IF EXISTS"è¯­å¥ï¼Œtrueè¡¨ç¤ºè¡¨ä¸å­˜åœ¨æ—¶ä¸æŠ¥é”™
	// åˆ é™¤æˆåŠŸè¿”å›nilï¼Œå¤±è´¥è¿”å›ç›¸åº”é”™è¯¯
	DropTable(ctx context.Context, tableName string, ifExists bool) error

	//-------------------------------------------------------------------------
	// è¾…åŠ©åŠŸèƒ½
	//-------------------------------------------------------------------------

	// LastInsertID è·å–æœ€åæ’å…¥çš„ID
	// è¿”å›æœ€åä¸€æ¬¡INSERTæ“ä½œç”Ÿæˆçš„è‡ªå¢ID
	// é€šå¸¸ç”¨äºè·å–AUTO_INCREMENTåˆ—çš„å€¼
	LastInsertID(ctx context.Context) (int64, error)
}

//=============================================================================
// SQLTransaction æ¥å£å®šä¹‰
//=============================================================================

// SQLTransaction å®šä¹‰äº†äº‹åŠ¡æ“ä½œæ¥å£
// æä¾›åœ¨å•ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªSQLæ“ä½œçš„èƒ½åŠ›
// é€šè¿‡RunInTransactionæ–¹æ³•è·å–äº‹åŠ¡å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ›å»º
type SQLTransaction interface {
	// QueryRow åœ¨äº‹åŠ¡ä¸­æŸ¥è¯¢å•è¡Œæ•°æ®
	// query: SQLæŸ¥è¯¢è¯­å¥
	// args: æŸ¥è¯¢å‚æ•°
	// è¿”å›é”®å€¼å¯¹å½¢å¼çš„ç»“æœ
	QueryRow(query string, args ...interface{}) (map[string]interface{}, error)

	// QueryRows åœ¨äº‹åŠ¡ä¸­æŸ¥è¯¢å¤šè¡Œæ•°æ®
	// query: SQLæŸ¥è¯¢è¯­å¥
	// args: æŸ¥è¯¢å‚æ•°
	// è¿”å›é”®å€¼å¯¹æ•°ç»„å½¢å¼çš„ç»“æœ
	QueryRows(query string, args ...interface{}) ([]map[string]interface{}, error)

	// Execute åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ›´æ–°æ“ä½œ
	// query: SQLè¯­å¥
	// args: å‚æ•°
	// è¿”å›å—å½±å“çš„è¡Œæ•°
	Execute(query string, args ...interface{}) (int64, error)
}
