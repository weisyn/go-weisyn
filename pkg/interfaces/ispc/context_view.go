// Package ispc provides context view interfaces for ISPC operations.
package ispc

// ════════════════════════════════════════════════════════════════════════════════════════════════
// ExecutionContextView - 执行上下文视图（只读、确定性）
// ════════════════════════════════════════════════════════════════════════════════════════════════
//
// 📋 **接口说明**：
//   - 为宿主函数提供执行上下文的只读视图
//   - 确保确定性执行：所有返回值基于固定快照
//   - 不暴露内部实现细节，仅提供最小必要信息
//   - 由 internal/core/ispc/context 实现
//
// 🎯 **设计目的**：
//   - 轻量级：只暴露宿主函数需要的最小能力
//   - 只读性：所有方法不修改状态，确保并发安全
//   - 确定性：基于固定区块高度的快照，保证可重放
//   - 隔离性：不暴露 ExecutionContext 的完整接口
//
// 🔒 **设计约束**：
//   - ✅ 只读：所有方法返回值，不修改状态
//   - ✅ 确定性：返回值基于创建时的固定快照
//   - ✅ 无状态：方法调用无副作用
//   - ✅ 轻量级：最小化方法数量
//
// 📚 **相关文档**：
//   - Host ABI 规范：_docs/specs/HOST_ABI_MINIMAL_PRIMITIVES.md
//   - ISPC 架构：_docs/implementation/ISPC_INTERFACE_ARCHITECTURE_ANALYSIS.md
//
// ════════════════════════════════════════════════════════════════════════════════════════════════

type ExecutionContextView interface {

	// ════════════════════════════════════════════════════════════════════════════════════════
	// 确定性区块视图（只读）
	// ════════════════════════════════════════════════════════════════════════════════════════

	// GetBlockHeight 获取当前区块高度
	//
	// 返回值:
	//   - uint64: 当前区块高度（固定快照）
	//
	// 说明:
	//   - 基于创建时的固定高度，确保执行确定性
	//   - 不会动态查询最新高度
	GetBlockHeight() uint64

	// GetBlockTimestamp 获取当前区块时间戳
	//
	// 返回值:
	//   - uint64: Unix 时间戳（秒）
	//
	// 说明:
	//   - 基于创建时的固定时间戳
	//   - 不会动态查询最新时间
	GetBlockTimestamp() uint64

	// GetChainID 获取链标识
	//
	// 返回值:
	//   - []byte: 链 ID
	//
	// 说明:
	//   - 用于区分不同的区块链网络（主网、测试网等）
	//   - 固定值，不会变化
	GetChainID() []byte

	// ════════════════════════════════════════════════════════════════════════════════════════
	// 执行上下文信息（只读）
	// ════════════════════════════════════════════════════════════════════════════════════════

	// GetExecutionID 获取执行 ID
	//
	// 返回值:
	//   - string: 执行唯一标识符
	//
	// 说明:
	//   - 用于关联执行轨迹和日志
	//   - 每次执行唯一
	GetExecutionID() string

	// GetCaller 获取调用者地址
	//
	// 返回值:
	//   - []byte: 调用者地址（20 字节）
	//
	// 说明:
	//   - 表示发起合约调用的账户地址
	//   - 用于权限验证、访问控制等场景
	GetCaller() []byte

	// GetContractAddress 获取当前合约地址
	//
	// 返回值:
	//   - []byte: 合约地址（20 字节）
	//
	// 说明:
	//   - 表示当前正在执行的合约地址
	//   - 用于合约自身逻辑判断、代理模式等场景
	GetContractAddress() []byte

	// GetTransactionID 获取当前交易 ID
	//
	// 返回值:
	//   - []byte: 交易 ID（32 字节哈希）
	//
	// 说明:
	//   - 表示当前正在构建的交易的唯一标识
	//   - 用于幂等性检查、事件关联等场景
	GetTransactionID() []byte

	// ════════════════════════════════════════════════════════════════════════════════════════
	// Draft 访问（间接）
	// ════════════════════════════════════════════════════════════════════════════════════════

	// GetDraftID 获取交易草稿 ID
	//
	// 返回值:
	//   - string: 草稿唯一标识符
	//
	// 说明:
	//   - 用于宿主函数通过 TransactionDraftService 访问草稿
	//   - 不直接暴露 Draft 对象，保持职责分离
	GetDraftID() string

	// ════════════════════════════════════════════════════════════════════════════════════════
	// Trace 记录接口
	// ════════════════════════════════════════════════════════════════════════════════════════

	// RecordHostFunctionCall 记录宿主函数调用
	//
	// 参数:
	//   - call: 宿主函数调用记录
	//
	// 说明:
	//   - 记录宿主函数的调用轨迹，供 ZK 证明使用
	//   - 调用此方法不返回错误，确保执行流程不中断
	//   - 实现层负责将记录写入执行轨迹
	RecordHostFunctionCall(call *HostFunctionCall)

	// ════════════════════════════════════════════════════════════════════════════════════════
	// 调试与日志（辅助）
	// ════════════════════════════════════════════════════════════════════════════════════════

	// LogDebug 记录调试日志（非链上）
	//
	// 参数:
	//   - message: 日志消息
	//
	// 说明:
	//   - 日志不进入链上，仅用于调试和监控
	//   - 记录到执行节点的日志系统
	//   - 不占用链上存储，可以任意使用
	LogDebug(message string)
}

// HostFunctionCall 宿主函数调用记录
//
// 📋 **记录内容**：
//   - 函数名、参数、返回值、调用时序
//   - 用于 ZK 证明生成和执行审计
//
// 🔒 **设计约束**：
//   - 所有字段不可变
//   - 不包含敏感信息
type HostFunctionCall struct {
	// 序号（调用顺序）
	Sequence uint64

	// 函数名（如 "tx_add_input", "utxo_lookup" 等）
	FunctionName string

	// 参数（JSON 编码）
	Parameters map[string]interface{}

	// 返回值（JSON 编码）
	Result map[string]interface{}

	// 调用时间戳（Unix 纳秒）
	Timestamp int64
}
