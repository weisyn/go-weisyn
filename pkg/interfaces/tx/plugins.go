// Package tx provides plugin interfaces for transaction verification.
package tx

import (
	"context"

	transaction "github.com/weisyn/v1/pb/blockchain/block/transaction"
	utxopb "github.com/weisyn/v1/pb/blockchain/utxo"
)

// ================================================================================================
// ğŸŒ Verifier Environmentï¼ˆéªŒè¯ç¯å¢ƒæ¥å£ï¼‰
// ================================================================================================

// VerifierEnvironment éªŒè¯ç¯å¢ƒæ¥å£
//
// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼šä¸ºéªŒè¯æ’ä»¶æä¾›åŒºå—ä¸Šä¸‹æ–‡å’Œå¿…è¦çš„æŸ¥è¯¢èƒ½åŠ›
//
// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
// å°†åŒºå—ä¸Šä¸‹æ–‡ï¼ˆé«˜åº¦ã€æ—¶é—´ã€çŸ¿å·¥ç­‰ï¼‰å’ŒæŸ¥è¯¢èƒ½åŠ›ï¼ˆUTXOã€è´¹ç”¨ç­‰ï¼‰
// æŠ½è±¡ä¸ºç»Ÿä¸€æ¥å£ï¼Œä¾›éªŒè¯æ’ä»¶ä½¿ç”¨ã€‚
//
// âš ï¸ **æ ¸å¿ƒçº¦æŸ**ï¼š
// - âŒ ç¯å¢ƒåªè¯»ï¼šä¸èƒ½ä¿®æ”¹åŒºå—çŠ¶æ€
// - âœ… ç¯å¢ƒå¯æ‰©å±•ï¼šå¯é€šè¿‡æ¥å£ç»„åˆæ·»åŠ æ–°èƒ½åŠ›
//
// ğŸ“ **å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š
// - CoinbaseéªŒè¯ï¼šè·å–æœŸæœ›è´¹ç”¨å’ŒçŸ¿å·¥åœ°å€
// - æ—¶é—´é”éªŒè¯ï¼šè·å–å½“å‰åŒºå—æ—¶é—´
// - é«˜åº¦é”éªŒè¯ï¼šè·å–å½“å‰åŒºå—é«˜åº¦
// - èµåŠ©é¢†å–éªŒè¯ï¼šæŸ¥è¯¢èµåŠ©æ± UTXO
//
// ğŸ“ **è°ƒç”¨æ–¹**ï¼šéªŒè¯æ’ä»¶ï¼ˆAuthZPluginã€ConservationPluginã€ConditionPluginï¼‰
type VerifierEnvironment interface {
	// ==================== åŒºå—ä¸Šä¸‹æ–‡ ====================

	// GetBlockHeight è·å–å½“å‰åŒºå—é«˜åº¦
	//
	// è¿”å›ï¼šå½“å‰æ­£åœ¨æ„å»º/éªŒè¯çš„åŒºå—é«˜åº¦
	//
	// ç”¨é€”ï¼š
	// - é«˜åº¦é”éªŒè¯
	// - DelegationLockæœ‰æ•ˆæœŸæ£€æŸ¥
	GetBlockHeight() uint64

	// GetBlockTime è·å–å½“å‰åŒºå—æ—¶é—´
	//
	// è¿”å›ï¼šå½“å‰åŒºå—æ—¶é—´ï¼ˆUnixæ—¶é—´æˆ³ï¼Œç§’ï¼‰
	//
	// ç”¨é€”ï¼š
	// - æ—¶é—´é”éªŒè¯
	// - äº¤æ˜“æœ‰æ•ˆæœŸæ£€æŸ¥
	GetBlockTime() uint64

	// GetMinerAddress è·å–çŸ¿å·¥åœ°å€
	//
	// è¿”å›ï¼šå½“å‰åŒºå—çš„çŸ¿å·¥åœ°å€ï¼ˆ20å­—èŠ‚ï¼‰
	//
	// ç”¨é€”ï¼š
	// - Coinbaseè¾“å‡ºOwneréªŒè¯
	// - èµåŠ©é¢†å–æƒé™éªŒè¯
	GetMinerAddress() []byte

	// GetChainID è·å–é“¾ID
	//
	// è¿”å›ï¼šå½“å‰é“¾çš„å”¯ä¸€æ ‡è¯†
	//
	// ç”¨é€”ï¼š
	// - é˜²è·¨é“¾é‡æ”¾æ”»å‡»
	// - äº¤æ˜“åˆæ³•æ€§æ£€æŸ¥
	GetChainID() []byte

	// ==================== è´¹ç”¨ç›¸å…³ ====================

	// GetExpectedFees è·å–æœŸæœ›è´¹ç”¨ï¼ˆèšåˆåï¼‰
	//
	// è¿”å›ï¼šä»åŒºå—å†…æ™®é€šäº¤æ˜“èšåˆçš„æœŸæœ›è´¹ç”¨ï¼ˆæŒ‰Tokenåˆ†ç»„ï¼‰
	//
	// ç”¨é€”ï¼š
	// - Coinbaseè´¹ç”¨å®ˆæ’éªŒè¯
	// - ç¡®ä¿Coinbaseä¸å¢å‘
	//
	// âš ï¸ æ³¨æ„ï¼š
	// - ä»…åœ¨éªŒè¯Coinbaseæ—¶éœ€è¦
	// - æ™®é€šäº¤æ˜“éªŒè¯ä¸éœ€è¦æ­¤æ–¹æ³•
	GetExpectedFees() *AggregatedFees

	// ==================== UTXOæŸ¥è¯¢ ====================

	// GetUTXO æŸ¥è¯¢å•ä¸ªUTXO
	//
	// å‚æ•°ï¼š
	//   outpoint: UTXOçš„OutPoint
	//
	// è¿”å›ï¼š
	//   *utxopb.UTXO: UTXOå¯¹è±¡
	//   error: æŸ¥è¯¢é”™è¯¯ï¼ˆå¦‚UTXOä¸å­˜åœ¨ï¼‰
	//
	// ç”¨é€”ï¼š
	// - éªŒè¯Inputå¼•ç”¨çš„UTXO
	// - æå–LockingCondition
	GetUTXO(ctx context.Context, outpoint *transaction.OutPoint) (*utxopb.UTXO, error)

	// ==================== æ‰©å±•èƒ½åŠ›ï¼ˆå¯é€‰ï¼‰ ====================

	// IsCoinbase åˆ¤æ–­å½“å‰äº¤æ˜“æ˜¯å¦ä¸ºCoinbase
	//
	// å‚æ•°ï¼š
	//   tx: å¾…åˆ¤æ–­çš„äº¤æ˜“
	//
	// è¿”å›ï¼štrueè¡¨ç¤ºæ˜¯Coinbaseäº¤æ˜“
	//
	// ç”¨é€”ï¼š
	// - æ’ä»¶å¿«é€Ÿåˆ¤æ–­äº¤æ˜“ç±»å‹
	// - é¿å…é‡å¤åˆ¤æ–­
	IsCoinbase(tx *transaction.Transaction) bool

	// GetNonce è·å–è´¦æˆ·å½“å‰nonce
	//
	// å‚æ•°ï¼š
	//   ctx: ä¸Šä¸‹æ–‡
	//   address: è´¦æˆ·åœ°å€
	//
	// è¿”å›ï¼š
	//   uint64: è´¦æˆ·å½“å‰nonceå€¼
	//   error: æŸ¥è¯¢é”™è¯¯
	//
	// ç”¨é€”ï¼š
	// - NoncePluginéªŒè¯äº¤æ˜“nonce
	// - é˜²æ­¢é‡æ”¾æ”»å‡»
	GetNonce(ctx context.Context, address []byte) (uint64, error)

	// GetPublicKey è·å–åœ°å€å¯¹åº”çš„å…¬é’¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
	//
	// å‚æ•°ï¼š
	//   ctx: ä¸Šä¸‹æ–‡
	//   address: è´¦æˆ·åœ°å€
	//
	// è¿”å›ï¼š
	//   []byte: å…¬é’¥ï¼ˆå¦‚æœæ‰¾ä¸åˆ°è¿”å›nilï¼‰
	//   error: æŸ¥è¯¢é”™è¯¯
	//
	// ç”¨é€”ï¼š
	// - ç­¾åéªŒè¯æ—¶ä»åœ°å€æ¨å¯¼å…¬é’¥
	// - æ”¯æŒåœ°å€åˆ°å…¬é’¥çš„æ˜ å°„æŸ¥è¯¢
	//
	// âš ï¸ æ³¨æ„ï¼š
	// - å¹¶éæ‰€æœ‰åœ°å€éƒ½æœ‰å¯¹åº”çš„å…¬é’¥è®°å½•
	// - å¦‚æœè¿”å›nilï¼Œè°ƒç”¨æ–¹åº”ä½¿ç”¨å…¶ä»–æ–¹å¼è·å–å…¬é’¥
	GetPublicKey(ctx context.Context, address []byte) ([]byte, error)

	// GetTxBlockHeight è·å–æŒ‡å®šäº¤æ˜“æ‰€åœ¨çš„åŒºå—é«˜åº¦
	//
	// å‚æ•°ï¼š
	//   ctx: ä¸Šä¸‹æ–‡
	//   txID: äº¤æ˜“ID
	//
	// è¿”å›ï¼š
	//   uint64: åŒºå—é«˜åº¦
	//   error: æŸ¥è¯¢é”™è¯¯ï¼ˆå¦‚äº¤æ˜“ä¸å­˜åœ¨ï¼‰
	//
	// ç”¨é€”ï¼š
	// - DelegationLockè¿‡æœŸéªŒè¯
	// - è®¡ç®—å§”æ‰˜æœ‰æ•ˆæœŸ
	GetTxBlockHeight(ctx context.Context, txID []byte) (uint64, error)

	// IsSponsorClaim åˆ¤æ–­å½“å‰äº¤æ˜“æ˜¯å¦ä¸ºèµåŠ©é¢†å–äº¤æ˜“
	//
	// å‚æ•°ï¼š
	//   tx: å¾…åˆ¤æ–­çš„äº¤æ˜“
	//
	// è¿”å›ï¼štrueè¡¨ç¤ºæ˜¯èµåŠ©é¢†å–äº¤æ˜“
	//
	// ç”¨é€”ï¼š
	// - æ’ä»¶å¿«é€Ÿåˆ¤æ–­äº¤æ˜“ç±»å‹
	// - è¯†åˆ«æ¿€åŠ±åŒºäº¤æ˜“
	IsSponsorClaim(tx *transaction.Transaction) bool
}

// ================================================================================================
// ğŸ”Œ AuthZ Pluginï¼ˆæƒé™éªŒè¯æ’ä»¶ï¼‰
// ================================================================================================

// AuthZPlugin æƒé™éªŒè¯æ’ä»¶æ¥å£
//
// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼šéªŒè¯ UnlockingProof æ˜¯å¦åŒ¹é… LockingCondition
//
// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
// å°† 7 ç§é”å®š/è§£é”æœºåˆ¶æŠ½è±¡ä¸ºç»Ÿä¸€çš„æ’ä»¶æ¥å£ï¼Œæ¯ç§æœºåˆ¶å®ç°ä¸€ä¸ªæ’ä»¶ã€‚
// å¾®å†…æ ¸éå†æ‰€æœ‰æ’ä»¶ï¼Œæ‰¾åˆ°åŒ¹é…çš„æ’ä»¶è¿›è¡ŒéªŒè¯ã€‚
//
// âš ï¸ **æ ¸å¿ƒçº¦æŸ**ï¼š
// - âŒ æ’ä»¶æ— çŠ¶æ€ï¼šä¸èƒ½å­˜å‚¨éªŒè¯ç»“æœæˆ–ä¸­é—´æ•°æ®
// - âŒ æ’ä»¶åªè¯»ï¼šä¸èƒ½ä¿®æ”¹äº¤æ˜“æˆ– UTXO
// - âœ… æ’ä»¶å¯å¹¶è¡Œï¼šä¸åŒ input çš„éªŒè¯å¯ä»¥å¹¶è¡Œ
//
// ğŸ“ **7 ç§æ’ä»¶**ï¼š
// 1. SingleKeyPlugin: å•å¯†é’¥éªŒè¯ï¼ˆP2PK/P2PKHï¼‰
// 2. MultiKeyPlugin: å¤šé‡ç­¾åéªŒè¯ï¼ˆM-of-Nï¼‰
// 3. ContractPlugin: æ™ºèƒ½åˆçº¦éªŒè¯
// 4. DelegationPlugin: å§”æ‰˜æˆæƒéªŒè¯
// 5. ThresholdPlugin: é—¨é™ç­¾åéªŒè¯
// 6. TimePlugin: æ—¶é—´é”éªŒè¯ï¼ˆé€’å½’éªŒè¯åŸºç¡€é”ï¼‰
// 7. HeightPlugin: é«˜åº¦é”éªŒè¯ï¼ˆé€’å½’éªŒè¯åŸºç¡€é”ï¼‰
//
// ğŸ“ **è°ƒç”¨æ–¹**ï¼šTxVerifierï¼ˆéªŒè¯å¾®å†…æ ¸ï¼‰
type AuthZPlugin interface {
	// Name æ’ä»¶åç§°
	//
	// è¿”å›ï¼šæ’ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ "single_key", "multi_key"ï¼‰
	//
	// ç”¨é€”ï¼š
	// - æ—¥å¿—è®°å½•
	// - é”™è¯¯ä¿¡æ¯
	// - æ’ä»¶ç®¡ç†
	Name() string

	// Match éªŒè¯ UnlockingProof æ˜¯å¦åŒ¹é… LockingCondition
	//
	// ğŸ¯ **æ ¸å¿ƒé€»è¾‘**ï¼š
	// 1. æ£€æŸ¥ lock å’Œ proof çš„ç±»å‹æ˜¯å¦åŒ¹é…ï¼ˆå¦‚ SingleKeyLock vs SingleKeyProofï¼‰
	// 2. å¦‚æœä¸åŒ¹é…ï¼Œè¿”å› (false, nil)ï¼Œè®©å…¶ä»–æ’ä»¶å°è¯•
	// 3. å¦‚æœåŒ¹é…ï¼Œæ‰§è¡Œå…·ä½“çš„éªŒè¯é€»è¾‘
	// 4. éªŒè¯é€šè¿‡è¿”å› (true, nil)ï¼Œå¤±è´¥è¿”å› (false, error)
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - lock: UTXO çš„é”å®šæ¡ä»¶ï¼ˆä» UTXO ä¸­è·å–ï¼‰
	//   - proof: input çš„è§£é”è¯æ˜ï¼ˆä» Transaction ä¸­è·å–ï¼‰
	//   - tx: å®Œæ•´çš„äº¤æ˜“å¯¹è±¡ï¼ˆç”¨äºç­¾åéªŒè¯ç­‰ï¼‰
	//
	// è¿”å›ï¼š
	//   - bool: æ˜¯å¦åŒ¹é…
	//     â€¢ true: æ­¤æ’ä»¶å¤„ç†äº†éªŒè¯ï¼ˆå¯èƒ½æˆåŠŸæˆ–å¤±è´¥ï¼‰
	//     â€¢ false: æ­¤æ’ä»¶ä¸å¤„ç†æ­¤ç±»å‹çš„ lock/proofï¼Œè®©å…¶ä»–æ’ä»¶å°è¯•
	//   - error: éªŒè¯é”™è¯¯
	//     â€¢ nil: éªŒè¯æˆåŠŸï¼ˆä»…å½“ç¬¬ä¸€ä¸ªè¿”å›å€¼ä¸º true æ—¶ï¼‰
	//     â€¢ non-nil: éªŒè¯å¤±è´¥ï¼Œæè¿°å¤±è´¥åŸå› 
	//
	// âš ï¸ çº¦æŸï¼š
	// - ä¸èƒ½ä¿®æ”¹ txã€lockã€proof
	// - ä¸èƒ½å­˜å‚¨çŠ¶æ€
	// - å¿…é¡»æ˜¯å¯é‡å…¥çš„ï¼ˆåŒä¸€æ’ä»¶å¯èƒ½è¢«å¹¶å‘è°ƒç”¨ï¼‰
	//
	// ğŸ“ **å…¸å‹å®ç°æ¨¡å¼**ï¼š
	//
	//	func (p *SingleKeyPlugin) Match(ctx, lock, proof, tx) (bool, error) {
	//	    // æ­¥éª¤ 1ï¼šæ£€æŸ¥ç±»å‹æ˜¯å¦åŒ¹é…
	//	    singleLock := lock.GetSingleKeyLock()
	//	    if singleLock == nil {
	//	        return false, nil  // ä¸æ˜¯ SingleKeyLockï¼Œè®©å…¶ä»–æ’ä»¶å¤„ç†
	//	    }
	//	    singleProof := proof.GetSingleKeyProof()
	//	    if singleProof == nil {
	//	        return false, fmt.Errorf("missing single key proof")
	//	    }
	//
	//	    // æ­¥éª¤ 2ï¼šæ‰§è¡Œå…·ä½“éªŒè¯é€»è¾‘
	//	    // - éªŒè¯ç­¾å
	//	    // - éªŒè¯å…¬é’¥æˆ–åœ°å€å“ˆå¸Œ
	//	    // ...
	//
	//	    // æ­¥éª¤ 3ï¼šè¿”å›ç»“æœ
	//	    return true, nil  // æˆ– true, error
	//	}
	Match(
		ctx context.Context,
		lock *transaction.LockingCondition,
		proof *transaction.UnlockingProof,
		tx *transaction.Transaction,
	) (bool, error)
}

// ================================================================================================
// âš–ï¸ Conservation Pluginï¼ˆä»·å€¼å®ˆæ’æ’ä»¶ï¼‰
// ================================================================================================

// ConservationPlugin ä»·å€¼å®ˆæ’æ’ä»¶æ¥å£
//
// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼šæ£€æŸ¥ä»·å€¼å®ˆæ’ï¼ˆÎ£è¾“å…¥ â‰¥ Î£è¾“å‡º + Feeï¼‰
//
// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
// å°†ä¸åŒçš„è´¹ç”¨æ¨¡å¼æŠ½è±¡ä¸ºæ’ä»¶ï¼Œæ”¯æŒå¤šç§ä»·å€¼å®ˆæ’æ£€æŸ¥ç­–ç•¥ã€‚
//
// âš ï¸ **æ ¸å¿ƒçº¦æŸ**ï¼š
// - âŒ æ’ä»¶æ— çŠ¶æ€ï¼šä¸èƒ½å­˜å‚¨éªŒè¯ç»“æœ
// - âŒ æ’ä»¶åªè¯»ï¼šä¸èƒ½ä¿®æ”¹ inputs/outputs
// - âœ… æ’ä»¶å¯å åŠ ï¼šå¯ä»¥åŒæ—¶æ³¨å†Œå¤šä¸ªæ’ä»¶ï¼Œéƒ½è¦é€šè¿‡
//
// ğŸ“ **å…¸å‹æ’ä»¶**ï¼š
// 1. BasicConservationPlugin: åŸºç¡€ä»·å€¼å®ˆæ’ï¼ˆÎ£è¾“å…¥ â‰¥ Î£è¾“å‡ºï¼‰
// 2. MinFeeConservationPlugin: æœ€ä½è´¹ç”¨æ£€æŸ¥
// 3. ProportionalFeePlugin: æ¯”ä¾‹è´¹ç”¨æ£€æŸ¥
// 4. ContractFeePlugin: åˆçº¦æ‰§è¡Œè´¹ç”¨æ£€æŸ¥
// 5. PriorityFeePlugin: ä¼˜å…ˆçº§è´¹ç”¨æ£€æŸ¥
//
// ğŸ“ **è°ƒç”¨æ–¹**ï¼šTxVerifierï¼ˆéªŒè¯å¾®å†…æ ¸ï¼‰
type ConservationPlugin interface {
	// Name æ’ä»¶åç§°
	//
	// è¿”å›ï¼šæ’ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ "basic_conservation", "min_fee"ï¼‰
	Name() string

	// Check æ£€æŸ¥ä»·å€¼å®ˆæ’
	//
	// ğŸ¯ **æ ¸å¿ƒé€»è¾‘**ï¼š
	// 1. è®¡ç®—è¾“å…¥æ€»é¢ï¼šÎ£(inputs.amount)ï¼ˆæ’é™¤ is_reference_only çš„ inputï¼‰
	// 2. è®¡ç®—è¾“å‡ºæ€»é¢ï¼šÎ£(outputs.amount)
	// 3. è®¡ç®—è´¹ç”¨ï¼šè¾“å…¥æ€»é¢ - è¾“å‡ºæ€»é¢
	// 4. æ£€æŸ¥è´¹ç”¨æ˜¯å¦ç¬¦åˆç­–ç•¥è¦æ±‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - inputs: è¾“å…¥ UTXO åˆ—è¡¨ï¼ˆå·²é€šè¿‡ repository.UTXOManager è·å–ï¼‰
	//   - outputs: è¾“å‡ºåˆ—è¡¨ï¼ˆä» Transaction ä¸­è·å–ï¼‰
	//   - tx: å®Œæ•´çš„äº¤æ˜“å¯¹è±¡ï¼ˆç”¨äºè¯»å– fee_mechanism ç­‰å­—æ®µï¼‰
	//
	// è¿”å›ï¼š
	//   - error: ä»·å€¼å®ˆæ’æ£€æŸ¥å¤±è´¥çš„åŸå› 
	//     â€¢ nil: æ£€æŸ¥é€šè¿‡
	//     â€¢ non-nil: æ£€æŸ¥å¤±è´¥ï¼Œæè¿°å¤±è´¥åŸå› ï¼ˆå¦‚"ä½™é¢ä¸è¶³"ã€"è´¹ç”¨è¿‡ä½"ï¼‰
	//
	// âš ï¸ çº¦æŸï¼š
	// - ä¸èƒ½ä¿®æ”¹ inputs/outputs/tx
	// - ä¸èƒ½å­˜å‚¨çŠ¶æ€
	//
	// ğŸ“ **å…¸å‹å®ç°æ¨¡å¼**ï¼š
	//
	//	func (p *BasicConservationPlugin) Check(ctx, inputs, outputs, tx) error {
	//	    var inputSum, outputSum uint64
	//	    for _, utxo := range inputs {
	//	        if !utxo.IsReferenceOnly {
	//	            inputSum += utxo.Amount
	//	        }
	//	    }
	//	    for _, output := range outputs {
	//	        if asset := output.GetAsset(); asset != nil {
	//	            amount, _ := strconv.ParseUint(asset.Amount, 10, 64)
	//	            outputSum += amount
	//	        }
	//	    }
	//	    if inputSum < outputSum {
	//	        return fmt.Errorf("conservation violation: %d < %d", inputSum, outputSum)
	//	    }
	//	    return nil
	//	}
	Check(
		ctx context.Context,
		inputs []*utxopb.UTXO,
		outputs []*transaction.TxOutput,
		tx *transaction.Transaction,
	) error
}

// ================================================================================================
// ğŸ• Condition Pluginï¼ˆæ¡ä»¶æ£€æŸ¥æ’ä»¶ï¼‰
// ================================================================================================

// ConditionPlugin æ¡ä»¶æ£€æŸ¥æ’ä»¶æ¥å£
//
// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼šæ£€æŸ¥æ—¶é—´é”ã€é«˜åº¦é”ã€nonce ç­‰æ¡ä»¶
//
// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
// å°†ä¸åŒçš„æ¡ä»¶æ£€æŸ¥æŠ½è±¡ä¸ºæ’ä»¶ï¼Œæ”¯æŒçµæ´»çš„æ¡ä»¶æ‰©å±•ã€‚
//
// âš ï¸ **æ ¸å¿ƒçº¦æŸ**ï¼š
// - âŒ æ’ä»¶æ— çŠ¶æ€ï¼šä¸èƒ½å­˜å‚¨éªŒè¯ç»“æœ
// - âŒ æ’ä»¶åªè¯»ï¼šä¸èƒ½ä¿®æ”¹äº¤æ˜“
// - âœ… æ’ä»¶å¯å åŠ ï¼šå¯ä»¥åŒæ—¶æ³¨å†Œå¤šä¸ªæ’ä»¶ï¼Œéƒ½è¦é€šè¿‡
//
// ğŸ“ **å…¸å‹æ’ä»¶**ï¼š
// 1. TimeWindowPlugin: æ—¶é—´çª—å£æ£€æŸ¥ï¼ˆvalidity_window.time_windowï¼‰
// 2. HeightWindowPlugin: é«˜åº¦çª—å£æ£€æŸ¥ï¼ˆvalidity_window.height_windowï¼‰
// 3. NoncePlugin: nonce æ£€æŸ¥ï¼ˆé˜²é‡æ”¾ï¼‰
// 4. ChainIDPlugin: é“¾ ID æ£€æŸ¥ï¼ˆé˜²è·¨é“¾é‡æ”¾ï¼‰
//
// ğŸ“ **è°ƒç”¨æ–¹**ï¼šTxVerifierï¼ˆéªŒè¯å¾®å†…æ ¸ï¼‰
type ConditionPlugin interface {
	// Name æ’ä»¶åç§°
	//
	// è¿”å›ï¼šæ’ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ "time_window", "nonce"ï¼‰
	Name() string

	// Check æ£€æŸ¥æ¡ä»¶
	//
	// ğŸ¯ **æ ¸å¿ƒé€»è¾‘**ï¼š
	// æ ¹æ®æ’ä»¶ç±»å‹æ£€æŸ¥ä¸åŒçš„æ¡ä»¶ï¼š
	// - TimeWindowPlugin: æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨ [not_before, not_after] èŒƒå›´å†…
	// - HeightWindowPlugin: æ£€æŸ¥å½“å‰é«˜åº¦æ˜¯å¦åœ¨ [not_before, not_after] èŒƒå›´å†…
	// - NoncePlugin: æ£€æŸ¥ nonce æ˜¯å¦è¿ç»­ä¸”æœªè¢«ä½¿ç”¨
	// - ChainIDPlugin: æ£€æŸ¥ chain_id æ˜¯å¦åŒ¹é…å½“å‰é“¾
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - tx: å®Œæ•´çš„äº¤æ˜“å¯¹è±¡
	//   - blockHeight: å½“å‰åŒºå—é«˜åº¦
	//   - blockTime: å½“å‰åŒºå—æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
	//
	// è¿”å›ï¼š
	//   - error: æ¡ä»¶æ£€æŸ¥å¤±è´¥çš„åŸå› 
	//     â€¢ nil: æ£€æŸ¥é€šè¿‡
	//     â€¢ non-nil: æ£€æŸ¥å¤±è´¥ï¼Œæè¿°å¤±è´¥åŸå› 
	//
	// âš ï¸ çº¦æŸï¼š
	// - ä¸èƒ½ä¿®æ”¹ tx
	// - ä¸èƒ½å­˜å‚¨çŠ¶æ€
	//
	// ğŸ“ **å…¸å‹å®ç°æ¨¡å¼**ï¼š
	//
	//	func (p *TimeWindowPlugin) Check(ctx, tx, blockHeight, blockTime) error {
	//	    window := tx.GetTimeWindow()
	//	    if window == nil {
	//	        return nil  // æ— æ—¶é—´çª—å£é™åˆ¶
	//	    }
	//	    if window.NotBefore != nil && blockTime < *window.NotBefore {
	//	        return fmt.Errorf("transaction not yet valid")
	//	    }
	//	    if window.NotAfter != nil && blockTime > *window.NotAfter {
	//	        return fmt.Errorf("transaction expired")
	//	    }
	//	    return nil
	//	}
	Check(
		ctx context.Context,
		tx *transaction.Transaction,
		blockHeight uint64,
		blockTime uint64,
	) error
}

// ================================================================================================
// ğŸ¯ æ’ä»¶è®¾è®¡è¯´æ˜
// ================================================================================================

// è®¾è®¡æƒè¡¡ 1: æ’ä»¶æ¥å£ç²’åº¦
//
// èƒŒæ™¯ï¼šæ˜¯å¦åº”è¯¥ä¸ºæ¯ç§é”å®šç±»å‹å®šä¹‰å•ç‹¬çš„æ¥å£
//
// å¤‡é€‰æ–¹æ¡ˆï¼š
// 1. ç»Ÿä¸€æ¥å£ï¼ˆAuthZPlugin.Matchï¼‰- ä¼˜åŠ¿ï¼šç®€æ´ - åŠ£åŠ¿ï¼šè¿”å›å€¼ç•¥å¤æ‚
// 2. åˆ†æ•£æ¥å£ï¼ˆSingleKeyVerifier, MultiKeyVerifier...ï¼‰- ä¼˜åŠ¿ï¼šç±»å‹å®‰å…¨ - åŠ£åŠ¿ï¼šæ¥å£è†¨èƒ€
//
// é€‰æ‹©ï¼šç»Ÿä¸€æ¥å£
//
// ç†ç”±ï¼š
// - 7 ç§é”å®šç±»å‹éƒ½éµå¾ªç›¸åŒçš„éªŒè¯æ¨¡å¼ï¼ˆmatch lock with proofï¼‰
// - ç»Ÿä¸€æ¥å£ä¾¿äºå¾®å†…æ ¸éå†å’Œç®¡ç†
// - è¿”å›å€¼ (bool, error) æ¸…æ™°è¡¨è¾¾"æ˜¯å¦åŒ¹é…"å’Œ"éªŒè¯ç»“æœ"
//
// ä»£ä»·ï¼š
// - è¿”å›å€¼ç•¥å¤æ‚ï¼ˆéœ€è¦åŒºåˆ†"ä¸åŒ¹é…"å’Œ"åŒ¹é…ä½†å¤±è´¥"ï¼‰
// - ä½†è¿™æ˜¯åˆç†çš„æƒè¡¡

// è®¾è®¡æƒè¡¡ 2: æ˜¯å¦ä¼ é€’å®Œæ•´äº¤æ˜“å¯¹è±¡
//
// èƒŒæ™¯ï¼šæ’ä»¶éªŒè¯æ—¶æ˜¯å¦éœ€è¦å®Œæ•´çš„äº¤æ˜“å¯¹è±¡
//
// å¤‡é€‰æ–¹æ¡ˆï¼š
// 1. ä¼ é€’å®Œæ•´ tx - ä¼˜åŠ¿ï¼šæ’ä»¶çµæ´» - åŠ£åŠ¿ï¼šå¯èƒ½è¢«æ»¥ç”¨
// 2. åªä¼ é€’å¿…è¦å­—æ®µ - ä¼˜åŠ¿ï¼šçº¦æŸæ¸…æ™° - åŠ£åŠ¿ï¼šæ‰©å±•å›°éš¾
//
// é€‰æ‹©ï¼šä¼ é€’å®Œæ•´ tx
//
// ç†ç”±ï¼š
// - æŸäº›éªŒè¯éœ€è¦å®Œæ•´äº¤æ˜“ï¼ˆå¦‚ç­¾åéªŒè¯éœ€è¦å®Œæ•´ tx å†…å®¹ï¼‰
// - ä¿¡ä»»æ’ä»¶å®ç°ä¸ä¼šæ»¥ç”¨ï¼ˆæ’ä»¶ç”±æ ¸å¿ƒå›¢é˜Ÿå®ç°ï¼‰
// - ä¾¿äºæœªæ¥æ‰©å±•ï¼ˆæ–°å¢éªŒè¯é€»è¾‘å¯èƒ½éœ€è¦æ›´å¤šå­—æ®µï¼‰
//
// ä»£ä»·ï¼š
// - æ’ä»¶å¯ä»¥è¯»å–æ‰€æœ‰ tx å­—æ®µï¼ˆä½†ä¸èƒ½ä¿®æ”¹ï¼‰
// - é€šè¿‡æ–‡æ¡£å’Œ review ç¡®ä¿æ’ä»¶ä¸æ»¥ç”¨

// è®¾è®¡æƒè¡¡ 3: æ’ä»¶æ˜¯å¦å¯ä»¥è°ƒç”¨å¤–éƒ¨æœåŠ¡
//
// èƒŒæ™¯ï¼šæ’ä»¶éªŒè¯æ—¶æ˜¯å¦å¯ä»¥è°ƒç”¨ UTXO Managerã€Network ç­‰å¤–éƒ¨æœåŠ¡
//
// å¤‡é€‰æ–¹æ¡ˆï¼š
// 1. å…è®¸ï¼šæ’ä»¶é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨å¤–éƒ¨æœåŠ¡ - ä¼˜åŠ¿ï¼šçµæ´» - åŠ£åŠ¿ï¼šå¤æ‚
// 2. ä¸å…è®¸ï¼šæ‰€æœ‰å¿…è¦æ•°æ®ç”±å¾®å†…æ ¸å‡†å¤‡å¥½ - ä¼˜åŠ¿ï¼šç®€å• - åŠ£åŠ¿ï¼šä¸å¤Ÿçµæ´»
//
// é€‰æ‹©ï¼šéƒ¨åˆ†å…è®¸ï¼ˆé€šè¿‡ä¾èµ–æ³¨å…¥ï¼‰
//
// ç†ç”±ï¼š
// - AuthZ æ’ä»¶ä¸éœ€è¦å¤–éƒ¨æœåŠ¡ï¼ˆæ‰€æœ‰æ•°æ®éƒ½åœ¨ lock/proof/tx ä¸­ï¼‰
// - Conservation æ’ä»¶éœ€è¦ UTXO æ•°æ®ï¼ˆç”±å¾®å†…æ ¸é€šè¿‡ UTXOManager è·å–åä¼ é€’ï¼‰
// - Condition æ’ä»¶éœ€è¦å½“å‰é«˜åº¦/æ—¶é—´ï¼ˆç”±å¾®å†…æ ¸ä½œä¸ºå‚æ•°ä¼ é€’ï¼‰
// - ç‰¹æ®Šæ’ä»¶ï¼ˆå¦‚ Contract éªŒè¯ï¼‰å¯èƒ½éœ€è¦åˆçº¦å¼•æ“ï¼ˆé€šè¿‡ä¾èµ–æ³¨å…¥ï¼‰
//
// ä»£ä»·ï¼š
// - æ’ä»¶å®ç°ç•¥å¤æ‚ï¼ˆéœ€è¦ä¾èµ–æ³¨å…¥ï¼‰
// - ä½†è¿™æ˜¯åˆç†çš„ï¼Œä¿æŒäº†çµæ´»æ€§

// ================================================================================================
// ğŸ¯ ä½¿ç”¨ç¤ºä¾‹
// ================================================================================================

// Example_SingleKeyPlugin å±•ç¤ºå¦‚ä½•å®ç° SingleKeyPlugin
//
// è¯´æ˜ï¼šæ­¤å‡½æ•°åªæ˜¯ç¤ºä¾‹ï¼Œä¸ä¼šè¢«ç¼–è¯‘è¿è¡Œ
func Example_SingleKeyPlugin() {
	// type SingleKeyPlugin struct {}
	//
	// func (p *SingleKeyPlugin) Name() string {
	// 	return "single_key"
	// }
	//
	// func (p *SingleKeyPlugin) Match(
	// 	ctx context.Context,
	// 	lock *transaction.LockingCondition,
	// 	proof *transaction.UnlockingProof,
	// 	tx *transaction.Transaction,
	// ) (bool, error) {
	// 	// æ­¥éª¤ 1ï¼šæ£€æŸ¥ç±»å‹
	// 	singleLock := lock.GetSingleKeyLock()
	// 	if singleLock == nil {
	// 		return false, nil // ä¸æ˜¯ SingleKeyLock
	// 	}
	// 	singleProof := proof.GetSingleKeyProof()
	// 	if singleProof == nil {
	// 		return false, fmt.Errorf("missing single key proof")
	// 	}
	//
	// 	// æ­¥éª¤ 2ï¼šéªŒè¯ç­¾å
	// 	txHash := ComputeTxHash(tx)
	// 	pubKey := singleProof.PublicKey.Value
	// 	signature := singleProof.Signature.Value
	// 	if !ecdsa.Verify(pubKey, txHash, signature) {
	// 		return false, fmt.Errorf("invalid signature")
	// 	}
	//
	// 	// æ­¥éª¤ 3ï¼šéªŒè¯å…¬é’¥æˆ–åœ°å€å“ˆå¸Œ
	// 	if singleLock.RequiredPublicKey != nil {
	// 		if !bytes.Equal(pubKey, singleLock.RequiredPublicKey.Value) {
	// 			return false, fmt.Errorf("public key mismatch")
	// 		}
	// 	}
	// 	if singleLock.RequiredAddressHash != nil {
	// 		addressHash := ComputeAddressHash(pubKey)
	// 		if !bytes.Equal(addressHash, singleLock.RequiredAddressHash) {
	// 			return false, fmt.Errorf("address hash mismatch")
	// 		}
	// 	}
	//
	// 	return true, nil
	// }
}
