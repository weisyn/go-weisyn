// Package eutxo æä¾›EUTXOå†™å…¥æ“ä½œçš„å…¬å…±æ¥å£å®šä¹‰
//
// ğŸ’ **EUTXOå†™å…¥æ¥å£ (UTXO Writer)**
//
// æœ¬åŒ…å®šä¹‰ WES ç³»ç»Ÿçš„ EUTXO å†™å…¥æ¥å£ï¼Œéµå¾ª CQRS æ¶æ„åŸåˆ™ï¼Œ
// ä¸“æ³¨äº UTXO çš„å†™å…¥æ“ä½œã€‚
//
// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼š
// - UTXOåˆ›å»ºå’Œåˆ é™¤
// - UTXOå¼•ç”¨è®¡æ•°ç®¡ç†
// - çŠ¶æ€æ ¹æ›´æ–°
//
// ğŸ—ï¸ **è®¾è®¡åŸåˆ™**ï¼š
// - CQRS å†™è·¯å¾„ï¼šåªåŒ…å«å†™æ“ä½œï¼Œä¸åŒ…å«æŸ¥è¯¢
// - ç›´æ¥æ“ä½œå­˜å‚¨ï¼šå†…éƒ¨ç›´æ¥æ“ä½œåŸºç¡€è®¾æ–½å±‚
// - èŒè´£å•ä¸€ï¼šåªå¤„ç†UTXOçš„å†™å…¥
//
// è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼špkg/interfaces/eutxo/README.md
package eutxo

import (
	"context"

	"github.com/weisyn/v1/pkg/interfaces/infrastructure/storage"
	transaction "github.com/weisyn/v1/pb/blockchain/block/transaction"
	utxo "github.com/weisyn/v1/pb/blockchain/utxo"
)

// UTXOWriter UTXOå†™å…¥æ¥å£ï¼ˆCQRSå†™è·¯å¾„ï¼‰
//
// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼š
// æä¾› UTXO çš„å†™å…¥æ“ä½œï¼Œå„æ¨¡å—å†…éƒ¨ç›´æ¥æ“ä½œå­˜å‚¨ã€‚
//
// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
// - åªåŒ…å«å†™æ“ä½œï¼Œä¸åŒ…å«æŸ¥è¯¢æ“ä½œï¼ˆæŸ¥è¯¢ç”± UTXOQuery æä¾›ï¼‰
// - å†…éƒ¨ç›´æ¥æ“ä½œå­˜å‚¨å±‚ï¼Œä¸é€šè¿‡æŸ¥è¯¢æ¥å£
// - æ”¯æŒäº‹åŠ¡ä¿è¯ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
//
// ğŸ“ **è°ƒç”¨æ–¹**ï¼š
// - TXæ¨¡å—ï¼šå¤„ç†äº¤æ˜“æ—¶åˆ›å»ºå’Œåˆ é™¤UTXO
// - BlockProcessorï¼šåŒºå—å¤„ç†æ—¶æ‰¹é‡æ›´æ–°UTXO
// - UTXOSnapshotï¼šå¿«ç…§å’Œåˆ†å‰å¤„ç†
//
// âš ï¸ **æ ¸å¿ƒçº¦æŸ**ï¼š
// - åªå†™ä¸è¯»ï¼šæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å†™æ“ä½œï¼Œä¸è¿”å›æŸ¥è¯¢ç»“æœ
// - äº‹åŠ¡ä¿è¯ï¼šçŠ¶æ€æ›´æ–°å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
// - å¹‚ç­‰æ€§ï¼šé‡å¤è°ƒç”¨ç»“æœä¸€è‡´
type UTXOWriter interface {
	// CreateUTXO åˆ›å»ºUTXOï¼ˆå†…éƒ¨ä½¿ç”¨ï¼Œä»…ç”¨äºå¿«ç…§å’Œåˆ†å‰å¤„ç†ï¼‰
	//
	// åˆ›å»ºæ–°çš„ UTXO å¯¹è±¡ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - utxoObj: UTXOå¯¹è±¡
	//
	// è¿”å›ï¼š
	//   - error: åˆ›å»ºé”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - å¿«ç…§æ¢å¤æ—¶åˆ›å»ºUTXO
	//   - åˆ†å‰å¤„ç†æ—¶æ¢å¤UTXO
	//
	// è¯´æ˜ï¼š
	//   - æ­£å¸¸æƒ…å†µä¸‹UTXOé€šè¿‡äº¤æ˜“è¾“å‡ºåˆ›å»ºï¼Œæ­¤æ–¹æ³•ä»…ç”¨äºç‰¹æ®Šåœºæ™¯
	CreateUTXO(ctx context.Context, utxoObj *utxo.UTXO) error

	// DeleteUTXO åˆ é™¤UTXOï¼ˆå†…éƒ¨ä½¿ç”¨ï¼Œä»…ç”¨äºå¿«ç…§å’Œåˆ†å‰å¤„ç†ï¼‰
	//
	// åˆ é™¤æŒ‡å®šçš„ UTXO å¯¹è±¡ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - outpoint: UTXOçš„è¾“å‡ºç‚¹
	//
	// è¿”å›ï¼š
	//   - error: åˆ é™¤é”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - å¿«ç…§æ¢å¤æ—¶åˆ é™¤UTXO
	//   - åˆ†å‰å¤„ç†æ—¶åˆ é™¤UTXO
	//
	// è¯´æ˜ï¼š
	//   - æ­£å¸¸æƒ…å†µä¸‹UTXOé€šè¿‡äº¤æ˜“è¾“å…¥åˆ é™¤ï¼Œæ­¤æ–¹æ³•ä»…ç”¨äºç‰¹æ®Šåœºæ™¯
	DeleteUTXO(ctx context.Context, outpoint *transaction.OutPoint) error

	// ReferenceUTXO å¼•ç”¨UTXOï¼ˆå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰
	//
	// å¢åŠ  UTXO çš„å¼•ç”¨è®¡æ•°ï¼ˆç”¨äºèµ„æºUTXOï¼‰ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - outpoint: UTXOçš„è¾“å‡ºç‚¹
	//
	// è¿”å›ï¼š
	//   - error: å¼•ç”¨é”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - èµ„æºUTXOè¢«å¼•ç”¨æ—¶å¢åŠ å¼•ç”¨è®¡æ•°
	ReferenceUTXO(ctx context.Context, outpoint *transaction.OutPoint) error

	// UnreferenceUTXO è§£é™¤UTXOå¼•ç”¨ï¼ˆå‡å°‘å¼•ç”¨è®¡æ•°ï¼‰
	//
	// å‡å°‘ UTXO çš„å¼•ç”¨è®¡æ•°ï¼ˆç”¨äºèµ„æºUTXOï¼‰ã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - outpoint: UTXOçš„è¾“å‡ºç‚¹
	//
	// è¿”å›ï¼š
	//   - error: è§£é™¤å¼•ç”¨é”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - èµ„æºUTXOå¼•ç”¨è§£é™¤æ—¶å‡å°‘å¼•ç”¨è®¡æ•°
	UnreferenceUTXO(ctx context.Context, outpoint *transaction.OutPoint) error

	// UpdateStateRoot æ›´æ–°çŠ¶æ€æ ¹
	//
	// æ›´æ–°å½“å‰ UTXO é›†åˆçš„çŠ¶æ€æ ¹å“ˆå¸Œã€‚
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - stateRoot: æ–°çš„çŠ¶æ€æ ¹å“ˆå¸Œ
	//
	// è¿”å›ï¼š
	//   - error: æ›´æ–°é”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - åŒºå—å¤„ç†å®Œæˆåæ›´æ–°çŠ¶æ€æ ¹
	UpdateStateRoot(ctx context.Context, stateRoot []byte) error

	// UpdateStateRootInTransaction åœ¨äº‹åŠ¡ä¸­æ›´æ–°çŠ¶æ€æ ¹ï¼ˆç”¨äºåŸå­å›æ»š/é‡æ”¾ï¼‰ã€‚
	//
	// âš ï¸ çº¦æŸï¼š
	// - ä¸å‘å¸ƒäº‹ä»¶ï¼Œä¸æ›´æ–°ç¼“å­˜ï¼›ç”±ä¸Šå±‚åœ¨äº‹åŠ¡æäº¤åè¿›è¡Œå¿…è¦çš„å¼‚æ­¥é€šçŸ¥/åˆ·æ–°ã€‚
	UpdateStateRootInTransaction(ctx context.Context, tx storage.BadgerTransaction, stateRoot []byte) error

	// ====================================================================
	//                           äº‹åŠ¡ç‰ˆæœ¬æ–¹æ³•
	// ====================================================================
	// ä»¥ä¸‹æ–¹æ³•ç”¨äºåœ¨å·²æœ‰äº‹åŠ¡ä¸­æ‰§è¡Œ UTXO æ“ä½œï¼Œç¡®ä¿åŸå­æ€§
	// ä¸»è¦ç”¨äº DataWriter.WriteBlock() åœºæ™¯

	// CreateUTXOInTransaction åœ¨äº‹åŠ¡ä¸­åˆ›å»º UTXO
	//
	// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼š
	// åœ¨å·²æœ‰äº‹åŠ¡ä¸­åˆ›å»º UTXOï¼Œç¡®ä¿ç´¢å¼•æ“ä½œä¹Ÿåœ¨åŒä¸€äº‹åŠ¡ä¸­ã€‚
	//
	// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
	// - ç”¨äº DataWriter.WriteBlock() åœºæ™¯
	// - æ¥æ”¶å¤–éƒ¨äº‹åŠ¡ï¼Œé¿å…åˆ›å»ºæ–°äº‹åŠ¡
	// - ç¡®ä¿æ‰€æœ‰æ“ä½œï¼ˆå­˜å‚¨ã€ç´¢å¼•ã€ç¼“å­˜ï¼‰åœ¨åŒä¸€äº‹åŠ¡ä¸­
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - tx: BadgerDB äº‹åŠ¡å¯¹è±¡ï¼ˆå¤–éƒ¨ä¼ å…¥ï¼Œä¸åœ¨æ­¤æ–¹æ³•ä¸­åˆ›å»ºï¼‰
	//   - utxoObj: UTXOå¯¹è±¡
	//
	// è¿”å›ï¼š
	//   - error: åˆ›å»ºé”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - DataWriter.WriteBlock() å¤„ç†äº¤æ˜“è¾“å‡ºæ—¶åˆ›å»º UTXO
	//
	// âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
	//   - tx å¿…é¡»æ˜¯æœ‰æ•ˆçš„äº‹åŠ¡å¯¹è±¡
	//   - äº‹åŠ¡çš„æäº¤/å›æ»šç”±è°ƒç”¨æ–¹æ§åˆ¶
	//   - ç¼“å­˜æ›´æ–°åº”å»¶è¿Ÿåˆ°äº‹åŠ¡æäº¤åï¼ˆæˆ–ç¦ç”¨ï¼‰
	CreateUTXOInTransaction(ctx context.Context, tx storage.BadgerTransaction, utxoObj *utxo.UTXO) error

	// DeleteUTXOInTransaction åœ¨äº‹åŠ¡ä¸­åˆ é™¤ UTXO
	//
	// ğŸ¯ **æ ¸å¿ƒèŒè´£**ï¼š
	// åœ¨å·²æœ‰äº‹åŠ¡ä¸­åˆ é™¤ UTXOï¼Œç¡®ä¿ç´¢å¼•æ“ä½œä¹Ÿåœ¨åŒä¸€äº‹åŠ¡ä¸­ã€‚
	//
	// ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼š
	// - ç”¨äº DataWriter.WriteBlock() åœºæ™¯
	// - æ¥æ”¶å¤–éƒ¨äº‹åŠ¡ï¼Œé¿å…åˆ›å»ºæ–°äº‹åŠ¡
	// - ç¡®ä¿æ‰€æœ‰æ“ä½œï¼ˆå­˜å‚¨ã€ç´¢å¼•ã€ç¼“å­˜ï¼‰åœ¨åŒä¸€äº‹åŠ¡ä¸­
	//
	// å‚æ•°ï¼š
	//   - ctx: ä¸Šä¸‹æ–‡å¯¹è±¡
	//   - tx: BadgerDB äº‹åŠ¡å¯¹è±¡ï¼ˆå¤–éƒ¨ä¼ å…¥ï¼Œä¸åœ¨æ­¤æ–¹æ³•ä¸­åˆ›å»ºï¼‰
	//   - outpoint: UTXOçš„è¾“å‡ºç‚¹
	//
	// è¿”å›ï¼š
	//   - error: åˆ é™¤é”™è¯¯ï¼Œnilè¡¨ç¤ºæˆåŠŸ
	//
	// ä½¿ç”¨åœºæ™¯ï¼š
	//   - DataWriter.WriteBlock() å¤„ç†äº¤æ˜“è¾“å…¥æ—¶åˆ é™¤ UTXO
	//
	// âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
	//   - tx å¿…é¡»æ˜¯æœ‰æ•ˆçš„äº‹åŠ¡å¯¹è±¡
	//   - äº‹åŠ¡çš„æäº¤/å›æ»šç”±è°ƒç”¨æ–¹æ§åˆ¶
	//   - ä¼šæ£€æŸ¥å¼•ç”¨è®¡æ•°ï¼Œå¼•ç”¨è®¡æ•° > 0 æ—¶æ‹’ç»åˆ é™¤
	//   - ç¼“å­˜æ›´æ–°åº”å»¶è¿Ÿåˆ°äº‹åŠ¡æäº¤åï¼ˆæˆ–ç¦ç”¨ï¼‰
	DeleteUTXOInTransaction(ctx context.Context, tx storage.BadgerTransaction, outpoint *transaction.OutPoint) error
}

