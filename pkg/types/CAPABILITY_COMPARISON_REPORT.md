# BLOCK ä¸ CHAIN æ¨¡å—èƒ½åŠ›å¯¹æ¯”æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-11-XX  
**å¯¹æ¯”åŸºå‡†**: `_archived/internal-core-blockchain` vs `internal/core/block` + `internal/core/chain`

---

## ğŸ“Š èƒ½åŠ›å¯¹æ¯”æ€»è§ˆ

### å·²å½’æ¡£æ¨¡å—ç»“æ„
```
_archived/internal-core-blockchain/
â”œâ”€â”€ block/                    # åŒºå—ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ manager.go           # ç»Ÿä¸€ç®¡ç†å™¨
â”‚   â”œâ”€â”€ create.go             # æŒ–çŸ¿å€™é€‰åŒºå—åˆ›å»º
â”‚   â”œâ”€â”€ validate.go           # åŒºå—éªŒè¯ï¼ˆå¤šå±‚éªŒè¯ä½“ç³»ï¼‰
â”‚   â”œâ”€â”€ process.go            # åŒºå—å¤„ç†ï¼ˆå«åˆ†å‰æ£€æµ‹ï¼‰
â”‚   â”œâ”€â”€ block_cache.go        # LRUç¼“å­˜å®ç°
â”‚   â”œâ”€â”€ cache_utils.go        # ç¼“å­˜å·¥å…·ï¼ˆåºåˆ—åŒ–ã€TTLï¼‰
â”‚   â”œâ”€â”€ hash_utils.go         # åŒºå—å“ˆå¸Œè®¡ç®—å·¥å…·
â”‚   â”œâ”€â”€ merkle.go             # Merkleæ ‘è®¡ç®—
â”‚   â””â”€â”€ genesis/              # åˆ›ä¸–åŒºå—æ¨¡å—
â”‚       â”œâ”€â”€ builder.go        # åˆ›ä¸–åŒºå—æ„å»º
â”‚       â””â”€â”€ validator.go      # åˆ›ä¸–åŒºå—éªŒè¯
â”‚
â”œâ”€â”€ chain/                    # é“¾çŠ¶æ€ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ manager.go           # ç»Ÿä¸€ç®¡ç†å™¨
â”‚   â”œâ”€â”€ info.go              # é“¾ä¿¡æ¯ç»¼åˆæŸ¥è¯¢
â”‚   â”œâ”€â”€ height.go            # é“¾é«˜åº¦æŸ¥è¯¢
â”‚   â”œâ”€â”€ hash.go              # æœ€ä½³åŒºå—å“ˆå¸ŒæŸ¥è¯¢
â”‚   â”œâ”€â”€ status.go            # ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼ˆå°±ç»ªã€æ–°é²œåº¦ã€çŠ¶æ€ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ config.go            # èŠ‚ç‚¹æ¨¡å¼é…ç½®æŸ¥è¯¢
â”‚   â””â”€â”€ genesis.go           # åˆ›ä¸–åŒºå—ç®¡ç†ï¼ˆåˆ›å»ºã€å¤„ç†ã€åˆå§‹åŒ–ï¼‰
â”‚
â”œâ”€â”€ fork/                     # åˆ†å‰å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ manager.go
â”‚   â”œâ”€â”€ processor.go
â”‚   â”œâ”€â”€ chain_weight.go
â”‚   â””â”€â”€ double_spend_detection.go
â”‚
â””â”€â”€ sync/                     # åŒæ­¥æœåŠ¡æ¨¡å—
    â”œâ”€â”€ manager.go
    â”œâ”€â”€ block_sync.go
    â”œâ”€â”€ height_probe.go
    â””â”€â”€ ...
```

### å½“å‰æ¨¡å—ç»“æ„
```
internal/core/block/
â”œâ”€â”€ builder/                  # åŒºå—æ„å»ºæœåŠ¡
â”‚   â”œâ”€â”€ service.go
â”‚   â”œâ”€â”€ candidate.go
â”‚   â””â”€â”€ cache.go              # ç®€å•ç¼“å­˜
â”œâ”€â”€ validator/                # åŒºå—éªŒè¯æœåŠ¡
â”‚   â”œâ”€â”€ service.go
â”‚   â”œâ”€â”€ structure.go
â”‚   â””â”€â”€ consensus.go
â”œâ”€â”€ processor/                # åŒºå—å¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ service.go
â”‚   â”œâ”€â”€ execute.go
â”‚   â””â”€â”€ transaction.go
â”œâ”€â”€ hash/                     # åŒºå—å“ˆå¸ŒæœåŠ¡ï¼ˆgRPCï¼‰
â”‚   â”œâ”€â”€ service.go
â”‚   â””â”€â”€ client.go
â””â”€â”€ merkle/                   # Merkleæ ‘è®¡ç®—
    â”œâ”€â”€ merkle.go
    â””â”€â”€ adapter.go

internal/core/chain/
â”œâ”€â”€ writer/                   # é“¾å†™å…¥æœåŠ¡
â”‚   â”œâ”€â”€ service.go
â”‚   â”œâ”€â”€ chain_tip.go
â”‚   â”œâ”€â”€ sync_status.go
â”‚   â””â”€â”€ validation.go
â””â”€â”€ fork/                     # åˆ†å‰å¤„ç†æœåŠ¡
    â”œâ”€â”€ service.go
    â”œâ”€â”€ handler.go
    â”œâ”€â”€ detector.go
    â””â”€â”€ weight.go
```

---

## âœ… å·²å®ç°çš„èƒ½åŠ›

### BLOCK æ¨¡å—
1. âœ… **åŒºå—æ„å»º** (`builder/`) - å·²å®ç°
   - âœ… `CreateMiningCandidate` - åˆ›å»ºæŒ–çŸ¿å€™é€‰åŒºå—
   - âœ… åŸºç¡€ç¼“å­˜æ”¯æŒ (`cache.go`)

2. âœ… **åŒºå—éªŒè¯** (`validator/`) - å·²å®ç°
   - âœ… `ValidateBlock` - å®Œæ•´åŒºå—éªŒè¯
   - âœ… `ValidateStructure` - ç»“æ„éªŒè¯
   - âœ… `ValidateConsensus` - å…±è¯†éªŒè¯

3. âœ… **åŒºå—å¤„ç†** (`processor/`) - å·²å®ç°
   - âœ… `ProcessBlock` - åŒºå—å¤„ç†
   - âœ… äº¤æ˜“æ‰§è¡Œ
   - âœ… UTXOçŠ¶æ€æ›´æ–°

4. âœ… **å“ˆå¸ŒæœåŠ¡** (`hash/`) - å·²å®ç°ï¼ˆgRPCåŒ–ï¼‰
   - âœ… `ComputeBlockHash` - åŒºå—å“ˆå¸Œè®¡ç®—
   - âœ… `ValidateBlockHash` - åŒºå—å“ˆå¸ŒéªŒè¯

5. âœ… **Merkleæ ‘** (`merkle/`) - å·²å®ç°
   - âœ… `CalculateMerkleRoot` - Merkleæ ¹è®¡ç®—

### CHAIN æ¨¡å—
1. âœ… **é“¾å†™å…¥** (`writer/`) - å·²å®ç°
   - âœ… `UpdateChainTip` - é“¾å°–æ›´æ–°
   - âœ… `UpdateSyncStatus` - åŒæ­¥çŠ¶æ€æ›´æ–°

2. âœ… **åˆ†å‰å¤„ç†** (`fork/`) - å·²å®ç°
   - âœ… `HandleFork` - åˆ†å‰å¤„ç†
   - âœ… `DetectFork` - åˆ†å‰æ£€æµ‹
   - âœ… `CalculateChainWeight` - é“¾æƒé‡è®¡ç®—

---

## âŒ ç¼ºå¤±çš„èƒ½åŠ›

### BLOCK æ¨¡å—ç¼ºå¤±

#### 1. **é«˜çº§ç¼“å­˜èƒ½åŠ›** âš ï¸ é«˜ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `block_cache.go` - LRUç¼“å­˜å®ç°  
**å½“å‰**: `cache.go` - ç®€å•ç¼“å­˜

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ LRUæ·˜æ±°ç­–ç•¥ï¼ˆåŒå‘é“¾è¡¨+å“ˆå¸Œè¡¨ï¼ŒO(1)æ“ä½œï¼‰
- âŒ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡ï¼ˆhitCount, missCountï¼‰
- âŒ è®¿é—®æ—¶é—´è¿½è¸ªï¼ˆaccessTimeï¼‰
- âŒ ç¼“å­˜å®¹é‡æ§åˆ¶ï¼ˆmaxSize, currentSizeï¼‰
- âŒ æ€§èƒ½ç›‘æ§æŒ‡æ ‡

**å½±å“**: å½“å‰ç¼“å­˜å®ç°è¾ƒç®€å•ï¼Œå¯èƒ½æ— æ³•é«˜æ•ˆå¤„ç†å¤§é‡å€™é€‰åŒºå—ç¼“å­˜åœºæ™¯ã€‚

#### 2. **ç¼“å­˜å·¥å…·æ–¹æ³•** âš ï¸ ä¸­ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `cache_utils.go` - ç¼“å­˜åºåˆ—åŒ–ã€TTLç®¡ç†  
**å½“å‰**: åŸºç¡€ç¼“å­˜ï¼Œç¼ºå°‘ä¸“é—¨å·¥å…·

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ å€™é€‰åŒºå—åºåˆ—åŒ–/ååºåˆ—åŒ–å·¥å…·
- âŒ TTLï¼ˆTime To Liveï¼‰ç®¡ç†
- âŒ ç¼“å­˜é”®æ ‡å‡†åŒ–ï¼ˆ`CandidateBlockPrefix`ï¼‰
- âŒ ç¼“å­˜é…ç½®ç®¡ç†ï¼ˆ`CacheConfig`ï¼‰

**å½±å“**: ç¼“å­˜ç®¡ç†ä¸å¤Ÿè§„èŒƒï¼Œå¯èƒ½å½±å“å†…å­˜ç®¡ç†å’Œæ€§èƒ½ã€‚

#### 3. **åˆ›ä¸–åŒºå—æ¨¡å—** âš ï¸ é«˜ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `block/genesis/` - ä¸“é—¨åˆ›ä¸–åŒºå—æ¨¡å—  
**å½“å‰**: æœªæ‰¾åˆ°ä¸“é—¨å®ç°

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ `CreateGenesisBlock` - åˆ›ä¸–åŒºå—æ„å»º
- âŒ `ValidateGenesisBlock` - åˆ›ä¸–åŒºå—éªŒè¯
- âŒ åˆ›ä¸–åŒºå—ç‰¹æ®Šè§„åˆ™å¤„ç†ï¼ˆé«˜åº¦0ã€çˆ¶å“ˆå¸Œå…¨é›¶ã€è·³è¿‡POWç­‰ï¼‰

**å½±å“**: åˆ›ä¸–åŒºå—å¤„ç†èƒ½åŠ›ç¼ºå¤±ï¼Œç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–å¯èƒ½æœ‰é—®é¢˜ã€‚

#### 4. **æŒ–çŸ¿å€™é€‰åŒºå—æ„å»ºç»†èŠ‚** âš ï¸ ä¸­ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `create.go` - å®Œæ•´çš„æŒ–çŸ¿æ”¯æŒ  
**å½“å‰**: `builder/candidate.go` - åŸºç¡€å®ç°

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ `buildIncentiveTransactions` - æ¿€åŠ±äº¤æ˜“æ„å»ºï¼ˆCoinbase + èµåŠ©é¢†å–ï¼‰
- âŒ `buildCoinbaseTransactionSimplified` - Coinbaseäº¤æ˜“æ„å»º
- âŒ `buildCandidateBlockHeader` - ä¸€ç«™å¼åŒºå—å¤´æ„å»º
- âŒ `calculateAdaptiveDifficulty` - é€‚åº”æ€§éš¾åº¦è®¡ç®—ï¼ˆä¸ºäº¤æ˜“æ”¶é›†ä¼˜åŒ–ï¼‰
- âŒ `assembleCandidateBlock` - å€™é€‰åŒºå—ç»„è£…
- âŒ `storeCandidateBlock` - å€™é€‰åŒºå—ç¼“å­˜å­˜å‚¨

**å½±å“**: æŒ–çŸ¿å€™é€‰åŒºå—æ„å»ºå¯èƒ½ä¸å¤Ÿå®Œæ•´ï¼Œç¼ºå°‘æ¿€åŠ±äº¤æ˜“å’Œéš¾åº¦è°ƒæ•´é€»è¾‘ã€‚

#### 5. **åŒºå—å¤„ç†ä¸­çš„åˆ†å‰æ£€æµ‹** âš ï¸ ä¸­ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `process.go` - åŒ…å« `detectAndHandleFork`  
**å½“å‰**: `processor/execute.go` - å¯èƒ½ç¼ºå°‘åˆ†å‰æ£€æµ‹

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ åŒºå—å¤„ç†æ—¶çš„åˆ†å‰æ£€æµ‹é€»è¾‘
- âŒ åŒé«˜åº¦åˆ†å‰æ£€æµ‹
- âŒ é“¾æ–­è£‚åˆ†å‰æ£€æµ‹
- âŒ åˆ†å‰äº‹ä»¶å‘å¸ƒ

**å½±å“**: åŒºå—å¤„ç†æ—¶å¯èƒ½æ— æ³•åŠæ—¶å‘ç°åˆ†å‰ï¼Œéœ€è¦ä¾èµ–å¤–éƒ¨åˆ†å‰æ£€æµ‹ã€‚

#### 6. **åŒºå—éªŒè¯ç»†èŠ‚** âš ï¸ ä½ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `validate.go` - å¤šå±‚éªŒè¯ä½“ç³»ï¼ˆ935è¡Œï¼‰  
**å½“å‰**: `validator/` - åŸºç¡€éªŒè¯å®ç°

**ç¼ºå¤±åŠŸèƒ½**:
- âš ï¸ éªŒè¯ç»†èŠ‚å¯èƒ½ä¸å¤Ÿå®Œå–„ï¼ˆéœ€è¦è¯¦ç»†å¯¹æ¯”ï¼‰
- âš ï¸ éªŒè¯é”™è¯¯åˆ†ç±»å¯èƒ½ä¸å¤Ÿè¯¦ç»†

**å½±å“**: åŒºå—éªŒè¯èƒ½åŠ›åŸºæœ¬å®Œæ•´ï¼Œä½†ç»†èŠ‚å¯èƒ½éœ€è¦å®Œå–„ã€‚

### CHAIN æ¨¡å—ç¼ºå¤±

#### 1. **é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡** âš ï¸ é«˜ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `chain/` - å®Œæ•´çš„é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡  
**å½“å‰**: ç¼ºå°‘æŸ¥è¯¢æœåŠ¡ï¼Œåªæœ‰å†™å…¥æœåŠ¡

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ `GetChainInfo` - é“¾ä¿¡æ¯ç»¼åˆæŸ¥è¯¢ï¼ˆé«˜åº¦ã€å“ˆå¸Œã€åŒæ­¥çŠ¶æ€ã€å¥åº·åº¦ï¼‰
- âŒ `GetCurrentHeight` - å½“å‰é“¾é«˜åº¦æŸ¥è¯¢
- âŒ `GetBestBlockHash` - æœ€ä½³åŒºå—å“ˆå¸ŒæŸ¥è¯¢
- âŒ `IsReady` - ç³»ç»Ÿå°±ç»ªçŠ¶æ€æ£€æŸ¥
- âŒ `IsDataFresh` - æ•°æ®æ–°é²œåº¦éªŒè¯
- âŒ `GetNodeMode` - èŠ‚ç‚¹æ¨¡å¼é…ç½®æŸ¥è¯¢

**å½±å“**: **ä¸¥é‡ç¼ºå¤±** - Chainæ¨¡å—ç¼ºå°‘æŸ¥è¯¢èƒ½åŠ›ï¼Œæ— æ³•å¯¹å¤–æä¾›é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡ã€‚

#### 2. **é“¾çŠ¶æ€ç®¡ç†å™¨** âš ï¸ é«˜ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `chain/manager.go` - ç»Ÿä¸€ç®¡ç†å™¨å®ç° `ChainService`  
**å½“å‰**: åªæœ‰ `writer/` å’Œ `fork/`ï¼Œç¼ºå°‘ç»Ÿä¸€ç®¡ç†å™¨

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ ç»Ÿä¸€çš„æœåŠ¡å…¥å£
- âŒ `ChainService` æ¥å£å®ç°
- âŒ çŠ¶æ€æŸ¥è¯¢å’Œç®¡ç†åè°ƒ

**å½±å“**: Chainæ¨¡å—åŠŸèƒ½ä¸å®Œæ•´ï¼Œæ— æ³•å®ç°å…¬å…±æ¥å£ã€‚

#### 3. **åˆ›ä¸–åŒºå—ç®¡ç†** âš ï¸ é«˜ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `chain/genesis.go` - åˆ›ä¸–åŒºå—å®Œæ•´ç®¡ç†  
**å½“å‰**: æœªæ‰¾åˆ°å®ç°

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ `NeedsGenesisBlock` - æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›ä¸–åŒºå—
- âŒ `CreateGenesisBlock` - åˆ›å»ºåˆ›ä¸–åŒºå—
- âŒ `ProcessGenesisBlock` - å¤„ç†åˆ›ä¸–åŒºå—
- âŒ `InitializeGenesisIfNeeded` - è‡ªåŠ¨åˆå§‹åŒ–åˆ›ä¸–åŒºå—
- âŒ `createGenesisTransactions` - åˆ›å»ºåˆ›ä¸–äº¤æ˜“
- âŒ `validateGenesisConfig` - éªŒè¯åˆ›ä¸–é…ç½®

**å½±å“**: **ä¸¥é‡ç¼ºå¤±** - ç³»ç»Ÿå¯åŠ¨æ—¶æ— æ³•è‡ªåŠ¨åˆå§‹åŒ–åˆ›ä¸–åŒºå—ã€‚

#### 4. **é“¾çŠ¶æ€æŒä¹…åŒ–** âš ï¸ ä¸­ä¼˜å…ˆçº§
**å·²å½’æ¡£**: `chain/status.go` - `SetChainStatus` å’ŒæŒä¹…åŒ–  
**å½“å‰**: `writer/` æœ‰åŸºç¡€å†™å…¥ï¼Œä½†å¯èƒ½ç¼ºå°‘çŠ¶æ€ç®¡ç†

**ç¼ºå¤±åŠŸèƒ½**:
- âŒ `SetChainStatus` - è®¾ç½®é“¾çŠ¶æ€ï¼ˆnormal/syncing/fork_processing/error/maintenanceï¼‰
- âŒ `persistChainStatus` - é“¾çŠ¶æ€æŒä¹…åŒ–
- âŒ `validateChainStatus` - çŠ¶æ€å€¼éªŒè¯

**å½±å“**: é“¾çŠ¶æ€ç®¡ç†èƒ½åŠ›ä¸å®Œæ•´ï¼Œæ— æ³•åè°ƒç³»ç»ŸçŠ¶æ€ã€‚

---

## ğŸ“‹ è¯¦ç»†å¯¹æ¯”è¡¨

### BLOCK æ¨¡å—åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | å·²å½’æ¡£æ¨¡å— | å½“å‰æ¨¡å— | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|-----------|---------|------|--------|
| **åŒºå—æ„å»º** |
| CreateMiningCandidate | âœ… create.go | âœ… builder/candidate.go | âœ… å·²å®ç° | - |
| GetCachedCandidate | âœ… block_cache.go | âš ï¸ cache.go (ç®€å•) | âš ï¸ ç®€åŒ–å®ç° | ä¸­ |
| æ¿€åŠ±äº¤æ˜“æ„å»º | âœ… buildIncentiveTransactions | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| Coinbaseäº¤æ˜“æ„å»º | âœ… buildCoinbaseTransactionSimplified | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| åŒºå—å¤´æ„å»º | âœ… buildCandidateBlockHeader | âš ï¸ éƒ¨åˆ†å®ç° | âš ï¸ ä¸å®Œæ•´ | ä¸­ |
| é€‚åº”æ€§éš¾åº¦è®¡ç®— | âœ… calculateAdaptiveDifficulty | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| **åŒºå—éªŒè¯** |
| ValidateBlock | âœ… validate.go (å¤šå±‚) | âœ… validator/service.go | âœ… å·²å®ç° | - |
| ValidateStructure | âœ… validate.go | âœ… validator/structure.go | âœ… å·²å®ç° | - |
| ValidateConsensus | âœ… validate.go | âœ… validator/consensus.go | âœ… å·²å®ç° | - |
| **åŒºå—å¤„ç†** |
| ProcessBlock | âœ… process.go | âœ… processor/execute.go | âœ… å·²å®ç° | - |
| åˆ†å‰æ£€æµ‹ | âœ… detectAndHandleFork | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| äº¤æ˜“æ± æ¸…ç† | âœ… cleanupTransactionPool | âœ… processor/execute.go | âœ… å·²å®ç° | - |
| **ç¼“å­˜ç®¡ç†** |
| LRUç¼“å­˜ | âœ… block_cache.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| ç¼“å­˜å·¥å…· | âœ… cache_utils.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| TTLç®¡ç† | âœ… cache_utils.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| **åˆ›ä¸–åŒºå—** |
| CreateGenesisBlock | âœ… genesis/builder.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| ValidateGenesisBlock | âœ… genesis/validator.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| **å“ˆå¸Œå’ŒMerkle** |
| åŒºå—å“ˆå¸Œè®¡ç®— | âœ… hash_utils.go | âœ… hash/service.go (gRPC) | âœ… å·²å®ç° | - |
| Merkleæ ¹è®¡ç®— | âœ… merkle.go | âœ… merkle/merkle.go | âœ… å·²å®ç° | - |

### CHAIN æ¨¡å—åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | å·²å½’æ¡£æ¨¡å— | å½“å‰æ¨¡å— | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|-----------|---------|------|--------|
| **é“¾çŠ¶æ€æŸ¥è¯¢** |
| GetChainInfo | âœ… info.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| GetCurrentHeight | âœ… height.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| GetBestBlockHash | âœ… hash.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| IsReady | âœ… status.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| IsDataFresh | âœ… status.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| GetNodeMode | âœ… config.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| **é“¾çŠ¶æ€ç®¡ç†** |
| SetChainStatus | âœ… status.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| persistChainStatus | âœ… status.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| validateChainStatus | âœ… status.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | ä¸­ |
| **é“¾å†™å…¥** |
| UpdateChainTip | âŒ ä¸åœ¨chainæ¨¡å— | âœ… writer/chain_tip.go | âœ… å·²å®ç° | - |
| UpdateSyncStatus | âŒ ä¸åœ¨chainæ¨¡å— | âœ… writer/sync_status.go | âœ… å·²å®ç° | - |
| **åˆ›ä¸–åŒºå—ç®¡ç†** |
| NeedsGenesisBlock | âœ… genesis.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| CreateGenesisBlock | âœ… genesis.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| ProcessGenesisBlock | âœ… genesis.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| InitializeGenesisIfNeeded | âœ… genesis.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| createGenesisTransactions | âœ… genesis.go | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | é«˜ |
| **åˆ†å‰å¤„ç†** |
| HandleFork | âœ… fork/manager.go | âœ… fork/handler.go | âœ… å·²å®ç° | - |
| DetectFork | âœ… fork/processor.go | âœ… fork/detector.go | âœ… å·²å®ç° | - |
| CalculateChainWeight | âœ… fork/chain_weight.go | âœ… fork/weight.go | âœ… å·²å®ç° | - |

---

## ğŸ¯ å…³é”®ç¼ºå¤±åŠŸèƒ½åˆ†æ

### 1. CHAIN æ¨¡å—ç¼ºå°‘é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡ âš ï¸ **ä¸¥é‡ç¼ºå¤±**

**é—®é¢˜**: Chainæ¨¡å—åªæœ‰å†™å…¥æœåŠ¡ï¼ˆ`writer/`ï¼‰å’Œåˆ†å‰å¤„ç†ï¼ˆ`fork/`ï¼‰ï¼Œä½†ç¼ºå°‘æ ¸å¿ƒçš„é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡ã€‚

**å·²å½’æ¡£å®ç°**:
- `chain/info.go` - é“¾ä¿¡æ¯ç»¼åˆæŸ¥è¯¢
- `chain/height.go` - é“¾é«˜åº¦æŸ¥è¯¢
- `chain/hash.go` - æœ€ä½³åŒºå—å“ˆå¸ŒæŸ¥è¯¢
- `chain/status.go` - ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
- `chain/config.go` - èŠ‚ç‚¹æ¨¡å¼æŸ¥è¯¢
- `chain/manager.go` - ç»Ÿä¸€ç®¡ç†å™¨ï¼Œå®ç° `ChainService` æ¥å£

**å»ºè®®**: 
1. åœ¨ `internal/core/chain` ä¸­åˆ›å»º `query/` æˆ– `service/` ç›®å½•
2. å®ç°é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡ï¼Œæä¾› `GetChainInfo`, `GetCurrentHeight`, `GetBestBlockHash` ç­‰æ–¹æ³•
3. å®ç°ç³»ç»ŸçŠ¶æ€æ£€æŸ¥æœåŠ¡ï¼Œæä¾› `IsReady`, `IsDataFresh`, `GetNodeMode` ç­‰æ–¹æ³•
4. åˆ›å»ºç»Ÿä¸€ç®¡ç†å™¨ï¼Œå®ç° `pkg/interfaces/blockchain.ChainService` æ¥å£

### 2. CHAIN æ¨¡å—ç¼ºå°‘åˆ›ä¸–åŒºå—ç®¡ç† âš ï¸ **ä¸¥é‡ç¼ºå¤±**

**é—®é¢˜**: ç³»ç»Ÿå¯åŠ¨æ—¶æ— æ³•è‡ªåŠ¨æ£€æŸ¥ã€åˆ›å»ºå’Œå¤„ç†åˆ›ä¸–åŒºå—ã€‚

**å·²å½’æ¡£å®ç°**:
- `chain/genesis.go` - å®Œæ•´çš„åˆ›ä¸–åŒºå—ç®¡ç†ï¼ˆ435è¡Œï¼‰
  - `NeedsGenesisBlock` - æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›ä¸–åŒºå—
  - `CreateGenesisBlock` - åˆ›å»ºåˆ›ä¸–åŒºå—
  - `ProcessGenesisBlock` - å¤„ç†åˆ›ä¸–åŒºå—
  - `InitializeGenesisIfNeeded` - è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆå¯¹å¤–æ¥å£ï¼‰
  - `createGenesisTransactions` - åˆ›å»ºåˆ›ä¸–äº¤æ˜“
  - `validateGenesisConfig` - éªŒè¯åˆ›ä¸–é…ç½®

**å»ºè®®**:
1. åœ¨ `internal/core/chain` ä¸­åˆ›å»º `genesis/` ç›®å½•
2. å®ç°åˆ›ä¸–åŒºå—ç®¡ç†æœåŠ¡
3. åœ¨ç³»ç»Ÿå¯åŠ¨æµç¨‹ä¸­é›†æˆ `InitializeGenesisIfNeeded`

### 3. BLOCK æ¨¡å—ç¼ºå°‘åˆ›ä¸–åŒºå—å¤„ç† âš ï¸ **é«˜ä¼˜å…ˆçº§**

**é—®é¢˜**: Blockæ¨¡å—ç¼ºå°‘ä¸“é—¨çš„åˆ›ä¸–åŒºå—æ„å»ºå’ŒéªŒè¯èƒ½åŠ›ã€‚

**å·²å½’æ¡£å®ç°**:
- `block/genesis/builder.go` - åˆ›ä¸–åŒºå—æ„å»º
- `block/genesis/validator.go` - åˆ›ä¸–åŒºå—éªŒè¯

**å»ºè®®**:
1. åœ¨ `internal/core/block` ä¸­åˆ›å»º `genesis/` ç›®å½•
2. å®ç°åˆ›ä¸–åŒºå—æ„å»ºå’ŒéªŒè¯é€»è¾‘
3. ä¸ Chain æ¨¡å—çš„åˆ›ä¸–ç®¡ç†åè°ƒ

### 4. BLOCK æ¨¡å—ç¼ºå°‘é«˜çº§ç¼“å­˜ âš ï¸ **é«˜ä¼˜å…ˆçº§**

**é—®é¢˜**: å½“å‰ç¼“å­˜å®ç°ç®€å•ï¼Œç¼ºå°‘LRUæ·˜æ±°ç­–ç•¥å’Œæ€§èƒ½ç›‘æ§ã€‚

**å·²å½’æ¡£å®ç°**:
- `block/block_cache.go` - LRUç¼“å­˜å®ç°ï¼ˆ372è¡Œï¼‰
  - O(1)æ—¶é—´å¤æ‚åº¦çš„è¯»å†™æ“ä½œ
  - åŒå‘é“¾è¡¨+å“ˆå¸Œè¡¨å®ç°
  - ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
  - å®¹é‡æ§åˆ¶

**å»ºè®®**:
1. å‡çº§ `internal/core/block/builder/cache.go` ä¸ºLRUç¼“å­˜
2. æˆ–åˆ›å»ºä¸“é—¨çš„ `cache/` åŒ…å®ç°LRUç¼“å­˜
3. æ·»åŠ ç¼“å­˜å·¥å…·æ–¹æ³•ï¼ˆ`cache_utils.go`ï¼‰

### 5. BLOCK æ¨¡å—ç¼ºå°‘æŒ–çŸ¿ç»†èŠ‚ âš ï¸ **ä¸­ä¼˜å…ˆçº§**

**é—®é¢˜**: æŒ–çŸ¿å€™é€‰åŒºå—æ„å»ºç¼ºå°‘æ¿€åŠ±äº¤æ˜“å’Œéš¾åº¦è°ƒæ•´é€»è¾‘ã€‚

**å·²å½’æ¡£å®ç°**:
- `buildIncentiveTransactions` - æ¿€åŠ±äº¤æ˜“æ„å»º
- `calculateAdaptiveDifficulty` - é€‚åº”æ€§éš¾åº¦è®¡ç®—
- `buildCandidateBlockHeader` - ä¸€ç«™å¼åŒºå—å¤´æ„å»º

**å»ºè®®**:
1. å®Œå–„ `internal/core/block/builder/candidate.go`
2. æ·»åŠ æ¿€åŠ±äº¤æ˜“æ„å»ºé€»è¾‘
3. æ·»åŠ é€‚åº”æ€§éš¾åº¦è®¡ç®—

### 6. BLOCK æ¨¡å—ç¼ºå°‘åˆ†å‰æ£€æµ‹ âš ï¸ **ä¸­ä¼˜å…ˆçº§**

**é—®é¢˜**: åŒºå—å¤„ç†æ—¶ç¼ºå°‘åˆ†å‰æ£€æµ‹é€»è¾‘ã€‚

**å·²å½’æ¡£å®ç°**:
- `process.go` ä¸­çš„ `detectAndHandleFork` æ–¹æ³•

**å»ºè®®**:
1. åœ¨ `internal/core/block/processor/execute.go` ä¸­æ·»åŠ åˆ†å‰æ£€æµ‹
2. æˆ–å§”æ‰˜ç»™ Chain æ¨¡å—çš„ ForkHandler

---

## ğŸ“Š ç¼ºå¤±åŠŸèƒ½ä¼˜å…ˆçº§æ€»ç»“

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å®ç°ï¼‰

1. **CHAIN æ¨¡å—é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡** - å®ç° `ChainService` æ¥å£çš„æ ¸å¿ƒæŸ¥è¯¢æ–¹æ³•
2. **CHAIN æ¨¡å—åˆ›ä¸–åŒºå—ç®¡ç†** - ç³»ç»Ÿå¯åŠ¨å¿…éœ€
3. **BLOCK æ¨¡å—åˆ›ä¸–åŒºå—å¤„ç†** - é…åˆChainæ¨¡å—å®Œæˆåˆ›ä¸–æµç¨‹
4. **BLOCK æ¨¡å—é«˜çº§ç¼“å­˜** - æå‡æŒ–çŸ¿æ€§èƒ½

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®ç°ï¼‰

5. **BLOCK æ¨¡å—æŒ–çŸ¿ç»†èŠ‚** - å®Œå–„æŒ–çŸ¿æ”¯æŒ
6. **BLOCK æ¨¡å—åˆ†å‰æ£€æµ‹** - æå‡åŒºå—å¤„ç†å®Œæ•´æ€§
7. **BLOCK æ¨¡å—ç¼“å­˜å·¥å…·** - è§„èŒƒç¼“å­˜ç®¡ç†
8. **CHAIN æ¨¡å—çŠ¶æ€ç®¡ç†** - å®Œå–„çŠ¶æ€åè°ƒèƒ½åŠ›

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

9. **BLOCK æ¨¡å—éªŒè¯ç»†èŠ‚** - å®Œå–„éªŒè¯é€»è¾‘

---

## ğŸ”§ å®æ–½å»ºè®®

### é˜¶æ®µ1: è¡¥é½CHAINæ¨¡å—æ ¸å¿ƒèƒ½åŠ›ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **åˆ›å»ºé“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡**
   ```
   internal/core/chain/
   â”œâ”€â”€ query/              # æ–°å»º
   â”‚   â”œâ”€â”€ service.go     # é“¾çŠ¶æ€æŸ¥è¯¢æœåŠ¡
   â”‚   â”œâ”€â”€ info.go         # GetChainInfoå®ç°
   â”‚   â”œâ”€â”€ height.go       # GetCurrentHeightå®ç°
   â”‚   â”œâ”€â”€ hash.go         # GetBestBlockHashå®ç°
   â”‚   â”œâ”€â”€ status.go       # IsReady, IsDataFreshå®ç°
   â”‚   â””â”€â”€ config.go       # GetNodeModeå®ç°
   â”œâ”€â”€ manager.go          # æ–°å»ºï¼šç»Ÿä¸€ç®¡ç†å™¨ï¼Œå®ç°ChainService
   â””â”€â”€ ...
   ```

2. **åˆ›å»ºåˆ›ä¸–åŒºå—ç®¡ç†æœåŠ¡**
   ```
   internal/core/chain/
   â”œâ”€â”€ genesis/            # æ–°å»º
   â”‚   â”œâ”€â”€ service.go      # åˆ›ä¸–åŒºå—ç®¡ç†æœåŠ¡
   â”‚   â”œâ”€â”€ creator.go      # CreateGenesisBlockå®ç°
   â”‚   â”œâ”€â”€ processor.go    # ProcessGenesisBlockå®ç°
   â”‚   â””â”€â”€ validator.go   # é…ç½®éªŒè¯
   â””â”€â”€ ...
   ```

### é˜¶æ®µ2: è¡¥é½BLOCKæ¨¡å—å…³é”®èƒ½åŠ›ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

3. **åˆ›å»ºåˆ›ä¸–åŒºå—å¤„ç†æ¨¡å—**
   ```
   internal/core/block/
   â”œâ”€â”€ genesis/            # æ–°å»º
   â”‚   â”œâ”€â”€ builder.go      # åˆ›ä¸–åŒºå—æ„å»º
   â”‚   â””â”€â”€ validator.go    # åˆ›ä¸–åŒºå—éªŒè¯
   â””â”€â”€ ...
   ```

4. **å‡çº§ç¼“å­˜å®ç°**
   ```
   internal/core/block/
   â”œâ”€â”€ builder/
   â”‚   â”œâ”€â”€ cache.go        # å‡çº§ä¸ºLRUç¼“å­˜
   â”‚   â””â”€â”€ cache_utils.go   # æ–°å»ºï¼šç¼“å­˜å·¥å…·
   â””â”€â”€ ...
   ```

### é˜¶æ®µ3: å®Œå–„ç»†èŠ‚ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

5. **å®Œå–„æŒ–çŸ¿æ”¯æŒ**
6. **æ·»åŠ åˆ†å‰æ£€æµ‹**
7. **å®Œå–„çŠ¶æ€ç®¡ç†**

---

## ğŸ“ å¤‡æ³¨

1. **Syncæ¨¡å—**: å·²å½’æ¡£æ¨¡å—ä¸­æœ‰ `sync/` ç›®å½•ï¼Œä½†å½“å‰ä»£ç åº“ä¸­å¯èƒ½åœ¨å…¶ä»–ä½ç½®å®ç°ï¼Œæœ¬æ¬¡å¯¹æ¯”æœªæ¶‰åŠã€‚

2. **æ¥å£å®ç°**: éœ€è¦ç¡®è®¤ `pkg/interfaces/blockchain.ChainService` å’Œ `pkg/interfaces/blockchain.BlockService` çš„å…·ä½“è¦æ±‚ï¼Œç¡®ä¿å®ç°å®Œæ•´æ€§ã€‚

3. **ä¾èµ–å…³ç³»**: å®æ–½æ—¶éœ€è¦å…³æ³¨æ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œé¿å…å¾ªç¯ä¾èµ–ã€‚

4. **æµ‹è¯•è¦†ç›–**: è¡¥å……èƒ½åŠ›æ—¶éœ€è¦åŒæ­¥è¡¥å……æµ‹è¯•ç”¨ä¾‹ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-XX  
**å»ºè®®**: ä¼˜å…ˆè¡¥é½CHAINæ¨¡å—çš„é“¾çŠ¶æ€æŸ¥è¯¢å’Œåˆ›ä¸–åŒºå—ç®¡ç†èƒ½åŠ›ï¼Œè¿™äº›æ˜¯ç³»ç»Ÿè¿è¡Œçš„åŸºç¡€èƒ½åŠ›ã€‚

